/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.pacl.ejb.session;

import jakarta.annotation.Resource;
import jakarta.ejb.Stateless;
import jakarta.persistence.EntityManager;
import jakarta.persistence.EntityManagerFactory;
import jakarta.persistence.Persistence;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;
import java.util.logging.Level;
import java.util.logging.Logger;
import static org.eclipse.persistence.config.PersistenceUnitProperties.*;

/**
 * A session EJB to create an entity manage with custom properties.
 *
 * @author grant.shan
 */
@Stateless
public class HealthideasFacade implements HealthideasFacadeLocal {
    
    @Resource(lookup = "java:app/eacl/application_properties")
    Properties applicationProperties;

    static final Logger logger = Logger.getLogger(HealthideasFacade.class.getName());
    static final String ORACLE_JDBC_DRIVER = "oracle.jdbc.driver.OracleDriver";
    static final String EACL_JNDI_PROPERTY_NAME = "java:app/eacl/application_properties";
    static final String HI_DB_URL_PROPERTY_ID = "healthideas_database_url";
    static final String HI_DB_PREFIX = "healthideas_schema_prefix";

    /**
     * Create an entity manager by provided properties.
     *
     * @param user HI DB UserID
     * @param password HI DB User Password
     * @return Entity Manager is created successfully
     */
    @Override
    public EntityManager createEntityManagerInstance(String user, String password) {
        EntityManager em = null;
        try {
            Map properties = new HashMap();
            String url = applicationProperties.getProperty(HI_DB_URL_PROPERTY_ID);
            properties.put(JDBC_DRIVER, ORACLE_JDBC_DRIVER);
            properties.put(JDBC_PASSWORD, password);
            properties.put(JDBC_USER, user);
            properties.put(JDBC_URL, url);
            EntityManagerFactory emf = Persistence.createEntityManagerFactory("PACL-HI", properties);
            em = emf.createEntityManager();
        } catch (Exception ex) {
            logger.log(Level.INFO, "login failed.", ex);
            throw ex;
        }
        return em;
    }

    /**
     * Get the schema named used by the Health Ideas DB in this environment.
     *
     * @return String
     */
    public String lookupSchemaPrefixFromJNDI() {
        return applicationProperties.getProperty(HI_DB_PREFIX);
    }
}