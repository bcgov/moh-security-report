/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.pacl.ejb.session;

import ca.bc.gov.health.pacl.ejb.entity.Project;
import ca.bc.gov.health.pacl.util.PaclConstants;
import jakarta.ejb.Stateless;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.persistence.Query;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 *
 * @author Michael.Tremblay
 */
@Stateless
public class ProjectSvaFacade extends AbstractFacade<Project> implements ProjectSvaFacadeLocal {

    static Logger logger = Logger.getLogger(ProjectFacade.class.getName());

    /**
     * New instance for EntityManager class.
     */
    @PersistenceContext(unitName = "PACLPU")
    private EntityManager em;

    public ProjectSvaFacade(Class<Project> entityClass) {
        super(entityClass);
    }

    /**
     * Gets the local instance of the {@link EntityManager} class.
     * @return entity Manager
     */
    @Override
    protected EntityManager getEntityManager() {
        return em;
    }

    /**
     * Default constructor.
     */
    public ProjectSvaFacade() {
        super(Project.class);
    }

    /**
     * Retrieve a list Letter Runs ordered by name.
     * @return List<Project> - list of Letter Runs ordered by name
     */
    @Override
    public List<Project> findAll() {
        //Query query = em.createNativeQuery("select * from PROJECT c"
       //         + " where c.projectTypeId.id = 21 OR c.projectTypeId.id = 22 OR c.projectTypeId.id = 23 order by UPPER(c.name) " , Project.class);

        return em.createNamedQuery("Project.findAllSVA").getResultList();
    }

    /**
     * Retrieve the default list with the most recent 5 projects.
     * @return List<Project> - list of the 5 most recent projects
     */
    @Override
    public List<Project> findRecent() {
        // The max result should be configurable. Needs to be moved out to JNDI property or so
        
        return em.createNamedQuery("Project.findRecent").setMaxResults(
                PaclConstants.DISPLAY_DEFAULT_PROJECTS_FIND).getResultList();
    }
    
    @Override
    public List<Project> findRecentSVA() {
        // The max result should be configurable. Needs to be moved out to JNDI property or so
        
        Query q = em.createNamedQuery("Project.findRecentSVA");
        q.setParameter("id1", PaclConstants.RANDOM_MONTLY_AUDIT_ID);
        q.setParameter("id2", PaclConstants.SELECT_SERVICE_AUDIT_ID);
        q.setParameter("id3", PaclConstants.SELECT_SERVICE_QUESTIONS_AUDIT_ID);
        System.out.println(q.toString());
         return q.setMaxResults(PaclConstants.DISPLAY_DEFAULT_PROJECTS_FIND).getResultList();
    }


    /**
     * Retrieve the projects based on user selected search criteria.
     *
     * @param lastName String - input search criteria from screen
     * @param firstName String - input search criteria from screen
     * @param pracCode String - input search criteria from screen
     * @param svaProjectCode String - input search criteria from screen
     * @param letterRunDate Date - input search criteria from screen
     * @param letterRunYear String  - input search criteria from screen
     * @param letterRunStatus Long - input search criteria from screen
     * @return List<Project> - list of projects from the search criteria
     */
 
    @Override
    public List<Project> findLetterRunBySearchCriteria(String lastName, String firstName, 
    String pracCode, String svaProjectCode, Date letterRunDate, String letterRunYear, Long letterRunStatus ) {

        StringBuilder builder = new StringBuilder("SELECT p FROM Project p");

        boolean isWhereAdded = false;
        int paramsCount = 0;
        String joinStmt =  " JOIN p.pracSvaProjectList pList";

        // Conditionally build the where clause for the query
        if (lastName != null && !lastName.trim().isEmpty()) {
            if (isWhereAdded) {
                builder.append(" AND pList.pracSurname LIKE ?").append(++paramsCount);
            } else {
                builder.append(joinStmt);
                builder.append(" WHERE pList.pracSurname LIKE ?").append(++paramsCount);
                isWhereAdded = true;
            }
        }
        
        if (firstName != null && !firstName.trim().isEmpty()) {
            if (isWhereAdded) {
                builder.append(" AND pList.pracFirstGvnNm LIKE ?").append(++paramsCount);
            } else {
                builder.append(joinStmt);
                builder.append(" WHERE pList.pracFirstGvnNm LIKE ?").append(++paramsCount);
                isWhereAdded = true;
            }
        }

        if (pracCode != null && !pracCode.trim().isEmpty()) {
            if (isWhereAdded) {
                builder.append(" AND pList.pracBllgNum LIKE ?").append(++paramsCount);
            } else {
                builder.append(joinStmt);
                builder.append(" WHERE pList.pracBllgNum LIKE ?").append(++paramsCount);
                isWhereAdded = true;
            }
        }
        
        if (svaProjectCode != null && !svaProjectCode.trim().isEmpty()) {
            if (isWhereAdded) {
                builder.append(" AND pList.svaProjectCode LIKE ?").append(++paramsCount);
            } else {
                builder.append(joinStmt);
                builder.append(" WHERE pList.svaProjectCode LIKE ?").append(++paramsCount);
                isWhereAdded = true;
            }
        }

        if (letterRunYear != null && !letterRunYear.trim().isEmpty()) {
            if (isWhereAdded) {
                builder.append(" AND p.projectYear = ?").append(++paramsCount);
            } else {
                builder.append(" WHERE p.projectYear = ?").append(++paramsCount);
                isWhereAdded = true;
            }
        }

        if (letterRunDate != null) {
            if (isWhereAdded) {
                builder.append(" AND p.projectMonth = ?").append(++paramsCount);
                builder.append(" AND p.projectYear = ?").append(++paramsCount);
            } else {
                builder.append(" WHERE p.projectMonth = ?").append(++paramsCount);
                builder.append(" AND p.projectYear = ?").append(++paramsCount);
                isWhereAdded = true;
            }
        }

        if (letterRunStatus != null) {

            if (isWhereAdded) {
                builder.append(" AND p.statusId.id = ?").append(++paramsCount);
            } else {
                builder.append(" WHERE p.statusId.id = ?").append(++paramsCount);
                isWhereAdded = true;
            }

        }
        // apppend order by clause and WHERE clause at the end of query 
        builder.append(" AND (p.projectTypeId.id = ?").append(++paramsCount);
        builder.append(" OR p.projectTypeId.id = ?").append(++paramsCount);
        builder.append(" OR p.projectTypeId.id = ?").append(++paramsCount);
        builder.append(")ORDER BY p.createdOnDtm DESC"); 
       

        logger.log(Level.INFO, "project search query = " + builder.toString());         
          //Set positional parameters
        Query q = em.createQuery(builder.toString(), Project.class);
        paramsCount = 0;

        if (firstName != null && !firstName.trim().isEmpty()) {
            q.setParameter(++paramsCount, "%" + firstName.toUpperCase() + "%");
        }
        
        if (lastName != null && !lastName.trim().isEmpty()) {
            q.setParameter(++paramsCount, "%" + lastName.toUpperCase() + "%");
        }

        if (pracCode != null && !pracCode.trim().isEmpty()) {
            q.setParameter(++paramsCount, "%" + pracCode.toUpperCase() + "%");
        }
        
        if (svaProjectCode != null && !svaProjectCode.trim().isEmpty()) {
            q.setParameter(++paramsCount, "%" + svaProjectCode.toUpperCase() + "%");
        }

        if (letterRunYear != null && !letterRunYear.trim().isEmpty()) {
            q.setParameter(++paramsCount, letterRunYear);
        }

        if (letterRunDate != null) {
        Calendar instance = Calendar.getInstance();
        instance.setTime(letterRunDate);
        String month = String.valueOf(instance.get(Calendar.MONTH) + 1);
        String projectAuditMonth = month.length() == 1 ? "0" + month : month;
        String projectAuditYear = String.valueOf(instance.get(Calendar.YEAR));
            q.setParameter(++paramsCount, projectAuditMonth);
            q.setParameter(++paramsCount, projectAuditYear);
        }

        if (letterRunStatus != null) {
            q.setParameter(++paramsCount, letterRunStatus);
        }
        
        q.setParameter(++paramsCount, PaclConstants.RANDOM_MONTLY_AUDIT_ID);
        q.setParameter(++paramsCount, PaclConstants.SELECT_SERVICE_AUDIT_ID);
        q.setParameter(++paramsCount, PaclConstants.SELECT_SERVICE_QUESTIONS_AUDIT_ID);
 
        return q.getResultList();
    }

    /**
     * Verify the unique project constraint on project name
     * and project month/year.
     * @param project Project - project details form the screen
     *
     * @return Project project
     */
    @Override
    public Project verifyProjectExist(Project project) {
        Query query = em.createNativeQuery("select * from PROJECT p"
                + " where p.NAME = ?1 and p.PROJECT_YEAR =?2"
                + " and p.PROJECT_MONTH = ?3", Project.class);
        query.setParameter(1, project.getName());
        query.setParameter(2, project.getProjectYear());
        query.setParameter(3, project.getProjectMonth());
        return (Project) query.getSingleResult();
    }

    /**
     * Verify if project name and project month/year are unique in database.
     * @param project Project - project details form the screen
     *
     * @return boolean
     */
    @Override
    public boolean projectExist(Project project) {
        boolean isCreated = false;
        Project testProject = new Project();
        try {
            testProject = verifyProjectExist(project);
        } catch (Exception e) {
            for (Throwable t = e.getCause(); t != null; t = t.getCause()) {
                if (t.getClass().getName().equals("java.sql.SQLException")) {
                    logger.log(Level.INFO, "Cannot add record, as it violates a constraint.", e);
                    throw e;
                }
            }
        }
        if (testProject.getId() != null) {
            isCreated = true;
        }
        return isCreated;
    }

    /**
     * The same as edit, but returns the modified object.
     * 
     * @param project Project - selected project for update
     *
     * @return Project project
     */
    @Override
    public Project editWithReturn(Project project) {
        return getEntityManager().merge(project);
    }

    /**
     * Finds project instance by project id.
     * @param prjId Long - project Id
     *
     * @return Project
     */
    @Override
    public Project findProjectById(Long prjId) {
        Query query = em.createNativeQuery("select * from PROJECT pr"
                + " where pr.ID = ?1", Project.class);
        query.setParameter(1, prjId);
        return (Project) query.getSingleResult();
    }
    /**
     * Function to get all project that is close and that is due for an email reminder or for being archive
     * @param DueDate
     * @return 
     */
    @Override
    public List<Project> findAllSVAArchivedBatch(Date DueDate) {
      
        
        Query q = em.createNamedQuery("Project.findAllSVAArchivedBatch");
        q.setParameter("ArchiveDate", DueDate);
         return q.getResultList();
    }

    }