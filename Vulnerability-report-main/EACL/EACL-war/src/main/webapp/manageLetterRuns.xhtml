<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/gov30Template.xhtml">

    <ui:define name="title"><h:outputText value="#{msg.Manage_Project}" /> - <h:outputText value="#{msg.Find_Letter_Run}" /></ui:define>
    <ui:define name="body">

        <style type="text/css">
            .ui-datatable-tablewrapper {
                overflow: hidden;
            }
            .ui-chkbox.ui-chkbox-all.ui-widget {
                display: block !important;
            }
        </style>

        <f:metadata>
            <f:event type="preRenderView" listener="#{findLetterRun.resetTable()}" />
        </f:metadata>
        <h2><h:outputText value="#{msg.Manage_Letter_Run}" /> - <h:outputText value="#{msg.Find_Letter_Run}" /></h2>
        <hr/>

        <h:form id="manageProjectForm"  onsubmit="PF('projectResultW').unselectAllRows();
                #{findLetterRun.setDisplayStats(false)}" >
            <p:messages id="messages" closable="true">
                <p:autoUpdate />
            </p:messages>
            <p:panel id="contentInner">
                <f:facet name="header">#{msg.Find_Letter_Run}</f:facet>

                <div>
                    <div class="ui-g">
                        <div class="ui-g-2">
                            <p:outputLabel for="letterRunDateId" value="#{msg.letter_run_month_year_line1}:" /><br/>
                            <p:outputLabel for="letterRunDateId" indicateRequired="false" value="#{msg.project_month_year_line2}" />
                        </div>
                        <div class="ui-g-1">
                            <p:calendar value="#{findLetterRun.letterRunDate}"
                                        id="letterRunDateId" 
                                        mode="popup"
                                        navigator="true"
                                        pattern="MMM-yyyy" 
                                        maxlength="12" />
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-2">
                            <p:outputLabel for="pracLastName" value="#{msg.prac_last_name}:" />
                        </div>
                        <div class="ui-g-3">
                            <p:inputText value="#{findLetterRun.pracLastName}"
                                         size="30"
                                         id="pracLastName" 
                                         label="#{msg.prac_last_name}" 
                                         maxlength="75">
                            </p:inputText>
                        </div>
                        <div class="col-xs-2"></div>
                        <div class="ui-g-2">
                            <p:outputLabel for="pracFirstName" value="#{msg.prac_first_name}:" />
                        </div>
                        <div class="ui-g-3">
                            <p:inputText value="#{findLetterRun.pracFirstName}"
                                         size="30"
                                         id="pracFirstName" 
                                         label="#{msg.prac_first_name}" 
                                         maxlength="75">
                            </p:inputText>
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-2">
                            <p:outputLabel for="pracCodeId" value="#{msg.prac_number}:" />
                        </div>
                        <div class="ui-g-3">
                            <p:inputText value="#{findLetterRun.pracCode}"
                                         size="30" 
                                         id="pracCodeId" 
                                         label="#{msg.prac_number}" 
                                         maxlength="6">
                            </p:inputText>
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-2">
                            <p:outputLabel for="svaProjectCodeId" value="#{msg.sva_project_code}:" />
                        </div>
                        <div class="ui-g-3">
                            <p:inputText value="#{findLetterRun.svaProjectCode}"
                                         size="30" 
                                         id="svaProjectCodeId" 
                                         label="#{msg.sva_project_code}" >
                            </p:inputText>
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-2">
                            <p:outputLabel for="letterRunYear" value="#{msg.letter_run_year}:" />
                        </div>
                        <div class="ui-g-1">
                            <p:inputText value="#{findLetterRun.letterRunYear}"
                                         size="10"
                                         id="letterRunYear"
                                         label="#{msg.letter_run_year}"
                                         maxlength="4">
                            </p:inputText>
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-2">
                            <p:outputLabel for="letterRunStatuses" value="#{msg.letter_run_status}:" />
                        </div>
                        <div class="ui-g-3">
                            <h:selectOneMenu id="letterRunStatuses" style="width: 50%;" 
                                             label="#{msg.letter_run_status}" 
                                             value="#{findLetterRun.letterRunStatus}">
                                <f:selectItem itemLabel="" itemValue ="" />
                                <f:selectItems value ="#{Droplists.codesProjectStatuss}" />
                            </h:selectOneMenu>
                        </div>
                    </div>
                </div>

                <br/><br/>
                <div id="commandButtons" align="center">
                    <p:commandButton id="findProjectBtn" actionListener="#{findLetterRun.findLetterRun}" value="#{msg.Find_Letter_Run}" update="manageProjectForm" />
                </div>
                <br/>
            </p:panel>
            <br/>
            <p:panel id="projectSummary">
                <f:facet name="header">Letter Run Summary</f:facet>

                <p:dataTable value="#{findLetterRun.letterRunResults}" rowKey="#{projectsResult.id}" 
                             selection="#{findLetterRun.letterRunResultsSelected}" 
                             disabledSelection="#{projectsResult.statusId.name == 'Archived'}" 
                             var="projectsResult" rowIndexVar="index" 
                             widgetVar="projectResultW"
                             editable="true" editMode="cell" scrollHeight="150" 
                             id="resultsTable" paginator="true" rows="5"
                             paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                             rowsPerPageTemplate="5,10" >
                    <p:ajax event="rowSelectCheckbox"   global="false" process="@this" listener="#{findLetterRun.setDisplayStats(false)}" update=":manageProjectForm:buttonsId :manageProjectForm:updateStatisticalPanel" />
                    <p:ajax event="rowUnselectCheckbox" global="false" process="@this" listener="#{findLetterRun.setDisplayStats(false)}" update=":manageProjectForm:buttonsId :manageProjectForm:updateStatisticalPanel" />
                    <p:ajax event="rowSelect"           global="false" process="@this" listener="#{findLetterRun.setDisplayStats(false)}" update=":manageProjectForm:buttonsId :manageProjectForm:updateStatisticalPanel" />
                    <p:ajax event="rowUnselect"         global="false" process="@this" listener="#{findLetterRun.setDisplayStats(false)}" update=":manageProjectForm:buttonsId :manageProjectForm:updateStatisticalPanel" />

                    <p:column style="width:4%" selectionMode="Multiple" styleClass="#{projectsResult.statusId.name == 'Archived' ? 'ui-state-disabled' : ''}" /><!-- styleClass override necessary for PrimeFaces 12.0.0 bug -->

                    <p:column sortBy="#{projectsResult.name}" width="16%">
                        <f:facet name="header"><h:outputText value="#{msg['Project.name.desc']}" /></f:facet>
                        <p:commandLink id="detailsLink" ajax="false" value="#{projectsResult.name}"
                                       disabled="#{projectsResult.statusId.name == 'Archived' }"
                                       action="#{findLetterRun.showDetailsForSvaProjectAction(projectsResult)}"
                                       onmouseover="window.status = 'Click to view details'; return true;"
                                       onmouseout="window.status = ''; return true;">
                        </p:commandLink>
                    </p:column>

                    <p:column sortBy="#{projectsResult.statusId.id}">
                        <f:facet name="header"><h:outputText value="#{msg['letter_run_status']}" /></f:facet>
                        <h:outputText value="#{projectsResult.statusId.name}" />
                    </p:column>

                    <p:column sortBy="#{projectsResultYear}" width="10%">
                        <f:facet name="header"><h:outputText value="#{msg['project_year_month']}" /></f:facet>
                        <h:outputText value="#{projectsResult.projectYear}" />-<h:outputText value="#{projectsResult.projectMonth}" />
                    </p:column>

                    <p:column sortBy="#{projectsResult.createdOnDtm}">
                        <f:facet name="header"><h:outputText value="#{msg['project_creation_date']}" /></f:facet>
                        <h:outputText value="#{findLetterRun.dateFormatter(projectsResult.createdOnDtm)}" />
                    </p:column>

                    <p:column sortBy="#{projectsResultYear}" width="6%">
                        <f:facet name="header"><h:outputText value="#{msg['project_year']}" /></f:facet>
                        <h:outputText value="#{projectsResult.projectYear}" />
                    </p:column>

                    <p:column sortBy="#{projectsResult.closedDate}">
                        <f:facet name="header"><h:outputText value="#{msg['Project.closedDate.desc']}" /></f:facet>
                        <h:outputText value="#{findLetterRun.dateFormatter(projectsResult.closedDate)}" />
                    </p:column>

                    <p:column sortBy="#{projectsResult.firstPrintingDate}">
                        <f:facet name="header"><h:outputText value="#{msg['Project.firstPrintingDate.desc']}" /></f:facet>
                        <h:outputText value="#{findLetterRun.dateFormatter(projectsResult.firstPrintingDate)}" />
                    </p:column>
                    <p:ajax  event="cellEdit" 
                             listener="#{findLetterRun.onCellEdit}"
                             update ="resultsTable"
                             process="@this" 
                             global="false"
                             />
                    <p:column sortBy="#{projectsResult.auditReasonDesc}">
                        <f:facet name="header"><h:outputText value="#{msg['audit_reason']}" /></f:facet>
                        <p:cellEditor rendered="#{findLetterRun.disableAuditReason(projectsResult)}">
                            <f:facet name="output">
                                <h:outputText value="#{projectsResult.auditReasonDesc}" />
                            </f:facet>
                            <f:facet name="input">
                                <p:inputText id="modelInput" value="#{projectsResult.auditReasonDesc}" />
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                    <p:ajax event="page" global="false" />
                    <p:ajax event="sort" global="false" />
                </p:dataTable>
                <br/>
                <p:outputPanel id="buttonsId" rendered="#{findLetterRun.letterRunResultsSelected!=null}">
                    <p:commandButton actionListener="#{findLetterRun.closeLetterRun()}" value="#{msg['Close_Letter_Run']}" 
                                     update="buttonsId projectSummary confirmPopUp" disabled="#{findLetterRun.letterRunResultsSelected.isEmpty()}" />
                    <p:graphicImage height="1" alt="" value="/resources/template-images/spacer.gif" width="10" />

                    <p:commandButton value="#{msg.project_archiveRun}"
                                     id="prjArchiveId"
                                     onclick="PF('dlg').show();"  disabled="#{findLetterRun.letterRunResultsSelected.isEmpty()}"
                                     global="false">
                    </p:commandButton>
                    <p:graphicImage height="1" alt="" value="/resources/template-images/spacer.gif" width="10" />

                    <p:commandButton id="showStatisticalButtonId"
                                     actionListener="#{findLetterRun.showStatisticalReport}" 
                                     value="#{msg['button.show_statistical_rep']}" 
                                     update="updateStatisticalPanel" 
                                     disabled="#{findLetterRun.letterRunResultsSelected.isEmpty()}" />
                </p:outputPanel>

                <p:dialog id="confirmPopUp" widgetVar="dlg" width="400" height="150" 
                          modal="true" resizable="false" closable="true"
                          styleClass="hoverable" header="#{msg['project_confirm_archive_run']}">
                    <p><p:outputLabel value="#{msg.prj_archive_data_policy}" /></p>
                    <br/>
                    <table align="center">
                        <tr>
                            <td class="hoverable">
                                <p:commandButton value="Confirm" id="ConfirmBtn" process="@this"
                                                 styleClass="hoverable"
                                                 update="buttonsId projectSummary confirmPopUp"
                                                 actionListener="#{findLetterRun.archiveLetterRun()}"
                                                 onclick="PF('dlg').hide();" />
                            </td>
                            <td>
                                <p:graphicImage height="1" alt="" value="/resources/template-images/spacer.gif" width="10" />
                            </td>
                            <td class="hoverable">
                                <p:commandButton value="Cancel" id ="cancelBtn"
                                                 update="buttonsId projectSummary confirmPopUp"
                                                 styleClass="hoverable"
                                                 onclick="PF('dlg').hide();return false;" />
                            </td>
                        </tr>
                    </table>
                </p:dialog>
            </p:panel>
            <br/>

            <p:outputPanel id="updateStatisticalPanel" >
                <p:panel id="StatisticalReport" widgetVar="statsPanel" 
                         closable="true" toggleable="true" style="display: block !important" closeSpeed="0"
                         rendered="#{findLetterRun.displayStats}" visible="#{findLetterRun.displayStats}">
                    <p:ajax event="close" update="manageProjectForm" global="false" />
                    <f:facet name="header">
                        <div class="ui-g-2">
                            <h:outputText value="#{msg.project_statistical_report}" />
                        </div>
                        <div class="ui-g-1">
                            <p:commandLink id="csv2" ajax="false">
                                <p:graphicImage value="/resources/images/xls.gif" />
                                <p:fileDownload value="#{findLetterRun.reportCSVfile}" />
                            </p:commandLink>
                        </div>
                    </f:facet>
                    <p:dataTable var="findLetterRunTotal" value="#{findLetterRun}" style="display: inline-table">
                        <p:columnGroup type="header">
                            <p:row>
                                <p:column headerText="" width="19%" />
                                <p:column headerText="#{msg['Letter.mailed']}" width="9.5%" />
                                <p:column headerText="#{msg['Letter.not.delivered']}" width="13%" />
                                <p:column headerText="#{msg['Letter.delivered']}" width="11.5%" />
                                <p:column headerText="#{msg['Letter.total.returns']}" width="9.5%" />
                                <p:column headerText="#{msg['Letter.total.percentage.returns']}" width="10%" />
                                <p:column headerText="#{msg['Letter.total.anomalies']}" width="12%" />
                                <p:column headerText="#{msg['Letter.total.percentage.anomalies']}" width="12%" />
                            </p:row>
                            <p:row>
                                <p:column headerText="#{msg['Letter_run_grand_total']}" />
                                <p:column headerText="#{findLetterRun.letterMailedTotal}" />
                                <p:column headerText="#{findLetterRun.letterNotDeliverTotal}" />
                                <p:column headerText="#{findLetterRun.letterDeliverTotal}" />
                                <p:column headerText="#{findLetterRun.letterReturnsTotal}" />
                                <p:column headerText="#{findLetterRun.letterReturnsPercentageTotal}%" />
                                <p:column headerText="#{findLetterRun.letterAnomalyTotal}" />
                                <p:column headerText="#{findLetterRun.letterAnomalyPercentageTotal}%" />
                            </p:row>
                        </p:columnGroup>
                        <p:ajax event="sort" global="false" />
                    </p:dataTable>
                    <p:dataTable id="resultsTableStats" var="letterRunRecord" value="#{findLetterRun.letterRunResultsSelected}" rowKey="#{letterRunRecord.id}" scrollHeight="700" style="display: inline-table">
                        <p:columnGroup type="header">
                            <p:row>
                                <p:column style="width:32px" />
                                <p:column headerText="#{msg['Project.name.desc']}" />
                            </p:row>
                        </p:columnGroup>
                        <p:column>
                            <p:rowToggler/>
                        </p:column>
                        <p:column>
                            <h:outputText value="#{letterRunRecord.name}" />
                        </p:column>
                        <p:rowExpansion>
                            <p:dataTable var="svaProject" value="#{letterRunRecord.pracSvaProjectList}" >
                                <p:columnGroup type="header">
                                    <p:row>
                                        <p:column headerText="#{msg.Letter_run_summary_total}" width="18.5%" />
                                        <p:column headerText="#{letterRunRecord.letterMailedTotal}" width="9.5%" />
                                        <p:column headerText="#{letterRunRecord.letterNotDeliverTotal}" width="13%" />
                                        <p:column headerText="#{letterRunRecord.letterDeliverTotal}" width="11.5%" />
                                        <p:column headerText="#{letterRunRecord.letterReturnsPerProjectTotal}" width="9.5%" />
                                        <p:column headerText="#{letterRunRecord.letterReturnsPercentageTotal}%" width="10%" />
                                        <p:column headerText="#{letterRunRecord.letterAnomalyTotal}" width="12%" />
                                        <p:column headerText="#{letterRunRecord.letterAnomalyPercentageTotal}%" width="12%" />
                                    </p:row>
                                </p:columnGroup>

                                <p:column >
                                    <h:outputText value="#{svaProject.pracBllgNum}" />-<p:outputLabel value="#{svaProject.svaProjectCode}" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="#{svaProject.letterMailed}" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="#{svaProject.letterNonDelivered}" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="#{svaProject.letterDelivered}" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="#{svaProject.letterTotalReturns}" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="#{svaProject.letterTotalPercentReturns}%" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="#{svaProject.letterTotalAnomaly}" />
                                </p:column>
                                <p:column>
                                    <h:outputText value="#{svaProject.letterTotalPercentAnomaly}%" />
                                </p:column>
                                <p:ajax event="sort" global="false" />
                            </p:dataTable>
                        </p:rowExpansion>
                        <p:ajax event="sort" global="false" />
                        <p:ajax event="rowToggle" global="false" />
                    </p:dataTable>
                </p:panel>
            </p:outputPanel>
        </h:form>

    </ui:define>
</ui:composition>