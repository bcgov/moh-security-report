/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.pacl.servlet;

import ca.bc.gov.health.pacl.ejb.entity.LetterTemplate;
import ca.bc.gov.health.pacl.ejb.session.CodesLetterTemplateTypeFacadeLocal;
import ca.bc.gov.health.pacl.ejb.session.LetterTemplateFacadeLocal;
import jakarta.ejb.EJB;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * Attachment servlet class to handle uploading images/graphics locally.
 *
 * @author dan.stepanov
 */
public class AttachmentServlet extends HttpServlet {

    /**
     * EJB to handle persistence.
     */
    @EJB
    private transient LetterTemplateFacadeLocal letterTemplateFacade;
    @EJB
    private transient CodesLetterTemplateTypeFacadeLocal codesLetterTemplateTypeFacade;

    /**
     * Retrieve user uploaded image data from the HTTP session request.
     *
     * @param request HttpServletRequest - HttpServletRequest object
     * @param resp HttpServletResponse - HttpServletResponse object
     * @throws ServletException
     * @throws IOException
     *
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse resp)
            throws ServletException, IOException {
        String id = request.getParameter("id");
        String img = request.getParameter("img");
        LetterTemplate letterTemplate = letterTemplateFacade.findByLetterTemplateTypeId(codesLetterTemplateTypeFacade.find(Long.parseLong(id)));
        byte[] data;
        switch (img) {
            case "signGraphic": {
                data = (byte[]) letterTemplate.getSenderSignatureGraphic();
                break;
            }
            case "minLogo": {
                data = (byte[]) letterTemplate.getMinistryLogo();
                break;
            }
            default:
                return;
        }

        resp.setHeader("content-length", "" + data.length);
        resp.getOutputStream().write(data);
        
        resp.getOutputStream().flush();
        resp.getOutputStream().close();
    }
}
