/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package swtwar;

import ca.bc.gov.hlth.swt.session.MailBeanLocal;
import ca.bc.gov.hlth.swt.session.SystemConstantFacadeLocal;
import jakarta.annotation.PostConstruct;
import jakarta.ejb.EJB;
import jakarta.faces.application.FacesMessage;
import jakarta.faces.context.FacesContext;
import jakarta.faces.view.ViewScoped;
import jakarta.inject.Named;
import java.io.PrintWriter;
import java.io.Serializable;
import java.io.StringWriter;

@ViewScoped
@Named
public class ContactUs implements Serializable {

    private static final long serialVersionUID = 1L;

    private String name;
    private String subject;
    private String email;
    private String message;
    private static final String FROM_ADDRESS = "do-not-reply@swt.hlth.gov.bc.ca";

    @EJB
    private MailBeanLocal mailer;
    @EJB
    private SystemConstantFacadeLocal scFacade;

    @PostConstruct
    public void init() {
    }

    public ContactUs() {
    }

    public boolean hasInvalidCharacters() {
        boolean invalid = false;

        if (name.matches(".*[^a-zA-Z ].*")) {
            FacesContext.getCurrentInstance().addMessage("btnSubmit", new FacesMessage(FacesMessage.SEVERITY_ERROR, "Name: Validation Error: Please enter only letters and spaces in Name.", null));
            invalid = true;
        }
        if (!email.isEmpty() && !email.matches(".+@.+[.].+")) {
            FacesContext.getCurrentInstance().addMessage("btnSubmit", new FacesMessage(FacesMessage.SEVERITY_ERROR, "Email: Validation Error: Please enter a valid email address (example@email.address).", null));
            invalid = true;
        }
        if (subject.matches(".*[^a-zA-Z0-9 ?.,].*")) {
            FacesContext.getCurrentInstance().addMessage("btnSubmit", new FacesMessage(FacesMessage.SEVERITY_ERROR, "Subject: Validation Error: Please enter only letters, numbers, and spaces in Subject.", null));
            invalid = true;
        }
        return invalid;
    }

    public void submit() {
        if (hasInvalidCharacters()) {
            return;
        }

        try {
            mailer.sendMessage(scFacade.find("FEEDBACK_EMAIL").getConstantValueTxt(),
                    FROM_ADDRESS,
                    email, 
                    subject, 
                    message);

            clear();
            FacesContext.getCurrentInstance().addMessage("btnSubmit",
                    new FacesMessage(FacesMessage.SEVERITY_INFO,
                            "Thank you for taking the time to"
                            + " write to the Ministry of Health. "
                            + "Please be assured that your email will"
                            + " be read and reviewed as soon as possible.", null));

        } catch (Exception e) {
            if (e.getMessage() == null) {
                StringWriter sw = new StringWriter();
                e.printStackTrace(new PrintWriter(sw));
                clear();
                FacesContext.getCurrentInstance().addMessage("btnSubmit", new FacesMessage(FacesMessage.SEVERITY_ERROR, "Error!" + sw.toString(), null));
            } else {
                clear();
                FacesContext.getCurrentInstance().addMessage("btnSubmit", new FacesMessage(FacesMessage.SEVERITY_ERROR, "Error!" + e.getMessage(), null));

            }

        }
    }

    public void clear() {
        name = null;
        message = null;
        subject = null;
        email = null;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getSubject() {
        return subject;
    }

    public void setSubject(String subject) {
        this.subject = subject;
    }

}
