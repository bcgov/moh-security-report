/*******************************************************************************
 * Copyright Â© 2015, Province of British Columbia.                             *
 *                                                                             *
 * All rights reserved.                                                        *
 *                                                                             *
 * File:                        MailService.java                               *
 * Date of Last Commit: $Date::                                              $ *
 * Revision Number:      $Rev::                                              $ *
 * Last Commit by:    $Author::                                              $ *
 *                                                                             *
 *******************************************************************************/

/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.hlth.mail;

import jakarta.mail.Message;
import jakarta.mail.MessagingException;
import jakarta.mail.Session;
import jakarta.mail.Transport;
import jakarta.mail.internet.InternetAddress;
import jakarta.mail.internet.MimeMessage;
import java.io.UnsupportedEncodingException;
import java.util.Properties;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Service class for sending messages
 *
 * @author greg.perkins
 */
public class MailService {

    private static final String CONST_SMTP_SERVER = "smtp_server";
    private String smtpServer;

    private static final String CLASSNAME = MailService.class.getSimpleName();
    private static final Logger LOG = Logger.getLogger(CLASSNAME);

    /**
     * Sends a simple message with no attachments
     *
     * @param toEmailAddress String - Email address to send to
     * @param fromEmailAddress String - Email address the message will come from
     * @param fromName String - Name the message will come from
     * @param subject String - Subject Line of the message
     * @param text String - Body of the message
     *
     * @throws MessagingException
     */
    public void sendMessage(String toEmailAddress, String fromEmailAddress, String fromName, String subject, String text) throws MessagingException {
        try {
            Properties props = System.getProperties();
            props.put(CONST_SMTP_SERVER, getSmtpServer());

            Session session = Session.getDefaultInstance(props, null);

            Message msg = new MimeMessage(session);
            InternetAddress from = new InternetAddress();
            from.setAddress(fromEmailAddress);
            try {
                from.setPersonal(fromName);
            } catch (UnsupportedEncodingException ex) {
                LOG.log(Level.SEVERE, null, ex);
            }
            msg.setFrom(from);
            msg.setRecipients(Message.RecipientType.TO, InternetAddress.parse(toEmailAddress, false));
            msg.setSubject(subject);
            msg.setText(text);

            Transport tr = session.getTransport("smtp");
            tr.connect(getSmtpServer(), "", "");

            try {
                msg.saveChanges();
                tr.sendMessage(msg, msg.getAllRecipients());
            } catch (MessagingException e) {
                throw e;
            } finally {
                tr.close();
            }

        } catch (MessagingException e) {
            LOG.warning("MessagingException encountered when sending message: " + e.getMessage());
            throw e;
        }
    }

    /* Getters and Setters */
    public String getSmtpServer() {
        return smtpServer;
    }

    public void setSmtpServer(String smtpServer) {
        this.smtpServer = smtpServer;
    }
}
