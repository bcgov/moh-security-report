<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/gov30Template.xhtml">

    <ui:define name="title">Maintain Non-SPR Statistics</ui:define>
    <ui:define name="content">
        <h2>Maintain Non-SPR Statistics</h2>
        <p:messages id="msgs" />
        <h:form id="form1" enctype="multipart/form-data">
                
            <p:panel header="Bulk import from .csv file">
                <div class="ui-g">
                    <div class="ui-g-12">
                        <p:fileUpload listener="#{MaintainNonSPRStatistics.handleFileUpload}"
                                      mode="advanced"
                                      dragDropSupport="true"
                                      invalidSizeMessage="File size exceeds 150kB"
                                      label="Browse" 
                                      onstart="PF('statusDialog').show()" 
                                      oncomplete="PF('statusDialog').hide(); return false;"
                                      uploadLabel="Import"
                                      update="@form" 
                                      sizeLimit="150000" 
                                      fileLimit="1"
                                      id="fileUpload"
                                      allowTypes="/(\.|\/)(csv)$/"/>
                    </div>
                </div>
            </p:panel>
            
            <p:panel header="Manual management">
                <div class="ui-g">
                    <div class="ui-g-12">
                        <p:outputLabel for="rollupProcedureGroupId" value="Non-SPR Procedure"/>
                        <h:selectOneMenu id="rollupProcedureGroupId" 
                                         value="#{MaintainNonSPRStatistics.stat.rollupProcedureGroupId.rollupProcedureGroupId}" 
                                         label="Non-SPR Procedure" 
                                         immediate="true" 
                                         valueChangeListener="#{MaintainNonSPRStatistics.procedureChanged}">
                            <f:convertNumber />
                            <f:selectItem itemLabel="" itemValue="0" />
                            <f:selectItems value="#{MaintainNonSPRStatistics.procedures}" />
                            <p:ajax event="change" process="@this" update="form1" />
                        </h:selectOneMenu>                                    
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-12">
                        <p:outputLabel for="theProcedure" value="Reporting Period" />
                        <h:selectOneMenu id="theProcedure" 
                                         value="#{MaintainNonSPRStatistics.selectedDataEntryId}" 
                                         label="Last Revised Date"
                                         disabled="#{MaintainNonSPRStatistics.dates.size() == 0}">
                            <f:selectItem itemLabel="" itemValue="#{null}"/>
                            <f:selectItems value="#{MaintainNonSPRStatistics.dates}"/>
                            <p:ajax event="change" process="@this" listener="#{MaintainNonSPRStatistics.dateChanged}" update="form1"/>
                        </h:selectOneMenu> 
                        <p:commandLink disabled="#{MaintainNonSPRStatistics.stat.rollupProcedureGroupId.rollupProcedureGroupId == null ||
                                                   MaintainNonSPRStatistics.stat.rollupProcedureGroupId.rollupProcedureGroupId == 0}" 
                                       onclick="PF('dates1').show();">
                            New Reporting Period
                        </p:commandLink>
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-12">
                        <p:outputLabel for="siteApproved" value="Data entry complete?" style="margin-right: 1em;"/>
                        <p:selectBooleanCheckbox id="siteApproved"
                                                 value="#{MaintainNonSPRStatistics.siteApproved}" 
                                                 valueChangeListener="#{MaintainNonSPRStatistics.dataEntryCompleteChanged}"/><br/>
                        You must check Data Entry Complete and click Save to ensure the statistics entered are included in the next Draft site
                    </div>
                </div>
                
                
                <p:growl id="messages" showDetail="true" sticky="true"/>
                <div class="ui-g">
                    <div class="ui-g-12 submit-buttons">
                        <p:commandButton value="Save" 
                                         action="#{MaintainNonSPRStatistics.save}" 
                                         update="form1"
                                         disabled="#{MaintainNonSPRStatistics.stat.rollupProcedureGroupId.rollupProcedureGroupId == null ||
                                                     MaintainNonSPRStatistics.stat.rollupProcedureGroupId.rollupProcedureGroupId == 0 ||
                                                     MaintainNonSPRStatistics.selectedDataEntryId == null || 
                                                     MaintainNonSPRStatistics.selectedDataEntryId == 0}" />
                    </div>
                </div>
                
                <hr />

                <p:remoteCommand name="onRowCancel" action="#{MaintainNonSPRStatistics.onRowCancel}" update="theTable" />
                <p:remoteCommand name="onUpdateTable" update="theTable msgs" />
                <p:dataTable id="theTable" value="#{MaintainNonSPRStatistics.statistics}" 
                             editable="true" widgetVar="theTable" var="currentRow" rows="10"
                             paginator="true" paginatorPosition="top"
                             paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink}">
                    <f:facet name="header" >
                        <h:outputText value="Maintain Non-SPR Statistics"/>   
                    </f:facet>

                    <p:ajax event="rowEdit" 
                            listener="#{MaintainNonSPRStatistics.onRowEdit}" 
                            oncomplete="onUpdateTable()" process="@this" global="false"  />
                    <p:ajax event="rowEditCancel" 
                            onstart="return confirm('#{msg.all_confirmUndo}')" 
                            oncomplete="onRowCancel()" process="@this" global="false"
                            />

                    <p:column headerText="Facility" sortBy="#{currentRow.rollupFacilityId.facilityNm}">
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{currentRow.rollupFacilityId.facilityNm}"/>
                                <h:outputText value="British Columbia" rendered="#{currentRow.rollupFacilityId == null}" />
                            </f:facet>
                            <f:facet name="input">
                                <h:selectOneMenu value="#{currentRow.rollupFacilityId}" label="Facility" converter="facilityConverter">
                                    <f:selectItem itemLabel="British Columbia" itemValue="" noSelectionOption="true"/>
                                    <f:selectItems value="#{MaintainNonSPRStatistics.facilities}"  var="f" itemValue="#{f}" itemLabel="#{f.facilityNm}" />
                                </h:selectOneMenu>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>                            
                    <p:column headerText="Specialist" sortBy="#{currentRow.rollupSurgeonId.surgeonLastNm}">
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{currentRow.rollupSurgeonId.displayTxt}" />
                            </f:facet>
                            <f:facet name="input">
                                <h:selectOneMenu value="#{currentRow.rollupSurgeonId}" label="Specialist" converter="surgeonConverter">
                                    <f:selectItem itemLabel="" itemValue="" noSelectionOption="true"/>
                                    <f:selectItems value="#{MaintainNonSPRStatistics.specialists}" var="s" itemValue="#{s}" itemLabel="#{s.displayTxt}" />
                                </h:selectOneMenu>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                    <p:column headerText="Priority" sortBy="#{currentRow.rollupPriorityId.priorityDsc}">
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{currentRow.rollupPriorityId.priorityDsc}" />
                            </f:facet>
                            <f:facet name="input">
                                <h:selectOneMenu value="#{currentRow.rollupPriorityId}" label="Priority" converter="priorityConverter">
                                    <f:selectItem itemLabel="" itemValue="" noSelectionOption="true"/>
                                    <f:selectItems value="#{MaintainNonSPRStatistics.priorities}" var="p" itemValue="#{p}" itemLabel="#{p.priorityDsc}" />
                                </h:selectOneMenu>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>                            
                    <p:column headerText="Patients Waiting" sortBy="#{currentRow.patientsWaitingNbr}" style="text-align: right;">   
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{currentRow.patientsWaitingNbr}" />
                            </f:facet>
                            <f:facet name="input">
                                <h:inputText value="#{currentRow.patientsWaitingNbr}" 
                                             size="3" label="Patients Waiting" maxlength="10" 
                                             required="#{!MaintainNonSPRStatistics.hipFracture}"
                                             requiredMessage="Patients Waiting Number is Required">
                                    <f:validateLongRange minimum="0" maximum="9999"/>
                                </h:inputText>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                    <p:column headerText="Procedures Completed" sortBy="#{currentRow.proceduresPerformedNbr}" style="text-align: right;">   
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{currentRow.proceduresPerformedNbr}" />
                            </f:facet>
                            <f:facet name="input">
                                <p:inputText value="#{currentRow.proceduresPerformedNbr}" 
                                             size="3" label="Procedures Completed" maxlength="10" required="true"
                                             requiredMessage="Procedures Completed Number is Required">
                                    <f:validateLongRange minimum="0" maximum="9999"/>
                                </p:inputText>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                    <p:column headerText="50% Received Services" sortBy="#{currentRow.fiftyPctWeeksNbr}" style="text-align: right;">   
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{currentRow.fiftyPctWeeksNbr}" />
                            </f:facet>
                            <f:facet name="input">
                                <h:inputText value="#{currentRow.fiftyPctWeeksNbr}" size="3" 
                                             label="50% Received Services Within (weeks)" 
                                             maxlength="10" id='fifty'>
                                    <f:validateDoubleRange minimum="0" maximum="999.9"/>
                                </h:inputText>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                    <p:column headerText="90% Received Services" sortBy="#{currentRow.ninetyPctWeeksNbr}" style="text-align: right;">   
                        <p:cellEditor>
                            <f:facet name="output">
                                <h:outputText value="#{currentRow.ninetyPctWeeksNbr}" />
                            </f:facet>
                            <f:facet name="input">
                                <h:inputText value="#{currentRow.ninetyPctWeeksNbr}" size="3" 
                                             label="90% Received Services Within (weeks)" 
                                             maxlength="10" id='ninety'>
                                    <f:validateDoubleRange minimum="0" maximum="999.9"/>
                                </h:inputText>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>
                    <p:column width="5%" rendered="#{MaintainNonSPRStatistics.stat.approvedForSiteYn!='Y'}">
                        <p:rowEditor styleClass="non-spr-statistics-row-editor" />
                        <p:commandLink update="theTable, msgs" ajax="true"
                                       action="#{MaintainNonSPRStatistics.onRowRemove(currentRow)}"
                                       onstart="return confirm('#{msg.all_confirmDelete}')">
                            <i class="pi pi-trash"></i>
                        </p:commandLink>
                    </p:column>
                </p:dataTable>
                <p:commandButton value="New" 
                                 icon="ui-icon-plusthick" 
                                 update="@form"
                                 action="#{MaintainNonSPRStatistics.onAddNew}" 
                                 oncomplete="clickNewRow()" 
                                 rendered="#{MaintainNonSPRStatistics.stat.approvedForSiteYn=='N'}" />
            </p:panel>
        </h:form>

        <p:dialog header="New Reporting Period" widgetVar="dates1" width="500" height="300">
            <f:facet name="header">
                <h:outputText value="New Reporting Period" />
            </f:facet>
            <f:facet name="controls">
                <h:graphicImage library="images" name="close.png" style="cursor:pointer; padding-top:3px; padding-right:3px;" onclick="PF('dates1').hide();" alt="Close this window"/>
            </f:facet>
            <h:form id="form2">
                <div class="ui-g">
                    <div class="ui-g-12">
                        <p:outputLabel for="patientsWaitingAsOf" value="Patients Waiting As Of" />
                        <p:calendar id="patientsWaitingAsOf"
                                    pattern="dd-MMM-yyyy" 
                                    value="#{MaintainNonSPRStatistics.patientsWaitingAsOf}" 
                                    size="13" />
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-12">
                        <p:outputLabel for="proceduresCompletedFrom" value="Procedures Completed From" />
                        <p:calendar id="proceduresCompletedFrom"
                                    pattern="dd-MMM-yyyy" 
                                    value="#{MaintainNonSPRStatistics.proceduresCompletedFrom}" 
                                    size="13" />
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-12">
                        <p:outputLabel for="proceduresCompletedTo" value="Procedures Completed To" />
                        <p:calendar id="proceduresCompletedTo"
                                    pattern="dd-MMM-yyyy" 
                                    value="#{MaintainNonSPRStatistics.proceduresCompletedTo}" 
                                    size="13" />
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-12 submit-buttons">
                        <p:commandButton action="#{MaintainNonSPRStatistics.saveNewReportingPeriod}" 
                                         update="msgs,form1,form2" 
                                         oncomplete="PF('dates1')}.hide();" 
                                         value="Save" />
                    </div>
                </div>
            </h:form>
        </p:dialog>


        <script language="javascript">
            function testPercentiles() {
                //if (document.getElementById('form1:fifty').value=='' || document.getElementById('form1:ninety').value==''){
                //    return confirm('You have not entered percentile data. Are you sure you wish to save?');
                //}else{
                return true;
                //}
            }
            function canEditRow(inEditMode, finishEditMsg, confirmMsg, deletable) {
                if (inEditMode) {
                    alert(finishEditMsg);
                    return false;
                } else if (confirmMsg != null) {
                    if (deletable == false) {
                        alert(confirmMsg);
                        return false;
                    }
                    return confirm(confirmMsg);
                } else {
                    return true;
                }
            }
        </script>
    </ui:define>
</ui:composition>
