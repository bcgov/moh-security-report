/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.hamis.session;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.List;
import org.junit.Before;
import org.junit.Test;

/**
 * Unit tests for the Standard Extract File Facade
 *
 * @author greg.perkins
 */
public class StandardExtractFileFacadeTest extends AbstractFacadeTest {

  protected static StandardExtractFileFacade sefFacade;

  @Before
  public void setUp() {
    sefFacade = new StandardExtractFileFacade();
    sefFacade.setEntityManager(entityManager);
  }

  @Test
  public void testBadFileImport() throws IOException {
    byte[] testData = readStream(this.getClass().getResourceAsStream("/sefFiles/wronglength.txt"));
    List<String> errors = new ArrayList<>();
    sefFacade.parseFile(testData, errors);
    assert (!errors.isEmpty());
  }

  @Test
  public void testGoodFileImport() throws IOException {
    byte[] testData = readStream(this.getClass().getResourceAsStream("/sefFiles/clean.txt"));
    List<String> errors = new ArrayList<>();
    sefFacade.parseFile(testData, errors);
    assert (errors.isEmpty());
  }

  private byte[] readStream(InputStream is) throws IOException {
    ByteArrayOutputStream baos = new ByteArrayOutputStream();
    byte[] buff = new byte[4096];
    int len = is.read(buff);
    while (len > 0) {
      baos.write(buff, 0, len);
      len = is.read(buff);
    }
    return baos.toByteArray();
  }
}
