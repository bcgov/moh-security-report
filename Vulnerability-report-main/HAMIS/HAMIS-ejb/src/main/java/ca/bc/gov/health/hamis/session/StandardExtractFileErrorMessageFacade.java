/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.hamis.session;

import ca.bc.gov.health.hamis.dto.SefErrorMessageDto;
import ca.bc.gov.health.hamis.entity.SefErrorMessage;
import ca.bc.gov.health.hamis.service.IStandardExtractFileErrorMessageFacade;
import jakarta.ejb.Stateless;
import jakarta.persistence.Query;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

/**
 * Facade class for SEF error messages
 *
 * @author greg.perkins
 */
@Stateless
public class StandardExtractFileErrorMessageFacade extends AbstractFacade<SefErrorMessage>
    implements IStandardExtractFileErrorMessageFacade {

  private static final Logger LOGGER =
      LogManager.getLogger(StandardExtractFileErrorMessageFacade.class);

  /** no-arg constructor */
  public StandardExtractFileErrorMessageFacade() {
    super(SefErrorMessage.class);
  }

  /**
   * Returns a list of SefErrorMessage records for a given sefId
   *
   * @param sefId
   * @return
   */
  @Override
  public List<SefErrorMessageDto> getErrorsForFile(int sefId) {
    LOGGER.debug("getErrorsForFile");
    String querySql =
        "SELECT LINE_NO, MESSAGE FROM SEF_ERROR_MESSAGES WHERE SEEM_SF_ID = ? AND SEEM_TYPE_CD <> 'WARNG' ORDER BY LINE_NO";
    List<SefErrorMessageDto> out = new ArrayList<>();
    Query query = getEntityManager().createNativeQuery(querySql);
    query.setParameter(1, sefId);
    long startTime = System.currentTimeMillis();
    @SuppressWarnings("unchecked")
    List<Object[]> results = query.getResultList();
    long duration = System.currentTimeMillis() - startTime;
    LOGGER.debug("Query executed in " + duration + "ms");
    for (Object[] row : results) {
      SefErrorMessageDto error = new SefErrorMessageDto();
      if (row[0] != null) {
        error.setLineNo(((BigDecimal) row[0]).intValue());
      }
      error.setMessage((String) row[1]);
      out.add(error);
    }
    return out;
  }
}
