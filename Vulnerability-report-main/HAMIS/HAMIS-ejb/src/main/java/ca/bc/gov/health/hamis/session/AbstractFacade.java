/*
 * *********************************************************************************************************************
 *  Copyright (c) 2019, Ministry of Health, BC.                                                                        *
 *                                                                                                                     *
 *  All rights reserved.                                                                                               *
 *    This information contained herein may not be used in whole                                                       *
 *    or in part without the express written consent of the                                                            *
 *    Government of British Columbia, Canada.                                                                          *
 *                                                                                                                     *
 *  Revision Control Information                                                                                       *
 *  File:                $Id:: AbstractFacade.java 1201 2018-01-25 23:59:00Z ahoplock                                $ *
 *  Date of Last Commit: $Date:: 2018-01-25 15:59:00 -0800 (Thu, 25 Jan 2018)                                        $ *
 *  Revision Number:     $Rev:: 1201                                                                                 $ *
 *  Last Commit by:      $Author:: ahoplock                                                                          $ *
 *                                                                                                                     *
 * *********************************************************************************************************************
 */
package ca.bc.gov.health.hamis.session;

import jakarta.persistence.Entity;
import jakarta.persistence.EntityManager;
import jakarta.persistence.Id;
import jakarta.persistence.PersistenceContext;
import jakarta.persistence.Query;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;
import lombok.Getter;
import lombok.Setter;

public abstract class AbstractFacade<T> implements SearchableFacadeLocal {

  private Class<T> entityClass;

  public AbstractFacade(Class<T> entityClass) {
    this.entityClass = entityClass;
  }

  @Getter
  @Setter
  @PersistenceContext(unitName = "hamis_pu")
  protected EntityManager entityManager;

  public void create(T entity) {
    getEntityManager().persist(entity);
  }

  public void edit(T entity) {
    getEntityManager().merge(entity);
  }

  public void remove(T entity) {
    getEntityManager().remove(getEntityManager().merge(entity));
  }

  public T find(Object id) {
    return getEntityManager().find(entityClass, id);
  }

  public List<T> findAll() {
    jakarta.persistence.criteria.CriteriaQuery cq =
        getEntityManager().getCriteriaBuilder().createQuery();
    cq.select(cq.from(entityClass));
    return getEntityManager().createQuery(cq).getResultList();
  }

  public List<T> findRange(int[] range) {
    jakarta.persistence.criteria.CriteriaQuery cq =
        getEntityManager().getCriteriaBuilder().createQuery();
    cq.select(cq.from(entityClass));
    jakarta.persistence.Query q = getEntityManager().createQuery(cq);
    q.setMaxResults(range[1] - range[0] + 1);
    q.setFirstResult(range[0]);
    return q.getResultList();
  }

  public int count() {
    jakarta.persistence.criteria.CriteriaQuery cq =
        getEntityManager().getCriteriaBuilder().createQuery();
    jakarta.persistence.criteria.Root<T> rt = cq.from(entityClass);
    cq.select(getEntityManager().getCriteriaBuilder().count(rt));
    jakarta.persistence.Query q = getEntityManager().createQuery(cq);
    return ((Long) q.getSingleResult()).intValue();
  }

  @Override
  public <T> List<T> search(T entity) {
    try {
      EntityManager em = getEntityManager();
      Class clazz = entity.getClass();
      List<String> cols = new ArrayList<>();
      List<Object> values = new ArrayList<>();
      Field[] fields = clazz.getDeclaredFields();
      for (Field field : fields) {
        try {
          String fieldName = field.getName();
          Method m =
              clazz.getMethod(
                  "get"
                      + field.getName().substring(0, 1).toUpperCase()
                      + field.getName().substring(1),
                  new Class[0]);
          Object value = m.invoke(entity, new Object[0]);
          if (value != null && value.getClass().getAnnotation(Entity.class) != null) {
            Field[] subFields = value.getClass().getDeclaredFields();
            for (Field field1 : subFields) {
              if (field1.getAnnotation(Id.class) != null) {
                fieldName += "." + field1.getName();
                m =
                    value
                        .getClass()
                        .getMethod(
                            "get"
                                + field1.getName().substring(0, 1).toUpperCase()
                                + field1.getName().substring(1),
                            new Class[0]);
                break;
              }
            }
            value = m.invoke(value, new Object[0]);
          }
          if (value != null && !((value instanceof String) && ((String) value).isEmpty())) {
            cols.add(fieldName);
            values.add(value);
          }

        } catch (Exception e) {
          // ignore
        }
      }
      StringBuilder buff = new StringBuilder();
      buff.append("select o from " + clazz.getSimpleName() + " o ");
      for (int i = 0; i < values.size(); i++) {
        String col = cols.get(i);
        if (i == 0) {
          buff.append("where ");
        } else {
          buff.append(" and ");
        }
        if (values.get(i).toString().contains("%")) {
          buff.append("o." + col + " like ?" + (i + 1));
        } else {
          buff.append("o." + col + "=?" + (i + 1));
        }
      }
      buff.append(" " + getOrderByClause());
      Query q = em.createQuery(buff.toString(), clazz);
      for (int i = 0; i < values.size(); i++) {
        Object object = values.get(i);
        q.setParameter(i + 1, object);
      }
      return q.getResultList();
    } catch (Exception e) {
      return null;
    }
  }

  protected String getOrderByClause() {
    return "";
  }
}
