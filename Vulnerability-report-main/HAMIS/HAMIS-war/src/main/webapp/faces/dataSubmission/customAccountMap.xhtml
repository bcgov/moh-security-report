<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
                xmlns:ui="http://java.sun.com/jsf/facelets" 
                xmlns:h="http://java.sun.com/jsf/html" 
                xmlns:f="http://java.sun.com/jsf/core" 
                xmlns:p="http://primefaces.org/ui" 
                template="/WEB-INF/templates/gov30Template.xhtml">

    <ui:define name="title">
        <h:outputFormat value="#{CustomAccountMapBean.create?msg['caMap.add.title']:msg['caMap.update.title']}" />
    </ui:define>

    <ui:define name="content">

        <ui:include src="/WEB-INF/fragments/navTabs/dataSubmissionTabs.xhtml" />

        <p:messages closable="true">
            <p:autoUpdate />
        </p:messages>

        <h:form id="form">
            <h1><h:outputText value="#{CustomAccountMapBean.create?msg['caMap.add.title']:msg['caMap.update.title']}" /></h1>
            <div class="ui-g">
                <div class="ui-g-3">
                    <p:outputLabel for="name" value="#{msg['sefMap.label.name']}" indicateRequired="true" />
                    <p:inputText id="name" value="#{CustomAccountMapBean.customAccountGroup.name}" required="true" />
                </div>
            </div>
            <div class="ui-g">
                <div class="ui-g-3">
                    <p:outputLabel for="fiscalYear" value="#{msg['sefMap.label.fiscalYear']}" styleClass="disabled" />
                    <p:inputText id="fiscalYear" value="#{CustomAccountMapBean.customAccountGroup.fiscalYear.fiscalYear}" disabled="true" style="pointer-events: all" title="#{CustomAccountMapBean.customAccountGroup.fiscalYear.fiscalYear}" />
                </div>
            </div>
            <div class="ui-g">
                <div class="ui-g-3">
                    <p:outputLabel for="valid" value="#{msg['caMap.label.valid']}" styleClass="disabled" />
                    <p:selectOneRadio id="valid" value="#{CustomAccountMapBean.valid}" disabled="true">
                        <f:selectItem itemLabel="Yes" itemValue="#{true}" id="validYes" />
                        <f:selectItem itemLabel="No" itemValue="#{false}" id="validNo" />
                    </p:selectOneRadio>
                </div>
            </div>
            <div class="ui-g">
                <div class="ui-g-3">
                    <p:outputLabel for="lastModified" value="#{msg['sefMap.label.lastModified']}" styleClass="disabled" />
                    <p:calendar id="lastModified" value="#{CustomAccountMapBean.customAccountGroup.dateModified}" disabled="true">
                        <f:convertDateTime pattern="MMM d, YYYY @ h:mm a" timeZone="PST" type="both" />
                    </p:calendar>
                </div>
            </div>
            <div class="ui-g">
                <p:commandButton id="addUpdate" value="#{CustomAccountMapBean.create?msg['sefMap.button.create']:msg['sefMap.button.update']}" action="#{CustomAccountMapBean.saveCustomAccountMap()}" update="form export mappings" />
                <p:commandButton id="cancel" value="#{msg['sefMap.button.cancel']}" styleClass="secondary" onclick="window.location = 'maintainMappings.xhtml';" process="@this" rendered="#{CustomAccountMapBean.create}" />
                <p:commandButton id="duplicate" value="#{msg['sefMap.button.duplicate']}" onclick="PF('duplicateDialogWidget').show();" rendered="#{!CustomAccountMapBean.create}" process="@this" />
                <p:commandButton id="delete" value="#{msg['sefMap.button.delete']}" styleClass="red" onclick="PF('deleteDialogWidget').show();" rendered="#{!CustomAccountMapBean.create}" />
            </div>
        </h:form>

        <p:dialog id="deleteDialog" width="650" closable="false" modal="true" resizable="false" visible="false" widgetVar="deleteDialogWidget" header="#{msg['caMap.delete.title']}">
            #{msg['caMap.delete.desc']}
            <h:form id="deleteForm">
                <p:commandButton id="delete" value="#{msg['sefMap.button.delete']}" styleClass="red" action="#{CustomAccountMapBean.deleteCustomAccountMap()}" ajax="false" />
                <p:commandButton id="cancel" value="#{msg['sefMap.button.cancel']}" styleClass="secondary" oncomplete="PF('deleteDialogWidget').hide();" process="@this" />
            </h:form>
        </p:dialog>

        <p:dialog id="duplicateDialog" width="650" closable="false" modal="true" resizable="false" visible="false" widgetVar="duplicateDialogWidget" header="#{msg['caMap.duplicate.title']}">
            <div class="dialogMessage">
                #{msg['caMap.duplicate.desc']}
            </div>
            <h:form id="duplicateForm">
                <p:messages id="duplicateMessages" closable="true" />
                <div class="ui-g">
                    <div class="ui-g-8">
                        <p:outputLabel for="name" indicateRequired="true" value="#{msg['sefMap.label.name']}" />
                        <p:inputText id="name" value="#{CustomAccountMapBean.duplicateName}" required="true" />
                    </div>
                </div>
                <p:commandButton id="duplicate" value="#{msg['sefMap.button.duplicate']}" action="#{CustomAccountMapBean.duplicateCustomAccountMap()}" update="duplicateMessages" />
                <p:commandButton id="cancel" value="#{msg['sefMap.button.cancel']}" styleClass="secondary" oncomplete="PF('duplicateDialogWidget').hide();" process="@this" />
            </h:form>
        </p:dialog>

        <p:panel id="export">
            <h2>
                <h:outputText value="#{msg['sefMap.header.export']}" />
            </h2>
            <h:form id="exportForm">
                <p:commandButton id="exportPdf" value="#{msg['sefMap.button.pdf']}" disabled="#{CustomAccountMapBean.create}" ajax="false" process="mappingForm exportForm">
                    <p:dataExporter 
                        exporter="#{CustomAccountMapBean.pdfExporter}"
                        type="pdf"
                        target="mappingForm:rulesTable" 
                        fileName="#{CustomAccountMapBean.customAccountGroup.name}-#{CustomAccountMapBean.customAccountGroup.fiscalYear.fiscalYear}-CustomAccountMap"
                        options="#{CustomAccountMapBean.pdfOptions}" />
                </p:commandButton>
                <p:commandButton id="exportCsv" value="#{msg['sefMap.button.csv']}" disabled="#{CustomAccountMapBean.create}" ajax="false" process="mappingForm exportForm">
                    <p:dataExporter type="csv" target="mappingForm:rulesTable" fileName="#{CustomAccountMapBean.customAccountGroup.name}-#{CustomAccountMapBean.customAccountGroup.fiscalYear.fiscalYear}-CustomAccountMap" />
                </p:commandButton>
            </h:form>
        </p:panel>

        <p:panel id="mappings">
            <h2>
                <h:outputText value="#{msg['sefMap.header.mappingRules']}" />
            </h2>
            <h:form id="mappingForm">
                <p:commandButton value="#{msg['sefMap.button.createMappingRule']}" action="#{CustomAccountMapBean.clearAccount()}" update="accountDialog" oncomplete="PF('accountDialogWidget').show();" disabled="#{CustomAccountMapBean.create}" />
                <p:dataTable id="rulesTable" value="#{CustomAccountMapBean.customAccountGroup.customAccounts}" var="row" rowKey="#{row.caId}"
                             widgetVar="rulesTableWidget" filteredValue="#{CustomAccountMapBean.filteredCustomAccounts}"
                             paginator="true" paginatorAlwaysVisible="true" rows="50" paginatorPosition="top"
                             currentPageReportTemplate="{startRecord} - {endRecord} of {totalRecords}" 
                             paginatorTemplate="{CurrentPageReport} {PreviousPageLink} {NextPageLink}"
                             selection="#{CustomAccountMapBean.selectedAccount}" selectionMode="single"
                             styleClass="filtered-paginator">
                    <p:ajax event="rowSelect" update="accountDialog" process="mappingForm" oncomplete="PF('accountDialogWidget').show();" listener="#{CustomAccountMapBean.selectRow}" />
                    <f:facet name="header">
                        <p:outputPanel>
                            <!-- Regarding "display:none". The PrimeFaces dataExporter uses the first outputText in the header facet as a column header, but we don't want to display it on the page. -->
                            <h:outputText value="#{msg['caMap.label.exporter.caption']}" style="display: none" />
                            <h:outputText value="#{msg['sefMap.label.filterRules']}" /> <h:outputText styleClass="smallGrey" value=" #{msg['caMap.label.filterRulesExtra']}" /><br/>
                            <p:inputText type="search" id="globalFilter" disabled="#{CustomAccountMapBean.create}" />
                            <p:commandButton id="filter" onclick="PF('rulesTableWidget').filter()" value="#{msg['sefMap.button.search']}" disabled="#{CustomAccountMapBean.create}" />
                            <p:defaultCommand target="filter" />
                        </p:outputPanel>
                    </f:facet>
                    <f:facet name="footer">
                        <p:outputPanel>
                            <!-- Regarding "display:none". The PrimeFaces dataExporter uses the first outputText in the header facet as a column header, but we don't want to display it on the page. -->
                            <h:outputText value="#{msg['caMap.label.exporter.caption']}" style="display: none" />
                        </p:outputPanel>
                    </f:facet>
                    <p:column filterBy="#{row.generalLedgerAcctNumber}" width="12%" filterable="true" filterStyle="display:none" sortBy="#{row.generalLedgerAcctNumber}" headerText="#{msg['caMap.label.glAccount']}"><h:outputText value="#{row.generalLedgerAcctNumber}" /></p:column>
                    <p:column filterBy="#{row.acctNumber}" width="12%" filterable="true" filterStyle="display:none" sortBy="#{row.acctNumber}" headerText="#{msg['caMap.label.misAccount']}"><h:outputText value="#{row.acctNumber}" /></p:column>
                    <p:column filterBy="#{row.acctName}" filterable="true" filterStyle="display:none" sortBy="#{row.acctName}" headerText="#{msg['caMap.label.accountName']}"><h:outputText value="#{row.acctName}" /></p:column>
                    <p:column sortBy="#{row.ignoreFlag}" width="12%" headerText="#{msg['caMap.label.ignore']}"><h:outputText value="#{row.ignoreFlag}" /></p:column>
                    <p:column sortBy="#{row.toggleSignFlag}" width="12%" headerText="#{msg['caMap.label.toggle']}"><h:outputText value="#{row.toggleSignFlag}" /></p:column>
                    <p:column sortBy="#{row.valid}" width="12%" headerText="#{msg['caMap.label.valid']}"><h:outputText value="#{row.valid}" /></p:column>
                    <p:column sortBy="#{row.caType}" width="17%" headerText="#{msg['caMap.label.accountType']}"><h:outputText value="#{DroplistBean.decode(DroplistBean.accountTypes,row.fsDataType)}" /></p:column>
                </p:dataTable>
            </h:form>
        </p:panel>

        <p:dialog id="accountDialog" blockScroll="true" width="650" closable="false" modal="true" resizable="false" visible="false" widgetVar="accountDialogWidget" header="#{!CustomAccountMapBean.createAccount?msg['sefMap.button.update']:msg['sefMap.button.add']} #{msg['caMap.label.rule']}">
            <h:form id="accountForm">
                <div id="accountDialogScroll" class="dialogueScroll">
                    <p:messages id="accountMessages" closable="true" />
                    <div class="ui-g">
                        <div class="ui-g-8">
                            <p:outputLabel for="accountType" indicateRequired="true" value="#{msg['caMap.label.accountType']}" />
                            <h:selectOneMenu id="accountType" value="#{CustomAccountMapBean.selectedAccount.fsDataType}">
                                <f:selectItems value="#{DroplistBean.accountTypes}" />
                                <p:ajax event="change" listener="#{CustomAccountMapBean.onChangeAccountType}" process="@this" update="accountType misAccount toggle toggleLabel" />
                            </h:selectOneMenu>
                        </div>
                        <div class="ui-g-3">
                            <p:outputLabel for="ignore" indicateRequired="true" value="#{msg['caMap.label.ignore']}" />
                            <p:selectOneRadio id="ignore" value="#{CustomAccountMapBean.selectedAccount.ignoreFlag}" required="true">
                                <f:selectItem itemLabel="Yes" itemValue="Y" id="ignoreYes" />
                                <f:selectItem itemLabel="No" itemValue="N" id="ignoreNo" />
                            </p:selectOneRadio>
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-8">
                            <p:outputLabel for="glAccount" indicateRequired="true" value="#{msg['caMap.label.glAccount']}" />
                            <p:inputText id="glAccount" value="#{CustomAccountMapBean.selectedAccount.generalLedgerAcctNumber}" required="true" />
                        </div>
                        <div class="ui-g-3">
                            <p:outputLabel id="toggleLabel" for="toggle" indicateRequired="#{CustomAccountMapBean.selectedAccount.fsDataType!='S'}" value="#{msg['caMap.label.toggle']}" />
                            <p:selectOneRadio id="toggle" value="#{CustomAccountMapBean.selectedAccount.toggleSignFlag}" required="#{CustomAccountMapBean.selectedAccount.fsDataType!='S'}">
                                <f:selectItem itemLabel="Yes" itemValue="Y" id="toggleYes" />
                                <f:selectItem itemLabel="No" itemValue="N" id="toggleNo" />
                            </p:selectOneRadio>
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-8">
                            <p:outputLabel for="misAccount" indicateRequired="true" value="#{msg['caMap.label.misAccount']}" />
                            <p:autoComplete dropdown="true" id="misAccount" required="true" value="#{CustomAccountMapBean.selectedAccount.miscoaAccount}" var="item" itemLabel="#{item.toString()}" itemValue="#{item}" completeMethod="#{CustomAccountMapBean.autocompleteMisAccount}" converter="#{CustomAccountMapBean.accountConverter}" size="75" scrollHeight="200" onclick="this.select()" onfocus="showAccount();" onblur="hideAccount();">
                                <p:ajax event="itemSelect" listener="#{CustomAccountMapBean.onAutoComplete}" process="@this" />
                                <p:ajax event="query" oncomplete="selectAutoComplete('accountForm', 'misAccount');" />
                            </p:autoComplete>
                            <a id="clearAccount" class="clearButton" onclick="clearAccount();">x</a>
                        </div>
                        <div class="ui-g-3">
                            <p:outputLabel for="valid" indicateRequired="false" value="#{msg['caMap.label.valid']}" styleClass="disabled" />
                            <p:selectOneRadio id="valid" value="#{CustomAccountMapBean.selectedAccount.valid}" disabled="true">
                                <f:selectItem itemLabel="Yes" itemValue="Y" id="validYes" />
                                <f:selectItem itemLabel="No" itemValue="N" id="validNo" />
                            </p:selectOneRadio>
                        </div>
                    </div> 
                    <p:commandButton id="accountSave" value="#{!CustomAccountMapBean.createAccount?msg['sefMap.button.update']:msg['sefMap.button.add']}" action="#{CustomAccountMapBean.saveAccount()}" update="accountForm mappingForm accountMessages" process="accountForm" oncomplete="if (!args.validationFailed){PF('accountDialogWidget').hide();}else{document.getElementById('accountDialogScroll').scrollTop=0;}" /> 
                    <p:commandButton id="accountDelete" value="#{msg['sefMap.button.delete']}" styleClass="red" action="#{CustomAccountMapBean.deleteAccount()}" update="accountForm mappingForm form" process="@this" oncomplete="PF('accountDialogWidget').hide();" rendered="#{!CustomAccountMapBean.createAccount}" />
                    <p:commandButton id="accountCancel" value="#{msg['sefMap.button.cancel']}" styleClass="secondary" action="#{CustomAccountMapBean.clearAccount()}" update="accountForm mappingForm" process="@this" oncomplete="PF('accountDialogWidget').hide();">
                        <p:resetInput target="accountForm" />
                    </p:commandButton>
                </div>
            </h:form>
        </p:dialog>
        <script>
            var accountCancel = false;
            function showAccount() {
                document.getElementById('clearAccount').style.display = 'inherit';
            }
            function hideAccount() {
                accountCancel = false;
                document.getElementById('accountForm:misAccount_input').scrollLeft = 0;
                setTimeout(function () {
                    if (!accountCancel) {
                        document.getElementById('clearAccount').style.display = 'none';
                    }
                }, 100);
            }
            function clearAccount() {
                accountCancel = true;
                document.getElementById('accountForm:misAccount_input').value = '';
                document.getElementById('accountForm:misAccount_hinput').value = '';
                document.getElementById('accountForm:misAccount_input').focus();
            }
        </script>
    </ui:define>
</ui:composition>