<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/gov30Template.xhtml">

    <ui:define name="title">
        <h:outputFormat value="#{msg['title.submitFiles']}" />
    </ui:define>

    <ui:define name="content">
        <script>
            function disableUpload() {
                window.addEventListener("dragover", function (e) {
                    e = e || event;
                    e.preventDefault();
                }, false);
                window.addEventListener("drop", function (e) {
                    e = e || event;
                    var uploadControl = document.getElementById('uploadForm:uploadControl_input');
                    if (!uploadControl || uploadControl.disabled) {
                        alert('Upload is disabled');
                        e.preventDefault();
                    }
                }, false);
            }
            disableUpload();
        </script>
        <ui:include src="/WEB-INF/fragments/navTabs/dataSubmissionTabs.xhtml" />

        <h:form id="uploadForm">

            <div class="ui-g">
                <div class="ui-g-6">
                    <p:outputLabel style="color: #777777" value="#{msg['submission.label.ha']}" />
                    <p:inputText readonly="true" disabled="true" value="#{UserBean.healthAuthorityName}" />
                </div>
            </div>

            <div class="ui-g">
                <div class="ui-g-6">
                    <p:outputLabel style="color: #777777" value="#{msg['submission.label.username']}" />
                    <p:inputText readonly="true" disabled="true" value="#{UserBean.userName}" />
                </div>
            </div>

            <!--Dropdown for "Year" and "period"-->
            <div class="ui-g">
                <div class="ui-g-3">
                    <p:outputLabel for="year" value="#{msg['form.year']}" indicateRequired="true" />
                    <h:selectOneMenu id="year" value="#{SubmitFilesBean.year}" required="true">
                        <p:ajax event="change" listener="#{SubmitFilesBean.onYearChange()}" update="periods custommaps sefsources uploads uploadControl poll validation reports revenueExpenseSummaryForm revenueExpenseDetailForm validationReports submission" />
                        <f:selectItem itemLabel="Select Year" noSelectionOption="true" />
                        <f:selectItems value="#{SubmitFilesBean.allFiscalYears}" var="item" />
                    </h:selectOneMenu>
                </div>
            </div>

            <div class="ui-g">
                <div class="ui-g-3">
                    <p:outputLabel for="periods" value="#{msg['form.period']}" indicateRequired="true" />
                    <h:selectOneMenu id="periods" value="#{SubmitFilesBean.period}">
                        <p:ajax event="change" listener="#{SubmitFilesBean.onPeriodChange()}" process="periods,year" update="uploads uploadControl poll validation reports revenueExpenseSummaryForm revenueExpenseDetailForm validationReports submission" />
                        <f:selectItem itemLabel="Select Period" />
                        <f:selectItems value="#{SubmitFilesBean.periods}" var="item" />
                    </h:selectOneMenu>
                </div>
            </div>

            <div class="formgroup">
                <h2>
                    <h:outputText value="#{msg['submission.title.upload']}" />
                </h2>

                <p:messages for="upload" />

                <!--Dropdown for "Sef Sources" and "Custom Map"-->
                <div class="ui-g">
                    <div class="ui-g-3">
                        <p:outputLabel for="sefsources" value="#{msg['submission.sef']}" indicateRequired="true" />
                        <h:selectOneMenu id="sefsources" value="#{SubmitFilesBean.sefSource}">
                            <p:ajax event="change" process="@this" update="uploadControl" />
                            <f:selectItem />
                            <f:selectItems value="#{SubmitFilesBean.seSources}" var="item" />
                        </h:selectOneMenu>
                    </div>
                </div>

                <div class="ui-g">
                    <div class="ui-g-3">
                        <p:outputLabel for="custommaps" value="#{msg['submission.map']}" />
                        <h:selectOneMenu id="custommaps" value="#{SubmitFilesBean.customMap}">
                            <p:ajax event="change" process="@this" update="uploadControl" />
                            <f:selectItem />
                            <f:selectItems value="#{SubmitFilesBean.custAccounts}" var="item" />
                        </h:selectOneMenu>
                    </div>
                </div>

                <p:fileUpload id="uploadControl" listener="#{SubmitFilesBean.upload}"
                              label="Add Files" mode="advanced" auto="true" dragDropSupport="true" fileLimit="10" sizeLimit="500000000"
                              update="@form" allowTypes="/(\.|\/)(prn|sef|txt)$/i" disabled="#{!SubmitFilesBean.uploadEnabled()}">
                    <p:messages for="uploadControl" closable="true" />
                </p:fileUpload>

                <div class="uploads">
                    <p:outputPanel id="uploads">
                        <p:dataTable value="#{SubmitFilesBean.getFiles(UserBean.healthAuthority,SubmitFilesBean.period,SubmitFilesBean.year)}" var="file" sortBy="#{file.timestamp}">
                            <p:column width="250" headerText="File Name"><h:outputText styleClass="blueText file" value="#{file.fileName}" /></p:column>
                            <p:column width="200" headerText="Submitter"><h:outputText value="#{file.uploader}" /></p:column>
                            <p:column width="200" headerText="Status">
                                <h:graphicImage width="12" height="12" value="/resources/template-images/error-large.png" rendered="#{file.error || file.rejected}" />
                                <h:outputText styleClass="leftPad" value="SYSTEM ERROR" rendered="#{file.error}" />
                                <h:outputText styleClass="leftPad" value="REJECTED" rendered="#{file.rejected}" />
                                <h:graphicImage width="12" height="12" value="/resources/template-images/success-large.png" rendered="#{file.accepted}" />
                                <h:outputText styleClass="leftPad" value="ACCEPTED" rendered="#{file.accepted}" />
                                <h:graphicImage width="23" height="23" value="/resources/template-images/animated-spinner.gif" rendered="#{file.inProgress}" />
                                <h:outputText styleClass="leftPad" value="IN PROGRESS" rendered="#{file.inProgress}" />
                            </p:column>
                            <p:column width="200" headerText="Updates">
                                <h:outputText value="#{file.status}" rendered="#{file.inProgress}" />
                                <p:commandLink styleClass="redLink" actionListener="#{SubmitFilesBean.getErrorsForFile(file.sefId)}" value="Errors" style="float:none;" process="@this" rendered="#{file.error || file.rejected}" update="errors" oncomplete="PF('errorDialog').show();" />
                            </p:column>
                            <p:column width="200" headerText="Submitted" sortBy="#{file.timestamp}" sortOrder="asc">
                                <h:outputText value="#{file.timestamp}">
                                    <f:convertDateTime pattern="MMM d, YYYY @ h:mm a" timeZone="PST" />
                                </h:outputText>
                            </p:column>
                            <p:column width="75" headerText="Action">
                                <p:commandLink styleClass="redLink" value="Delete" action="#{SubmitFilesBean.deleteFile}" process="@this" update="@form reports validation validationReports submission">
                                    <f:setPropertyActionListener target="#{SubmitFilesBean.sefId}" value="#{file.sefId}" />
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>
                        <p:poll id="poll" update="uploads reports validation validationReports submission" process="uploads year periods" interval="2" stop="#{!SubmitFilesBean.shouldPollForStatusUpdates(UserBean.healthAuthority,SubmitFilesBean.period,SubmitFilesBean.year)}" />
                    </p:outputPanel>
                </div>
            </div>
        </h:form>

        <p:dialog id="errors" widgetVar="errorDialog" modal="true" header="Errors" closable="false" visible="#{SubmitFilesBean.errors.size()>0}" width="650">
            <h:form id="errorForm">
                <p:dataTable id="errorList" styleClass="errorList" value="#{SubmitFilesBean.errors}" var="row" style="max-height:400px; overflow-y: auto;">
                    <p:column><h:outputText value="#{row}" /></p:column>
                </p:dataTable>
                <p:commandButton id="exportCsv" value="#{msg['sefMap.button.csv']}" ajax="false" process="errors">
                    <p:dataExporter type="csv" target="errorList" fileName="#{SubmitFilesBean.year}-#{SubmitFilesBean.period}-Errors" />
                </p:commandButton>
                <p:commandButton value="Close" styleClass="secondary" onclick="PF('errorDialog').hide();" action="#{SubmitFilesBean.clearErrors()}" />
            </h:form>
        </p:dialog>

        <div class="formgroup">
            <h2>
                <h:outputText value="#{msg['submission.title.reports']}" />
            </h2>
            <p>
                <p:outputPanel id="reports">
                    <h:form id="revExpenseReportsForm">
                        <div class="ui-g">
                            <div class="ui-g-3">
                                <p:commandButton id="revExpSumReport" value="Revenue Expense Summary" process="@this" onclick="PF('revenueExpenseSummaryDialog').show();" disabled="#{SubmitFilesBean.files.size()==0}" />
                            </div>
                        </div>
                        <div class="ui-g">
                            <div class="ui-g-3">
                                <p:commandButton id="revExpDetailReport" value="Revenue Expense Detail" action="#{SubmitFilesBean.openRevenueReportDialog()}" process="@this" update="revenueExpenseDetailForm" oncomplete="PF('revenueExpenseDetailDialog').show();" disabled="#{SubmitFilesBean.files.size()==0}" />
                            </div>
                        </div>
                        <div class="ui-g">
                            <div class="ui-g-3">
                                <p:commandButton id="balanceSheetReport" value="Balance Sheet Summary" update="@form" ajax="false" action="#{SubmitFilesBean.getBalanceSheetReport}" disabled="#{SubmitFilesBean.files.size()==0}" />
                            </div>
                        </div>
                    </h:form>
                </p:outputPanel>
            </p>
        </div>

        <p:dialog modal="true" closable="false" resizable="false" widgetVar="revenueExpenseSummaryDialog" header="Revenue Expense Summary Report" width="650">
            <h:form id="revenueExpenseSummaryForm">
                <div class="ui-g">
                    <div class="ui-g-6">
                        <p:outputLabel for="finStat" value="Financial/Statistical" indicateRequired="true" />
                        <h:selectOneMenu id="finStat" value="#{SubmitFilesBean.revExpSummaryFinStat}" required="true">
                            <f:selectItem itemValue="FS" itemLabel="Both" />
                            <f:selectItem itemValue="F" itemLabel="Financial" />
                            <f:selectItem itemValue="S" itemLabel="Statistical" />
                        </h:selectOneMenu>
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-6">
                        <p:outputLabel for="actualBudget" value="Actual/Budget" indicateRequired="true" />
                        <h:selectOneMenu id="actualBudget" value="#{SubmitFilesBean.revExpSummaryActualBudget}" required="true">
                            <f:selectItem itemValue="A" itemLabel="Actual" />
                            <f:selectItem itemValue="B" itemLabel="Budget" />
                        </h:selectOneMenu>
                    </div>
                </div>
                <br/>
                <p:commandButton id="generateRevExpenseReport" value="Generate Report" ajax="false" action="#{SubmitFilesBean.getRevenueExpenseReport()}" />
                <p:commandButton id="closeRevExpenseReport" styleClass="secondary" process="@this" value="Close" onclick="PF('revenueExpenseSummaryDialog').hide();" />
            </h:form>
        </p:dialog>

        <p:dialog modal="true" closable="false" resizable="false" widgetVar="revenueExpenseDetailDialog" header="Revenue Expense Detail Report" width="700">
            <h:form id="revenueExpenseDetailForm">
                <div class="ui-g">
                    <div class="ui-g-6">
                        <p:outputLabel for="finStatDtl" value="Financial/Statistical" indicateRequired="true" />
                        <h:selectOneMenu id="finStatDtl" value="#{SubmitFilesBean.revExpDetailFinStat}" required="true">
                            <f:selectItem itemValue="FS" itemLabel="Both" />
                            <f:selectItem itemValue="F" itemLabel="Financial" />
                            <f:selectItem itemValue="S" itemLabel="Statistical" />
                        </h:selectOneMenu>
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-6">
                        <p:outputLabel for="actualBudgetDtl" value="Actual/Budget" indicateRequired="true" />
                        <h:selectOneMenu id="actualBudgetDtl" value="#{SubmitFilesBean.revExpDetailActualBudget}" required="true">
                            <f:selectItem itemValue="A" itemLabel="Actual" />
                            <f:selectItem itemValue="B" itemLabel="Budget" />
                        </h:selectOneMenu>
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-6">
                        <p:outputLabel for="lei" value="LEI" />
                        <p:selectManyMenu id="lei" value="#{SubmitFilesBean.revExpDetailLei}" scrollHeight="150" style="width:300px">
                            <p:ajax event="change" listener="#{SubmitFilesBean.clearHsp()}" update="hsp lei generateRevExpenseDetailReport" />
                            <f:selectItems value="#{SubmitFilesBean.leis}" />
                        </p:selectManyMenu>
                    </div>
                    <div class="ui-g-6">
                        <p:outputLabel for="hsp" value="HSP" />
                        <p:selectManyMenu id="hsp" value="#{SubmitFilesBean.revExpDetailHsp}" scrollHeight="150" style="width:300px">
                            <p:ajax event="change" listener="#{SubmitFilesBean.clearLei()}" update="lei hsp generateRevExpenseDetailReport" />
                            <f:selectItems value="#{SubmitFilesBean.hsps}" />
                        </p:selectManyMenu>
                    </div>
                </div>
                <div class="ui-g">
                    <h:outputText value="#{msg['submission.note.multi']}" />
                </div>
                <br/>
                <p:commandButton id="generateRevExpenseDetailReport" disabled="#{SubmitFilesBean.reportButtonDisabled}" value="Generate Report" ajax="false" action="#{SubmitFilesBean.getRevenueExpenseDetailReport()}" />
                <p:commandButton id="closeRevExpenseDetailReport" styleClass="secondary" process="@this" value="Close" onclick="PF('revenueExpenseDetailDialog').hide();" action="#{SubmitFilesBean.clearAll()}" />
            </h:form>
        </p:dialog>

        <h:form id="validation">
            <div class="formgroup">
                <h2>
                    <h:outputText value="#{msg['submission.title.validation']}" />
                </h2>

                <p:messages for="validation" />

                <p:commandButton id="startValidation" value="#{msg['submission.validation.start']}" update="@form"
                                 action="#{SubmitFilesBean.validate}" disabled="#{!SubmitFilesBean.isValidationEnabled()}" />
                <br/><br/>
                <div class="uploads">
                    <p:outputPanel id="validations" rendered="#{SubmitFilesBean.sefValidations.size()>0}">
                        <p:dataTable value="#{SubmitFilesBean.allValidations}" var="sub" sortBy="#{sub.transactionTypeDescription}">
                            <p:column headerText="Type">
                                <h:outputText styleClass="blueText" value="#{sub.transactionTypeDescription}" />
                            </p:column>
                            <p:column headerText="Status">
                                <h:graphicImage width="12" height="12" value="/resources/template-images/error-large.png" rendered="#{sub.error || sub.rejected}" />
                                <h:graphicImage width="12" height="12" value="/resources/template-images/success-large.png" rendered="#{sub.accepted}" />
                                <h:graphicImage width="23" height="23" value="/resources/template-images/animated-spinner.gif" rendered="#{sub.inProgress}" />
                                <h:outputText styleClass="leftPad" value="#{sub.customStatusDescription}" />
                            </p:column>
                            <p:column headerText="Completed">
                                <h:outputText value="#{sub.dateModified}">
                                    <f:convertDateTime pattern="MMM d, YYYY @ h:mm a" timeZone="PST" />
                                </h:outputText>
                            </p:column>
                        </p:dataTable>
                        <p:poll id="pollValidations" listener="#{SubmitFilesBean.refreshValidationStatus()}" stop="#{!SubmitFilesBean.shouldPollForValidationUpdates()}" update="validations validationReports submission" process="validations" interval="2" />
                    </p:outputPanel>
                </div>
            </div>
        </h:form>

        <h:form id="validationReports">
            <div class="formgroup">
                <h2>
                    <h:outputText value="#{msg['submission.title.validationReports']}" />
                </h2>
                <div class="ui-g">
                    <div class="ui-g-3">
                        <p:commandButton id="SectorValidationReport" value="Sector Validation" ajax="false" action="#{SubmitFilesBean.getSectorValidationReport}" disabled="#{!SubmitFilesBean.isSefValidationReportEnabled()}" />
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-3">
                        <p:commandButton id="SefValidationReport" value="SEF Validation" ajax="false" action="#{SubmitFilesBean.getSEFValidationReport}" disabled="#{!SubmitFilesBean.isSefValidationReportEnabled()}" />
                    </div>
                </div>
                <div class="ui-g">
                    <div class="ui-g-3">
                        <p:commandButton id="SefFileStatusReport" value="SEF Files Status" ajax="false" action="#{SubmitFilesBean.getSEFFileStatusReport}" disabled="#{!SubmitFilesBean.isSefValidationReportEnabled()}" />
                    </div>
                </div>
            </div>
        </h:form>

        <h:form id="submission">
            <div class="formgroup">
                <h2>
                    <h:outputText value="#{msg['submission.title.submission']}" />
                </h2>

                <p:messages for="submission" />

                <p:outputLabel for="actualsbudget" styleClass="#{SubmitFilesBean.isSubmissionEnabled()?'':'disabled'}">
                    <h:outputText value="#{msg['submission.actbud']}" />
                </p:outputLabel>
                <div class="ui-g">
                    <div class="ui-g-3">
                        <h:selectOneMenu id="actualsbudget" value="#{SubmitFilesBean.actualOrBudget}" disabled="#{!SubmitFilesBean.isSubmissionEnabled()}">
                            <f:selectItem itemLabel="Actuals" itemValue="A" />
                            <f:selectItem itemLabel="Budgets" itemValue="B" />
                            <f:selectItem itemLabel="Both" itemValue="" />
                        </h:selectOneMenu>
                    </div>
                </div>

                <p>
                    <br/>
                    <p:commandButton id="sendDataButton" value="#{msg['submission.send']}" update="@form" disabled="#{!SubmitFilesBean.isSubmissionEnabled() || SubmitFilesBean.shouldPollForSubmissionUpdates()}" action="#{SubmitFilesBean.sendData()}" />
                </p>
                <div class="uploads">
                    <p:outputPanel id="exports" rendered="#{SubmitFilesBean.isSubmissionEnabled()}">
                        <p:dataTable value="#{SubmitFilesBean.exports}" var="export" sortBy="#{export.transactionTypeDescription}">
                            <p:column sortBy="#{export.transactionTypeDescription}" sortOrder="asc" headerText="Type">
                                <h:outputText styleClass="blueText" value="#{export.transactionTypeDescription}" />
                            </p:column>
                            <p:column headerText="Status">
                                <h:graphicImage width="12" height="12" value="/resources/template-images/error-large.png" rendered="#{export.error || export.rejected}" />
                                <h:graphicImage width="12" height="12" value="/resources/template-images/success-large.png" rendered="#{export.accepted}" />
                                <h:graphicImage width="23" height="23" value="/resources/template-images/animated-spinner.gif" rendered="#{export.inProgress}" />
                                <h:outputText styleClass="leftPad" value="#{export.customStatusDescription}" rendered="#{export.accepted}" />
                                <h:outputText styleClass="leftPad" value="IN PROGRESS" rendered="#{export.inProgress}" />
                                <p:commandLink styleClass="leftPad redLink" actionListener="#{SubmitFilesBean.findErrorsForSubmission(export.subId)}" value="#{export.customStatusDescription}" style="float:none;" process="@this" rendered="#{export.error || export.rejected}" update="errors" oncomplete="PF('errorDialog').show();">
                                </p:commandLink>
                            </p:column>
                            <p:column headerText="Updates">
                                <h:outputText value="#{export.subStatusTypeDesc}" rendered="#{export.inProgress}" />
                            </p:column>
                            <p:column headerText="Submitted">
                                <h:outputText value="#{export.dateCreated}">
                                    <f:convertDateTime pattern="MMM d, YYYY @ h:mm a" timeZone="PST" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Completed">
                                <h:outputText value="#{export.dateModified}">
                                    <f:convertDateTime pattern="MMM d, YYYY @ h:mm a" timeZone="PST" />
                                </h:outputText>
                            </p:column>
                        </p:dataTable>
                        <p:poll id="pollExports" listener="#{SubmitFilesBean.refreshSubmissionStatus()}" stop="#{!SubmitFilesBean.shouldPollForSubmissionUpdates()}" update="exports sendDataButton" process="exports" interval="1" />
                    </p:outputPanel>
                </div>
            </div>
        </h:form>

    </ui:define>
</ui:composition>
