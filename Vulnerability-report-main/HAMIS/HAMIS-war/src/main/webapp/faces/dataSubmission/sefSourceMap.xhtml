<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
                xmlns:ui="http://java.sun.com/jsf/facelets" 
                xmlns:h="http://java.sun.com/jsf/html" 
                xmlns:f="http://java.sun.com/jsf/core" 
                xmlns:p="http://primefaces.org/ui" 
                template="/WEB-INF/templates/gov30Template.xhtml">

    <ui:define name="title">
        <h:outputText value="#{SefSourceMapBean.create?msg['sefMap.add.title']:msg['sefMap.update.title']}" />
    </ui:define>

    <ui:define name="content">

        <ui:include src="/WEB-INF/fragments/navTabs/dataSubmissionTabs.xhtml" />

        <p:messages closable="true">
            <p:autoUpdate />
        </p:messages>

        <h:form id="form">
            <h1><h:outputText value="#{SefSourceMapBean.create?msg['sefMap.add.title']:msg['sefMap.update.title']}" /></h1>
            <div class="ui-g">
                <div class="ui-g-3">
                    <p:outputLabel for="name" value="#{msg['sefMap.label.name']}" indicateRequired="true" />
                    <p:inputText id="name" value="#{SefSourceMapBean.extractSource.name}" required="true" />
                </div>
            </div>
            <div class="ui-g">
                <div class="ui-g-3">
                    <p:outputLabel for="fiscalYear" value="#{msg['sefMap.label.fiscalYear']}" styleClass="disabled" />
                    <p:inputText id="fiscalYear" value="#{SefSourceMapBean.extractSource.fiscalYear}" disabled="true" style="pointer-events: all" title="#{SefSourceMapBean.extractSource.fiscalYear}" />
                </div>
            </div>
            <div class="ui-g">
                <div class="ui-g-3">
                    <p:outputLabel for="lastModified" value="#{msg['sefMap.label.lastModified']}" styleClass="disabled" />
                    <p:calendar id="lastModified" value="#{SefSourceMapBean.extractSource.dateModified}" disabled="true">
                        <f:convertDateTime pattern="MMM d, YYYY @ h:mm a" timeZone="PST" type="both" />
                    </p:calendar>
                </div>
            </div>
            <div class="ui-g">
                <p:commandButton id="addUpdate" value="#{SefSourceMapBean.create?msg['sefMap.button.create']:msg['sefMap.button.update']}" action="#{SefSourceMapBean.saveSefSource()}" update="form export mappings" />
                <p:commandButton id="cancel" value="#{msg['sefMap.button.cancel']}" styleClass="secondary" onclick="window.location = 'maintainMappings.xhtml';" process="@this" rendered="#{SefSourceMapBean.create}" />
                <p:commandButton id="duplicate" value="#{msg['sefMap.button.duplicate']}" onclick="PF('duplicateDialogWidget').show();" rendered="#{!SefSourceMapBean.create}" process="@this" />
                <p:commandButton id="delete" value="#{msg['sefMap.button.delete']}" styleClass="red" onclick="PF('deleteDialogWidget').show();" rendered="#{!SefSourceMapBean.create}" />
            </div>
        </h:form>

        <p:dialog id="deleteDialog" width="650" closable="false" modal="true" resizable="false" visible="false" widgetVar="deleteDialogWidget" header="#{msg['sefMap.delete.title']}">
            <div class="dialogMessage">
                #{msg['sefMap.delete.desc']}
            </div>
            <h:form id="deleteForm">
                <p:commandButton id="delete" value="#{msg['sefMap.button.delete']}" styleClass="red" action="#{SefSourceMapBean.deleteSefSource()}" ajax="false" />
                <p:commandButton id="cancel" value="#{msg['sefMap.button.cancel']}" styleClass="secondary" oncomplete="PF('deleteDialogWidget').hide();" process="@this" />
            </h:form>
        </p:dialog>

        <p:dialog id="duplicateDialog" width="650" closable="false" modal="true" resizable="false" visible="false" widgetVar="duplicateDialogWidget" header="#{msg['sefMap.duplicate.title']}">
            #{msg['sefMap.duplicate.desc']}
            <h:form id="duplicateForm">
                <p:messages id="duplicateMessages" closable="true" />
                <div class="ui-g">
                    <div class="ui-g-8">
                        <p:outputLabel for="name" indicateRequired="true" value="#{msg['sefMap.label.name']}" />
                        <p:inputText id="name" value="#{SefSourceMapBean.duplicateName}" required="true" />
                    </div>
                </div>
                <p:commandButton id="duplicate" value="#{msg['sefMap.button.duplicate']}" action="#{SefSourceMapBean.duplicateSefSource()}" update="duplicateMessages" />
                <p:commandButton id="cancel" value="#{msg['sefMap.button.cancel']}" styleClass="secondary" oncomplete="PF('duplicateDialogWidget').hide();" process="@this" />
            </h:form>
        </p:dialog>

        <p:panel id="export">
            <h2>#{msg['sefMap.header.export']}</h2>
            <h:form id="exportForm">
                <p:commandButton id="exportPdf" value="#{msg['sefMap.button.pdf']}" disabled="#{SefSourceMapBean.create}" ajax="false" process="mappingForm exportForm">
                    <p:dataExporter
                        exporter="#{SefSourceMapBean.pdfExporter}"
                        type="pdf" 
                        target="mappingForm:rulesTable" 
                        fileName="#{SefSourceMapBean.extractSource.name}-#{SefSourceMapBean.extractSource.fiscalYear}-SefSourceMapBean"
                        options="#{SefSourceMapBean.pdfOptions}"
                        />
                </p:commandButton>
                <p:commandButton id="exportCsv" value="#{msg['sefMap.button.csv']}" disabled="#{SefSourceMapBean.create}" ajax="false" process="mappingForm exportForm">
                    <p:dataExporter type="csv" target="mappingForm:rulesTable" fileName="#{SefSourceMapBean.extractSource.name}-#{SefSourceMapBean.extractSource.fiscalYear}-SefSourceMapBean" />
                </p:commandButton>
            </h:form>
        </p:panel>

        <p:panel id="mappings">
            <h2>#{msg['sefMap.header.mappingRules']}</h2>
            <h:form id="mappingForm">
                <p:commandButton id="createMappingRule" value="#{msg['sefMap.button.createMappingRule']}" action="#{SefSourceMapBean.clearProvider()}" update="providerDialog" oncomplete="PF('providerDialogWidget').show();" disabled="#{SefSourceMapBean.create}" />
                <p:dataTable id="rulesTable" value="#{SefSourceMapBean.extractSource.providerDefinitions}" 
                             var="row" sortMode="single" sortBy="#{row.lei}"
                             widgetVar="rulesTableWidget" filteredValue="#{SefSourceMapBean.filteredProviderDefinitions}"
                             paginator="true" paginatorAlwaysVisible="true" rows="50" paginatorPosition="top"
                             currentPageReportTemplate="{startRecord} - {endRecord} of {totalRecords}" 
                             paginatorTemplate="{CurrentPageReport} {PreviousPageLink} {NextPageLink}"
                             selection="#{SefSourceMapBean.selectedProvider}" selectionMode="single" rowKey="#{row.pdId}" styleClass="filtered-paginator">
                    <p:ajax event="rowSelect" update="providerDialog" process="mappingForm" oncomplete="PF('providerDialogWidget').show();"  />
                    <f:facet name="header">
                        <p:outputPanel>
                            <!-- Regarding "display:none". The PrimeFaces dataExporter uses the first outputText in the header facet as a column header, but we don't want to display it on the page. -->
                            <h:outputText value="#{msg['sefMap.label.filterRulesExporter']}" style="display: none" />
                            <h:outputText styleClass="#{SefSourceMapBean.create?'disabled':''}" value="#{msg['sefMap.label.filterRules']}" /><h:outputText styleClass="smallGrey" value="#{msg['sefMap.label.filterRulesExtra']}" /><br/>
                            <p:inputText id="globalFilter" disabled="#{SefSourceMapBean.create}" type="search" />
                            <p:commandButton id="filter" onclick="PF('rulesTableWidget').filter()" value="#{msg['sefMap.button.search']}" disabled="#{SefSourceMapBean.create}" />
                            <p:defaultCommand target="filter" />
                        </p:outputPanel>
                    </f:facet>
                    <f:facet name="footer">
                        <p:outputPanel>
                            <!-- Regarding "display:none". The PrimeFaces dataExporter uses the first outputText in the header facet as a column header, but we don't want to display it on the page. -->
                            <h:outputText value="#{msg['sefMap.label.filterRulesExporter']}" style="display: none" />
                        </p:outputPanel>
                    </f:facet>
                    <p:column filterBy="#{row.lei}" sortOrder="asc" filterable="true" filterStyle="display:none" width="10%" headerText="#{msg['sefMap.label.lei']}" sortBy="#{row.lei}"><h:outputText value="#{row.lei}" /></p:column>
                    <p:column filterBy="#{row.ptId}" filterable="true" filterStyle="display:none" width="30%" headerText="#{msg['sefMap.label.sector']}" sortBy="#{row.ptId}"><h:outputText value="#{row.ptId}" /></p:column>
                    <p:column filterBy="#{row.orId.subHoId.currentName} #{row.orId.subHoId.spId}" filterable="true" filterStyle="display:none" width="30%" headerText="#{msg['sefMap.label.providerName']}" sortBy="#{row.orId.subHoId.currentName}"><h:outputText value="#{row.orId.subHoId.spId}" /> - <h:outputText value="#{row.orId.subHoId.currentName}" /></p:column>
                    <p:column filterBy="#{row.name}" filterable="true" filterStyle="display:none" width="30%" headerText="#{msg['sefMap.label.description']}" sortBy="#{row.name}"><h:outputText value="#{row.name}" /></p:column>
                </p:dataTable>
            </h:form>
        </p:panel>

        <p:dialog id="providerDialog" blockScroll="true" width="650" closable="false" modal="true" resizable="false" visible="false" widgetVar="providerDialogWidget" header="#{!SefSourceMapBean.createProviderDefinition?msg['sefMap.button.update']:msg['sefMap.button.add']} #{msg['sefMap.label.rule']}">
            <h:form id="providerForm">
                <div id="providerDialogScroll" class="dialogueScroll">
                    <p:messages id="providerMessages" closable="true" />
                    <div class="ui-g">
                        <div class="ui-g-8">
                            <p:outputLabel for="lei" indicateRequired="true" value="#{msg['sefMap.label.lei']}" />
                            <p:inputText id="lei" value="#{SefSourceMapBean.selectedProvider.lei}" maxlength="2" required="true" />
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-8">
                            <p:outputLabel for="sector" value="#{msg['sefMap.label.sector']}" />
                            <p:autoComplete dropdown="true" type="search" id="sector" required="true" value="#{SefSourceMapBean.selectedProvider.ptId}" var="item" itemLabel="#{item.toString()}" itemValue="#{item}" completeMethod="#{SefSourceMapBean.autocompleteProviderType}" size="75" scrollHeight="200" onclick="this.select()" converter="#{SefSourceMapBean.providerTypeConverter}" onfocus="showSector();" onblur="hideSector();">
                                <p:ajax event="query" oncomplete="selectAutoComplete('providerForm', 'sector');" />
                            </p:autoComplete>
                            <a id="sectorClear" class="clearButton" onclick="clearSector();">x</a>
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-8">
                            <p:outputLabel for="providerName" indicateRequired="true" value="#{msg['sefMap.label.providerName']}" />
                            <p:autoComplete dropdown="true" type="search" id="providerName" required="true" value="#{SefSourceMapBean.selectedProvider.orId}" var="item" itemLabel="#{item.toString()}" itemValue="#{item}" completeMethod="#{SefSourceMapBean.autocompleteOrganizations}" size="75" scrollHeight="200" onclick="this.select()" converter="#{SefSourceMapBean.organizationRelationshipConverter}" onfocus="showProvider();" onblur="hideProvider();">
                                <p:ajax event="query" oncomplete="selectAutoComplete('providerForm', 'providerName');" />
                            </p:autoComplete>
                            <a id="providerClear" class="clearButton" onclick="clearProvider();">x</a>
                        </div>
                    </div>
                    <div class="ui-g">
                        <div class="ui-g-8">
                            <p:outputLabel for="description" value="#{msg['sefMap.label.description']}" />
                            <p:inputText id="description" value="#{SefSourceMapBean.selectedProvider.name}" maxlength="255" />
                        </div>
                    </div>
                    <p:commandButton id="providerSave" value="#{!SefSourceMapBean.createProviderDefinition?msg['sefMap.button.update']:msg['sefMap.button.add']}" action="#{SefSourceMapBean.saveProvider()}" update="providerForm mappingForm  providerForm providerMessages" process="providerForm" oncomplete="if (!args.validationFailed){PF('providerDialogWidget').hide();}else{document.getElementById('providerDialogScroll').scrollTop=0;}" /> 
                    <p:commandButton id="providerDelete" value="#{msg['sefMap.button.delete']}" styleClass="red" action="#{SefSourceMapBean.deleteProvider()}" update="providerForm mappingForm" process="providerForm" oncomplete="PF('providerDialogWidget').hide();" rendered="#{!SefSourceMapBean.createProviderDefinition}" />
                    <p:commandButton id="providerCancel" value="#{msg['sefMap.button.cancel']}" styleClass="secondary" action="#{SefSourceMapBean.clearProvider()}" update="providerForm" process="@this" oncomplete="PF('providerDialogWidget').hide();">
                        <p:resetInput target="providerForm" />
                    </p:commandButton>
                </div>
            </h:form>
        </p:dialog>
        <script language="javascript">
            var sectorCancel = false;
            var providerCancel = false;
            function showSector() {
                document.getElementById('sectorClear').style.display = 'inherit';
            }
            function hideSector() {
                sectorCancel = false;
                document.getElementById('providerForm:sector_input').scrollLeft = 0;
                setTimeout(function () {
                    if (!sectorCancel) {
                        document.getElementById('sectorClear').style.display = 'none';
                    }
                }, 100);
            }
            function clearSector() {
                sectorCancel = true;
                document.getElementById('providerForm:sector_input').value = '';
                document.getElementById('providerForm:sector_hinput').value = '';
                document.getElementById('providerForm:sector_input').focus();
            }
            function showProvider() {
                document.getElementById('providerClear').style.display = 'inherit';
            }
            function hideProvider() {
                providerCancel = false;
                document.getElementById('providerForm:providerName_input').scrollLeft = 0;
                setTimeout(function () {
                    if (!providerCancel) {
                        document.getElementById('providerClear').style.display = 'none';
                    }
                }, 100);
            }
            function clearProvider() {
                providerCancel = true;
                document.getElementById('providerForm:providerName_input').value = '';
                document.getElementById('providerForm:providerName_hinput').value = '';
                document.getElementById('providerForm:providerName_input').focus();
            }
        </script>
    </ui:define>
</ui:composition>