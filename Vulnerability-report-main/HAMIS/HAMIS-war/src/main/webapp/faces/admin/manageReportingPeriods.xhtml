<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
                xmlns:ui="http://java.sun.com/jsf/facelets" 
                xmlns:h="http://java.sun.com/jsf/html" 
                xmlns:f="http://java.sun.com/jsf/core" 
                xmlns:p="http://primefaces.org/ui" 
                template="/WEB-INF/templates/gov30Template.xhtml">

    <ui:define name="title">
        <h:outputFormat value="#{msg['title.manageReportingPeriods']}" />
    </ui:define>

    <ui:define name="content">
        <script lang="javascript">
            function startSpin(elementId) {
                document.getElementById(elementId).style.display = 'inline';
            }
            function stopSpin(elementId) {
                document.getElementById(elementId).style.display = 'none';
            }
            function jerk() {
                var s = document.getElementById('reportingPeriodsDialog_content');
                s.scrollTop = s.scrollTop - 1;
                s.scrollTop = s.scrollTop + 1; // Stupid but works
            }
            function scrollPickerIntoView(id) {
                var x = $(id);
                if (x.children('div').length > 0) {
                    x.children('div')[0].scrollIntoView();
                }
            }
        </script>

        <ui:include src="/WEB-INF/fragments/navTabs/adminTabs.xhtml" />

        <!-- PF Messages Component defined for the whole page -->
        <p:messages closable="true" id="pageMessages" rendered="#{ReportingPeriodsBean.enablePageMessages}">
            <p:autoUpdate disabled="false" />
        </p:messages>

        <h:form id="createForm">
            <div class="ui-g">
                <p:commandButton id="createFiscalYear" value="#{msg['reportingPeriod.button.createFiscalYear']}" 
                                 disabled="#{ReportingPeriodsBean.futureYearExist}"
                                 resetValues="true"
                                 action="#{ReportingPeriodsBean.insertFiscalYear()}"
                                 update="reportingPeriodsDialog" onstart="startSpin('createForm:spinner')"
                                 oncomplete="stopSpin('createForm:spinner'); PF('reportingPeriodsDialogWidget').show();" />
                <p:commandButton id="rollover" value="#{msg['reportingPeriod.button.rollover']}"
                                 oncomplete="PF('rolloverDialogWidget').show();" 
                                 disabled="#{!ReportingPeriodsBean.futureYearExist}" />
                <span class="ui-g-3">
                    <p:ajaxStatus>
                        <f:facet name="default" />
                        <f:facet name="start">
                            <h:graphicImage id="spinner" width="23" height="23" value="/resources/template-images/animated-spinner.gif" 
                                            styleClass="spinner_inline" />
                        </f:facet>
                    </p:ajaxStatus>
                </span>
            </div>
        </h:form>

        <h:form id="tableForm">
            <p:dataTable id="fiscalYearTable" value="#{ReportingPeriodsBean.fiscalYearsList}"
                         var="row" rowKey="#{row.fiscalYear}" rowIndexVar="rowIndex"
                         sortBy="#{row.fiscalYear}"
                         paginator="true" paginatorAlwaysVisible="true" 
                         rows="5" paginatorPosition="top"
                         currentPageReportTemplate="{startRecord} - {endRecord} of {totalRecords}" 
                         paginatorTemplate="{CurrentPageReport} {PreviousPageLink} {NextPageLink}"
                         widgetVar="yearTableWidget"
                         selection="#{ReportingPeriodsBean.selectedFiscalYear}" selectionMode="single">

                <f:facet name="header">
                </f:facet>

                <p:ajax event="rowSelect" 
                        resetValues="true"
                        listener="#{ReportingPeriodsBean.loadReportingPeriodsList}" 
                        update="reportingPeriodsDialog" 
                        oncomplete="{PF('reportingPeriodsDialogWidget').show();}" />

                <p:column width="20%" sortBy="#{row.fiscalYear}" sortOrder="desc" headerText="#{msg['reportingPeriod.label.fiscalYear']}">#{row.fiscalYear}</p:column>
                <p:column sortBy="#{row.startDate}" headerText="#{msg['reportingPeriod.label.startDate']}">
                    <h:outputText value="#{row.startDate}">
                        <f:convertDateTime pattern="YYYY-MMM-dd" timeZone="PST" />
                    </h:outputText></p:column>
                <p:column sortBy="#{row.endDate}" headerText="#{msg['reportingPeriod.label.endDate']}">
                    <h:outputText value="#{row.endDate}">
                        <f:convertDateTime pattern="YYYY-MMM-dd" timeZone="PST" />
                    </h:outputText></p:column>
                <p:column sortBy="#{row.yearType}" headerText="#{msg['reportingPeriod.label.yearType']}">#{ReportingPeriodsBean.getFullYearType(row.yearType)}</p:column>
            </p:dataTable> 
        </h:form>


        <p:dialog id="reportingPeriodsDialog" width="1005" closable="false" modal="true" resizable="false" visible="false" 
                  widgetVar="reportingPeriodsDialogWidget" header="#{ReportingPeriodsBean.dialogueHeader}">

            <h:form id="reportingPeriodsForm">
                <f:param value="#{ReportingPeriodsBean.selectedFiscalYear.fiscalYear}" />

                <div id="reportingPeriodsDialogScroll" class="dialogueScroll" style="max-height: 600px">
                    <p:messages id="reportingPeriodsMessages" closable="true" />

                    <p:dataTable id="reportingPeriodsTable" var="period" value="#{ReportingPeriodsBean.reportingPeriodsList}" rowIndexVar="index">
                        <p:column headerText="#{msg['reportingPeriod.label.period']}" width="8%">
                            <p:inputText class="ui-custom-datepicker" value="#{period.period}" size="2" disabled="true" />
                        </p:column>

                        <p:column headerText="#{msg['reportingPeriod.label.periodStartDate']}" width="15%">
                            <p:datePicker class="ui-custom-datepicker" value="#{period.startDate}" 
                                          rendered="#{(index &lt; 9)}"
                                          required="true" pattern="yyyy-MMM-dd" 
                                          requiredMessage="#{msg['reportingPeriod.message.datepicker.startREQUIRED']}"
                                          disabled="#{ReportingPeriodsBean.pastYear}" />
                            <p:datePicker class="ui-custom-datepicker" value="#{period.startDate}" 
                                          id="periodStartDate"
                                          rendered="#{(index &gt;= 9)}"
                                          onfocus="jerk();"
                                          onclick="scrollPickerIntoView('#reportingPeriodsForm\\\\:reportingPeriodsTable\\\\:${index}\\\\:periodStartDate');"
                                          required="true" pattern="yyyy-MMM-dd" 
                                          requiredMessage="#{msg['reportingPeriod.message.datepicker.startREQUIRED']}"
                                          disabled="#{ReportingPeriodsBean.pastYear}" />
                        </p:column> 


                        <p:column headerText="#{msg['reportingPeriod.label.periodEndDate']}" width="15%">
                            <p:datePicker class="ui-custom-datepicker" value="#{period.endDate}" 
                                          rendered="#{(index &lt; 9)}"
                                          required="true" pattern="yyyy-MMM-dd" 
                                          requiredMessage="#{msg['reportingPeriod.message.datepicker.endREQUIRED']}"
                                          disabled="#{ReportingPeriodsBean.pastYear}" />
                            <p:datePicker class="ui-custom-datepicker" value="#{period.endDate}" 
                                          id="periodEndDate"
                                          rendered="#{(index &gt;= 9)}"
                                          onfocus="jerk();"
                                          onclick="scrollPickerIntoView('#reportingPeriodsForm\\\\:reportingPeriodsTable\\\\:${index}\\\\:periodEndDate');"
                                          required="true" pattern="yyyy-MMM-dd" 
                                          requiredMessage="#{msg['reportingPeriod.message.datepicker.endREQUIRED']}"
                                          disabled="#{ReportingPeriodsBean.pastYear}" />
                        </p:column>

                        <p:column headerText="#{msg['reportingPeriod.label.periodDueDate']}" width="15%">
                            <p:datePicker class="ui-custom-datepicker" value="#{period.dueDate}" 
                                          rendered="#{(index &lt; 9)}"
                                          required="true" pattern="yyyy-MMM-dd"
                                          requiredMessage="#{msg['reportingPeriod.message.datepicker.dueREQUIRED']}"
                                          disabled="#{ReportingPeriodsBean.pastYear}" />
                            <p:datePicker class="ui-custom-datepicker" value="#{period.dueDate}" 
                                          id="periodDueDate"
                                          rendered="#{(index &gt;= 9)}"
                                          onfocus="jerk();"
                                          onclick="scrollPickerIntoView('#reportingPeriodsForm\\\\:reportingPeriodsTable\\\\:${index}\\\\:periodDueDate');"
                                          required="true" pattern="yyyy-MMM-dd"
                                          requiredMessage="#{msg['reportingPeriod.message.datepicker.dueREQUIRED']}"
                                          disabled="#{ReportingPeriodsBean.pastYear}" />
                        </p:column>
                    </p:dataTable>

                    <p:commandButton id="reportingPeriodUpdate" value="#{msg['reportingPeriod.button.update']}" 
                                     disabled="#{ReportingPeriodsBean.pastYear}"
                                     action="#{ReportingPeriodsBean.saveReportingPeriods()}" process="reportingPeriodsForm"
                                     update="reportingPeriodsForm tableForm createForm reportingPeriodsMessages"
                                     oncomplete="if (args.validationFailed){document.getElementById('reportingPeriodsDialog').scrollTop=0;}else{PF('reportingPeriodsDialogWidget').hide();}" /> 

                    <p:commandButton id="reportingPeriodCancel" value="#{msg['reportingPeriod.button.cancel']}" styleClass="secondary" 
                                     rendered="#{!ReportingPeriodsBean.createFiscalYear}"
                                     update="reportingPeriodsForm tableForm" process="reportingPeriodsForm" 
                                     oncomplete="PF('reportingPeriodsDialogWidget').hide();">
                        <p:resetInput target="reportingPeriodsForm" />
                    </p:commandButton>

                    <p:commandButton id="reportingPeriodCancelNew" value="#{msg['reportingPeriod.button.cancel']}" styleClass="secondary" 
                                     rendered="#{ReportingPeriodsBean.createFiscalYear}"
                                     action="#{ReportingPeriodsBean.cancelCreateFiscalYear()}"
                                     update="reportingPeriodsForm tableForm" process="reportingPeriodsForm" 
                                     oncomplete="PF('reportingPeriodsDialogWidget').hide();">
                        <p:resetInput target="reportingPeriodsForm" />
                    </p:commandButton>
                </div>
            </h:form>
        </p:dialog>


        <!-- Confirm Rollover dialog -->
        <p:dialog id="rolloverDialog" blockScroll="true" visible="false"
                  closable="false" modal="true" resizable="false" 
                  header="#{msg['reportingPeriod.title.rollover']}" widgetVar="rolloverDialogWidget">
            <h:form id="rolloverForm">
                <div class="dialogMessage">
                    <h:outputText value="#{msg['reportingPeriod.message.rollover']}" escape="false" />
                </div>

                <div class="dialogMessage">
                    <p:ajaxStatus>
                        <f:facet name="default" />
                        <f:facet name="start">
                            <h:outputText value="" escape="false" /> 
                            <h:graphicImage id="spinner" width="23" height="23" value="/resources/template-images/animated-spinner.gif" 
                                            styleClass="spinner_inline" />
                        </f:facet>
                    </p:ajaxStatus>
                </div>

                <p:commandButton id="rolloverConfirm"
                                 value="#{msg['reportingPeriod.button.rollover']}"
                                 styleClass="red" 
                                 action="#{ReportingPeriodsBean.rollover()}" 
                                 update="rolloverForm createForm tableForm"
                                 process="rolloverForm" 
                                 oncomplete="stopSpin('rolloverForm:spinner'); PF('rolloverDialogWidget').hide();"
                                 onstart="startSpin('rolloverForm:spinner')" />
                <p:commandButton id="rolloverCancel"
                                 value="#{msg['reportingPeriod.button.cancel']}"
                                 styleClass="secondary"
                                 onclick="PF('rolloverDialogWidget').hide();" />

            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>
