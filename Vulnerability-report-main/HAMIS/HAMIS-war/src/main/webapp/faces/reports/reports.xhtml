<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
                xmlns:ui="http://java.sun.com/jsf/facelets" 
                xmlns:h="http://java.sun.com/jsf/html" 
                xmlns:f="http://java.sun.com/jsf/core" 
                xmlns:p="http://primefaces.org/ui" 
                template="/WEB-INF/templates/gov30Template.xhtml">

    <ui:define name="title">
        <h:outputFormat value="#{msg['title.reports']}" />
    </ui:define>

    <script type="text/javascript">
        var url = "";
    </script>

    <ui:define name="content">

        <ui:include src="/WEB-INF/fragments/navTabs/reportsTabs.xhtml" />

        <p:messages id="messages" closable="true" escape="false" />

        <h:form id="reportsForm">
            <p:dataTable id="reportsTable" value="#{ExternalReportsBean.reportList}"
                         var="row" rowKey="#{row.reportId}" rowIndexVar="rowIndex" sortBy="#{row.category}" 
                         paginator="true" paginatorAlwaysVisible="true" 
                         rows="30" paginatorPosition="top"
                         currentPageReportTemplate="{startRecord} - {endRecord} of {totalRecords}" 
                         paginatorTemplate="{CurrentPageReport} {PreviousPageLink} {NextPageLink}"
                         widgetVar="reportsTableWidget"
                         selection="#{ExternalReportsBean.selectedReport}" selectionMode="single">

                <f:facet name="header">
                </f:facet>
                <p:ajax event="rowSelect" listener="#{ExternalReportsBean.showReport}"
                        oncomplete=" 
                        url = args.reportUrl;
                        console.log('URL = ' + url);
                        if (args.displayAgreementDialog) { PF('showAgreementDialogWidget').show();}" />

                <p:column visible="false">#{row.reportLink}</p:column>
                <p:column sortBy="#{row.category}" sortOrder="asc" headerText="#{msg['reports.label.category']}">#{row.category}</p:column>
                <p:column sortBy="#{row.reportTitle}" headerText="#{msg['reports.label.reportTitle']}">#{row.reportTitle}</p:column>

            </p:dataTable>

            <p:dialog id="showAgreementDialog" visible="false" width="700"
                      style="overflow-y: scroll; max-height: 100%;"
                      blockScroll="true"
                      closable="false" modal="true" resizable="false"
                      widgetVar="showAgreementDialogWidget">

                <f:facet name="header">
                    <h:outputText escape="false" value="#{ExternalReportsBean.agreementDialogTitle}"></h:outputText>
                </f:facet>

                <p>
                    <h:outputText escape="false" value="#{ExternalReportsBean.agreementDialogBody}"></h:outputText>
                </p>

                <p:commandButton id="reportShowAccept"
                                 actionListener="#{ExternalReportsBean.onAccept}"
                                 widgetVar="reportShowAcceptWidget"
                                 value="#{msg['reports.agreement.button.accept']}"
                                 onclick="PF('showAgreementDialogWidget').hide(); $(location).attr('href', url);" />

                <p:commandButton id="reportShowCancel"
                                 widgetVar="reportShowCancelWidget"
                                 value="#{msg['reports.agreement.button.cancel']}"
                                 styleClass="secondary"
                                 onclick="PF('showAgreementDialogWidget').hide();" />

            </p:dialog> 
        </h:form>

    </ui:define>
</ui:composition>