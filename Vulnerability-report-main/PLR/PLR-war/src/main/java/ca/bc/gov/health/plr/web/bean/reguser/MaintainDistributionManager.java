package ca.bc.gov.health.plr.web.bean.reguser;

import ca.bc.gov.health.plr.dto.reguser.DistributionDto;
import ca.bc.gov.health.plr.ejb.entity.GrsCtDistribOnOperations;
import ca.bc.gov.health.plr.ejb.entity.GrsCtDistribOwnCodes;
import ca.bc.gov.health.plr.persistence.CodeTableCodes;
import ca.bc.gov.health.plr.persistence.CodesDao;
import ca.bc.gov.health.plr.service.provider.DuplicateRecordException;
import ca.bc.gov.health.plr.service.registry.user.MaintainDistributionService;
import ca.bc.gov.health.plr.service.validators.DistributionAddressValidator;
import ca.bc.gov.health.plr.service.validators.EntityValidationException;
import ca.bc.gov.health.plr.web.bean.PlrManagedBean;
import ca.bc.gov.health.plr.web.bean.provider.interfaces.GrowlEnabled;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Set;
import javax.annotation.PostConstruct;
import javax.ejb.EJB;
import javax.faces.application.FacesMessage;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ViewScoped;
import javax.faces.context.FacesContext;
import javax.validation.ConstraintViolation;
import javax.validation.Validation;
import javax.validation.Validator;
import javax.validation.ValidatorFactory;

/**
 * MaintainAddress.xhtml backing bean.
 *
 * @author ian.scott
 */
@ManagedBean
@ViewScoped
public class MaintainDistributionManager implements GrowlEnabled {

    @EJB
    protected MaintainDistributionService maintainDistributionService;
    
    @EJB
    private CodesDao  codesDao;
    
    private DistributionDto distDto;
    private List<DistributionDto> distributions;
    
    @EJB
    private DistributionAddressValidator distributionAddressValidator;
    /**
     * panel identifer ajax should use when re-rendering
     */
    private String panelToUpdate;
    
    private Long ruId;

    /**
     * Initialize the backing transfer objects. We'll do all at once since it's
     * cheap and we don't know what the users may choose.
     */
    @PostConstruct
    public void init() {
        distDto = new DistributionDto();
        Long ownAllCodeId = codesDao.lookup(GrsCtDistribOwnCodes.class, CodeTableCodes.GrsCtDistribOwnCodes.ALL).getCtlId();
        Long onOperationAllCodeId = codesDao.lookup(GrsCtDistribOnOperations.class, CodeTableCodes.GrsCtDistribOnOperations.ALL).getCtlId();
        distDto.setCreateCodeId(onOperationAllCodeId);
        distDto.setUpdateCodeId(onOperationAllCodeId);
        distDto.setOwnCodeId(ownAllCodeId);
        distDto.setEffectiveStartDate(new Date());//Mandatory for the table
        panelToUpdate = ":distributionPanel";
        ruId = 0L;
    }

    /**
     * Initial method called from page which determines if the request is an add
     * or an update does not use growl
     */
    @Override
    public void save() {
        save(false);
    }

    /**
     * Initial method called from page which determines if the request is an add
     * or an update
     *
     * @param pDetailsGrowl boolean indicating if the page growl should be used
     */
    @Override
    public void save(boolean pDetailsGrowl) {
        FacesContext context = FacesContext.getCurrentInstance();
        //ensures that class level constraints are fired/checked
        boolean passedValidation = preProcessDto(context, distDto);
        if (!passedValidation) {
            context.validationFailed();
            return;
        }

        if (this.distDto.isNew()) {
            if(ruId != 0L){
                distDto.setRuRuId(ruId);
            } 
        }
        String growl = null;
        try {
            if (pDetailsGrowl) {
                growl = PlrManagedBean.PROVIDER_DETAILS_GROWL;
            }

            DistributionDto temp = getDistDto();
            DistributionDto newDistribution = maintainDistributionService.saveDistribution(temp);
            if(distributions != null){
                distributions.clear();
            } else {
                distributions = new ArrayList<>();
            }
            distributions.addAll(maintainDistributionService.refreshAllDistributions(newDistribution));
            String message = "The distribution was successfully " + (distDto.isNew() ? "created." : "updated.");


            context.addMessage(growl, new FacesMessage(FacesMessage.SEVERITY_INFO, message, ""));
        } catch (DuplicateRecordException | EntityValidationException dre) {
            context.validationFailed();
            context.addMessage(growl, new FacesMessage(FacesMessage.SEVERITY_ERROR, dre.getMessage(), ""));
        }
    }
    
    

    /**
     *
     * @return the : started representation of the panel to update
     */

    public String getPanelToUpdate() {
        return panelToUpdate;
    }

    /**
     *
     * @param panelToUpdate the : started representation of the panel to update
     */

    public void setPanelToUpdate(String panelToUpdate) {
        this.panelToUpdate = panelToUpdate;
    }

    /**
     * ensures that class level constraints are fired/checked
     *
     * @param context - faces context to inject messages if failures encountered
     * @param toProcess - the Address to call validation on.
     * @return true if all constraints passed. false if DTO failed any
     * validation
     */
    private boolean preProcessDto(FacesContext context, DistributionDto toProcess) {
        ValidatorFactory factory = Validation.buildDefaultValidatorFactory();
        Validator validator = factory.getValidator();
        Set<ConstraintViolation<DistributionDto>> constraintViolations = validator.validate(toProcess);
        if (!constraintViolations.isEmpty()) {
            for (ConstraintViolation<?> constraintViolation : constraintViolations) {
                FacesMessage facesMessage = new FacesMessage(constraintViolation.getMessage());
                facesMessage.setSeverity(FacesMessage.SEVERITY_ERROR);
                context.addMessage(null, facesMessage);
            }
            return false;
        }
        return true;
    }

    public Long getRuId() {
        return ruId;
    }

    public void setRuId(Long ruId) {
        this.ruId = ruId;
    }

    public DistributionDto getDistDto() {
        return distDto;
    }

    public void setDistDto(DistributionDto distDto) {
        this.distDto = distDto;
    }

    public List<DistributionDto> getDistributions() {
        return distributions;
    }

    public void setDistributions(List<DistributionDto> distributions) {
        this.distributions = distributions;
    }
}
