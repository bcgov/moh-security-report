package ca.bc.gov.health.plr.rule.provider;

import ca.bc.gov.health.plr.ejb.entity.GrsRegistryUsers;
import ca.bc.gov.health.plr.ejb.entity.PrsCtStatusClassCodes;
import ca.bc.gov.health.plr.ejb.entity.PrsProviders;
import ca.bc.gov.health.plr.ejb.entity.PrsStatuses;
import ca.bc.gov.health.plr.persistence.BusinessRuleKeys;
import ca.bc.gov.health.plr.persistence.BusinessRuleMessageDao;
import ca.bc.gov.health.plr.persistence.CodesDao;
import ca.bc.gov.health.plr.rule.BusinessRule;
import ca.bc.gov.health.plr.rule.BusinessRuleMessage;
import ca.bc.gov.health.plr.rule.BusinessRuleResult;
import java.util.ArrayList;
import java.util.List;
import javax.ejb.EJB;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;

/**
 * Validates that the given registry user is allowed to add Status Class Codes
 * (PRS_STATUSES) associated with the given Provider.
 *
 * @author David Sharpe <david.a.sharpe@cgi.com>
 */
@Stateless
@LocalBean
public class ValidateAllowedStatusClassCode implements BusinessRule, RecordTypeDpsCheck {

    @EJB
    private CodesDao codesDao;

    /**
     * Validates that the given registry user is allowed to add Status Class
     * Codes (PRS_STATUSES) associated with the given Provider.
     *
     * @param provider the Provider containing the Identifiers to be added.
     * @param regUser the registry user performing the add.
     * @return the validation result.
     */
    @Override
    public BusinessRuleResult validate(PrsProviders provider, GrsRegistryUsers regUser) {

        BusinessRuleKeys key = BusinessRuleKeys.ERROR_DISALLOWED_STATUS_CLASS_CODE;
        String messageFormat = BusinessRuleMessageDao.getMessageResource(key);

        List<PrsCtStatusClassCodes> allowedStatusClassCodes = codesDao.getStatusClassesForAdd(regUser, provider.getHptCode());
        List<BusinessRuleMessage> messages = new ArrayList<>();
        for (PrsStatuses status : provider.getPrsStatusesList()) {
            if (!allowedStatusClassCodes.contains(status.getStatusClassCode())) {
                String message = String.format(messageFormat, status.getStatusClassCode().getCtlNameCode());
                messages.add(new BusinessRuleMessage(message, BusinessRuleMessage.Severity.ERROR));
            }
        }
        if (!messages.isEmpty()) {
            return new BusinessRuleResult(false, messages);
        }

        return new BusinessRuleResult();

    }

}
