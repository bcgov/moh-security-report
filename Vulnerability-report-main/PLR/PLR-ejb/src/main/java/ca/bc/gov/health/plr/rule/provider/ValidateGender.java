package ca.bc.gov.health.plr.rule.provider;

import ca.bc.gov.health.plr.ejb.entity.PrsCtGenderCodes;
import ca.bc.gov.health.plr.persistence.BusinessRuleKeys;
import ca.bc.gov.health.plr.persistence.BusinessRuleMessageDao;
import ca.bc.gov.health.plr.persistence.CodesDao;
import ca.bc.gov.health.plr.rule.BusinessRule;
import ca.bc.gov.health.plr.rule.BusinessRuleMessage;
import ca.bc.gov.health.plr.rule.BusinessRuleResult;
import ca.bc.gov.health.plr.util.MessageCodeHelper;
import java.util.ArrayList;
import java.util.List;
import javax.ejb.EJB;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import org.apache.commons.lang3.StringUtils;

/**
 * Validate Gender method.
 * following rules specified in the method JavaDoc.
 *
 * @author Kuan Fan
 */
@Stateless
@LocalBean
public class ValidateGender implements BusinessRule {

    @EJB
    private CodesDao codesDao;
    
    public BusinessRuleResult validateGenderCode(String genderCode, boolean validateBlankGender ) {

        BusinessRuleKeys key = null;
        String message = null;
        List<BusinessRuleMessage> brmList = new ArrayList<>();
        if(StringUtils.isNotBlank(genderCode)) {
            PrsCtGenderCodes prsCtGenderCodes = codesDao.lookup(PrsCtGenderCodes.class, genderCode);
            if(prsCtGenderCodes == null) {
                key = BusinessRuleKeys.ERROR_DEMOGRAPICHGENDERFIELD_INVALID;
                message = BusinessRuleMessageDao.getMessageResource(key);
                brmList.add(new BusinessRuleMessage(message, BusinessRuleMessage.Severity.ERROR));
            }
        } else {
            if(validateBlankGender) {
                BusinessRuleKeys genderBlankBRK = BusinessRuleKeys.ERROR_MANDATORY_PART1;
                String genderBlankErrorArray[] = MessageCodeHelper.splitCodeAndMessage(BusinessRuleMessageDao.getMessageResource(genderBlankBRK));
                genderBlankErrorArray[1] = genderBlankErrorArray[1] + "Gender" + BusinessRuleMessageDao.getMessageResource( BusinessRuleKeys.ERROR_MANDATORY_PART2);
                brmList.add(new BusinessRuleMessage(genderBlankErrorArray[0], genderBlankErrorArray[1], BusinessRuleMessage.Severity.ERROR));
            }
        }
        
        if (brmList.size() > 0) {
            return new BusinessRuleResult(false, brmList);
        } else {
            return new BusinessRuleResult();
        }

    }
    
}
