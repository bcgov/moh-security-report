/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.plr.service.validators;

import ca.bc.gov.health.plr.ejb.entity.OwnableEntity;
import ca.bc.gov.health.plr.ejb.entity.PrsProviders;
import ca.bc.gov.health.plr.ejb.entity.PrsWorkLocationDetails;
import ca.bc.gov.health.plr.ejb.entity.PrsWorkLocations;
import ca.bc.gov.health.plr.service.provider.ProviderAuthorizationService;
import ca.bc.gov.health.plr.util.PropertyUtils;
import javax.ejb.EJB;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;

/**
 * Class to invoke the providerAuthorizationService for data owner code
 * validation.
 *
 * @author sumesh.kariyil
 * @param <T>
 */
@LocalBean
@Stateless
public class DataOwnerCodeValidator<T> implements EntityValidator<T> {

    @EJB
    private ProviderAuthorizationService providerAuthorizationService;

    @Override
    public void validate(T entity) throws EntityValidationException {
        if (entity instanceof PrsProviders) {
            providerAuthorizationService.applyDataOwnerCode((PrsProviders) entity);
        } else if (entity instanceof OwnableEntity || entity instanceof PrsWorkLocationDetails) {
            if (PropertyUtils.doesPropertyExist(entity, "pauthPauthId")) {
                PrsProviders provider = (PrsProviders) PropertyUtils.invokeGetter(entity, "pauthPauthId");
                //handle work location child
                if (provider == null && PropertyUtils.doesPropertyExist(entity, "wlWlId")) {
                    PrsWorkLocations workLocation = (PrsWorkLocations) PropertyUtils.invokeGetter(entity, "wlWlId");
                    if (workLocation != null) {
                        providerAuthorizationService.checkWlDataOwnerCode((OwnableEntity) entity, workLocation.getPauthPauthId());
                    }
                } else {
                    //Handle work location detail here (as there is no data owner code for work location details, check DPS for PRS_WORK_LOCATION
                    if(entity instanceof PrsWorkLocationDetails){
                        PrsWorkLocationDetails wlDetails = (PrsWorkLocationDetails) entity;                        
                        providerAuthorizationService.checkDataOwnerCode((OwnableEntity) wlDetails.getWlWlId(), provider);
                    } else {
                        providerAuthorizationService.checkDataOwnerCode((OwnableEntity) entity, provider);
                    }
                }
            }
        }
    }

}
