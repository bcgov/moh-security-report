package ca.bc.gov.health.plr.rule.provider;

import ca.bc.gov.health.plr.ejb.entity.GrsRegistryUsers;
import ca.bc.gov.health.plr.ejb.entity.PrsCtProvCredentialTypes;
import ca.bc.gov.health.plr.ejb.entity.PrsProviderCredentials;
import ca.bc.gov.health.plr.ejb.entity.PrsProviders;
import ca.bc.gov.health.plr.persistence.BusinessRuleKeys;
import ca.bc.gov.health.plr.persistence.BusinessRuleMessageDao;
import ca.bc.gov.health.plr.persistence.CodesDao;
import ca.bc.gov.health.plr.rule.BusinessRule;
import ca.bc.gov.health.plr.rule.BusinessRuleMessage;
import ca.bc.gov.health.plr.rule.BusinessRuleResult;
import java.util.ArrayList;
import java.util.List;
import javax.ejb.EJB;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;

/**
 * Validates that the given registry user is allowed to add Credentials
 * (PRS_PROVIDER_CREDENTIALS) associated with the given Provider.
 *
 * @author David Sharpe <david.a.sharpe@cgi.com>
 */
@Stateless
@LocalBean
public class ValidateAllowedCredentialType implements BusinessRule, RecordTypeDpsCheck {

    @EJB
    private CodesDao codesDao;

    /**
     * Validates that the given registry user is allowed to add Credentials
     * (PRS_PROVIDER_CREDENTIALS) associated with the given Provider.
     *
     * @param provider the Provider containing the Credentials to be added.
     * @param regUser the registry user performing the add.
     * @return the validation result.
     */
    @Override
    public BusinessRuleResult validate(PrsProviders provider, GrsRegistryUsers regUser) {

        BusinessRuleKeys key = BusinessRuleKeys.ERROR_DISALLOWED_CREDENTIAL_TYPE;
        String messageFormat = BusinessRuleMessageDao.getMessageResource(key);

        List<PrsCtProvCredentialTypes> allowedTypes = codesDao.getCredentialTypesForAdd(regUser, provider.getHptCode());
        List<BusinessRuleMessage> messages = new ArrayList<>();
        for (PrsProviderCredentials credential : provider.getPrsProviderCredentialsList()) {
            PrsCtProvCredentialTypes credentialType = credential.getProviderCredentialTypeCode();
            if (!allowedTypes.contains(credentialType)) {
                String message = String.format(messageFormat, credentialType.getCtlNameCode());
                messages.add(new BusinessRuleMessage(message, BusinessRuleMessage.Severity.ERROR));
            }
        }
        if (!messages.isEmpty()) {
            return new BusinessRuleResult(false, messages);
        }

        return new BusinessRuleResult();

    }

}
