/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.plr.service.validators;

import ca.bc.gov.health.plr.ejb.entity.GrsAccessProfileGroups;
import ca.bc.gov.health.plr.ejb.entity.GrsCtBooleanTypes;
import ca.bc.gov.health.plr.persistence.BusinessRuleKeys;
import ca.bc.gov.health.plr.persistence.BusinessRuleMessageDao;
import ca.bc.gov.health.plr.persistence.CodeTableCodes;
import ca.bc.gov.health.plr.persistence.CodesDao;
import java.util.List;
import javax.ejb.EJB;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;

/**
 * Validates whether the DPS name is unique
 * @author sumesh.kariyil
 */
@LocalBean
@Stateless
public class DpsUniqueValidator implements EntityValidator<GrsAccessProfileGroups>{
    
    @PersistenceContext(unitName = "PLR-ejbPU")
    private EntityManager em;
    
    @EJB
    private CodesDao codesDao;

    @Override
    public void validate(GrsAccessProfileGroups entity) throws EntityValidationException {
        GrsCtBooleanTypes active = codesDao.lookup(GrsCtBooleanTypes.class, CodeTableCodes.GrsCtBooleanTypes.YES);
        TypedQuery<GrsAccessProfileGroups> dpsQuery = em.createNamedQuery("GrsAccessProfileGroups.findByGroupChid", GrsAccessProfileGroups.class)
                .setParameter(1, active.getCtlId())
                .setParameter(2, entity.getApgId() == null ? 0 : entity.getApgId())
                .setParameter(3, entity.getAccessProfileGroupChid());
        List<GrsAccessProfileGroups> dps = dpsQuery.getResultList();
        if(dps != null && dps.size() > 0){
            throw new EntityValidationException(BusinessRuleMessageDao.getMessageResource(BusinessRuleKeys.ERROR_DPS_ID_UNIQUE));
        }
    }
    
}
