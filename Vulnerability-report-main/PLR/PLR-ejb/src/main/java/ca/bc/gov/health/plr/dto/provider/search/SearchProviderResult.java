package ca.bc.gov.health.plr.dto.provider.search;

import ca.bc.gov.health.plr.dto.provider.ProviderDto;
import ca.bc.gov.health.plr.rule.BusinessRuleMessage;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

/**
 * Search Provider result transfer object. Encapsulates result records and the
 * time it took for the search to execute.
 *
 * @author Grant.Hodgins
 */
public class SearchProviderResult {

    private Long searchStartTime;
    private List<ProviderDto> searchResults = new ArrayList<>();
    private Long dataAccessEventId;
    private final List<BusinessRuleMessage> messages = new ArrayList<>();
    private BigDecimal lengthOfTimeToSearch = BigDecimal.ZERO;
    private boolean runOnce = false;

    /**
     * Note: SearchProviderResult contains a timer that starts an instantiation,
     * so don't execute the query before instantiation.
     */
    public SearchProviderResult() {
        super();
        searchStartTime = System.currentTimeMillis();
    }

    /**
     * Calculate the length of time in seconds the search took to perform to the
     * point of rendering the results.
     *
     * @return the elapsed time for the search to complete in seconds
     */
    public BigDecimal getSearchTime() {

        // Don't change the time if it has already been calculated
        if (searchStartTime != null && !runOnce) {
            lengthOfTimeToSearch = new BigDecimal(System.currentTimeMillis() - searchStartTime);
            lengthOfTimeToSearch = lengthOfTimeToSearch.divide(BigDecimal.valueOf(1000));
            runOnce = true;
        }

        return lengthOfTimeToSearch;
    }

    /**
     * Convenience method to query the provider id within a search result set.
     *
     * @return the provider id or 0 if the result set is empty.
     */
    public Long getPauthIdOfFirstResult() {
        Long result = 0l;
        if (searchResults != null && searchResults.size() > 0) {
            result = searchResults.get(0).getPauthId();
        }
        return result;
    }

    /**
     * @return the searchStartTime
     */
    public Long getSearchStartTime() {
        return searchStartTime;
    }

    /**
     * @return the searchResults
     */
    public List<ProviderDto> getSearchResults() {
        return searchResults;
    }

    /**
     * @param searchResults the searchResults to set
     */
    public void setSearchResults(List<ProviderDto> searchResults) {
        this.searchResults = searchResults;
    }

    public Long getDataAccessEventId() {
        return dataAccessEventId;
    }

    public void setDataAccessEventId(Long dataAccessEventId) {
        this.dataAccessEventId = dataAccessEventId;
    }

    /**
     * Add a message to be sent to the client.
     *
     * @param message the message.
     */
    public void addMessage(BusinessRuleMessage message) {
        messages.add(message);
    }

    /**
     * Adds a list of messages to be sent to the client.
     *
     * @param messages the list of messages.
     */
    public void addMessages(List<BusinessRuleMessage> messages) {
        this.messages.addAll(messages);
    }

    /**
     * @return a list of messages to be sent to the client.
     */
    public List<BusinessRuleMessage> getMessages() {
        return messages;
    }
}
