package ca.bc.gov.health.plr.rule.provider;

import ca.bc.gov.health.plr.dto.provider.RegistryUserRelationshipDto;
import ca.bc.gov.health.plr.ejb.entity.GrsRegistryUsers;
import ca.bc.gov.health.plr.persistence.BusinessRuleKeys;
import ca.bc.gov.health.plr.persistence.BusinessRuleMessageDao;
import ca.bc.gov.health.plr.rule.BusinessRule;
import ca.bc.gov.health.plr.rule.BusinessRuleMessage;
import ca.bc.gov.health.plr.rule.BusinessRuleResult;
import ca.bc.gov.health.plr.service.provider.MaintainRegistryUserRelationshipService;
import java.util.Arrays;
import java.util.List;
import javax.annotation.PostConstruct;
import javax.ejb.EJB;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;

/**
 * Validates the the given Registry User ID uniquely identifies a single
 * Registry User.
 *
 * @author David Sharpe <david.a.sharpe@cgi.com>
 */
@Stateless
@LocalBean
public class ValidateRegisitryUserIdUniquelyIdentifies implements BusinessRule {

    @EJB
    private MaintainRegistryUserRelationshipService service;

    private BusinessRuleMessage businessRuleMessage;

    @PostConstruct
    public void postConstruct() {
        BusinessRuleKeys key = BusinessRuleKeys.ERROR_NONUNIQUE_REG_USER_IDENTIFIER;
        String message = BusinessRuleMessageDao.getMessageResource(key);
        businessRuleMessage = new BusinessRuleMessage(message, BusinessRuleMessage.Severity.ERROR);
    }

    /**
     * Validates that the given Registry User ID uniquely identifies a single
     * Registry User.
     *
     * @param dto
     * @return the result of the validation.
     */
    public BusinessRuleResult validateUniquelyIdentifies(RegistryUserRelationshipDto dto) {
        List<GrsRegistryUsers> users = service.getMatchingRegistryUsers(dto);
        if (users.size() != 1) {
            return new BusinessRuleResult(false, Arrays.asList(businessRuleMessage));
        }
        return new BusinessRuleResult();
    }

}
