package ca.bc.gov.health.plr.rule.provider;

import ca.bc.gov.health.plr.ejb.entity.GrsAddresses;
import ca.bc.gov.health.plr.ejb.entity.GrsRegistryUsers;
import ca.bc.gov.health.plr.ejb.entity.PrsCtCommunPurposeTypes;
import ca.bc.gov.health.plr.ejb.entity.PrsProviders;
import ca.bc.gov.health.plr.persistence.BusinessRuleKeys;
import ca.bc.gov.health.plr.persistence.BusinessRuleMessageDao;
import ca.bc.gov.health.plr.persistence.CodesDao;
import ca.bc.gov.health.plr.rule.BusinessRule;
import ca.bc.gov.health.plr.rule.BusinessRuleMessage;
import ca.bc.gov.health.plr.rule.BusinessRuleResult;
import java.util.ArrayList;
import java.util.List;
import javax.ejb.EJB;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;

/**
 * Validates that the given registry user is allowed to add Addresses
 * (GRS_ADDRESSES) associated with the given Provider.
 *
 * @author David Sharpe <david.a.sharpe@cgi.com>
 */
@Stateless
@LocalBean
public class ValidateAllowedAddressPurposeType implements BusinessRule, RecordTypeDpsCheck {

    @EJB
    private CodesDao codesDao;

    /**
     * Validates that the given registry user is allowed to add Addresses
     * (GRS_ADDRESSES) associated with the given Provider.
     *
     * @param provider the Provider containing the Addresses to be added.
     * @param regUser the registry user performing the add.
     * @return the validation result.
     */
    @Override
    public BusinessRuleResult validate(PrsProviders provider, GrsRegistryUsers regUser) {

        BusinessRuleKeys key = BusinessRuleKeys.ERROR_DISALLOWED_ADDRESS_COMMUNICATION_PURPOSE_TYPE;
        String messageFormat = BusinessRuleMessageDao.getMessageResource(key);

        List<PrsCtCommunPurposeTypes> allowedTypes = codesDao.getAddressPurposeTypesForAdd(regUser, provider.getHptCode());
        List<BusinessRuleMessage> messages = new ArrayList<>();
        for (GrsAddresses address : provider.getGrsAddressesList()) {
            if (!allowedTypes.contains(address.getCmnctnPrpsTypCd())) {
                String message = String.format(messageFormat, address.getCmnctnPrpsTypCd().getCtlNameCode());
                messages.add(new BusinessRuleMessage(message, BusinessRuleMessage.Severity.ERROR));
            }
        }
        if (!messages.isEmpty()) {
            return new BusinessRuleResult(false, messages);
        }

        return new BusinessRuleResult();

    }

}
