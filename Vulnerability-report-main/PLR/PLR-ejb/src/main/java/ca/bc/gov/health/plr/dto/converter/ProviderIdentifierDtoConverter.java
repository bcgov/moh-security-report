package ca.bc.gov.health.plr.dto.converter;

import ca.bc.gov.health.plr.dto.provider.CollegeIdentifierDto;
import ca.bc.gov.health.plr.ejb.entity.GrsCtBooleanTypes;
import ca.bc.gov.health.plr.ejb.entity.GrsCtEndReasonTypes;
import ca.bc.gov.health.plr.ejb.entity.GrsIdentifiers;
import ca.bc.gov.health.plr.ejb.entity.PrsCtDataOwnerCodes;
import ca.bc.gov.health.plr.ejb.entity.PrsCtIdentifierTypes;
import ca.bc.gov.health.plr.ejb.entity.PrsProviderSubRoles;
import ca.bc.gov.health.plr.ejb.entity.PrsProviders;
import ca.bc.gov.health.plr.ejb.entity.util.DatabaseConstants;
import ca.bc.gov.health.plr.ejb.entity.util.EntityUtils;
import ca.bc.gov.health.plr.persistence.CodesDao;
import java.util.logging.Logger;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;

/**
 * Used to convert (for persistence) the identifier of a given Provider The
 * example would be Registered Nurse (RoleType) with ID of X
 *
 * @author ian.scott
 */
@Stateless
public class ProviderIdentifierDtoConverter {

    private static final Logger logger = Logger.getLogger(ProviderIdentifierDtoConverter.class.getName());
    @PersistenceContext(unitName = "PLR-ejbPU")
    EntityManager em;
    @EJB
    CodesDao codesDao;
    @EJB
    DtoConverter dtoConverter;    

    /**
     * Assemble Entity from transfer object
     *
     * @param dto - the transfer object to convert
     * @return - the entity representation of the transfer object
     */
    public GrsIdentifiers toEntity(CollegeIdentifierDto dto) {
        GrsIdentifiers newIdentifier = new GrsIdentifiers();

        if (dto.getId() != null) {
            newIdentifier.setPidId(dto.getId());
        }

        if (dto.getIdentifier() != null) {
            newIdentifier.setProviderChid(dto.getIdentifier());
        }

        //set the pauth
        if (dto.getPauthId() != null) {
            newIdentifier.setPauthPauthId(em.find(PrsProviders.class, dto.getPauthId()));
        }

        if (dto.getTypeId() != null) {
            newIdentifier.setIdentifierTypeCode(codesDao.lookup(PrsCtIdentifierTypes.class, dto.getTypeId()));
        } else if(dto.getTypeCode() != null){
            newIdentifier.setIdentifierTypeCode(codesDao.lookup(PrsCtIdentifierTypes.class, dto.getTypeCode()));
        }
        if (dto.getDataOwnerCode() != null) {
            //Long Required.
            //TODO catch failure
            PrsCtDataOwnerCodes dataOwnerCode = null;
            dataOwnerCode = codesDao.lookup(PrsCtDataOwnerCodes.class, dto.getDataOwnerCode());

            newIdentifier.setDataOwnerCode(dataOwnerCode);
        }
        if (dto.getPsrPsrID() != null) {
            PrsProviderSubRoles psrPsrId = new PrsProviderSubRoles();
            psrPsrId.setPsrId(dto.getPsrPsrID());
            newIdentifier.setPsrPsrId(psrPsrId);
        }
        
        dtoConverter.copyCommonProperties(dto, newIdentifier);

        return newIdentifier;
    }
}
