/*
 * *********************************************************************************************************************
 *  Copyright (c) 2018, Ministry of Health, BC.                                                                        *
 *                                                                                                                     *
 *  All rights reserved.                                                                                               *
 *    This information contained herein may not be used in whole                                                       *
 *    or in part without the express written consent of the                                                            *
 *    Government of British Columbia, Canada.                                                                          *
 *                                                                                                                     *
 *  Revision Control Information                                                                                       *
 *  File:                $Id::                                                                                       $ *
 *  Date of Last Commit: $Date::                                                                                     $ *
 *  Revision Number:     $Rev::                                                                                      $ *
 *  Last Commit by:      $Author::                                                                                   $ *
 *                                                                                                                     *
 * *********************************************************************************************************************
 */
package ca.bc.gov.health.plr.rule.provider;

import ca.bc.gov.health.plr.dto.provider.TelecommunicationDto;
import ca.bc.gov.health.plr.persistence.CodesDao;
import ca.bc.gov.health.plr.util.CodeDaoMocks;
import java.util.Date;
import javax.validation.ConstraintValidatorContext;
import org.junit.Test;
import static org.junit.Assert.*;
import static org.mockito.Matchers.anyString;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

/**
 * Validator testing the rules in telecom DTO and emergency contact in location
 * DTO.
 *
 * @author CGI Information Management Consultants Inc.
 */
public class TelecomNumberTypeValidatorTest {

    @Test
    public void testIsValid() {

        TelecomCrossFieldValidator tcfv = new TelecomCrossFieldValidator();
        CodesDao codesDao = mock(CodesDao.class);

        CodeDaoMocks.setupCodesDaoMocks(codesDao);

        tcfv.codesDao = codesDao;

        assertTrue(tcfv.isValid(new TelecommunicationDto() {
            {
                setCommunicationPurposeCode(CodeDaoMocks.EMERGENCY_CONTACT_CODE_NAME);
                setTypeCode(CodeDaoMocks.TELECOM_PHONE_CD);
                setTypeId(CodeDaoMocks.TELECOM_PHONE_CD_ID);
                setEffectiveStartDate(new Date());
            }
        }, makeConstraintValidatorContext()));

        assertTrue(tcfv.isValid(new TelecommunicationDto() {
            {
                setCommunicationPurposeCode(CodeDaoMocks.EMERGENCY_CONTACT_CODE_NAME);
                setTypeCode(CodeDaoMocks.TELECOM_MOBILE_CD);
                setEffectiveStartDate(new Date());
            }
        }, makeConstraintValidatorContext()));

        assertTrue(tcfv.isValid(new TelecommunicationDto() {
            {
                setCommunicationPurposeCode(CodeDaoMocks.NOT_EMERGENCY_CONTACT_CODE_NAME);
                setTypeCode(CodeDaoMocks.TELECOM_MOBILE_CD);
                setEffectiveStartDate(new Date());
            }
        }, makeConstraintValidatorContext()));

        assertTrue(tcfv.isValid(new TelecommunicationDto() {
            {
                setCommunicationPurposeCode(CodeDaoMocks.NOT_EMERGENCY_CONTACT_CODE_NAME);
                setTypeCode(CodeDaoMocks.TELECOM_FAX_CD);
                setEffectiveStartDate(new Date());
            }
        }, makeConstraintValidatorContext()));

        assertFalse(tcfv.isValid(new TelecommunicationDto() {
            {
                setCommunicationPurposeCode(CodeDaoMocks.EMERGENCY_CONTACT_CODE_NAME);
                setTypeCode(CodeDaoMocks.TELECOM_FAX_CD);
                setTypeId(CodeDaoMocks.TELECOM_FAX_CD_ID);
                setEffectiveStartDate(new Date());
            }
        }, makeConstraintValidatorContext()));
        
        assertFalse(tcfv.isValid(new TelecommunicationDto() {
            {
                setCommunicationPurposeCode("invalidcd");
                setTypeCode(CodeDaoMocks.TELECOM_FAX_CD);
                setTypeId(CodeDaoMocks.TELECOM_FAX_CD_ID);
                setEffectiveStartDate(new Date());
            }
        }, makeConstraintValidatorContext()));

    }

    private ConstraintValidatorContext makeConstraintValidatorContext() {
        ConstraintValidatorContext context = mock(ConstraintValidatorContext.class);
        ConstraintValidatorContext.ConstraintViolationBuilder mocBuilder = mock(ConstraintValidatorContext.ConstraintViolationBuilder.class);
        when(mocBuilder.addNode(anyString())).thenReturn(mock(ConstraintValidatorContext.ConstraintViolationBuilder.NodeBuilderDefinedContext.class));
        when(context.buildConstraintViolationWithTemplate(anyString())).thenReturn(mocBuilder);
        return context;
    }

}
