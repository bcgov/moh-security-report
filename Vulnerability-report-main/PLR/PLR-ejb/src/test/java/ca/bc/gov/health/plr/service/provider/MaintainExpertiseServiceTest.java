/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.plr.service.provider;

import ca.bc.gov.health.plr.dto.provider.ExpertiseDto;
import ca.bc.gov.health.plr.ejb.entity.PrsProviderExpertises;
import ca.bc.gov.health.plr.ejb.entity.PrsProviders;
import ca.bc.gov.health.plr.rule.BusinessRuleException;
import ca.bc.gov.health.plr.rule.provider.ProviderTestDataBuilder;
import static ca.bc.gov.health.plr.service.provider.IntegrationSetup.maintainExpertiseService;
import ca.bc.gov.health.plr.service.validators.EntityValidationException;
import java.util.ArrayList;
import java.util.List;
import org.junit.After;
import org.junit.Test;
import static org.junit.Assert.*;

/**
 *
 * @author adebiyi.kuseju
 */
public class MaintainExpertiseServiceTest extends IntegrationSetup {

    private static final long PAUTH_ID = 5011;

    @After
    public void tearDown() {
        List<Exception> exceptions = new ArrayList<>();

        PrsProviders provider = entityManagerProxy.find(PrsProviders.class, PAUTH_ID);
        for (PrsProviderExpertises name : provider.getPrsProviderExpertisesList()) {
            try {
                entityManagerProxy.remove(name);
            } catch (Exception e) {
                e.printStackTrace();
                exceptions.add(e);
            }
        }
        if (!exceptions.isEmpty()) {
            throw new IllegalStateException("Exceptions occurred while deleting entities. Check log for details.");
        }
    }

    /**
     * Test of save method.
     *
     * @throws ca.bc.gov.health.plr.service.provider.DuplicateRecordException
     */
    @Test
    public void testAddExpertise() throws DuplicateRecordException, EntityValidationException, BusinessRuleException {
        ExpertiseDto newEntity = ProviderTestDataBuilder.getExpertise();
        newEntity.setRoleTypeCode("DEN");
//        newEntity.setDataOwnerCode("MOH");
        newEntity.setTypeId(1405L);
        newEntity.setPauthId(PAUTH_ID);
        
        int originalCount = maintainExpertiseService.getExpetises(PAUTH_ID).size();

        maintainExpertiseService.save(newEntity);
        
        List<ExpertiseDto> expertises = maintainExpertiseService.getExpetises(PAUTH_ID);
        int newCount = expertises.size();
        assertEquals(originalCount + 1, newCount);
        assertEquals("DEN", expertises.get(0).getRoleTypeCode());
    }
}
