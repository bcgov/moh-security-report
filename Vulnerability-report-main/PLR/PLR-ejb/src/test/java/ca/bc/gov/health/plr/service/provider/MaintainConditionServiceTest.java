/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.plr.service.provider;

import ca.bc.gov.health.plr.dto.provider.ConditionsDto;
import ca.bc.gov.health.plr.ejb.entity.PrsConditions;
import ca.bc.gov.health.plr.ejb.entity.PrsProviders;
import ca.bc.gov.health.plr.rule.BusinessRuleException;
import ca.bc.gov.health.plr.rule.provider.ProviderTestDataBuilder;
import static ca.bc.gov.health.plr.service.provider.IntegrationSetup.entityManagerProxy;
import static ca.bc.gov.health.plr.service.provider.IntegrationSetup.maintainConditionService;
import ca.bc.gov.health.plr.service.validators.EntityValidationException;
import java.util.ArrayList;
import java.util.List;
import org.junit.After;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertTrue;
import org.junit.Before;
import org.junit.Test;

/**
 *
 * @author ian.scott
 */
public class MaintainConditionServiceTest extends IntegrationSetup {

    private static Long idToRemove;

    @Before
    public void init() {
        idToRemove = null;
    }

    @After
    public void cleanup() {
        if (idToRemove != null) {
            entityManagerProxy.remove(entityManagerProxy.find(PrsConditions.class, idToRemove));
        }
    }    
    
    /**
     * Test of save method .
     */
    @Test
    public void testAddCondition() throws EntityValidationException {

        ConditionsDto newEntity = ProviderTestDataBuilder.getConditions();
        newEntity.setPauthId(276l);

        PrsProviders provider = entityManagerProxy.find(PrsProviders.class, newEntity.getPauthId());
        List<PrsConditions> originalEntityList = provider.getPrsConditionsList();
        int originalEntityListSize = originalEntityList.size();
        List<Long> originalIds = new ArrayList<>();
        for (PrsConditions originalEntity : originalEntityList) {
            originalIds.add(originalEntity.getPresId());
        }
        ConditionsDto result = null;
        try {
            result = maintainConditionService.save(newEntity);
        } catch (DuplicateRecordException dre) {
            assertTrue(dre.getMessage().equals(""));
        }

        assertNotNull(result);

        provider = entityManagerProxy.find(PrsProviders.class, newEntity.getPauthId());
        assertEquals(originalEntityListSize + 1, provider.getPrsConditionsList().size());

        entityManagerProxy.remove(entityManagerProxy.find(PrsConditions.class, result.getId()));


    }
    
    /**
     * Test to ensure adding a record without an identifier populates it with a generated one.
     * REQ-00939
     *
     * @throws ca.bc.gov.health.plr.service.provider.DuplicateRecordException
     * @throws ca.bc.gov.health.plr.service.validators.EntityValidationException
     * @throws BusinessRuleException
     */
    @Test
    public void testGenerateIdentifier() throws DuplicateRecordException, EntityValidationException, BusinessRuleException {
        ConditionsDto newEntity = ProviderTestDataBuilder.getConditions();
        newEntity.setPauthId(276l);
        newEntity.setIdentifier(null);
        ConditionsDto result;
        result = maintainConditionService.save(newEntity);
        idToRemove = result.getId();
        assertTrue(result.getIdentifier()!=null && !"".equals(result.getIdentifier()));
    }    
}
