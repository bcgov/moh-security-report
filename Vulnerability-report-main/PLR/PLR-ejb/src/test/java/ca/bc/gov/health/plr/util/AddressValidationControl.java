/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.plr.util;

import ca.bc.gov.health.plr.constants.Consts;
import ca.bc.gov.health.plr.ejb.entity.PlrConfigurationProperties;
import static ca.bc.gov.health.plr.service.provider.IntegrationSetup.entityManagerProxy;
import static ca.bc.gov.health.plr.service.provider.IntegrationSetup.plrConfigurationResourceLoader;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 *
 * @author jonathan.wiebe
 */
public class AddressValidationControl {

    static String addrValState = "false";

    public static void turnOffAddressValidation() {
        addrValState = plrConfigurationResourceLoader.getValue(Consts.ADDRESS_VALIDATION_TOGGLE);
        PlrConfigurationProperties addrValToggle = entityManagerProxy.find(PlrConfigurationProperties.class, Consts.ADDRESS_VALIDATION_TOGGLE);
        addrValToggle.setValue("false");
        entityManagerProxy.merge(addrValToggle);
        entityManagerProxy.flush();

        waitABit();
    }

    public static void turnOnAddressValidation() {
        addrValState = plrConfigurationResourceLoader.getValue(Consts.ADDRESS_VALIDATION_TOGGLE);
        PlrConfigurationProperties addrValToggle = entityManagerProxy.find(PlrConfigurationProperties.class, Consts.ADDRESS_VALIDATION_TOGGLE);
        addrValToggle.setValue("true");
        entityManagerProxy.merge(addrValToggle);
        entityManagerProxy.flush();

        waitABit();
    }

    public static void waitABit() {
        try {
            // let the change happen
            Thread.sleep(10000l);
        } catch (InterruptedException ex) {
            Logger.getLogger(AddressValidationControl.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

    public static void restoreAddressValidation() {
        String currentState = plrConfigurationResourceLoader.getValue(Consts.ADDRESS_VALIDATION_TOGGLE);
        if (currentState != null && !currentState.equals(addrValState)) {
            PlrConfigurationProperties addrValToggle = entityManagerProxy.find(PlrConfigurationProperties.class, Consts.ADDRESS_VALIDATION_TOGGLE);
            addrValToggle.setValue(addrValState);
            entityManagerProxy.merge(addrValToggle);
            entityManagerProxy.flush();

            waitABit(); // let the change happen
        }
    }

}
