/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.plr.service.registry.user;

import ca.bc.gov.health.plr.dto.reguser.DistributionDto;
import ca.bc.gov.health.plr.ejb.entity.GrsDistributionProfiles;
import ca.bc.gov.health.plr.ejb.entity.GrsRegistryUsers;
import ca.bc.gov.health.plr.rule.BusinessRuleException;
import ca.bc.gov.health.plr.rule.provider.ProviderTestDataBuilder;
import ca.bc.gov.health.plr.service.provider.IntegrationSetup;
import static ca.bc.gov.health.plr.service.provider.IntegrationSetup.entityManagerProxy;
import ca.bc.gov.health.plr.service.provider.DuplicateRecordException;
import ca.bc.gov.health.plr.service.validators.EntityValidationException;
import java.util.ArrayList;
import java.util.List;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import static org.junit.Assert.*;

/**
 *
 * @author sumesh.kariyil
 */
public class MaintainDistributionServiceTest extends IntegrationSetup{
    
    private static Long idToRemove;

    @Before
    public void init() {
        idToRemove = null;
    }

    @After
    public void cleanup() {
        if (idToRemove != null) {
            entityManagerProxy.remove(entityManagerProxy.find(GrsDistributionProfiles.class, idToRemove));
        }
    }

    /**
     * Test of test save access profile method, of class
     * MaintainAccessProfile .
     * @throws ca.bc.gov.health.plr.rule.BusinessRuleException
     */
    @Test
    public void testAddDistribution() throws BusinessRuleException, EntityValidationException {
        DistributionDto newDist = ProviderTestDataBuilder.getDistributionDto();
        
        GrsRegistryUsers grsRegistryUsers = entityManagerProxy.find(GrsRegistryUsers.class, newDist.getRuRuId());
        List<GrsDistributionProfiles> distributions = grsRegistryUsers.getGrsDistributionProfilesList();

        List<Long> originalIds = new ArrayList<>();
        for (GrsDistributionProfiles distributionProfile : distributions) {
            originalIds.add(distributionProfile.getCdpId());
        }
        DistributionDto result = null;
        try {
            result = maintainDistributionService.saveDistribution(newDist);
        } catch (DuplicateRecordException dre) {
            assertTrue(dre.getMessage().equals(""));
        }
        assertNotNull(result);
        List<DistributionDto> allForRegUser = maintainDistributionService.refreshAllDistributions(newDist);
        assertEquals(allForRegUser.size(), grsRegistryUsers.getGrsDistributionProfilesList().size() + 1);

        for (DistributionDto distributionDto : allForRegUser) {
            if (!originalIds.contains(distributionDto.getId())) {
                entityManagerProxy.remove(entityManagerProxy.find(GrsDistributionProfiles.class, distributionDto.getId()));
            }
        }

    }
    
    
    /**
     * Test of test save access profile method, of class
     * MaintainAccessProfile .
     * @throws ca.bc.gov.health.plr.rule.BusinessRuleException
     */
    @Test
    public void testAddDistribution_invalidAddress() throws BusinessRuleException, EntityValidationException, DuplicateRecordException {
        DistributionDto newDist = ProviderTestDataBuilder.getDistributionDto();
        newDist.setDestAddress("http://kdjfdjh.%kjjkkkds.com");
        
        try {
            maintainDistributionService.saveDistribution(newDist);
        } catch (EntityValidationException dre) {
            assertTrue(dre.getMessage().contains("The destination address URL is invalid."));
        }
    }

    /**
     * Test to ensure adding a duplicate record throws an exception
     * @throws DuplicateRecordException
     * @throws BusinessRuleException 
     */
    @Test
    public void testAddDuplicate() throws DuplicateRecordException, BusinessRuleException, EntityValidationException {
        DistributionDto newDist = ProviderTestDataBuilder.getDistributionDto();
        DistributionDto result;
        result = maintainDistributionService.saveDistribution(newDist);
        idToRemove = result.getId();

        newDist = ProviderTestDataBuilder.getDistributionDto();
        boolean exceptionThrown = false;
        try {
            maintainDistributionService.saveDistribution(newDist);
        } catch (DuplicateRecordException | EntityValidationException dre) {
            exceptionThrown = true;
        }
        assertTrue(exceptionThrown);
    }

    
}
