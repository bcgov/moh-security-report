/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.esb.service.query;

import ca.bc.gov.health.plr.dto.esb.QueryRequest;
import ca.bc.gov.moh.hsa.plr.esb.service.maintain.MessageIdExtractor;
import ca.bc.gov.moh.hsa.plr.esb.service.util.SetTransportLayerSecurity;
import org.apache.camel.builder.RouteBuilder;
import org.apache.camel.builder.xml.Namespaces;
import org.apache.camel.converter.jaxb.JaxbDataFormat;
import org.apache.camel.spi.DataFormat;
import org.hl7.v3.m4_16.PRPMIN306011UV01;
import org.springframework.stereotype.Component;

/**
 *
 * @author conrad.gustafson
 */
@Component
public class QueryServiceRouteBuilder extends RouteBuilder {

    @Override
    public void configure() throws Exception {
        
        //Set the https to use TLSv1.2
        SetTransportLayerSecurity.getRegistry();

        String incomingEndpointURI = "cxf://queryProviders?wsdlURL=wsdl/PRPM_AR300013CA.wsdl&dataFormat=MESSAGE";

        DataFormat jaxb = new JaxbDataFormat("org.hl7.v3.m4_16");
        Namespaces ns = new Namespaces("soapenv", "http://schemas.xmlsoap.org/soap/envelope/");
        ns.add("v3", "urn:hl7-org:v3");

        from(incomingEndpointURI)
            .routeId("cxf://queryProviders")
            .log("The ${routeId} route received a request")
            .convertBodyTo(String.class)
            .to("audit:RECEIVE?transactionType=QUERYPROVIDERS&level=INFO")
            .to("messagedrop:RECEIVE")
            .transform(ns.xquery("//v3:PRPM_IN306010"))
            .to("validator:wsdl/PRPM_AR300013CA.xsd")
            .unmarshal(jaxb)
            .bean(MessageIdExtractor.class)
            .convertBodyTo(QueryRequest.class)
            .to("direct:plrQuery")
            .convertBodyTo(PRPMIN306011UV01.class)
            .bean(MessageIdExtractor.class)
            .marshal(jaxb)
            .convertBodyTo(String.class)
            .to("bean:namespaceRepairer")
            .to("audit:RESPOND?level=INFO")
            .to("messagedrop:RESPOND")
            .removeHeader("HSA_TRANSACTION")
            ;

    }
}
