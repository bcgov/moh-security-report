/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.esb.service.distribution;

import ca.bc.gov.health.plr.dto.esb.DistributionUpdate;
import ca.bc.gov.health.plr.dto.provider.esb.DistributionStatus;
import static ca.bc.gov.moh.hsa.plr.esb.service.distribution.DistributionAddressExtractor.MESSAGE_ID_HEADER;
import java.util.HashMap;
import java.util.Map;
import org.apache.camel.Exchange;

/**
 * Update PLR with the distribution status
 * @author greg.perkins
 */
public class DistributionStatusUpdater {

    /**
     * Process the exchange.  Sends a success message back to PLR
     *
     * @param exchange Exchange
     * @throws Exception
     */
    public void success(Exchange exchange) throws Exception {
        Map<String,DistributionStatus> statuses = new HashMap<>();
        String messageId = getMessageId(exchange);
        if (messageId!=null){
            statuses.put(messageId, DistributionStatus.PROCESSED);
        }
        DistributionUpdate du = new DistributionUpdate();
        du.setIsTransactionSuccess(true);
        du.setStatuses(statuses);  
        exchange.getOut().setBody(du);
    }
    
    /**
     * Process the exchange. Sends a failure message back to PLR
     *
     * @param exchange Exchange
     * @throws Exception
     */
    public void fail(Exchange exchange) throws Exception {
        Map<String,DistributionStatus> statuses = new HashMap<>();
        String messageId = getMessageId(exchange);
        if (messageId!=null){
            statuses.put(messageId, DistributionStatus.FAILED);
        }
        DistributionUpdate du = new DistributionUpdate();
        du.setIsTransactionSuccess(false);
        du.setStatuses(statuses);
        exchange.getOut().setBody(du);
    }   
    
    
    /**
     * Pull the messageID from the exchange
     * @param exchange Exchange
     * @return 
     */
    private String getMessageId(Exchange exchange){
        return (String)exchange.getIn().getHeader(MESSAGE_ID_HEADER);
    }
}
