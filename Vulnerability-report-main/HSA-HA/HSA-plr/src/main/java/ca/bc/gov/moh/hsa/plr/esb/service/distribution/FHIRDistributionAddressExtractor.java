/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.esb.service.distribution;

import ca.bc.gov.health.plr.dto.esb.DistributionNotification;
import ca.bc.gov.moh.hsa.plr.esb.service.util.GetFacilityDistributionBundleID;
import ca.bc.gov.moh.hsa.plr.esb.service.util.GetFacilityIFC;
import org.apache.camel.Exchange;
import org.springframework.stereotype.Component;

/**
 *
 * @author jonathan.wiebe
 */
@Component
public class FHIRDistributionAddressExtractor {

    public static String FHIR_DISTRIBUTION_CONSUMER_ADDRESS = "FHIRDistributionConsumerAddress";

    /**
     * This method adds the Bundle/<distrib event item id> suffix of the URL that get passed into the ESB
     * All distributions will be sent to POST/PUT and https4://<domain>/<path>/Bundle/<distrib event item id>
     * @param exchange
     * @throws Exception 
     */
    public void process(Exchange exchange) throws Exception {
        DistributionNotification body = exchange.getIn().getBody(DistributionNotification.class);
        exchange.getIn().setHeader(FHIR_DISTRIBUTION_CONSUMER_ADDRESS, body.getDestinationAddress().replaceFirst("https", "https4") + "/Bundle/"+GetFacilityDistributionBundleID.getFacilityDistributionEventID(body));
        exchange.getIn().setHeader(DistributionAddressExtractor.MESSAGE_ID_HEADER, body.getDistributionId());
    }
}
