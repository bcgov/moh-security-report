/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.esb.service.maintain;

import org.springframework.stereotype.Component;
import org.apache.camel.Exchange;
import org.apache.camel.Processor;

/**
 *
 * @author conrad.gustafson
 */
@Component
public class NamespaceRepairer implements Processor {

    private static final String XML_DECLARATION = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>";
    
    @Override
    public void process(Exchange exchange) throws Exception {
        String output = (String) exchange.getIn().getBody();
        output = repairOutput(output);
        exchange.getIn().setBody(output);
    }
    
    /**
     * Fixes namespace declarations and adds the soap wrapper around the XML data
     * @param message 
     * @return 
     */
    private static String repairOutput(String message){
        message = message.replace("xmlns:ns2=", "xmlns=");
        message = message.replace("ns2:", "");
        message = message.replaceAll("<\\?xml.*\\?>","");
        message = XML_DECLARATION+"<soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"><soap:Header/><soap:Body>"+message+"</soap:Body></soap:Envelope>";
        return message;
    }

}
