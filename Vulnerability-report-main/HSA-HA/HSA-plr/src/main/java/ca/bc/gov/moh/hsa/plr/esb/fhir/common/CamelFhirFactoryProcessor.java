/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.esb.fhir.common;

import org.apache.camel.Exchange;
import org.apache.camel.Processor;

/**
 * Adds a FHIRFactory to the exchange based on the Accept Header
 * @author greg.perkins
 */
public class CamelFhirFactoryProcessor implements Processor{
    
    @Override
    public void process(Exchange exchange) throws Exception {
        String fhirVersion = "4";
        String bcFHIRVersion = "1";
        String accept = (String)exchange.getIn().getHeader("Accept");
        if (accept!=null){
            String[] parts = accept.split(";");
            for (String part:parts){
                String[] keyValue = part.split("=");
                if ("fhirVersion".equals(keyValue[0])){
                    fhirVersion = keyValue[1].trim();
                }
                if ("bcFHIRVersion".equals(keyValue[0])){
                    bcFHIRVersion = keyValue[1].trim();
                }                
            }
        }
        String version = "R"+fhirVersion;
        if (bcFHIRVersion!=null){
            version = version+"BC"+bcFHIRVersion;
        }
        FHIRFactory factory = new FHIRFactory(version);
        
        exchange.setProperty("FHIRFactory", factory);
            
    }
    
}
