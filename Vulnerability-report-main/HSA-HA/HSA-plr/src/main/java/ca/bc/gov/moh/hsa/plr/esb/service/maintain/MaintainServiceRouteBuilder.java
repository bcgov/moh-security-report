/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.esb.service.maintain;

import ca.bc.gov.health.plr.dto.esb.MaintainProviderRequest;
import ca.bc.gov.moh.hsa.plr.esb.service.util.SetTransportLayerSecurity;
import org.apache.camel.builder.RouteBuilder;
import org.apache.camel.builder.xml.Namespaces;
import org.apache.camel.converter.jaxb.JaxbDataFormat;
import org.springframework.stereotype.Component;
import org.apache.camel.spi.DataFormat;
import org.hl7.v3.m4_0.PRPMIN301011MCCIMT000300Message;
import org.hl7.v3.m4_0.PRPMIN303011MCCIMT000300Message;

/**
 *
 * @author conrad.gustafson
 */
@Component
public class MaintainServiceRouteBuilder extends RouteBuilder {

    @Override
    public void configure() throws Exception {
        
        //Set the https to use TLSv1.2
        SetTransportLayerSecurity.getRegistry();
        
        // Expose WS endpoint
        String incomingEndpointURI = "cxf://maintainProvider?wsdlURL=wsdl/PRPM_AR300004.wsdl&dataFormat=MESSAGE";

        DataFormat jaxb40 = new JaxbDataFormat("org.hl7.v3.m4_0");
        
        Namespaces ns = new Namespaces("soapenv", "http://schemas.xmlsoap.org/soap/envelope/");
        ns.add("v3", "urn:hl7-org:v3");
        
        from(incomingEndpointURI)
                .routeId("cxf://maintainProvider")
                .log("The ${routeId} route received a request")
                .inOut("direct:maintain");
        
        from("direct:maintainErrorResponse")
                .routeId("direct:maintainErrorResponse")
                .to("bean:maintainExceptionHandler")
                .marshal(jaxb40)
                .convertBodyTo(String.class)
                .to("audit:ERROR?level=ERROR&status=FAILED")
                .to("messagedrop:ERROR")
                .to("audit:COMPLETE?level=INFO&status=FAILED");
        
        from("direct:maintain")
                .routeId("direct:maintain")
                .onException(Throwable.class)
                    .handled(true)
                    .to("direct:maintainErrorResponse")
                .end()
                .convertBodyTo(String.class)
                .to("audit:RECEIVE?transactionType=MAINTAINPROVIDER&level=INFO")
                .to("messagedrop:RECEIVE")
                .choice()
                    .when(ns.xpath("//v3:PRPM_IN301010"))
                        .setHeader("SOAPAction",constant("PRPM_IN301010"))
                    .otherwise()
                        .setHeader("SOAPAction",constant("PRPM_IN303010"))
                .end()
                .transform(ns.xquery("(//v3:PRPM_IN301010 | //v3:PRPM_IN303010)[1]"))
                .to("validator:wsdl/PRPM_AR300004.xsd")
                .unmarshal(jaxb40)
                .bean(MessageIdExtractor.class)
                .convertBodyTo(MaintainProviderRequest.class)
                .to("direct:plrMaintain")
                .choice()
                    .when(header("SOAPAction").isEqualTo("PRPM_IN301010"))
                        .convertBodyTo(PRPMIN301011MCCIMT000300Message.class)
                    .otherwise()
                        .convertBodyTo(PRPMIN303011MCCIMT000300Message.class)
                .end()
                .bean(MessageIdExtractor.class)
                .marshal(jaxb40)
                .convertBodyTo(String.class)
                .to("bean:namespaceRepairer")
                .to("audit:RESPOND?level=INFO")
                .to("messagedrop:RESPOND")
                .removeHeader("HSA_TRANSACTION")
                .convertBodyTo(String.class)                
                ;
    }

}
