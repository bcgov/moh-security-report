/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.esb.service.distribution;

import ca.bc.gov.health.plr.dto.esb.Acknowledgment;
import static ca.bc.gov.moh.hsa.plr.esb.service.maintain.MessageIdExtractor.MESSAGE_ID_KEY;
import org.apache.camel.Exchange;
import org.springframework.stereotype.Component;

/**
 * Builds an ACK message in response to a distribution received from PLR
 *
 * @author greg.perkins
 */
@Component
public class DistributionAckBuilder {

    /**
     * Process the exchange. Sets the OUT message to be a positive Acknowledgment object
     *
     * @param exchange Exchange
     * @throws Exception
     */
    public void success(Exchange exchange) throws Exception {
        Acknowledgment ack = new Acknowledgment();
        String messageId = exchange.getIn().getHeader(MESSAGE_ID_KEY, String.class); 
        ack.setMsgCode("SUCCESS");
        ack.setMsgText("The distribution message was received successfully");
        ack.setTargetMessageID(messageId);
        ack.setTypeCode("AA");

        exchange.getOut().setBody(ack);
    }

    /**
     * Process the exchange. Sets the OUT message to be negative Acknowledgment object
     *
     * @param exchange Exchange
     * @throws Exception
     */
    public void fail(Exchange exchange) throws Exception {
        Acknowledgment ack = new Acknowledgment();

        Throwable caused = (Throwable) exchange.getProperty(Exchange.EXCEPTION_CAUGHT, Throwable.class);
        while (caused != null && caused.getCause() != null) {
            caused = caused.getCause();
        }

        String messageId = exchange.getIn().getHeader(MESSAGE_ID_KEY, String.class); 
        ack.setMsgCode("FAILURE");
        ack.setMsgText(caused.getMessage());
        ack.setTargetMessageID(messageId);
        ack.setTypeCode("AE");

        exchange.getOut().setBody(ack);
    }
}
