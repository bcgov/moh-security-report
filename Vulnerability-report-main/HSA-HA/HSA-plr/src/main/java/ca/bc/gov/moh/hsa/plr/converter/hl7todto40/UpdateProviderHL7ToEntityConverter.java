package ca.bc.gov.moh.hsa.plr.converter.hl7todto40;

import ca.bc.gov.moh.hsa.entity.AddressAttribute;
import ca.bc.gov.moh.hsa.entity.Attribute;
import ca.bc.gov.moh.hsa.entity.ConfidentialityMaskAttribute;
import ca.bc.gov.moh.hsa.entity.DateAttribute;
import ca.bc.gov.moh.hsa.entity.EmailAttribute;
import ca.bc.gov.moh.hsa.entity.GenderAttribute;
import ca.bc.gov.moh.hsa.entity.IdentifierAttribute;
import ca.bc.gov.moh.hsa.entity.Person;
import ca.bc.gov.moh.hsa.entity.PersonNameAttribute;
import ca.bc.gov.moh.hsa.entity.PhoneAttribute;
import ca.bc.gov.moh.hsa.plr.converter.hl7todto.AuditInfo;
import static ca.bc.gov.moh.hsa.plr.converter.hl7todto40.HL7_40_ToEntityConverter.PRIVILEGE_CATEGORIZATION_CODE;
import static ca.bc.gov.moh.hsa.plr.converter.hl7todto40.HL7_40_ToEntityConverter_WithProvider.getLowTime;
import ca.bc.gov.moh.hsa.plr.converter.utils.ConverterUtils;
import static ca.bc.gov.moh.hsa.plr.converter.utils.OidsUser.AUDIT_INFO_POINTER_OID;
import static ca.bc.gov.moh.hsa.plr.converter.utils.OidsUser.AUDIT_INFO_TARGET_OID;
import static ca.bc.gov.moh.hsa.plr.converter.utils.OidsUser.CONDITION_OID;
import static ca.bc.gov.moh.hsa.plr.converter.utils.OidsUser.CREDENTIAL_OID;
import static ca.bc.gov.moh.hsa.plr.converter.utils.OidsUser.DATA_OWNER_OID;
import static ca.bc.gov.moh.hsa.plr.converter.utils.OidsUser.DISCIPLINARYACTION_OID;
import static ca.bc.gov.moh.hsa.plr.converter.utils.OidsUser.WORKLOCATION_OID;
import ca.bc.gov.moh.hsa.plr.entity.transaction.ConditionAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.CredentialAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.DisciplinaryActionAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.ExpertiseAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.InformationRouteAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.MaintainProviderRequestEntity;
import ca.bc.gov.moh.hsa.plr.entity.transaction.NoteAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.ProviderAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.ProviderRelationshipAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.StatusAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.WorkLocationAttribute;
import ca.bc.gov.moh.hsa.plr.entity.transaction.WorkLocationDetailsAttribute;
import java.io.Serializable;
import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import javax.xml.bind.JAXBElement;
import org.apache.cxf.common.util.CollectionUtils;
import org.apache.cxf.common.util.StringUtils;
import org.hl7.v3.m4_0.AD;
import org.hl7.v3.m4_0.CD;
import org.hl7.v3.m4_0.CE;
import org.hl7.v3.m4_0.CR;
import org.hl7.v3.m4_0.ED;
import org.hl7.v3.m4_0.EN;
import org.hl7.v3.m4_0.HL7ControlActProcess;
import org.hl7.v3.m4_0.HL7HealthCareProvider;
import org.hl7.v3.m4_0.HL7RequestMessage;
import org.hl7.v3.m4_0.II;
import org.hl7.v3.m4_0.INT;
import org.hl7.v3.m4_0.IVLTS;
import org.hl7.v3.m4_0.MFMIMT700701Author2;
import org.hl7.v3.m4_0.ON;
import org.hl7.v3.m4_0.PRPMIN303010MFMIMT700701ControlActProcess;
import org.hl7.v3.m4_0.PRPMIN303010MFMIMT700701Subject1;
import org.hl7.v3.m4_0.PRPMIN303010MCCIMT000100Message;
import org.hl7.v3.m4_0.PRPMMT303010ActDefinitionOrEvent;
import org.hl7.v3.m4_0.PRPMMT303010ActDefinitionOrEventLocation;
import org.hl7.v3.m4_0.PRPMMT303010ActDefinitionOrEventLocationUpdateMode;
import org.hl7.v3.m4_0.PRPMMT303010ActDefinitionOrEventSequel;
import org.hl7.v3.m4_0.PRPMMT303010ActDefinitionOrEventSequelUpdateMode;
import org.hl7.v3.m4_0.PRPMMT303010AssignedEntity;
import org.hl7.v3.m4_0.PRPMMT303010ControlActEvent;
import org.hl7.v3.m4_0.PRPMMT303010Custodian;
import org.hl7.v3.m4_0.PRPMMT303010DisciplinaryAction;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderAddr;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderId;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderRelatedTo;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderResponsibleFor;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderStatusCode;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderSubjectOf1;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderSubjectOf4;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderTelecom;
import org.hl7.v3.m4_0.PRPMMT303010Note;
import org.hl7.v3.m4_0.PRPMMT303010Organization;
import org.hl7.v3.m4_0.PRPMMT303010Place;
import org.hl7.v3.m4_0.PRPMMT303010PrimaryPerformer3;
import org.hl7.v3.m4_0.PRPMMT303010PrincipalPerson;
import org.hl7.v3.m4_0.PRPMMT303010PrincipalPersonAdministrativeGenderCode;
import org.hl7.v3.m4_0.PRPMMT303010PrincipalPersonBirthTime;
import org.hl7.v3.m4_0.PRPMMT303010PrincipalPersonBirthplace;
import org.hl7.v3.m4_0.PRPMMT303010PrincipalPersonDeceasedTime;
import org.hl7.v3.m4_0.PRPMMT303010PrincipalPersonName;
import org.hl7.v3.m4_0.PRPMMT303010Privilege;
import org.hl7.v3.m4_0.PRPMMT303010PrivilegeCategorization;
import org.hl7.v3.m4_0.PRPMMT303010QualifiedEntity;
import org.hl7.v3.m4_0.PRPMMT303010RoleActivation;
import org.hl7.v3.m4_0.PRPMMT303010ServiceDeliveryLocation;
import org.hl7.v3.m4_0.PRPMMT303010ServiceDeliveryLocationAddr;
import org.hl7.v3.m4_0.PRPMMT303010ServiceDeliveryLocationTelecom;
import org.hl7.v3.m4_0.PRPMMT303010Subject3;
import org.hl7.v3.m4_0.PRPMMT303010Subject4;
import org.hl7.v3.m4_0.PRPMMT303010Subject6;
import org.hl7.v3.m4_0.PRPMMT303010TerritorialAuthority;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProvider;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderRelatedToUpdateMode;
import org.hl7.v3.m4_0.PRPMMT303010HealthCareProviderSubjectOf3;
import org.hl7.v3.m4_0.PRPMMT303010InformDefinition;
import org.hl7.v3.m4_0.PRPMMT303010InformRequest;
import org.hl7.v3.m4_0.PRPMMT303010InformRequestIndirectTarget;
import org.hl7.v3.m4_0.PRPMMT303010InformRequestSubject;
import org.hl7.v3.m4_0.ST;
import org.hl7.v3.m4_0.TEL;
import org.hl7.v3.m4_0.TS;

/**
 * Converts HL7 Update Provider Messages to internal ESB DTOs.
 *
 * Note that AddProviderHL7ToEntityConverter and
 * UpdateProviderHL7ToEntityConverter should be identical except where the
 * mapping rules are different. At the time of this writing, they differ only in
 * the setDemographicDetails method for setting birthday and gender.
 *
 * @see AddProviderHL7ToEntityConverter
 *
 * @author conrad.gustafson
 */
public class UpdateProviderHL7ToEntityConverter extends HL7_40_ToEntityConverter_WithProvider {

    public MaintainProviderRequestEntity convertPRPMIN303010ToEntity(PRPMIN303010MCCIMT000100Message requestMessage) {
        final MaintainProviderRequestEntity hl7RequestMessage = convertHL7RequestMessage(requestMessage);
        hl7RequestMessage.setMessageType("PRPM_IN303010");
        hl7RequestMessage.setMessageId(requestMessage.getId().getExtension());
        hl7RequestMessage.setInteractionId(requestMessage.getInteractionId().getExtension());
        return hl7RequestMessage;
    }

    @Override
    public HL7HealthCareProvider getHealthCareProvider(HL7RequestMessage providerMessage) {
        PRPMIN303010MCCIMT000100Message updateRequestMessage = (PRPMIN303010MCCIMT000100Message) providerMessage;

        PRPMMT303010HealthCareProvider healthCareProvider = null;
        try {
            JAXBElement<PRPMMT303010HealthCareProvider> healthCareProviderElement = updateRequestMessage.getControlActProcess().getSubject().get(0).getRegistrationEvent().getSubject1().getHealthCareProvider();
            if (healthCareProviderElement != null) {
                healthCareProvider = healthCareProviderElement.getValue();
            }
        } catch (NullPointerException npe) {
            // Nothing to do here
        }
        return healthCareProvider;
    }

    @Override
    protected void setNames(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute, HL7HealthCareProvider untypedHealthCareProvider) {
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;

        List<PRPMMT303010PrincipalPersonName> names;
        try {
            names = healthCareProvider.getHealthCarePrincipalPerson().getValue().getName();
        } catch (NullPointerException npe) {
            return;
        }

        List<EN> namesAsENList = new ArrayList<>();
        namesAsENList.addAll(names);
        List<PersonNameAttribute> personNameAttributes = createPersonNameAttributesFromHL7Names(namesAsENList, requestMessage);
        providerAttribute.setPersonNames(personNameAttributes);
    }

    @Override
    protected void setAddresses(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute, HL7HealthCareProvider untypedHealthCareProvider) {
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;

        List<PRPMMT303010HealthCareProviderAddr> addressList = healthCareProvider.getAddr();

        if (!CollectionUtils.isEmpty(addressList)) {
            List<AddressAttribute> addressAttributes = new ArrayList<>();
            providerAttribute.setAddresses(addressAttributes);

            for (PRPMMT303010HealthCareProviderAddr address : addressList) {
                AddressAttribute addressAttribute = createAddressAttributeFromHL7Address(address, requestMessage);
                addressAttributes.add(addressAttribute);
            }
        }

    }

    @Override
    protected void setPhonesAndEmail(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute, HL7HealthCareProvider untypedHealthCareProvider) {
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;

        List<PRPMMT303010HealthCareProviderTelecom> telecomList = healthCareProvider.getTelecom();

        if (!CollectionUtils.isEmpty(telecomList)) {
            List<PhoneAttribute> phoneAttributeList = new ArrayList<>();
            providerAttribute.setPhones(phoneAttributeList);

            List<EmailAttribute> emailAttributeList = new ArrayList<>();
            providerAttribute.setEmails(emailAttributeList);

            for (PRPMMT303010HealthCareProviderTelecom tel : telecomList) {
                createPhoneOrEmailAttribute(tel, phoneAttributeList, emailAttributeList, requestMessage);
            }
        }
    }
    
    protected void setConfidentiality(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute, HL7HealthCareProvider untypedHealthCareProvider){
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;
         
        // Confidentiality flag
        if (healthCareProvider.getSubjectOf3() != null && healthCareProvider.getSubjectOf3().getValue() != null) {
            PRPMMT303010InformDefinition informDefinition = healthCareProvider.getSubjectOf3().getValue().getInformDefinition();
            
            if (informDefinition != null) {
                ConfidentialityMaskAttribute ma = new ConfidentialityMaskAttribute();
                ma.setMasked(informDefinition.isNegationInd());
                ma.setStartDate(getLowTime(informDefinition.getEffectiveTime()));
                ma.setExpiryDate(getHighTime(informDefinition.getEffectiveTime()));
                // Please Note that the empty demographic block created from here will be removed later in PLREntityToDtoTypeConverter::setDemographicDetails
                if (providerAttribute.getDemographicDetails()==null){
                    providerAttribute.setDemographicDetails(new ArrayList<Person>());
                }
                if (providerAttribute.getDemographicDetails().isEmpty()){
                    providerAttribute.getDemographicDetails().add(new Person());
                }
                if (providerAttribute.getDemographicDetails().get(0).getConfidentialityMask()==null){
                    providerAttribute.getDemographicDetails().get(0).setConfidentialityMask(new ArrayList<ConfidentialityMaskAttribute>());
                }
                providerAttribute.getDemographicDetails().get(0).getConfidentialityMask().add(ma);
                
                // populate reason code from the audit info element
                PRPMMT303010HealthCareProviderSubjectOf3 subjectOf3 = healthCareProvider.getSubjectOf3().getValue();
                AuditInfo auditInfo = getAuditInfo(subjectOf3.getControlActReferenceId(), requestMessage);                
                if(subjectOf3.getUpdateMode() != null) {
                    ma.setEndReasonCode(auditInfo.getReasonCode());
                }
            }
        }
    }

    @Override
    protected void setConditions(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute, HL7HealthCareProvider untypedHealthCareProvider) {
        
        // set confidentiality
        setConfidentiality(requestMessage, providerAttribute, untypedHealthCareProvider);
        
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;

        List<PRPMMT303010HealthCareProviderResponsibleFor> responsibleForList = healthCareProvider.getResponsibleFor();

        if (!CollectionUtils.isEmpty(responsibleForList)) {
            List<ConditionAttribute> conditionAttributes = new ArrayList<>();
            providerAttribute.setConditions(conditionAttributes);

            for (PRPMMT303010HealthCareProviderResponsibleFor responsibleFor : responsibleForList) {

                ConditionAttribute conditionAttribute = new ConditionAttribute();

                final II controlActReferenceId = responsibleFor.getControlActReferenceId();
                AuditInfo auditInfo = getAuditInfo(controlActReferenceId, requestMessage);
                conditionAttribute.setSource(auditInfo.getDataOwner());
                if (responsibleFor.getUpdateMode() != null) {
                    conditionAttribute.setEndReasonCode(auditInfo.getReasonCode());
                }

                final PRPMMT303010Privilege privilege = responsibleFor.getPrivilege();
                if (privilege != null) {
                    List<II> idList = privilege.getId();
                    for (II id : idList) {
                        if (CONDITION_OID.equals(id.getRoot())) {
                            conditionAttribute.setId(id.getExtension());
                        }
                    }

                    final List<PRPMMT303010Subject4> subjectOfList = privilege.getSubjectOf();
                    if (!CollectionUtils.isEmpty(subjectOfList)) {
                        for (PRPMMT303010Subject4 subjectOf : subjectOfList) {
                            PRPMMT303010PrivilegeCategorization privilegeCategorization = subjectOf.getPrivilegeCategorization();
                            CD code = privilegeCategorization.getCode();
                            if (code != null && PRIVILEGE_CATEGORIZATION_CODE.equals(code.getCode())) {
                                CE value = privilegeCategorization.getValue();
                                if (value != null) {
                                    conditionAttribute.setUncodedType(value.getCode());
                                }
                            }
                        }
                    }

                    if (privilege.getConfidentialityCode() != null
                            && privilege.getConfidentialityCode().getValue() != null) {

                        CE confidentialityCode = privilege.getConfidentialityCode().getValue();

                        conditionAttribute.setRestricted("R".equals(confidentialityCode.getCode()));

                        if (confidentialityCode.getOriginalText() != null) {
                            conditionAttribute.setRestrictionExplanationText(confidentialityCode.getOriginalText().getText());
                        }
                    }

                    populateAuditInfoFromValidTime(auditInfo, privilege.getEffectiveTime());
                    conditionAttribute.setStartDate(auditInfo.getStartDate());
                    conditionAttribute.setExpiryDate(auditInfo.getExpiryDate());
                } else {
                    continue;
                }

                conditionAttributes.add(conditionAttribute);
            }
        }
    }

    @Override
    protected void setDemographicDetails(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute, HL7HealthCareProvider untypedHealthCareProvider) {
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;
        JAXBElement<PRPMMT303010PrincipalPerson> healthCarePrincipalPerson = healthCareProvider.getHealthCarePrincipalPerson();
        if (healthCarePrincipalPerson == null) {
            return;
        }
        PRPMMT303010PrincipalPerson hl7Person = healthCarePrincipalPerson.getValue();
        PRPMMT303010PrincipalPersonAdministrativeGenderCode administrativeGenderCode = hl7Person.getAdministrativeGenderCode();
        PRPMMT303010PrincipalPersonBirthTime birthTime = hl7Person.getBirthTime();
        JAXBElement<PRPMMT303010PrincipalPersonDeceasedTime> deceasedTimeElement = hl7Person.getDeceasedTime();
        List<PRPMMT303010PrincipalPersonBirthplace> birthplaceList = hl7Person.getBirthplace();
        if (demographicElementsAreEmpty(administrativeGenderCode, birthTime, deceasedTimeElement, birthplaceList)) {
            return;
        }

        if (providerAttribute.getDemographicDetails() == null) {
            providerAttribute.setDemographicDetails(new ArrayList<Person>());
        }
        List<Person> demographicDetails = providerAttribute.getDemographicDetails();
        Person personAttribute = new Person();
        demographicDetails.add(personAttribute);

        if (administrativeGenderCode != null) {
            personAttribute.setGender(new GenderAttribute(administrativeGenderCode.getCode()));
        }

        if (birthTime != null) {
            personAttribute.setBirthDate(new DateAttribute(ConverterUtils.convertFromHL7StringToDate(birthTime.getValue())));
        }

        PRPMMT303010PrincipalPersonDeceasedTime deceasedTime = null;
        if (deceasedTimeElement != null) {
            deceasedTime = deceasedTimeElement.getValue();
            if (deceasedTime != null) {
                personAttribute.setDeathDate(new DateAttribute(ConverterUtils.convertFromHL7StringToDate(deceasedTime.getValue())));
            }
        }

        PRPMMT303010PrincipalPersonBirthplace birthplace = null;
        if (!CollectionUtils.isEmpty(birthplaceList)) {
            birthplace = birthplaceList.get(0);
            AD addr = birthplace.getAddr();
            if (addr != null) {
                AddressAttribute createAddressAttributeFromHL7Address = createAddressAttributeFromHL7Address(addr, requestMessage);
                personAttribute.setBirthCountryCode(createAddressAttributeFromHL7Address.getCountry());
                personAttribute.setBirthProvinceCode(createAddressAttributeFromHL7Address.getProvince());
                List<AddressAttribute> addresses = new ArrayList<>();
                addresses.add(createAddressAttributeFromHL7Address);
                personAttribute.setAddress(addresses);
            }
        }

        List<TimeAndAuditAdapter> timeAndAuditElements = Arrays.asList(
                new TimeAndAuditAdapter(administrativeGenderCode),
                new TimeAndAuditAdapter(deceasedTime),
                new TimeAndAuditAdapter(birthTime),
                new TimeAndAuditAdapter(birthplace));
        mapFirstAvailableAudit(timeAndAuditElements, requestMessage, personAttribute);
        mapFirstAvailableTime(timeAndAuditElements, personAttribute);
    }

    private boolean demographicElementsAreEmpty(PRPMMT303010PrincipalPersonAdministrativeGenderCode administrativeGenderCode, PRPMMT303010PrincipalPersonBirthTime birthTime, JAXBElement<PRPMMT303010PrincipalPersonDeceasedTime> deceasedTimeElement, List<PRPMMT303010PrincipalPersonBirthplace> birthplaceList) {
        return administrativeGenderCode == null
                && birthTime == null
                && (deceasedTimeElement == null || deceasedTimeElement.getValue() == null)
                && (birthplaceList == null || birthplaceList.isEmpty() || birthplaceList.get(0).getAddr() == null);
    }

    private void mapFirstAvailableAudit(List<TimeAndAuditAdapter> timeAndAuditElements, HL7RequestMessage requestMessage, Person personAttribute) {
        for (TimeAndAuditAdapter l : timeAndAuditElements) {
            if (l.getControlActReferenceId() != null) {
                AuditInfo auditInfo = getAuditInfo(l.getControlActReferenceId(), requestMessage);
                personAttribute.setSource(auditInfo.getDataOwner());
                personAttribute.setEndReasonCode(auditInfo.getReasonCode());
                return;
            }
        }
    }

    private void mapFirstAvailableTime(List<TimeAndAuditAdapter> timeAndAuditElements, Person personAttribute) {
        for (TimeAndAuditAdapter l : timeAndAuditElements) {
            if (l.getValidTime() != null) {
                personAttribute.setStartDate(getLowTime(l.getValidTime()));
                personAttribute.setExpiryDate(getHighTime(l.getValidTime()));
                return;
            }
        }
    }

    @Override
    protected void processRelatedToBlocks(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute, HL7HealthCareProvider untypedHealthCareProvider) {
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;
        List<PRPMMT303010HealthCareProviderRelatedTo> relatedToList = healthCareProvider.getRelatedTo();
        if (CollectionUtils.isEmpty(relatedToList)) {
            return;
        }
        List<ExpertiseAttribute> expertiseAttributeList = new ArrayList<>();
        providerAttribute.setExpertises(expertiseAttributeList);
        List<CredentialAttribute> credentialAttributeList = new ArrayList<>();
        providerAttribute.setCredentials(credentialAttributeList);
        List<ProviderRelationshipAttribute> providerRelationshipAttributeList = new ArrayList<>();
        providerAttribute.setProviderRelationships(providerRelationshipAttributeList);
        List<WorkLocationAttribute> workLocationAttributeList = new ArrayList<>();
        providerAttribute.setWorkLocations(workLocationAttributeList);
        List<InformationRouteAttribute> informationRouteAttributeList = new ArrayList<>();
        providerAttribute.setInformationRoutes(informationRouteAttributeList);

        for (PRPMMT303010HealthCareProviderRelatedTo relatedTo : relatedToList) {

            JAXBElement<PRPMMT303010HealthCareProvider> relatedToHealthCareProviderElement = relatedTo.getHealthCareProvider();
            if (relatedToHealthCareProviderElement != null) {
                final PRPMMT303010HealthCareProvider relatedToHealthCareProvider = relatedToHealthCareProviderElement.getValue();
                if (relatedToHealthCareProvider != null) {
                    // This is a provider relationship
                    providerRelationshipAttributeList.add(
                            createProviderRelationship(relatedToHealthCareProvider,
                                    relatedTo.getControlActReferenceId(),
                                    relatedTo.getValidTime(), requestMessage, relatedTo));
                }
                continue;
            }

            // Not mapped by HL7
//            expertiseAttribute.setRoleCode(???);
            JAXBElement<PRPMMT303010QualifiedEntity> qualifiedEntityElement = relatedTo.getQualifiedEntity();
            if (qualifiedEntityElement != null) {
                PRPMMT303010QualifiedEntity qualifiedEntity = qualifiedEntityElement.getValue();
                if (qualifiedEntity != null) {
                    createExpertiseOrCredential(qualifiedEntity, expertiseAttributeList, credentialAttributeList, relatedTo, requestMessage);
                }
            }

            JAXBElement<PRPMMT303010AssignedEntity> assignedEntityElement = relatedTo.getAssignedEntity();
            if (assignedEntityElement != null) {
                PRPMMT303010AssignedEntity assignedEntity = assignedEntityElement.getValue();
                if (assignedEntity != null) {
                    createWorkLocationIfPossible(assignedEntity, workLocationAttributeList, requestMessage, relatedTo.getUpdateMode());
                }
            }
        }
        
        // Need to create information routes after work locations because they reference each other
        for (PRPMMT303010HealthCareProviderRelatedTo relatedTo : relatedToList) {

            JAXBElement<PRPMMT303010AssignedEntity> assignedEntityElement = relatedTo.getAssignedEntity();
            if (assignedEntityElement != null) {
                PRPMMT303010AssignedEntity assignedEntity = assignedEntityElement.getValue();
                if (assignedEntity != null) {
                    createInformationRouteIfPossible(assignedEntity, workLocationAttributeList, informationRouteAttributeList, requestMessage, relatedTo.getUpdateMode());
                }
            }
        }
    }

    public void createExpertiseOrCredential(PRPMMT303010QualifiedEntity qualifiedEntity, List<ExpertiseAttribute> expertiseAttributeList, List<CredentialAttribute> credentialAttributeList, PRPMMT303010HealthCareProviderRelatedTo relatedTo, HL7RequestMessage requestMessage) {
        ExpertiseAttribute expertiseAttribute = null;
        CredentialAttribute credentialAttribute = null;
        Attribute attribute;

        // Assume it is an expertise unless you get this weird combo
        boolean isExpertise = true;
        boolean isCredential = false;

        CD code = qualifiedEntity.getCode();
        if (code != null) {
            ED originalText = code.getOriginalText();
            if (originalText != null) {
                TEL reference = originalText.getReference();
                if (reference != null) {
                    String value = reference.getValue();
                    if (!StringUtils.isEmpty(value)) {
                        isCredential = true;
                        isExpertise = false;
                    }
                }
            }
        }

        if (isCredential) {
            credentialAttribute = new CredentialAttribute();
            attribute = credentialAttribute;
        } else {
            expertiseAttribute = new ExpertiseAttribute();
            attribute = expertiseAttribute;
        }

        if (isExpertise) {
            if (expertiseAttribute != null && code != null) {
                expertiseAttribute.setUncodedType(code.getCode());
                ED originalText = code.getOriginalText();
                if (originalText != null) {
                    expertiseAttribute.setSourceCode(originalText.getText());
                }
            }
            expertiseAttributeList.add(expertiseAttribute);
        }

        if (isCredential) {
            setCredentialSpecificInformation(qualifiedEntity, credentialAttribute, requestMessage, code);
            credentialAttributeList.add(credentialAttribute);
        }

        IVLTS effectiveTime = qualifiedEntity.getEffectiveTime();
        if (effectiveTime != null) {
            attribute.setStartDate(getLowTime(effectiveTime));
            attribute.setExpiryDate(getHighTime(effectiveTime));
        }

        II controlActReferenceId = relatedTo.getControlActReferenceId();
        if (controlActReferenceId != null) {
            AuditInfo auditInfo = getAuditInfo(controlActReferenceId, requestMessage);
            attribute.setSource(auditInfo.getDataOwner());
            if (relatedTo.getUpdateMode() != null) {
                attribute.setEndReasonCode(auditInfo.getReasonCode());
            }
        }
    }

    public void setCredentialSpecificInformation(PRPMMT303010QualifiedEntity qualifiedEntity, CredentialAttribute credentialAttribute, HL7RequestMessage requestMessage, CD code) {
        List<II> idList = qualifiedEntity.getId();
        String id = ConverterUtils.findIdForOid40(idList, CREDENTIAL_OID);
        if (id != null) {
            credentialAttribute.setRegistrationNumber(id);
        }

        CD credentialCode = qualifiedEntity.getCode();
        if (credentialCode != null) {
            credentialAttribute.setUncodedType(credentialCode.getCode());

            ED originalText = credentialCode.getOriginalText();
            if (originalText != null) {
                TEL reference = originalText.getReference();
                if (reference != null) {
                    credentialAttribute.setDesignation(reference.getValue());
                }
            }
        }

        JAXBElement<PRPMMT303010Organization> qualificationGrantingOrganizationEntity = qualifiedEntity.getQualificationGrantingOrganization();
        if (qualificationGrantingOrganizationEntity != null) {
            PRPMMT303010Organization qualificationGrantingOrganization = qualificationGrantingOrganizationEntity.getValue();

            if (qualificationGrantingOrganization != null) {
                List<ON> nameList = qualificationGrantingOrganization.getName();
                if (!CollectionUtils.isEmpty(nameList)) {
                    // There can only be one
                    final ON name = nameList.get(0);
                    if (name != null) {
                        credentialAttribute.setGrantingInstitution(name.getText());
                    }
                }

                if (qualificationGrantingOrganization.getAddr() != null) {

                    List<AD> addrList = qualificationGrantingOrganization.getAddr();

                    if (!CollectionUtils.isEmpty(addrList)) {
                        // There can only be one
                        AddressAttribute address = createAddressAttributeFromHL7Address(addrList.get(0), requestMessage);
                        if (address != null) {
                            credentialAttribute.setInstitutionCity(address.getCity());
                            credentialAttribute.setInstitutionProvStateCode(address.getProvince());
                            credentialAttribute.setInstitutionCountryCode(address.getCountry());
                        }
                    }
                } else {

                    AD emptyAddress = new AD();
                    emptyAddress.setText("");
                    qualificationGrantingOrganization.getAddr().add(emptyAddress);

                }

            }

            List<PRPMMT303010Subject3> subjectOf2List = qualifiedEntity.getSubjectOf2();
            if (!CollectionUtils.isEmpty(subjectOf2List)) {
                PRPMMT303010Subject3 subjectOf2 = subjectOf2List.get(0);
                if (subjectOf2 != null) {
                    PRPMMT303010RoleActivation roleActivation = subjectOf2.getRoleActivation();
                    if (roleActivation != null) {
                        JAXBElement<ST> textElement = roleActivation.getText();
                        if (textElement != null) {
                            ST value = textElement.getValue();
                            if (value != null) {
                                credentialAttribute.setYearIssued(value.getText());
                                value.getText();
                            }
                        }
                    }
                }
            }
        }

        List<CR> qualifierList = code.getQualifier();
        if (!CollectionUtils.isEmpty(qualifierList)) {
            CR qualifier = qualifierList.get(0);
            CD value = qualifier.getValue();
            if (value != null) {
                credentialAttribute.setEquivalent(Boolean.valueOf(value.getCode()));
            }
        }
    }

    @Override
    protected void setStatuses(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute,
            HL7HealthCareProvider untypedHealthCareProvider
    ) {
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;
        JAXBElement<PRPMMT303010HealthCareProviderStatusCode> statusCodeElement = healthCareProvider.getStatusCode();
        if (statusCodeElement == null) {
            return;
        }
        PRPMMT303010HealthCareProviderStatusCode statusCode = statusCodeElement.getValue();
        if (statusCode != null) {
            List<StatusAttribute> statusAttributeList = new ArrayList<>();
            providerAttribute.setStatuses(statusAttributeList);

            StatusAttribute statusAttribute = new StatusAttribute();

            statusAttribute.setUncodedType(statusCode.getCode());

            // Hard-coded in HL7
            statusAttribute.setClassCode(STATUS_CLASS_CODE);

            AuditInfo auditInfo = getAuditInfo(statusCode.getControlActReferenceId(), requestMessage);
            statusAttribute.setSource(auditInfo.getDataOwner());
            try {
                String ext = healthCareProvider.getStatusCode().getValue().getControlActReferenceId().getExtension();
                for (PRPMMT303010Subject3 subjectOf2 : healthCareProvider.getSubjectOf2()) {
                    if (subjectOf2.getRoleActivation().getSubjectOf().get(0).getControlActEvent().getId().getExtension().equals(ext)) {
                        statusAttribute.setReasonCode(subjectOf2.getRoleActivation().getReasonCode().getValue().getCode());
                    }
                }
            } catch (Exception e) {
            }
            if (statusCode.getUpdateMode() != null) {
                statusAttribute.setEndReasonCode(auditInfo.getReasonCode());
            }
            populateAuditInfoFromValidTime(auditInfo, statusCode.getValidTime());
            statusAttribute.setStartDate(auditInfo.getStartDate());
            statusAttribute.setExpiryDate(auditInfo.getExpiryDate());

            statusAttributeList.add(statusAttribute);
        }
    }

    @Override
    protected void setNotes(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute,
            HL7HealthCareProvider untypedHealthCareProvider
    ) {
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;
        List<NoteAttribute> noteAttributeList = new ArrayList<>();
        providerAttribute.setNotes(noteAttributeList);

        List<PRPMMT303010HealthCareProviderSubjectOf4> subjectOf4List = healthCareProvider.getSubjectOf4();
        for (PRPMMT303010HealthCareProviderSubjectOf4 subjectOf4 : subjectOf4List) {

            NoteAttribute noteAttribute = new NoteAttribute();

            final PRPMMT303010Note note = subjectOf4.getNote();
            if (note != null) {
                JAXBElement<II> idElement = note.getId();
                if (idElement != null && idElement.getValue() != null) {
                    noteAttribute.setIdentifier(idElement.getValue().getExtension());
                }
                final ST text = note.getText();
                if (text != null) {
                    noteAttribute.setText(text.getText());
                }

                noteAttributeList.add(noteAttribute);
                AuditInfo auditInfo = getAuditInfo(subjectOf4.getControlActReferenceId(), requestMessage);
                noteAttribute.setSource(auditInfo.getDataOwner());
                if (subjectOf4.getUpdateMode() != null) {
                    noteAttribute.setEndReasonCode(auditInfo.getReasonCode());
                }
                populateAuditInfoFromValidTime(auditInfo, subjectOf4.getValidTime());
                noteAttribute.setStartDate(getLowTime(note.getEffectiveTime()));
                noteAttribute.setExpiryDate(getHighTime(note.getEffectiveTime()));
            }
        }
    }

    @Override
    protected void setDisciplinaryActions(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute,
            HL7HealthCareProvider untypedHealthCareProvider
    ) {
        PRPMMT303010HealthCareProvider healthCareProvider = (PRPMMT303010HealthCareProvider) untypedHealthCareProvider;
        List<DisciplinaryActionAttribute> attributeList = new ArrayList<>();

        providerAttribute.setDisciplinaryActions(attributeList);

        List<PRPMMT303010HealthCareProviderSubjectOf1> subjectOf1List = healthCareProvider.getSubjectOf1();
        for (PRPMMT303010HealthCareProviderSubjectOf1 subjectOf1 : subjectOf1List) {

            PRPMMT303010DisciplinaryAction disciplinaryAction = subjectOf1.getDisciplinaryAction();
            if (disciplinaryAction != null) {
                DisciplinaryActionAttribute attribute = new DisciplinaryActionAttribute();

                JAXBElement<II> idElement = disciplinaryAction.getId();
                if (idElement != null) {
                    II id = idElement.getValue();

                    if (id != null && DISCIPLINARYACTION_OID.equals(id.getRoot())) {
                        attribute.setIdentifier(id.getExtension());
                    }
                }

                JAXBElement<ST> textElement = disciplinaryAction.getText();
                if (textElement != null) {
                    ST value = textElement.getValue();
                    if (value != null) {
                        attribute.setDescription(value.getText());
                    }
                }

                JAXBElement<TS> availabilityTimeElement = disciplinaryAction.getAvailabilityTime();
                if (availabilityTimeElement != null) {
                    TS value = availabilityTimeElement.getValue();
                    if (value != null) {
                        attribute.setArchiveDate(ConverterUtils.convertFromHL7StringToDate(value.getValue()));
                    }
                }

                JAXBElement<CE> confidentialityCodeElement = disciplinaryAction.getConfidentialityCode();
                if (confidentialityCodeElement != null) {
                    CE value = confidentialityCodeElement.getValue();
                    if (value != null) {
                        attribute.setDisplay(convertToBoolean(value.getCode()));
                    }
                }

                AuditInfo auditInfo = getAuditInfo(subjectOf1.getControlActReferenceId(), requestMessage);
                attribute.setSource(auditInfo.getDataOwner());
                if (subjectOf1.getUpdateMode() != null) {
                    attribute.setEndReasonCode(auditInfo.getReasonCode());
                }
                populateAuditInfoFromValidTime(auditInfo, disciplinaryAction.getEffectiveTime());
                attribute.setStartDate(auditInfo.getStartDate());
                attribute.setExpiryDate(auditInfo.getExpiryDate());

                attributeList.add(attribute);
            }
        }
    }

    private void createWorkLocationIfPossible(PRPMMT303010AssignedEntity assignedEntity,
            List<WorkLocationAttribute> workLocationAttributeList,
            HL7RequestMessage requestMessage, PRPMMT303010HealthCareProviderRelatedToUpdateMode parentUpdateMode) {

        AuditInfoRequirements_40 auditInfoRequirements = new AuditInfoRequirements_40();

        // Test to see if it is a work location or information route
        PRPMMT303010ActDefinitionOrEvent actDefinitionOrEvent = null;
        List<PRPMMT303010PrimaryPerformer3> performanceEntityList = assignedEntity.getPerformance();
        if (!CollectionUtils.isEmpty(performanceEntityList)) {
            actDefinitionOrEvent = performanceEntityList.get(0).getActDefinitionOrEvent();
        }
        if (actDefinitionOrEvent == null) {
            return;
        }
        List<PRPMMT303010ActDefinitionOrEventLocation> locationList = actDefinitionOrEvent.getLocation();
        if (!CollectionUtils.isEmpty(locationList)) {

            WorkLocationAttribute workLocationAttribute = new WorkLocationAttribute();
            auditInfoRequirements.setAuditInfoAttribute(workLocationAttribute);

            setWorkLocationSpecificFields(locationList, auditInfoRequirements, workLocationAttribute, requestMessage, workLocationAttributeList);
            if (!auditInfoRequirements.isIsUpdateMode()) {
                auditInfoRequirements.setIsUpdateMode(parentUpdateMode != null);
            }

            Attribute auditInfoAttribute = auditInfoRequirements.getAuditInfoAttribute();
            if (auditInfoAttribute != null) {
                auditInfoAttribute.setStartDate(getLowTime(auditInfoRequirements.getEffectiveTime()));
                auditInfoAttribute.setExpiryDate(getHighTime(auditInfoRequirements.getEffectiveTime()));
                AuditInfo auditInfo = getAuditInfo(auditInfoRequirements.getControlActReferenceId(), requestMessage);
                workLocationAttribute.setDataOwnerCode(auditInfo.getDataOwner());
                if (auditInfoRequirements.isIsUpdateMode()) {
                    PRPMMT303010ActDefinitionOrEventLocationUpdateMode locationUpdateMode = locationList.get(0).getUpdateMode();
                    if (PRPMMT303010ActDefinitionOrEventLocationUpdateMode.D.equals(locationUpdateMode)
                            || (locationUpdateMode == null && PRPMMT303010HealthCareProviderRelatedToUpdateMode.D.equals(parentUpdateMode))) {
                        auditInfoAttribute.setEndReasonCode("CEASE");
                    } else {
                        auditInfoAttribute.setEndReasonCode(auditInfo.getReasonCode());
                    }
                }
            }
        }
    }
    
    /**
     * Creates an information route element with specific fields from the HL7 request message.
     *
     * @param assignedEntity PRPMMT303010AssignedEntity - the assigned entity
     * @param workLocationAttributeList List<WorkLocationAttribute> - list of Work Location Attributes
     * @param informationRouteAttributeList List<InformationRouteAttribute> - list of Information Route Attributes
     * @param requestMessage HL7RequestMessage - the HL7 request message
     * @param parentUpdateMode PRPMMT303010HealthCareProviderRelatedToUpdateMode - the parent element to update
     */
    private void createInformationRouteIfPossible(PRPMMT303010AssignedEntity assignedEntity,
            List<WorkLocationAttribute> workLocationAttributeList,
            List<InformationRouteAttribute> informationRouteAttributeList,
            HL7RequestMessage requestMessage, 
            PRPMMT303010HealthCareProviderRelatedToUpdateMode parentUpdateMode) {
        
        AuditInfoRequirements_40 auditInfoRequirements = new AuditInfoRequirements_40();

        // Test to see if it is an information route
        PRPMMT303010ActDefinitionOrEvent actDefinitionOrEvent = null;
        if (!CollectionUtils.isEmpty(assignedEntity.getPerformance())) {
            actDefinitionOrEvent = assignedEntity.getPerformance().get(0).getActDefinitionOrEvent();
        }
        if (actDefinitionOrEvent == null) {
            return;
        }
        
        List<PRPMMT303010ActDefinitionOrEventSequel> sequelList = actDefinitionOrEvent.getSequel();
        if (!CollectionUtils.isEmpty(sequelList)) {
            
            InformationRouteAttribute informationRouteAttribute = new InformationRouteAttribute();
            auditInfoRequirements.setAuditInfoAttribute(informationRouteAttribute);
            
            setInformationRouteSpecificFields(actDefinitionOrEvent.getSequel(),
                    informationRouteAttributeList, workLocationAttributeList,
                    requestMessage, auditInfoRequirements, parentUpdateMode);
            
            if (!auditInfoRequirements.isIsUpdateMode()) {
                auditInfoRequirements.setIsUpdateMode(parentUpdateMode != null);
            }

        }

    }

    /**
     * Set information route element with specific fields from the HL7 request message.
     *
     * @param sequelList List<PRPMMT303010ActDefinitionOrEventSequel> - list of Sequel attributes for 4.0 update schema
     * @param workLocationAttributeList List<WorkLocationAttribute> - list of Work Location Attributes
     * @param informationRouteAttributeList List<InformationRouteAttribute> - list of Information Route Attributes
     * @param requestMessage HL7RequestMessage - the HL7 request message
     * @param auditInfoRequirements AuditInfoRequirements_40 - the audit Info requirements
     */
    private void setInformationRouteSpecificFields(
            List<PRPMMT303010ActDefinitionOrEventSequel> sequelList,
            List<InformationRouteAttribute> informationRouteAttributeList,
            List<WorkLocationAttribute> workLocationAttributeList,
            HL7RequestMessage requestMessage, 
            AuditInfoRequirements_40 auditInfoRequirements,
            PRPMMT303010HealthCareProviderRelatedToUpdateMode parentUpdateMode) {

        InformationRouteAttribute informationRouteAttribute = new InformationRouteAttribute();
        PRPMMT303010ActDefinitionOrEventSequel sequel = sequelList.get(0);
        final II controlActReferenceIdSeq = sequel.getControlActReferenceId();
        
        auditInfoRequirements.setControlActReferenceId(controlActReferenceIdSeq);
        auditInfoRequirements.setIsUpdateMode(sequel.getUpdateMode() != null);
        
        PRPMMT303010InformRequest informRequest = sequel.getInformRequest();
        if (informRequest != null) {
            CD code = informRequest.getCode();
            if (code != null) {
                informationRouteAttribute.setDocumentTypeCode(code.getCode());
            }

            JAXBElement<PRPMMT303010InformRequestSubject> subjectElement = informRequest.getSubject();
            if (subjectElement != null) {
                PRPMMT303010InformRequestSubject subject = subjectElement.getValue();
                CE modeCode = subject.getModeCode();
                if (modeCode != null) {
                    informationRouteAttribute.setMechanismTypeCode(modeCode.getCode());
                }
                
                PRPMMT303010ServiceDeliveryLocation serviceDeliveryInformRequest = subject.getServiceDeliveryLocation();                
                if (serviceDeliveryInformRequest != null) {

                    // Check to see if this information route belongs to a work location
                    String workLocationChid = getWorkLocationChid(subject.getServiceDeliveryLocation());
                    if (!StringUtils.isEmpty(workLocationChid)) {
                        boolean matchingWorkLocationFound = false;
                        BigInteger workLocationChidNumber = new BigInteger(workLocationChid);
                        for (WorkLocationAttribute workLocationAttribute : workLocationAttributeList) {
                            if (workLocationChidNumber.equals(workLocationAttribute.getSequenceNumber())) {
                                workLocationAttribute.getInformationRoutes().add(informationRouteAttribute);
                                matchingWorkLocationFound = true;
                                break;
                            }
                        }
                        if (!matchingWorkLocationFound) {
                            WorkLocationAttribute workLocationAttribute = new WorkLocationAttribute();
                            workLocationAttribute.setIdentifier(workLocationChid);
                            workLocationAttribute.getInformationRoutes().add(informationRouteAttribute);
                            workLocationAttributeList.add(workLocationAttribute);
                        }
                    } else {
                        // Add the information route to the Provider if it does not belong to a Work Location
                        informationRouteAttributeList.add(informationRouteAttribute);
                    }
                }
            }          
            
            PRPMMT303010InformRequestIndirectTarget indirectTarget = informRequest.getIndirectTarget();
            if (indirectTarget != null) {
                II controlActReferenceId = indirectTarget.getControlActReferenceId();
                String controlActReferenceIdExtentsion = "";
                if (controlActReferenceId != null) {
                    controlActReferenceIdExtentsion = controlActReferenceId.getExtension();
                }
                JAXBElement<PRPMMT303010HealthCareProvider> healthCareProvider = indirectTarget.getHealthCareProvider();
                if (healthCareProvider != null && healthCareProvider.getValue() != null) {
                    List<PRPMMT303010HealthCareProviderAddr> addrs = healthCareProvider.getValue().getAddr();
                    if (!CollectionUtils.isEmpty(addrs)) {
                        AddressAttribute addressAttribute = createAddressAttributeFromHL7Address(addrs.get(0), requestMessage);
                        informationRouteAttribute.setAddressAttribute(addressAttribute);
                        informationRouteAttribute.setCommunicationDataOwnerCode(addressAttribute.getSource());
                        informationRouteAttribute.setCommunicationPurposeCode(addressAttribute.getCommunicationPurposeCode());
                        //Find the controlActReferenceId
                        for (Serializable obj : addrs.get(0).getContent()) {
                            if (obj instanceof JAXBElement && ((JAXBElement) obj).getDeclaredType().equals(II.class)) {
                                controlActReferenceIdExtentsion = ((II) ((JAXBElement) obj).getValue()).getExtension();
                            }
                        }
                    }
                    List<PRPMMT303010HealthCareProviderTelecom> telecoms = healthCareProvider.getValue().getTelecom();
                    if (!CollectionUtils.isEmpty(telecoms)) {
                        List<PhoneAttribute> phoneAtts = new ArrayList<>();
                        List<EmailAttribute> emailAtts = new ArrayList<>();
                        createPhoneOrEmailAttribute(telecoms.get(0), phoneAtts, emailAtts, requestMessage);
                        if (phoneAtts.size() > 0) {
                            informationRouteAttribute.setPhoneAttribute(phoneAtts.get(0));
                            informationRouteAttribute.setCommunicationDataOwnerCode(phoneAtts.get(0).getSource());
                            informationRouteAttribute.setCommunicationPurposeCode(phoneAtts.get(0).getCommunicationPurposeCode());
                        } else if (emailAtts.size() > 0) {
                            informationRouteAttribute.setEmailAttribute(emailAtts.get(0));
                            informationRouteAttribute.setCommunicationDataOwnerCode(emailAtts.get(0).getSource());
                            informationRouteAttribute.setCommunicationPurposeCode(emailAtts.get(0).getCommunicationPurposeCode());
                        }
                        //Find the controlActReferenceId
                        controlActReferenceIdExtentsion = telecoms.get(0).getControlActReferenceId().getExtension();
                    }
                }
                
                JAXBElement<PRPMMT303010ServiceDeliveryLocation> serviceDeliveryLocationElement = indirectTarget.getServiceDeliveryLocation();
                if (serviceDeliveryLocationElement != null) {
                    PRPMMT303010ServiceDeliveryLocation serviceDeliveryLocation = serviceDeliveryLocationElement.getValue();
                                        
                    List<PRPMMT303010ServiceDeliveryLocationAddr> addrList = serviceDeliveryLocation.getAddr();
                    if (!CollectionUtils.isEmpty(addrList)) {
                        PRPMMT303010ServiceDeliveryLocationAddr addr = addrList.get(0);
                        AddressAttribute addressAttribute = createAddressAttributeFromHL7Address(addr, requestMessage);
                        informationRouteAttribute.setAddressAttribute(addressAttribute);
                        informationRouteAttribute.setCommunicationDataOwnerCode(addressAttribute.getSource());
                        informationRouteAttribute.setCommunicationPurposeCode(addressAttribute.getCommunicationPurposeCode());
                    }
                    
                    List<PRPMMT303010ServiceDeliveryLocationTelecom> telecoms = serviceDeliveryLocation.getTelecom();
                   if (!CollectionUtils.isEmpty(telecoms)){
                       List<PhoneAttribute> phoneAtts = new ArrayList<>();
                       List<EmailAttribute> emailAtts = new ArrayList<>();
                       createPhoneOrEmailAttribute(telecoms.get(0), phoneAtts , emailAtts, requestMessage);
                       if (phoneAtts.size() > 0){
                           informationRouteAttribute.setPhoneAttribute(phoneAtts.get(0));
                           informationRouteAttribute.setCommunicationDataOwnerCode(phoneAtts.get(0).getSource());
                           informationRouteAttribute.setCommunicationPurposeCode(phoneAtts.get(0).getCommunicationPurposeCode());
                       }else if (emailAtts.size() > 0){
                           informationRouteAttribute.setEmailAttribute(emailAtts.get(0));
                           informationRouteAttribute.setCommunicationDataOwnerCode(emailAtts.get(0).getSource());
                           informationRouteAttribute.setCommunicationPurposeCode(emailAtts.get(0).getCommunicationPurposeCode());
                       }
                   }

                    //Get the work location id
                    JAXBElement<II> idElement = serviceDeliveryLocation.getId();
                    if (idElement != null) {
                        II value = idElement.getValue();
                        informationRouteAttribute.setWorkLocationIdentifier(Long.valueOf(value.getExtension()));
                    }

                    //Get WL data owner code
                    PRPMMT303010HealthCareProvider provider = ((PRPMIN303010MCCIMT000100Message)requestMessage).getControlActProcess().getSubject().get(0).getRegistrationEvent().getSubject1().getHealthCareProvider().getValue();
                    List<PRPMMT303010Subject3> subjects = provider.getSubjectOf2();
                    for (PRPMMT303010Subject3 subject : subjects) {
                        List<PRPMMT303010Subject6> subjectOf6s = subject.getRoleActivation().getSubjectOf();
                        if (!CollectionUtils.isEmpty(subjectOf6s)) {
                            PRPMMT303010Subject6 subjectOf6 = subjectOf6s.get(0);
                            II id = subjectOf6.getControlActEvent().getId();
                            if (AUDIT_INFO_TARGET_OID.equals(id.getRoot()) && controlActReferenceIdExtentsion.equals(id.getExtension())) {
                                List<PRPMMT303010Custodian> custodians = subjectOf6.getControlActEvent().getCustodian();
                                if (!CollectionUtils.isEmpty(custodians)) {
                                    List<II> iis = custodians.get(0).getAssignedEntity().getId();
                                    if (!CollectionUtils.isEmpty(iis)) {
                                        String owner = iis.get(0).getExtension();
                                        informationRouteAttribute.setWorkLocationOwnerCode(owner);
                                        informationRouteAttribute.setSource(owner);
                                    }
                                }
                            }
                        }
                    }                    
                }                
            }
        }
        
        // set start/expiry dates and end reason code for the IR attribute
        informationRouteAttribute.setStartDate(getLowTime(sequel.getValidTime()));
        informationRouteAttribute.setExpiryDate(getHighTime(sequel.getValidTime()));
        AuditInfo auditInfo = getAuditInfo(auditInfoRequirements.getControlActReferenceId(), requestMessage);
        if (auditInfoRequirements.isIsUpdateMode()) {
            PRPMMT303010ActDefinitionOrEventSequelUpdateMode sequelUpdateMode = sequel.getUpdateMode();
            if (PRPMMT303010ActDefinitionOrEventSequelUpdateMode.D.equals(sequelUpdateMode)
                    || (sequelUpdateMode == null && PRPMMT303010HealthCareProviderRelatedToUpdateMode.D.equals(parentUpdateMode))) {
                informationRouteAttribute.setEndReasonCode("CEASE");
            } else {
                informationRouteAttribute.setEndReasonCode(auditInfo.getReasonCode());
            }
        }
        informationRouteAttribute.setDefaulted(CollectionUtils.isEmpty(informationRouteAttributeList));
    }
    
    /**
     * Get the Work Location ID. If the given parameter is not a work location
     * or if the work location ID is not present (null or blank), return null.
     */
    private static String getWorkLocationChid(PRPMMT303010ServiceDeliveryLocation serviceDeliveryLocation) {
        if (serviceDeliveryLocation != null
                && serviceDeliveryLocation.getId() != null
                && serviceDeliveryLocation.getId().getValue() != null
                && WORKLOCATION_OID.equals(serviceDeliveryLocation.getId().getValue().getRoot())
                && !StringUtils.isEmpty(serviceDeliveryLocation.getId().getValue().getExtension())) {
            return serviceDeliveryLocation.getId().getValue().getExtension();
        }
        return null;
    }

    private void setWorkLocationSpecificFields(List<PRPMMT303010ActDefinitionOrEventLocation> locationList, AuditInfoRequirements_40 auditInfoRequirements, WorkLocationAttribute workLocationAttribute, HL7RequestMessage requestMessage, List<WorkLocationAttribute> workLocationAttributeList) {
        WorkLocationDetailsAttribute workLocationDetailsAttribute = null;
        PRPMMT303010ActDefinitionOrEventLocation location = locationList.get(0);
        final II controlActReferenceId = location.getControlActReferenceId();

        JAXBElement<INT> sequenceNumberElement = location.getSequenceNumber();
        if (sequenceNumberElement != null) {
            INT sequenceValue = sequenceNumberElement.getValue();
            workLocationAttribute.setSequenceNumber(sequenceValue.getValue());
        }

        auditInfoRequirements.setControlActReferenceId(controlActReferenceId);
        auditInfoRequirements.setIsUpdateMode(location.getUpdateMode() != null);
        PRPMMT303010ServiceDeliveryLocation serviceDeliveryLocation = location.getServiceDeliveryLocation();

        if (serviceDeliveryLocation != null) {
            JAXBElement<II> idElement = serviceDeliveryLocation.getId();
            if (idElement != null) {
                II ii = idElement.getValue();
                if (WORKLOCATION_OID.equals(ii.getRoot())) {
                    workLocationAttribute.setIdentifier(ii.getExtension());
                }
            }

            TS effectiveTime = serviceDeliveryLocation.getEffectiveTime();
            auditInfoRequirements.setEffectiveTime(effectiveTime);
            if (effectiveTime != null) {
                List<WorkLocationDetailsAttribute> details = workLocationAttribute.getDetails();
                if (CollectionUtils.isEmpty(details)) {
                    workLocationDetailsAttribute = new WorkLocationDetailsAttribute();
                    details.add(workLocationDetailsAttribute);
                } else {
                    workLocationDetailsAttribute = details.get(0);
                }
                auditInfoRequirements.setAuditInfoAttribute(workLocationDetailsAttribute);
            }

            // Set work location name
            JAXBElement<PRPMMT303010Place> serviceDeliveryLocationLocation = serviceDeliveryLocation.getLocation();
            if (serviceDeliveryLocationLocation != null) {
                PRPMMT303010Place locationValue = serviceDeliveryLocationLocation.getValue();
                if (locationValue != null) {
                    EN name = locationValue.getName();
                    if (name != null) {
                        PersonNameAttribute nameAttribute = convertToNameAttribute(name);
                        if (workLocationDetailsAttribute != null && nameAttribute != null) {
                            workLocationDetailsAttribute.setName(nameAttribute.getFirstName());
                        }
                    }
                }
            }

            // Set work location type
            CE code = serviceDeliveryLocation.getCode();
            if (workLocationDetailsAttribute != null && code != null) {
                workLocationDetailsAttribute.setTypeCode(code.getCode());
            }

            // Set work location addresses
            List<PRPMMT303010ServiceDeliveryLocationAddr> addrList = serviceDeliveryLocation.getAddr();
            if (!CollectionUtils.isEmpty(addrList)) {
                List<AddressAttribute> workLocationAddressAttributeList = new ArrayList<>();
                workLocationAttribute.setAddresses(workLocationAddressAttributeList);
                for (PRPMMT303010ServiceDeliveryLocationAddr addr : addrList) {
                    AddressAttribute addressAttribute = createAddressAttributeFromHL7Address(addr, requestMessage);
                    workLocationAddressAttributeList.add(addressAttribute);
                }
            }

            // Set work location emails and phone numbers
            List<PRPMMT303010ServiceDeliveryLocationTelecom> telecomList = serviceDeliveryLocation.getTelecom();
            if (!CollectionUtils.isEmpty(telecomList)) {
                List<EmailAttribute> emailAttributeList = new ArrayList<>();
                workLocationAttribute.setEmailAddresses(emailAttributeList);

                List<PhoneAttribute> phoneAttributeList = new ArrayList<>();
                workLocationAttribute.setPhoneNumbers(phoneAttributeList);

                for (PRPMMT303010ServiceDeliveryLocationTelecom tel : telecomList) {
                    createPhoneOrEmailAttribute(tel, phoneAttributeList, emailAttributeList, requestMessage);
                }
            }
        }

        if (workLocationDetailsAttribute != null) {
            boolean isWorkLocationDefault = false;
            if (workLocationAttribute.getSequenceNumber() != null
                    && workLocationAttribute.getSequenceNumber().compareTo(BigInteger.ONE) == 0) {
                isWorkLocationDefault = true;
            }
            workLocationDetailsAttribute.setDefaulted(isWorkLocationDefault);
        }

        workLocationAttributeList.add(workLocationAttribute);
    }

    private ProviderRelationshipAttribute createProviderRelationship(
            PRPMMT303010HealthCareProvider hl7HealthCareProvider,
            II controlActReferenceId,
            TS validTime,
            HL7RequestMessage requestMessage,
            PRPMMT303010HealthCareProviderRelatedTo relatedTo) {
        ProviderRelationshipAttribute attribute = new ProviderRelationshipAttribute();

        List<PRPMMT303010HealthCareProviderId> ids = hl7HealthCareProvider.getId();
        if (!CollectionUtils.isEmpty(ids)) {
            // There can only be one type. If there are more provided, we don't know what to do with them.
            PRPMMT303010HealthCareProviderId id = ids.get(0);
            attribute.setRelationshipWithProviderType(ConverterUtils.getOidValue(id.getRoot()));
            attribute.setRelationshipWithProviderCollegeId(id.getExtension());
        }

        CE code = hl7HealthCareProvider.getCode();
        if (code != null) {
            String codeValue = code.getCode();
            attribute.setRelationshipTypeCode(codeValue);
        }

        List<EN> names = hl7HealthCareProvider.getName();
        if (!CollectionUtils.isEmpty(names)) {
            EN name = names.get(0);
            String nameText = name.getText();
            attribute.setRelationshipWithProviderName(nameText);
        }

        AuditInfo auditInfo = getAuditInfo(controlActReferenceId, requestMessage);
        attribute.setSource(auditInfo.getDataOwner());
        if (relatedTo.getUpdateMode() != null) {
            attribute.setEndReasonCode(auditInfo.getReasonCode());
        }
        populateAuditInfoFromValidTime(auditInfo, validTime);
        attribute.setStartDate(auditInfo.getStartDate());
        attribute.setExpiryDate(auditInfo.getExpiryDate());

        return attribute;
    }

    @Override
    protected void setIdentifiers(HL7RequestMessage requestMessage, ProviderAttribute providerAttribute, HL7HealthCareProvider healthCareProvider) {
        PRPMMT303010HealthCareProvider typedHealthCarePRovider = (PRPMMT303010HealthCareProvider) healthCareProvider;

        List<PRPMMT303010HealthCareProviderId> ids = typedHealthCarePRovider.getId();
        if (!ids.isEmpty()) {
            List<IdentifierAttribute> mappedCollegeIdentifiers = new ArrayList<>();
            providerAttribute.setCollegeIdentifiers(mappedCollegeIdentifiers);
            List<IdentifierAttribute> mappedRegistryIdentifiers = new ArrayList<>();
            providerAttribute.setRegistryIdentifiers(mappedRegistryIdentifiers);
            for (PRPMMT303010HealthCareProviderId id : ids) {
                IdentifierAttribute mappedIdentifier = new IdentifierAttribute();

                mappedIdentifier.setValue(id.getExtension());

                String idRoot = id.getRoot();
                mappedIdentifier.setUncodedType(ConverterUtils.getOidValue(idRoot));

                TS validTime = id.getValidTime();
                mappedIdentifier.setStartDate(getLowTime(validTime));
                mappedIdentifier.setExpiryDate(getHighTime(validTime));

                AuditInfo auditInfo = getAuditInfo(id.getControlActReferenceId(), requestMessage);
                mappedIdentifier.setSource(auditInfo.getDataOwner());
                if (id.getUpdateMode() != null) {
                    mappedIdentifier.setEndReasonCode(auditInfo.getReasonCode());
                }

                if (ConverterUtils.isRegistryIdType(idRoot)) {
                    mappedRegistryIdentifiers.add(mappedIdentifier);
                } else {
                    mappedCollegeIdentifiers.add(mappedIdentifier);
                }
            }
        }
    }

    @Override
    public String getJurisdictionFromHealthCareProvider(HL7HealthCareProvider healthCareProvider) {

        PRPMMT303010HealthCareProvider typedHealthCareProvider = (PRPMMT303010HealthCareProvider) healthCareProvider;

        String jurisdiction = null;
        try {
            List<PRPMMT303010TerritorialAuthority> territorialAuthorityList = typedHealthCareProvider.getRepresentedOrganization().getValue().getTerritorialAuthority();
            if (territorialAuthorityList != null && !CollectionUtils.isEmpty(territorialAuthorityList)) {
                jurisdiction = territorialAuthorityList.get(0).getTerritory().getValue().getCode().getCode();
            }
        } catch (NullPointerException npe) {
            // nothing to do here
        }
        return jurisdiction;
    }

    @Override
    protected AuditInfo getAuditInfo(II controlActReferenceId, HL7RequestMessage requestMessage) {
        AuditInfo auditInfo = new AuditInfo();
        if (controlActReferenceId == null) {
            return auditInfo;
        }
        String subjectOf2Id;
        if (AUDIT_INFO_POINTER_OID.equals(controlActReferenceId.getRoot())) {
            subjectOf2Id = controlActReferenceId.getExtension();
        } else {
            return auditInfo;
        }
        final PRPMIN303010MFMIMT700701ControlActProcess typedControlActProcess = (PRPMIN303010MFMIMT700701ControlActProcess) requestMessage.getControlActProcess();

        List<PRPMMT303010Subject3> subjectOf2List = typedControlActProcess.getSubject().get(0).getRegistrationEvent().getSubject1().getHealthCareProvider().getValue().getSubjectOf2();
        for (PRPMMT303010Subject3 subjectOf2 : subjectOf2List) {
            try {
                List<PRPMMT303010Subject6> subjectOfList = subjectOf2.getRoleActivation().getSubjectOf();
                for (PRPMMT303010Subject6 subjectOf : subjectOfList) {
                    try {
                        PRPMMT303010ControlActEvent controlActEvent = subjectOf.getControlActEvent();
                        II id = controlActEvent.getId();
                        if (AUDIT_INFO_TARGET_OID.equals(id.getRoot()) && subjectOf2Id.equals(id.getExtension())) {
                            List<CE> reasonCodes = controlActEvent.getReasonCode();
                            if (reasonCodes != null && !reasonCodes.isEmpty()) {
                                String reason = reasonCodes.get(0).getCode();
                                auditInfo.setReasonCode(reason);
                            }
                            List<II> dataOwnerIds = controlActEvent.getCustodian().get(0).getAssignedEntity().getId();
                            if (!CollectionUtils.isEmpty(dataOwnerIds)) {
                                II dataOwnerId = dataOwnerIds.get(0);
                                if (DATA_OWNER_OID.equals(dataOwnerId.getRoot())) {
                                    auditInfo.setDataOwner(dataOwnerId.getExtension());
                                }
                            }
                        }
                    } catch (NullPointerException | IndexOutOfBoundsException npe) {
                    }
                }
            } catch (NullPointerException | IndexOutOfBoundsException npe) {
            }
        }
        return auditInfo;

    }

    @Override
    public List<II> getControlActProcessSubjectId(final HL7ControlActProcess controlActProcess) {
        PRPMIN303010MFMIMT700701ControlActProcess typedControlActProcess = (PRPMIN303010MFMIMT700701ControlActProcess) controlActProcess;

        List<II> id = null;
        final List<PRPMIN303010MFMIMT700701Subject1> subjectList = typedControlActProcess.getSubject();
        if (!CollectionUtils.isEmpty(subjectList)) {
            final JAXBElement<MFMIMT700701Author2> authorElement = subjectList.get(0).getRegistrationEvent().getAuthor();
            id = authorElement.getValue().getAssignedEntity().getId();
        }
        return id;
    }

    /**
     * Adapts some JAXB annotated classes to a common interface.
     *
     * The JAXB classes are generated, so we do not want to edit them directly.
     */
    private static class TimeAndAuditAdapter {

        TS validTime;
        II controlActReferenceId;

        TimeAndAuditAdapter(PRPMMT303010PrincipalPersonBirthplace birthplace) {
            if (birthplace != null) {
                validTime = birthplace.getValidTime();
                controlActReferenceId = birthplace.getControlActReferenceId();
            }
        }

        TimeAndAuditAdapter(PRPMMT303010PrincipalPersonAdministrativeGenderCode administrativeGenderCode) {
            if (administrativeGenderCode != null) {
                validTime = administrativeGenderCode.getValidTime();
                controlActReferenceId = administrativeGenderCode.getControlActReferenceId();
            }
        }

        TimeAndAuditAdapter(PRPMMT303010PrincipalPersonBirthTime birthTime) {
            if (birthTime != null) {
                validTime = birthTime.getValidTime();
                controlActReferenceId = birthTime.getControlActReferenceId();
            }
        }

        TimeAndAuditAdapter(PRPMMT303010PrincipalPersonDeceasedTime deceasedTime) {
            if (deceasedTime != null) {
                validTime = deceasedTime.getValidTime();
                controlActReferenceId = deceasedTime.getControlActReferenceId();
            }
        }

        TS getValidTime() {
            return validTime;
        }

        II getControlActReferenceId() {
            return controlActReferenceId;
        }
    }
}
