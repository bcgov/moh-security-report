/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.esb.service.query;

import ca.bc.gov.health.plr.dto.esb.QueryParameters;
import ca.bc.gov.health.plr.dto.esb.QueryRequest;
import static ca.bc.gov.moh.hsa.plr.converter.dtotohl7.HL740Constants.ACCEPT_ACK_CODE;
import static ca.bc.gov.moh.hsa.plr.converter.dtotohl7.HL740Constants.PROCESSING_CODE;
import static ca.bc.gov.moh.hsa.plr.converter.dtotohl7.HL740Constants.PROCESSING_MODE_CODE;
import static ca.bc.gov.moh.hsa.plr.converter.indivprovtofhir.ProviderFhirConstants.COMMON_PROVIDER_NUMBER;
import ca.bc.gov.moh.hsa.plr.esb.service.maintain.MessageIdExtractor;
import java.util.UUID;
import org.apache.camel.Exchange;
import org.apache.camel.Processor;

/**
 *
 * @author jonathan.wiebe
 */
public class FHIRProcessorQueryIn implements Processor {

    @Override
    public void process(Exchange exchng) throws Exception {
        String id = exchng.getIn().getHeader("id", String.class);
        String format = exchng.getIn().getHeader("_format", String.class);
        if (format != null) {
            exchng.getIn().setHeader("contentType", format);
        } else {
            exchng.getIn().setHeader("contentType", "application/fhir+json");
        }

        QueryRequest qr = new QueryRequest();

        qr.setUniqueMessageID(UUID.randomUUID().toString());
        qr.setProcessingCode(PROCESSING_CODE);
        qr.setProcessModeCode(PROCESSING_MODE_CODE);
        qr.setAcceptAckCode(ACCEPT_ACK_CODE);
        qr.setRegistryUserOrgId(
                "jwiebe");
        qr.setQueryParameters(
                new QueryParameters());
        qr.getQueryParameters()
                .setHistoryFlag(false);
        qr.getQueryParameters()
                .setIdentifier(id);
        String idType = exchng.getIn().getHeader("idType", String.class);
        if (idType
                != null && !idType.isEmpty()) {
            qr.getQueryParameters().setIdentifierTypeCode(idType);
        } else {
            qr.getQueryParameters().setIdentifierTypeCode(COMMON_PROVIDER_NUMBER);
        }

        exchng.getIn()
                .setBody(qr, QueryRequest.class
                );
        exchng.getIn()
                .setHeader(MessageIdExtractor.MESSAGE_ID_KEY, qr.getUniqueMessageID());
    }

}
