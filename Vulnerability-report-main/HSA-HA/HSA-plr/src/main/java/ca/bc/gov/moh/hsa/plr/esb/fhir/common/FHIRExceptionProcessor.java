/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.esb.fhir.common;

import java.io.PrintWriter;
import java.io.StringWriter;
import org.apache.camel.Exchange;
import org.apache.camel.Processor;

/**
 * Generic exception handler for FHIR Queries
 * @author greg.perkins
 */
public class FHIRExceptionProcessor implements Processor{

    /**
     * Handle the exchange
     * @param exchange
     * @throws Exception 
     */
    @Override
    public void process(Exchange exchange) throws Exception {
        
        //Get the exception from the exchange
        Exception ex = exchange.getException();
        if (ex==null){
            //Pull from exchange properties if not found
            ex = exchange.getProperty("CamelExceptionCaught", Exception.class);
        }
        //Get the cached FHIR factory from the exchange
        FHIRFactory factory = (FHIRFactory)exchange.getProperty("FHIRFactory");    
        
        //Create Operation Outcome
        Object operationOutcomeQueryResponseFhir = factory.newOperationOutcome();
        Object bcQueryResponseBundleFhir = factory.newBCQueryResponseBundle();
        Object operationOutcomeIssueFhir = factory.newOperationOutcomeIssueComponent();

        factory.getSetOperationOutcomeIssueComponentAttributes().setIssueSeverity(operationOutcomeIssueFhir, factory.newOOIssueSeverity(FHIRFactory.OperationOutcomeIssueSeverity.ERROR));
        factory.getSetOperationOutcomeIssueComponentAttributes().setIssueCode(operationOutcomeIssueFhir, factory.newOOIssueCode(FHIRFactory.OperationOutcomeIssueCode.EXCEPTION));
        
        if (ex!=null){  
            //Set properties from exception, if found
            if (ex instanceof FHIRException){
                FHIRException fe = (FHIRException)ex;
                ex = (Exception)fe.getCause();
                exchange.getIn().setHeader(Exchange.HTTP_RESPONSE_CODE, fe.getResponseCode());
                factory.getSetOperationOutcomeIssueComponentAttributes().setIssueDetails(operationOutcomeIssueFhir, fe.getErrorCode(), fe.getErrorDescription());
            }else{
                exchange.getIn().setHeader(Exchange.HTTP_RESPONSE_CODE, 500);
                factory.getSetOperationOutcomeIssueComponentAttributes().setIssueDetails(operationOutcomeIssueFhir, ex.getClass().getSimpleName(), ex.getMessage());
            }                              
            StringWriter sw = new StringWriter();
            ex.printStackTrace(new PrintWriter(sw));
            sw.flush();
            String stackTrace = sw.toString();
            factory.callMethod(operationOutcomeIssueFhir,"setDiagnostics", stackTrace);
        }
        factory.callMethod(operationOutcomeQueryResponseFhir, "addIssue", operationOutcomeIssueFhir);
        factory.getSetQueryResponseBundleAttributes().setOperationOutcomeQueryResponse(bcQueryResponseBundleFhir, operationOutcomeQueryResponseFhir);
        
        //Set the new body back into the exchange
        exchange.getIn().setBody(bcQueryResponseBundleFhir);
    }
    
}
