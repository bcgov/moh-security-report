/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.converter.facilitytofhir;

import ca.bc.gov.health.plr.dto.facility.esb.FacilityDto;
import ca.uhn.fhir.parser.DataFormatException;
import ca.uhn.fhir.validation.FhirValidator;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertTrue;
import org.junit.Test;

/**
 *
 * @author dan.stepanov
 */
public class FacilityCHSACodeToBCLocationCHSAExtFhirTest {
    
    @Test
    public void testFacilityCHSACodeToBCLocationCHSAExtension() throws Exception {
        FacilityDto facilityDetailsTest = FacilityDataBuilderFhirTest.getFacilityLocationDetails();

        MapFacilityChsaCodeToBCCHSAExtensionFhir facilityToBCCHSAExtFhir = new MapFacilityChsaCodeToBCCHSAExtensionFhir();

        String testJsonParsedBcChsaCodeFhir = null;
        testJsonParsedBcChsaCodeFhir = facilityToBCCHSAExtFhir.mapFacilityChsaCodeToBCLocationCHSAExt(facilityDetailsTest);

        String bcNoteTextParsedExpectedResult = "{\"resourceType\":\"Location\",\"meta\":{\"profile\":[\"http://hl7.org/fhir/ca-bc/provider/StructureDefinition/bc-location\"]},\"extension\":[{\"url\":\"http://hl7.org/fhir/ca-bc/provider/StructureDefinition/bc-facility-commmunity-health-service-area-extension\",\"extension\":[{\"url\":\"http://hl7.org/fhir/ca-bc/provider/StructureDefinition/bc-facility-commmunity-health-service-area-code-extension\",\"valueCodeableConcept\":{\"text\":\"CHSA name code test AAA\"}}]}]}";        
        assertNotNull(testJsonParsedBcChsaCodeFhir);
        assertEquals(bcNoteTextParsedExpectedResult, testJsonParsedBcChsaCodeFhir);

        // json format BC Location civic address in FHIR result is:
//        {
//                "resourceType": "Location",
//                "meta": {
//                        "profile": [
//                                "http://hl7.org/fhir/ca-bc/provider/StructureDefinition/bc-location"
//                        ]
//                },
//                "extension": [
//                        {
//                                "url": "http://hl7.org/fhir/ca-bc/provider/StructureDefinition/bc-facility-commmunity-health-service-area-extension",
//                                "extension": [
//                                        {
//                                                "url": "http://hl7.org/fhir/ca-bc/provider/StructureDefinition/bc-facility-commmunity-health-service-area-code-extension",
//                                                "valueCodeableConcept": {
//                                                        "text": "CHSA name code test AAA"
//                                                }
//                                        }
//                                ]
//                        }
//                ]
//        }
    }
    
    @Test
    public void testFacilityCHSACodeToBCLocationCHSAExtValid() throws Exception {

        FacilityDto facilityDetailsTest = FacilityDataBuilderFhirTest.getFacilityLocationDetails();

        MapFacilityChsaCodeToBCCHSAExtensionFhir facilityToBCCHSAExtFhir = new MapFacilityChsaCodeToBCCHSAExtensionFhir();
        
        boolean testJsonParsedFacilityChsaExtFhirValid = false;

        // Create a FhirInstanceValidator and register it to a validator
        FhirValidator fhirValidator = FacilityDataBuilderFhirTest.initFhirValidatorTest();

        String parsedEncodedFacilityChsa = facilityToBCCHSAExtFhir.mapFacilityChsaCodeToBCLocationCHSAExt(facilityDetailsTest);
        testJsonParsedFacilityChsaExtFhirValid = facilityToBCCHSAExtFhir.validateBCLocationFhir(fhirValidator, parsedEncodedFacilityChsa);

        assertNotNull(testJsonParsedFacilityChsaExtFhirValid);
        assertTrue(testJsonParsedFacilityChsaExtFhirValid);
    }

    @Test
    public void testFacilityCHSACodeToBCLocationCHSAExtInvalid() throws Exception, DataFormatException {

        MapFacilityChsaCodeToBCCHSAExtensionFhir facilityToBCCHSAExtFhir = new MapFacilityChsaCodeToBCCHSAExtensionFhir();

        boolean testJsonParsedFacilityChsaExtFhirValid = false;

        // Create a FhirInstanceValidator and register it to a validator
        FhirValidator fhirValidator = FacilityDataBuilderFhirTest.initFhirValidatorTest();

        String parsedEncodedFacilityChsaInvalid = "{\"resourceType\":\"Location_CHSA\",\"meta\":{\"profile\":[\"http://hl7.org/fhir/ca-bc/provider/StructureDefinition/bc-location\"]},\"extension\":[{\"url\":\"http://hl7.org/fhir/ca-bc/provider/StructureDefinition/bc-facility-commmunity-health-service-area-extension\",\"extension\":[{\"url\":\"http://hl7.org/fhir/ca-bc/provider/StructureDefinition/bc-facility-commmunity-health-service-area-code-extension\",\"valueCodeableConcept\":{\"text\":\"CHSA name code test AAA\"}}]}]}";        
        testJsonParsedFacilityChsaExtFhirValid = facilityToBCCHSAExtFhir.validateBCLocationFhir(fhirValidator, parsedEncodedFacilityChsaInvalid);

        assertNotNull(testJsonParsedFacilityChsaExtFhirValid);
        assertFalse(testJsonParsedFacilityChsaExtFhirValid);
    }
    
}
