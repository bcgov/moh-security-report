/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.route.distribution;

import ca.bc.gov.health.plr.dto.esb.Acknowledgment;
import ca.bc.gov.health.plr.dto.esb.DistributionNotification;
import ca.bc.gov.moh.hsa.plr.converter.plr.distribution.AbstractDistributionTest;
import ca.bc.gov.moh.hsa.plr.converter.plr.distribution.ProviderTestDataBuilder;
import com.sun.jersey.api.client.Client;
import com.sun.jersey.api.client.ClientResponse;
import com.sun.jersey.api.client.WebResource;
import com.sun.jersey.api.client.config.ClientConfig;
import com.sun.jersey.api.client.config.DefaultClientConfig;
import java.io.IOException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.UriBuilder;
import org.apache.cxf.helpers.IOUtils;
import org.codehaus.jackson.map.ObjectMapper;
import static org.junit.Assert.assertTrue;
import org.junit.Test;

/**
 *
 * @author greg.perkins
 */
public class RestDistributionTest extends AbstractDistributionTest {

//    @Test
    public void testJSON() throws Exception{
        DistributionNotification dist = createNotification(ProviderTestDataBuilder.getPublicProviderDetails());
        ClientConfig config = new DefaultClientConfig();

        Client client = Client.create(config);
        ObjectMapper mapper = new ObjectMapper();

        String jsonInString = mapper.writeValueAsString(dist);
        DistributionNotification out = mapper.readValue(jsonInString, DistributionNotification.class);
    }
    
    @Test
    public void testRest() throws IOException {
        DistributionNotification dist = createNotification(ProviderTestDataBuilder.getPublicProviderDetails());
        ClientConfig config = new DefaultClientConfig();

        Client client = Client.create(config);
        ObjectMapper mapper = new ObjectMapper();

        String jsonInString = mapper.writeValueAsString(dist);
        WebResource webResource = client.resource(UriBuilder.fromUri("http://localhost:28080/HSA-web/rs/distribution").build());

        ClientResponse response = webResource.type(MediaType.APPLICATION_JSON).post(ClientResponse.class, jsonInString);

        String body = IOUtils.readStringFromStream(response.getEntityInputStream());
        System.out.println(body);
        Acknowledgment ack = mapper.readValue(body, Acknowledgment.class);

        assertTrue(ack != null);
        assertTrue("AA".equals(ack.getTypeCode()));
    }
}
