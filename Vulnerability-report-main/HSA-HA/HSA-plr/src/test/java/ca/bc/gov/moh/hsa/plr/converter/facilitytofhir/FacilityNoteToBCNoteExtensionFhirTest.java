/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.plr.converter.facilitytofhir;

import ca.bc.gov.moh.hsa.plr.esb.fhir.common.FHIRFactory;
import ca.bc.gov.health.plr.dto.facility.esb.FacilityDto;
import static org.junit.Assert.assertTrue;
import org.junit.Test;

/**
 *
 * @author dan.stepanov
 */
public class FacilityNoteToBCNoteExtensionFhirTest {

    @Test
    public void testAddingNotesExtension_R4() {
        FHIRFactory factory = new FHIRFactory("R4");
        FacilityDto facilityDetailsTest = FacilityDataBuilderFhirTest.getFacilityLocationDetails();
        Object b = factory.newBundle();
        Object l = factory.newBCLocation();
        Object ber = factory.newBundleEntryRequestComponent();
        factory.getSetBundleAttributes().addBundleEntry(b, l, "fullurl", ber);
        MapFacilityNotesToBCNotesExtensionFhir.addFacilityNotesToBCLocation(factory, facilityDetailsTest.getNotes(), l);

        // should be one Note
        Object notesList = factory.callMethod(l, "getBcNoteExtension");
        Integer listSize = (Integer) factory.callMethod(notesList, "size");
        assertTrue(listSize == 1);

        String json = factory.encodeToString(b);
        System.out.println(json);
        assertTrue(json.contains("StructureDefinition/bc-location"));
        assertTrue(json.contains("StructureDefinition/bc-note-extension"));
        assertTrue(json.contains("StructureDefinition/bc-end-reason-extension"));
        assertTrue(json.contains("StructureDefinition/bc-period-extension"));
        assertTrue(json.contains("\"fullUrl\": \"fullurl\""));
        assertTrue(json.contains("\"resourceType\": \"Location\""));
        assertTrue(json.contains("\"text\": \"CHG\""));
        assertTrue(json.contains("\"display\": \"MOH\""));
        assertTrue(json.contains("\"value\": \"BC Note identifier 1 for FHIR custom extension\""));
        assertTrue(json.contains("\"valueString\": \"BC Note text 001 for FHIR custom extension\""));
        assertTrue(json.contains("\"start\": \"2020-01-05T00:00:00"));
        assertTrue(json.contains("\"end\": \"2050-12-30T00:00:00"));
    }

}
