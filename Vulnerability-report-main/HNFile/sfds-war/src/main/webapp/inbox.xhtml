<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
                xmlns:ui="http://java.sun.com/jsf/facelets" 
                xmlns:h="http://java.sun.com/jsf/html" 
                xmlns:f="http://java.sun.com/jsf/core" 
                xmlns:p="http://primefaces.org/ui"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions" 
                template="/WEB-INF/templates/sfdsTemplate.xhtml">

    <ui:define name="title">
        <h:outputFormat value="#{msg['title.inbox']}" />
    </ui:define>

    <ui:define name="content">

        <p:importConstants type="ca.bc.gov.health.sfds.util.SFDSConstants" var="SFDSConstants" />

        <!-- PF Messages Component defined for the whole page -->
        <p:messages closable="true" id="pageMessages" escape="false" rendered="#{!facesContext.validationFailed}">
            <p:autoUpdate disabled="false" />
        </p:messages>

        <h1><h:outputFormat value="#{msg['title.inbox']}" /></h1>

        <h:form id="mailboxSelectForm">
            <div class="table" style="width: 50%">
                <div class="row">
                    <div class="labelCell">
                        <p:outputLabel for="mailboxesList" value="#{msg['inbox.selectAccount']}" styleClass="bold" />
                    </div>
                </div>
                <div class="row">
                    <div class="inputCell wide">
                        <p:selectOneMenu id="mailboxesList" value="#{InboxBean.selectedMailbox}">
                            <f:selectItem itemLabel="Select" noSelectionOption="true" />
                            <f:selectItems value="#{InboxBean.availableMailboxes}" var="item" />
                            <p:ajax event="change" listener="#{InboxBean.onMailboxChange}" update="filesForm" 
                                    onstart="PF('statusDialog').show()" 
                                    onsuccess="PF('statusDialog').hide()" />
                        </p:selectOneMenu>
                    </div>
                </div>
            </div>
        </h:form>

        <h:form id="filesForm">

            <!-- 
                <p:repeat> does not play well with dataTable sorting
                See https://stackoverflow.com/a/10848158 for details. 
            -->
            <p:dataList var="group" value="#{InboxBean.groups}" emptyMessage="" id="groups" rowIndexVar="groupIndex">
                <p:column>
                    <!-- PF in its best: https://github.com/primefaces/primefaces/issues/3812 -->
                    <p:dataTable id="filesTable"
                                 value="#{group.files}"
                                 var="row" rowKey="#{row.surrogateId}" rowIndexVar="rowIndex" sortBy="#{row.fileName}"
                                 paginator="true" paginatorAlwaysVisible="false" rows="10" paginatorPosition="top"
                                 currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords}" 
                                 paginatorTemplate="{CurrentPageReport} {PreviousPageLink} {NextPageLink}"
                                 widgetVar="filesTableWidget-#{group.id}" 
                                 selection="#{InboxBean.currentFile}" 
                                 selectionMode="single">

                        <f:facet name="header">
                            <div id="groupName">
                                <span>#{group.groupGetLabel}</span>
                            </div>
                        </f:facet>

                        <p:ajax event="rowSelect" 
                                resetValues="true" 
                                update="fileDetailsForm" 
                                oncomplete="PF('fileDetailsDialogWidget').show();" />

                        <p:column visible="false">#{row.surrogateId}</p:column>
                        <p:column headerText="#{msg['inbox.label.fileName']}" width="30%" sortBy="#{row.fileName}" sortOrder="asc">
                            <h:outputText value="#{row.fileName}" id="rowFileName" title="#{row.fileName}" />
                        </p:column>
                        <p:column headerText="#{msg['inbox.label.status']}" width="15%" sortBy="#{row.status}"><h:outputText value="#{row.statusForTable}" escape="false" /></p:column>
                        <p:column headerText="#{msg['inbox.label.sendingAcct']}" width="30%" sortBy="#{row.sendingAccount}">#{row.sendingAccount}</p:column>
                        <p:column headerText="#{msg['inbox.label.sentDate']}" width="10%" sortBy="#{row.sendDate}">
                            <h:outputText value="#{row.sendDate}">
                                <f:convertDateTime pattern="MMM dd, yyyy" type="date" />
                            </h:outputText>
                        </p:column>
                        <p:column headerText="#{msg['inbox.label.size']}" width="10%" sortBy="#{row.size}">#{row.sizeInKb}</p:column>
                    </p:dataTable>
                </p:column>
            </p:dataList>

        </h:form>

        <h:form id="fileDetailsForm">

            <p:dialog id="fileDetailsDialog" closeOnEscape="true"
                      width="680" 
                      closable="false" modal="true" 
                      resizable="false" visible="false" 
                      widgetVar="fileDetailsDialogWidget" 
                      header="#{msg['inbox.dialogue.header']}">

                <div class="table" style="margin-bottom: 0;">
                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel for="fileName" value="#{msg['inbox.label.fileName.low']}" styleClass="readonly" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="inputCell">
                            <p:inputText id="fileName" size="71" 
                                         value="#{fn:length(InboxBean.currentFile.fileName) lt 70 ? InboxBean.currentFile.fileName : fn:substring(InboxBean.currentFile.fileName, 1, 66).concat('...')}" 
                                         disabled="true" 
                                         title="#{InboxBean.currentFile.fileName}" styleClass="showTitle" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel for="useName" value="#{msg['inbox.label.use']}" styleClass="readonly" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="inputCell">
                            <p:inputText id="useName" size="71" value="#{InboxBean.currentFile.useName}" disabled="true" />
                        </div>
                    </div>
                </div>

                <div class="table">
                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel for="status" value="#{msg['inbox.label.status.low']}" styleClass="readonly" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="size" value="#{msg['inbox.label.size.low']}" styleClass="readonly" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="inputCell">
                            <p:inputText id="status" size="30" value="#{InboxBean.currentFile.status}" disabled="true" />
                        </div>
                        <div class="inputCell">
                            <p:inputText id="size" size="30" value="#{InboxBean.currentFile.sizeInKb}" disabled="true" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel for="sendingAccount" value="#{msg['inbox.label.sendingAcct.low']}" styleClass="readonly" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="receivingAccount" value="#{msg['inbox.label.receivingAcct.low']}" styleClass="readonly" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="inputCell">
                            <p:inputText id="sendingAccount" size="30" value="#{InboxBean.currentFile.sendingAccount}" disabled="true" />
                        </div>
                        <div class="inputCell">
                            <p:inputText id="receivingAccount" size="30" value="#{InboxBean.currentFile.receivingAccount}" disabled="true" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel for="sendingUID" value="#{msg['inbox.label.sendingUID.low']}" styleClass="readonly" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="receivingUID" value="#{msg['inbox.label.receivingUID.low']}" styleClass="readonly" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="inputCell">
                            <p:inputText id="sendingUID" size="30" value="#{InboxBean.currentFile.sendingUID}" disabled="true" />
                        </div>
                        <div class="inputCell">
                            <p:inputText id="receivingUID" size="30" value="#{InboxBean.currentFile.receivingUID}" disabled="true" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel for="sentDate" value="#{msg['inbox.label.sentDate.low']}" styleClass="readonly" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="receivedDate" value="#{msg['inbox.label.receivedDate.low']}" styleClass="readonly" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="inputCell">
                            <p:inputText id="sentDate" size="30" value="#{InboxBean.currentFile.sendDate}" disabled="true">
                                <f:convertDateTime pattern="MMM dd, yyyy" type="date" />
                            </p:inputText>
                        </div>
                        <div class="inputCell">
                            <p:inputText id="receivedDate" size="30" value="#{InboxBean.currentFile.receivedDate}" disabled="true">
                                <f:convertDateTime pattern="MMM dd, yyyy" type="date" />
                            </p:inputText>
                        </div>
                    </div>
                </div>

                <p:commandButton id="fileDetailsDownload" 
                                 value="#{msg['inbox.dialogue.button.download']}" 
                                 widgetVar="fileDetailsDownload"
                                 onclick="PrimeFaces.monitorDownload(statusDialogStart, statusDialogStop);"
                                 process="@this"
                                 icon="pi pi-download">
                    <p:fileDownload value="#{FileDownloadBean.fileContent}" />
                    <f:param name="#{SFDSConstants.FILE_SAVE_NAME_PARAMETER}" value="#{InboxBean.currentFile.fileName}" />
                    <f:param name="#{SFDSConstants.FILE_REAL_NAME_PARAMETER}" value="#{InboxBean.currentFile.serverData.name}" />
                    <f:param name="#{SFDSConstants.MAILBOX_NAME_PARAMETER}" value="#{InboxBean.selectedMailbox}" />
                    <f:param name="#{SFDSConstants.DATA_RECIPIENT_ID_PARAMETER}" value="#{InboxBean.currentFile.drrID}" />
                    <f:param name="#{SFDSConstants.DATA_RECIPIENT_LOCK_SEQ_NUM_PARAMETER}" value="#{InboxBean.currentFile.drrLockNum}" />
                </p:commandButton>

                <p:commandButton id="fileDetailsDelete" value="#{msg['inbox.dialogue.button.delete']}"
                                 rendered="#{InboxBean.deleteEnabled}"
                                 styleClass="danger"  
                                 widgetVar="fileDetailsDelete"
                                 process="@this"
                                 update="filesForm pageMessages"
                                 action="#{InboxBean.deleteFile()}"
                                 onstart="PF('statusDialog').show()" 
                                 oncomplete="PF('statusDialog').hide(); PF('fileDetailsDialogWidget').hide();"
                                 icon="pi pi-times-circle">
                    <p:confirm header="Confirmation" message="#{msg['inbox.file.delete.confirmation']}" icon="pi pi-info-circle" />
                </p:commandButton>

                <p:commandButton id="fileDetailsClose" value="#{msg['inbox.dialogue.button.close']}" styleClass="secondary"
                                 widgetVar="fileDetailsClose"
                                 process="@this" 
                                 oncomplete="PF('fileDetailsDialogWidget').hide();">
                </p:commandButton>

                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no secondary" />
                    <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" />
                </p:confirmDialog>

            </p:dialog>

        </h:form>

        <script type="text/javascript">
            function statusDialogStart() {
                PF('statusDialog').show();
            }

            function statusDialogStop() {
                PF('statusDialog').hide();
            }
        </script>

        <ui:include src="/statusSpinner.xhtml" />

    </ui:define>

</ui:composition>