<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/sfdsTemplate.xhtml">

    <ui:define name="title">
        <h:outputFormat value="#{msg['title.sendFile']}" />
    </ui:define>

    <ui:define name="content">

        <p:importConstants type="ca.bc.gov.health.sfds.util.SFDSConstants" var="SFDSConstants" />

        <!-- PF Messages Component defined for the whole page -->
        <p:messages closable="true" id="pageMessages" escape="false" rendered="#{!facesContext.validationFailed}">
            <p:autoUpdate disabled="false" />
        </p:messages>

        <h:form id="mailboxSelectForm">
            <div class="table" style="width: 50%">
                <div class="row">
                    <div class="labelCell">
                        <p:outputLabel for="mailboxesList" value="#{msg['sendFile.selectAccount']}" styleClass="bold" />
                    </div>
                </div>
                <div class="row strut">
                    <div class="inputCell wide">
                        <p:selectOneMenu id="mailboxesList" value="#{SendFileBean.selectedMailbox}">
                            <f:selectItem itemLabel="Select Account" noSelectionOption="true" />
                            <f:selectItems value="#{SendFileBean.availableMailboxes}" var="mailbox" />
                            <p:ajax event="change" listener="#{SendFileBean.onMailboxChange}" update="recipientSelectList fileSubmitForm"
                                    onstart="PF('statusDialog').show()"
                                    onsuccess="PF('statusDialog').hide()" />
                        </p:selectOneMenu>
                    </div>
                </div>
                <div class="row">
                    <div class="labelCell">
                        <p:outputLabel for="mailboxesList" value="#{msg['sendFile.selectRecipient']}" styleClass="bold" />
                    </div>
                </div>
                <div class="row strut">
                    <div class="inputCell wide">
                        <p:selectOneMenu id="recipientSelectList" value="#{SendFileBean.selectedUse.useId}">
                            <f:selectItem itemLabel="Select Use" noSelectionOption="true" />
                            <f:selectItems value="#{SendFileBean.usesForSelectedMailbox}" var="use" />
                            <p:ajax event="change" listener="#{SendFileBean.onRecipientChange}"
                                    update="fileSubmitForm:calendarPanel fileSubmitForm:fileUploadPanel fileSubmitForm:multiSendPanel fileSubmitForm:sendMessagePanel"
                                    onstart="PF('statusDialog').show()"
                                    onsuccess="PF('statusDialog').hide()" />
                        </p:selectOneMenu>
                    </div>
                </div>
            </div>
        </h:form>

        <h:form id="fileSubmitForm">

            <!-- Panel for multiple recipients -->
            <p:panel id="multiSendPanel" style="width: 90%" visible="#{SendFileBean.multiSendPanelVisible}">
                <div class="table">
                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel value="#{msg['sendFile.label.recipient.search']}" styleClass="bold" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="inputCell recipientSearchFilter">
                            <p:remoteCommand name="searchRecipients" actionListener="#{SendFileBean.findRecipients}" update="fileSubmitForm" />
                            <p:inputText
                                type="recipientSearch"
                                id="recipientSearchFilter"
                                value="#{SendFileBean.recipientSearchFilter}"
                                onkeypress="if (event.keyCode == 13) {
                                            searchRecipients();
                                            return false;
                                        }" />
                            <p:commandButton id="recipientSearchButton"
                                             value="#{msg['sendFile.button.search']}"
                                             widgetVar="recipientSearchButtonVar"
                                             update="fileSubmitForm"
                                             onstart="PF('statusDialog').show()"
                                             onsuccess="PF('statusDialog').hide()"
                                             action="#{SendFileBean.findRecipients}" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="inputCell">
                            <p:pickList id="recipientsPickList" value="#{SendFileBean.recipients}"
                                        var="recipient" itemLabel="#{recipient.name}" itemValue="#{recipient}"
                                        converter="recipientConverter">
                                <f:facet name="sourceCaption"><h:outputText value="#{msg['sendFile.label.available.recipients']}" /></f:facet>
                                <f:facet name="targetCaption"><h:outputText value="#{msg['sendFile.label.selected.recipients']}" /></f:facet>

                                <p:ajax event="transfer" listener="#{SendFileBean.onTransfer}" update="@form" />

                                <p:column style="width:90%">
                                    <h:outputText value="#{recipient.name}"></h:outputText>
                                </p:column>
                                <p:column>
                                    <p:commandLink action="#{SendFileBean.recipientDetails}" oncomplete="PF('recipientInfoWidget').show()">
                                        <h:outputText value="Details" />
                                        <f:param name="#{SFDSConstants.RECIPIENT_ID_PARAMETER}" value="#{recipient.accountIdentifier}" />
                                    </p:commandLink>
                                </p:column>
                            </p:pickList>
                        </div>
                    </div>
                </div>
            </p:panel>

            <!-- HSCIS specific panel to display Year and Quarter -->
            <p:panel id="calendarPanel" style="width: 25%" visible="#{SendFileBean.calendarPanelVisible}">
                <div class="table" style="width: 25%">
                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel for="yearsList" value="#{msg['sendFile.selectYear']}" styleClass="bold" />
                        </div>
                    </div>
                    <div class="row strut">
                        <div class="inputCell narrow">
                            <p:selectOneMenu id="yearsList" value="#{SendFileBean.selectedYear}">
                                <f:selectItems value="#{SendFileBean.availableYears}" var="year" />
                            </p:selectOneMenu>
                        </div>
                    </div>
                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel for="quartersList" value="#{msg['sendFile.selectQuarter']}" styleClass="bold" />
                        </div>
                    </div>
                    <div class="row strut">
                        <div class="inputCell narrow">
                            <p:selectOneMenu id="quartersList" value="#{SendFileBean.selectedQuarter}">
                                <f:selectItems value="#{SendFileBean.availableQuarters}" var="quarter" />
                            </p:selectOneMenu>
                        </div>
                    </div>
                </div>
            </p:panel>

            <!-- Sending files -->
            <p:panel id="fileUploadPanel" visible="#{SendFileBean.fileUploadPanelVisible}" header="#{msg['sendFile.frame.sendFile.header']}" styleClass="framedPanel">
                <p:fileUpload   id="uploadControl"
                                listener="#{SendFileBean.upload}"
                                multiple="false"
                                onstart="startUpload(this.files[0].name)"
                                label="#{msg['sendFile.label.addFile']}"
                                mode="advanced"
                                auto="true" dragDropSupport="true" fileLimit="1" sizeLimit="500000000"
                                update="@form uploadedFiles sendConfirmation">
                    <p:messages for="uploadControl" closable="true" />

                </p:fileUpload>

                <p:dataTable id="uploadedFiles" value="#{SendFileBean.uploadedFiles}" widgetVar="uploadedFilesTable"
                             selectionMode="single"
                             selection="#{SendFileBean.currentFile}"
                             var="file" rowKey="#{file.id}">

                    <p:ajax event="rowSelect" resetValues="true"
                            update="fileSubmitForm:sendConfirmation fileSubmitForm:fileSubmitButton"
                            listener="#{SendFileBean.onRowSelect}" />

                    <p:ajax event="rowUnselect" resetValues="true"
                            update="fileSubmitForm:sendConfirmation fileSubmitForm:fileSubmitButton"
                            listener="#{SendFileBean.onRowUnselect}" />

                    <p:column headerText="#{msg['sendFile.label.fileName']}"><h:outputText value="#{file.name}" /></p:column>
                    <p:column headerText="#{msg['sendFile.label.status']}">
                        <h:graphicImage width="12" height="12"
                                        value="/resources/template-images/animated-spinner.gif"
                                        rendered="#{file.status.code eq 'IN_PROGRESS'}" styleClass="submission-status-icon" />
                        <h:graphicImage width="12" height="12"
                                        value="/resources/template-images/error-large.png"
                                        rendered="#{file.status.code eq 'ERROR'}" styleClass="submission-status-icon" />
                        <h:graphicImage width="12" height="12"
                                        value="/resources/template-images/success-large.png"
                                        rendered="#{file.status.code eq 'DELIVERED'}" styleClass="submission-status-icon" />
                        <h:outputText value="#{file.status.description}" />
                    </p:column>
                    <p:column headerText="#{msg['sendFile.label.size']}">
                        <h:outputText value="#{file.sizeInKb}" />
                    </p:column>
                    <p:column headerText="#{msg['sendFile.label.submitted']}">
                        <h:outputText value="#{file.submittedStr}" />
                    </p:column>
                </p:dataTable>

                <!-- Send button and checkbox -->
                <div class="table" style="width: 50%">
                    <div class="row">
                        <p:selectBooleanCheckbox id="sendConfirmation"
                                                 value="#{SendFileBean.sendConfirmation}"
                                                 itemLabel="#{msg['sendFile.label.send.confirmation.file']}"
                                                 disabled="#{!SendFileBean.allowedToSendFile}" />
                    </div>
                    <div class="row strut">&#160;</div>
                    <div class="row">
                        <p:commandButton id="fileSubmitButton"
                                         action="#{SendFileBean.startSend}"
                                         oncomplete="if($('#pageMessages').html()!='') {$('#pageMessages')[0].scrollIntoView();} else {rcSend()}"
                                         value="#{msg['sendFile.button.send.file']}"
                                         disabled="#{!SendFileBean.allowedToSendFile}"
                                         update="uploadedFiles"
                                         widgetVar="fileSubmitButtonWidget">
                        </p:commandButton>
                    </div>
                </div>
            </p:panel>

            <!-- Sending messages -->
            <p:panel id="sendMessagePanel" visible="#{SendFileBean.sendMessagePanelVisible}"
                     header="#{msg['sendFile.frame.sendMessage.header']}" styleClass="framedPanel">
                <div class="table">
                    <div class="row">
                        <p:outputLabel for="messageSubject" value="#{msg['sendFile.label.subject']}" styleClass="bold" indicateRequired="true" />
                    </div>
                    <div class="row strut">
                        <div class="inputCell narrow">
                            <p:inputText id="messageSubject" value="#{SendFileBean.messageSubject}" style="width: 489px"
                                         widgetVar="messageSubjectWidget" maxlength="50">
                                <p:ajax event="keyup" listener="#{SendFileBean.getMessageSubject}" update="sendConfirmationForMessage messageSubmitButton" />
                            </p:inputText>
                        </div>
                    </div>
                    <div class="row">
                        <p:outputLabel for="messageBody" value="#{msg['sendFile.label.message']}" styleClass="bold" />
                    </div>
                    <div class="row strut">
                        <div class="inputCell">
                            <div>
                                <p:inputTextarea  style="width: 489px;"
                                                  id="messageBody"
                                                  value="#{SendFileBean.messageBody}"
                                                  rows="5" cols="60"
                                                  maxlength="500" counter="display" counterTemplate="{0} characters remaining." autoResize="false">
                                </p:inputTextarea >
                            </div>
                            <div class="small-text">
                                <h:outputText id="display" class="p-d-block" />
                            </div>
                        </div>
                    </div>

                    <!-- Send button and checkbox -->
                    <div class="row">
                        <p:selectBooleanCheckbox id="sendConfirmationForMessage"
                                                 value="#{SendFileBean.sendConfirmationForMessage}"
                                                 itemLabel="#{msg['sendFile.label.send.confirmation.message']}"
                                                 widgetVar="sendConfirmationForMessageWidget"
                                                 disabled="#{!SendFileBean.allowedToSendMessage}" />
                    </div>
                    <div class="row strut">&#160;</div>
                    <div class="row">
                        <p:commandButton id="messageSubmitButton"
                                         action="#{SendFileBean.sendMessage}"
                                         value="#{msg['sendFile.button.send.message']}"
                                         oncomplete="if($('#pageMessages').html()!='') {$('#pageMessages')[0].scrollIntoView();}"
                                         widgetVar="messageSubmitButtonWidget"
                                         disabled="#{!SendFileBean.allowedToSendMessage}" />
                    </div>
                </div>
            </p:panel>

            <p:remoteCommand name="rcUpload" action="#{SendFileBean.onStartUpload}" />
            <p:remoteCommand name="rcSend" action="#{SendFileBean.endSend}" oncomplete="if($('#pageMessages').html()!='') {$('#pageMessages')[0].scrollIntoView();}" />

            <script type="text/javascript">
                function startUpload(filename)
                {
                    rcUpload([{name: 'fileName', value: filename}]);
                }
            </script>

        </h:form>

        <ui:include src="/statusSpinner.xhtml" />

        <h:form id="recipientInfoForm">
            <p:dialog id="recipientInfoDialog" widgetVar="recipientInfoWidget" modal="true" draggable="false" resizable="false" closable="false" closeOnEscape="true"
                      header="#{msg['sendFile.recipient.info.dialogue.header']}">
                <div style="margin-bottom: 10px">
                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel value="#{msg['sendFile.recipient.info.dialogue.name']}" styleClass="readonly" />
                        </div>
                        <div class="labelCell" />
                    </div>
                    <div class="row">
                        <div class="inputCell">
                            <p:inputText id="currentRecipientAccount" value="#{SendFileBean.selectedRecipient.name}" disabled="true" style="width: 482px" />
                        </div>
                    </div>
                </div>
                <div class="table" style="width: 100%">
                    <div class="row">
                        <div class="labelCell">
                            <p:outputLabel value="#{msg['sendFile.recipient.info.dialogue.city']}" styleClass="readonly" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel value="#{msg['sendFile.recipient.info.dialogue.pracPayeeNumbers']}" styleClass="readonly" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="inputCell">
                            <p:inputText id="currentRecipientCity" value="#{SendFileBean.selectedRecipient.city}" disabled="true" />
                        </div>
                        <div class="inputCell">
                            <p:inputText id="pracPayeeNumber" value="#{SendFileBean.selectedRecipient.pracPayeeNumber}" disabled="true" />
                        </div>
                    </div>
                </div>

                <p:commandButton id="recipientInfoClose" value="#{msg['sendFile.recipient.info.dialogue.button.close']}" styleClass="secondary"
                                 widgetVar="recipientInfoCloseWidget"
                                 process="@this"
                                 oncomplete="PF('recipientInfoWidget').hide();">
                </p:commandButton>

            </p:dialog>
        </h:form>

    </ui:define>

</ui:composition>
