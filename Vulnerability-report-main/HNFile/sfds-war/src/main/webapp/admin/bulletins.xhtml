<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/sfdsTemplate.xhtml">

    <ui:define name="title">
        <h:outputFormat value="#{msg['title.admin']}" />
    </ui:define>

    <ui:define name="content">
        <ui:include src="/admin/adminTabs.xhtml">
            <ui:param name="page" value="bulletins" />
        </ui:include>


        <!-- PF Messages Component defined for the whole page -->
        <p:messages closable="true" id="pageMessages" escape="false" rendered="#{!facesContext.validationFailed}">
            <p:autoUpdate disabled="false" />
        </p:messages>

        <script type="text/javascript">
            var gf = ""; // Storing global filter
        </script>

        <h:form id="bulletinsForm" class="admin-bulletins">

            <p:dataTable id="bulletinsTable" value="#{AdministerBulletinsBean.bulletins}"
                         var="row" rowKey="#{row.parcelId}" rowIndexVar="rowIndex"
                         paginator="true" paginatorAlwaysVisible="true" rows="10" paginatorPosition="top"
                         currentPageReportTemplate="{startRecord}-{endRecord} of {totalRecords}"
                         paginatorTemplate="{CurrentPageReport} {PreviousPageLink} {NextPageLink}"
                         widgetVar="bulletinsTableWidget"
                         filteredValue="#{AdministerBulletinsBean.filteredBulletins}"
                         selection="#{AdministerBulletinsBean.currentBulletin}" selectionMode="single"
                         sortBy="#{row.externalIdentifier}">

                <f:facet name="header">
                    <p:outputPanel>
                        <h:outputText value="#{msg['bulletins.admin.label.search']}" /><br/>
                        <p:inputText type="search" id="globalFilter" widgetVar="globalFilterVar" />
                        <p:commandButton id="filter" onclick="PF('bulletinsTableWidget').filter()" value="#{msg['bulletinContent.button.search']}" />
                        <p:defaultCommand target="filter" />
                    </p:outputPanel>
                </f:facet>

                <p:ajax event="rowSelect"
                        listener="#{AdministerBulletinsBean.retrieveCurrentBulletin}"
                        resetValues="true"
                        update="bulletinCreateForm"
                        oncomplete="PF('bulletinCreateDialogWidget').show();" />

                <p:ajax event="filter" ignoreAutoUpdate="true" />

                <p:column visible="false">#{row.parcelId}</p:column>
                <p:column filterBy="#{row.externalIdentifier}" sortOrder="asc" filterStyle="display: none" width="10%" sortBy="#{row.externalIdentifier}" headerText="#{msg['bulletins.admin.column.title.id']}">#{row.externalIdentifier}</p:column>
                <p:column filterBy="#{row.parentContext}" filterStyle="display: none" width="10%" sortBy="#{row.parentContext}" headerText="#{msg['bulletins.admin.column.title.use']}">#{row.parentContext}</p:column>
                <p:column width="20%" sortBy="#{row.effectiveDate}" headerText="#{msg['bulletins.admin.column.title.effDate']}"><h:outputText value="#{row.effectiveDate}"><f:convertDateTime pattern="MMM d, YYYY" /></h:outputText></p:column>
                <p:column width="20%" sortBy="#{row.endDate}" headerText="#{msg['bulletins.admin.column.title.endDate']}"><h:outputText value="#{row.endDate}"><f:convertDateTime pattern="MMM d, YYYY" /></h:outputText></p:column>
                <p:column filterBy="#{row.summary}" filterStyle="display: none" width="40%" sortBy="#{row.summary}" headerText="#{msg['bulletins.admin.column.title.title']}">#{row.summary}</p:column>
            </p:dataTable>

        </h:form>

        <h:form id="bulletinInstantiateCreationForm">
            <p:commandButton id="createBulletin" value="#{msg['bulletins.admin.create']}"
                             action="#{AdministerBulletinsBean.instantiateBulletin()}"
                             update="bulletinCreateForm"
                             oncomplete="PF('bulletinCreateDialogWidget').show();">
            </p:commandButton>
        </h:form>

        <h:form id="bulletinCreateForm">
            <p:dialog id="bulletinCreateDialog" width="700" height="680" closable="false" modal="true" resizable="false" visible="false" closeOnEscape="true"
                      widgetVar="bulletinCreateDialogWidget" header="#{AdministerBulletinsBean.createDialogueHeader}">

                <p:ajax event="open" update="bulletinContent" />
                <p:messages id="bulletinMessages" closable="true" escape="false" />

                <h:inputHidden id="bulletinTrueContent" value="#{AdministerBulletinsBean.bulletinTrueText}" valueChangeListener="#{AdministerBulletinsBean.valueChanged}">
                    <f:attribute name="#{AdministerBulletinsBean.bulletinInternalAttributeName}" value="#{AdministerBulletinsBean.bulletinContentInternalId}" />
                </h:inputHidden>

                <div class="create-bulletin-form-inputs">

                    <div class="create-bulletin-input">
                        <p:outputLabel for="bulletinUseList" indicateRequired="true" value="#{msg['bulletins.admin.label.use']}" />
                        <p:selectOneMenu id="bulletinUseList" value="#{AdministerBulletinsBean.bulletinForDialogue.parentContext}" required="true"
                                         valueChangeListener="#{AdministerBulletinsBean.valueChanged}">
                            <f:attribute name="#{AdministerBulletinsBean.bulletinInternalAttributeName}" value="#{AdministerBulletinsBean.bulletinUseListInternalId}" />
                            <f:selectItem itemLabel="Select" noSelectionOption="true" />
                            <f:selectItems value="#{AdministerBulletinsBean.availableUses}" var="item" />
                        </p:selectOneMenu>
                    </div>

                    <div class="create-bulletin-input create-bulletin-input-date">
                        <p:outputLabel for="bulletinEffectiveDate" value="#{msg['bulletins.admin.label.effDate']}" />
                        <p:datePicker id="bulletinEffectiveDate" value="#{AdministerBulletinsBean.bulletinForDialogue.effectiveDate}"
                                      pattern="yyyy-MMM-dd" valueChangeListener="#{AdministerBulletinsBean.valueChanged}"
                                      showIcon="true">
                            <f:attribute name="#{AdministerBulletinsBean.bulletinInternalAttributeName}" value="#{AdministerBulletinsBean.bulletinEffectiveDateInternalId}" />
                            <f:validator binding="#{AdministerBulletinsBean.dateValidator}" />
                        </p:datePicker>
                    </div>

                    <div class="create-bulletin-input">
                        <p:outputLabel for="bulletinContext" indicateRequired="true" value="#{msg['bulletins.admin.label.id']}"
                                       rendered="#{AdministerBulletinsBean.isCreate}" />
                        <p:outputLabel for="bulletinContext" indicateRequired="true" value="#{msg['bulletins.admin.label.id']}"
                                       styleClass="readonly" rendered="#{!AdministerBulletinsBean.isCreate}" />
                        <p:inputText id="bulletinContext" value="#{AdministerBulletinsBean.bulletinForDialogue.context}" required="true"
                                     disabled="#{!AdministerBulletinsBean.isCreate}" />
                    </div>

                    <div class="create-bulletin-input create-bulletin-input-date">
                        <p:outputLabel for="bulletinEndDate" value="#{msg['bulletins.admin.label.endDate']}" />
                        <p:datePicker id="bulletinEndDate" value="#{AdministerBulletinsBean.bulletinForDialogue.endDate}"
                                      pattern="yyyy-MMM-dd" valueChangeListener="#{AdministerBulletinsBean.valueChanged}"
                                      showIcon="true">
                            <f:attribute name="#{AdministerBulletinsBean.bulletinInternalAttributeName}" value="#{AdministerBulletinsBean.bulletinExpiredDateInternalId}" />
                        </p:datePicker>
                    </div>

                    <div class="create-bulletin-input">
                        <p:outputLabel for="bulletinTitle" indicateRequired="true" value="#{msg['bulletins.admin.label.title']}" />
                        <p:inputText id="bulletinTitle" value="#{AdministerBulletinsBean.bulletinForDialogue.summary}"
                                     required="true"
                                     valueChangeListener="#{AdministerBulletinsBean.valueChanged}">
                            <f:attribute name="#{AdministerBulletinsBean.bulletinInternalAttributeName}" value="#{AdministerBulletinsBean.bulletinSummaryInternalId}" />
                        </p:inputText>
                    </div>
                    <div class="clear"></div>
                </div>

                <div class="create-bulletin-form-message">
                    <p:outputLabel for="bulletinContent" value="#{msg['bulletins.admin.label.content']}" styleClass="hiddenLabel" />
                    <p:textEditor id="bulletinContent"
                                  widgetVar="bulletinContentEditor"
                                  value="#{AdministerBulletinsBean.bulletinText}"
                                  height="300" placeholder="Enter bulletin content"
                                  required="true"
                                  valueChangeListener="#{AdministerBulletinsBean.valueChanged}">

                        <f:facet name="toolbar">
                            <span class="ql-formats">
                                <select class="ql-font"></select>
                                <select class="ql-size"></select>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-bold"></button>
                                <button class="ql-italic"></button>
                                <button class="ql-underline"></button>
                                <button class="ql-strike"></button>
                            </span>
                        </f:facet>
                    </p:textEditor>
                </div>

                <p:commandButton id="bulletinCreationProceed" value="#{msg['bulletinContent.button.create']}"
                                 rendered="#{AdministerBulletinsBean.isCreate}"
                                 widgetVar="bulletinCreationProceedButton"
                                 action="#{AdministerBulletinsBean.createBulletin()}"
                                 process="bulletinCreateForm"
                                 update="bulletinsForm bulletinMessages"
                                 onclick="$('#bulletinCreateForm\\:bulletinTrueContent').val(PF('bulletinContentEditor').getEditorValue())"
                                 onstart="onDialogueActionStart();"
                                 oncomplete="onDialogueActionComplete(args);">
                </p:commandButton>

                <p:commandButton id="bulletinUpdateProceed" value="#{msg['bulletinContent.button.update']}"
                                 rendered="#{!AdministerBulletinsBean.isCreate}"
                                 widgetVar="bulletinUpdateProceedButton"
                                 action="#{AdministerBulletinsBean.updateBulletin()}"
                                 update="bulletinsForm bulletinMessages"
                                 process="bulletinCreateForm"
                                 onclick="$('#bulletinCreateForm\\:bulletinTrueContent').val(PF('bulletinContentEditor').getEditorValue())"
                                 onstart="onDialogueActionStart();"
                                 oncomplete="onDialogueActionComplete(args);">
                </p:commandButton>

                <p:commandButton id="bulletinDeletionProceed" value="#{msg['bulletinContent.button.delete']}"
                                 rendered="#{!AdministerBulletinsBean.isCreate}"
                                 widgetVar="bulletinDeleteProceedButton"
                                 action="#{AdministerBulletinsBean.deleteBulletin()}"
                                 styleClass="danger"
                                 update="bulletinsForm bulletinMessages"
                                 process="bulletinCreateForm"
                                 immediate="true"
                                 onstart="onDialogueActionStart();"
                                 oncomplete="onDialogueActionComplete(args);">
                    <p:confirm header="Confirmation" message="#{msg['bulletins.admin.message.delete.confirmation']}" icon="pi pi-info-circle" />
                </p:commandButton>

                <p:commandButton id="bulletinCreationCancel" value="#{msg['bulletinContent.button.cancel']}" styleClass="secondary"
                                 widgetVar="bulletinCreationCancelButton"
                                 action="#{AdministerBulletinsBean.clearCurrentBulletin()}"
                                 process="@this"
                                 oncomplete="PF('bulletinCreateDialogWidget').hide();">
                </p:commandButton>

                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no secondary" />
                    <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" />
                </p:confirmDialog>

                <script type="text/javascript">
                    function onDialogueActionStart() {
                        PF('statusDialog').show();
                        gf = PF('globalFilterVar').jq.val();
                    }
                    function onDialogueActionComplete(args) {
                        PF('statusDialog').hide();
                        if (!args.validationFailed) {
                            PF('bulletinsTableWidget').clearFilters();
                            PF('bulletinCreateDialogWidget').hide();
                            PF('globalFilterVar').jq.val(gf);
                            PF('bulletinsTableWidget').filter();
                        } else
                        {
                            PF('globalFilterVar').jq.val(gf);
                        }
                    }
                </script>

            </p:dialog>
        </h:form>

        <ui:include src="/statusSpinner.xhtml" />

    </ui:define>

</ui:composition>
