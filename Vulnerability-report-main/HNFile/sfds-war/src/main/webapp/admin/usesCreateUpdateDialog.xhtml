<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui">

    <p:importEnum type="ca.bc.gov.health.sfds.enums.NotificationType" />
    <p:importEnum type="ca.bc.gov.health.sfds.enums.BooleanTrueFalse" />
    <p:importEnum type="ca.bc.gov.health.sfds.enums.BooleanYesNo" />
    <p:importEnum type="ca.bc.gov.health.sfds.enums.Description" />
    <p:importEnum type="ca.bc.gov.health.sfds.enums.FileRecognizer" />
    <p:importEnum type="ca.bc.gov.health.sfds.enums.SortComparator" />
    <p:importEnum type="ca.bc.gov.health.sfds.enums.FileRenamer" />
    <p:importEnum type="ca.bc.gov.health.sfds.enums.SearchField" />

    <p:importConstants
        type="ca.bc.gov.health.sfds.beans.uses.AdministerUsesBean"
        var="SFDSConstants" />

    <h:form id="useCreateForm">
        <p:dialog id="useCreateDialog" width="700" height="640" closeOnEscape="true"
                  closable="false" modal="true" resizable="false" visible="false"
                  widgetVar="useCreateDialogWidget"
                  header="#{AdministerUsesBean.currentUse.persisted ? msg['uses.admin.update'] : msg['uses.admin.create']}"
                  styleClass="#{AdministerUsesBean.currentUse.multi ? 'multi-use-dialog' : ''}">

            <p:outputPanel id="dialogContent">
                <p:messages id="useMessages" closable="true" escape="false" />

                <div class="table">

                    <div class="row" data-row-id="1.1">
                        <div class="labelCell">
                            <p:outputLabel for="useId"
                                           styleClass="#{AdministerUsesBean.currentUse.persisted ? 'readonly' : ''}"
                                           value="#{msg['uses.admin.dialog.use.id']}" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="name"
                                           value="#{msg['uses.admin.dialog.use.name']}" />
                        </div>
                    </div>
                    <div class="row" data-row-id="1.2">
                        <div class="inputCell">
                            <p:inputText id="useId" widgetVar="useIdWidget"
                                         value="#{AdministerUsesBean.currentUse.useId}" required="true"
                                         disabled="#{AdministerUsesBean.currentUse.persisted}"
                                         maxlength="20"
                                         validatorMessage="#{msg['uses.admin.message.create.invalid.useId']}">
                                <f:validateRegex pattern="#{SFDSConstants.ALPHANUMERIC_PATTERN}" />
                            </p:inputText>
                        </div>
                        <div class="inputCell">
                            <p:inputText id="name"
                                         value="#{AdministerUsesBean.currentUse.name}" required="true"
                                         maxlength="50"
                                         validatorMessage="#{msg['uses.admin.message.create.invalid.name']}">
                                <f:validateRegex
                                    pattern="#{SFDSConstants.ALPHANUMERIC_PATTERN_WITH_SPACE}" />
                            </p:inputText>
                        </div>
                    </div>

                    <div class="row" data-row-id="2.1">
                        <div class="labelCell">
                            <p:outputLabel for="description"
                                           value="#{msg['uses.admin.dialog.use.description']}" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="getLabel"
                                           value="#{msg['uses.admin.dialog.inbox.use.label']}" />
                        </div>
                    </div>
                    <div class="row" data-row-id="2.2">
                        <div class="inputCell">
                            <p:selectOneMenu id="description"
                                             value="#{AdministerUsesBean.currentUse.description}"
                                             required="true">
                                <f:attribute name="description"
                                             value="#{AdministerUsesBean.currentUse.description}" />
                                <f:selectItems value="#{Description.ALL_VALUES}" var="item"
                                               itemValue="#{item.value}" itemLabel="#{item.label}" />
                            </p:selectOneMenu>
                        </div>
                        <div class="inputCell">
                            <p:inputText id="getLabel"
                                         value="#{AdministerUsesBean.currentUse.getLabel}"
                                         required="true" maxlength="50"
                                         validatorMessage="#{msg['uses.admin.message.create.invalid.getLabel']}">
                                <f:validateRegex
                                    pattern="#{SFDSConstants.ALPHANUMERIC_PATTERN_WITH_SPACE}" />
                            </p:inputText>
                        </div>
                    </div>

                    <div class="row" data-row-id="3.1">
                        <div class="labelCell">
                            <p:outputLabel for="sendLabel"
                                           value="#{msg['uses.admin.dialog.send.file.use.label']}" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="notificationType"
                                           value="#{msg['uses.admin.dialog.timing.of.notification']}" />
                        </div>
                    </div>
                    <div class="row" data-row-id="3.2">
                        <div class="inputCell">
                            <p:inputText id="sendLabel"
                                         value="#{AdministerUsesBean.currentUse.sendLabel}"
                                         required="true" maxlength="50"
                                         validatorMessage="#{msg['uses.admin.message.create.invalid.sendLabel']}">
                                <f:validateRegex
                                    pattern="#{SFDSConstants.ALPHANUMERIC_PATTERN_WITH_SPACE}" />
                            </p:inputText>
                        </div>
                        <div class="inputCell">
                            <p:selectOneMenu id="notificationType"
                                             value="#{AdministerUsesBean.currentUse.notificationType}"
                                             required="true">
                                <f:attribute name="notificationType"
                                             value="#{AdministerUsesBean.currentUse.notificationType}" />
                                <f:selectItems value="#{NotificationType.ALL_VALUES}" />
                            </p:selectOneMenu>
                        </div>
                    </div>

                    <div class="row" data-row-id="4.1">
                        <div class="labelCell">
                            <p:outputLabel for="confirmationType"
                                           value="#{msg['uses.admin.dialog.timing.of.confirmation']}" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="acknowledgement"
                                           value="#{msg['uses.admin.dialog.timing.of.acknowledgement']}" />
                        </div>
                    </div>
                    <div class="row" data-row-id="4.2">
                        <div class="inputCell">
                            <p:selectOneMenu id="confirmationType"
                                             value="#{AdministerUsesBean.currentUse.confirmationType}"
                                             required="true">
                                <f:attribute name="confirmationType"
                                             value="#{AdministerUsesBean.currentUse.confirmationType}" />
                                <f:selectItems value="#{NotificationType.ALL_VALUES}" />
                            </p:selectOneMenu>
                        </div>
                        <div class="inputCell">
                            <p:selectOneMenu id="acknowledgement"
                                             value="#{AdministerUsesBean.currentUse.acknowledgement}"
                                             required="true">
                                <f:attribute name="acknowledgement"
                                             value="#{AdministerUsesBean.currentUse.acknowledgement}" />
                                <f:selectItems value="#{NotificationType.ALL_VALUES}" />
                            </p:selectOneMenu>
                        </div>
                    </div>

                    <div class="row" data-row-id="5.1">
                        <div class="labelCell">
                            <p:outputLabel for="fileRecognizer"
                                           value="#{msg['uses.admin.dialog.file.recognition']}" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="sortComparator"
                                           value="#{msg['uses.admin.dialog.sort.order']}" />
                        </div>
                    </div>
                    <div class="row" data-row-id="5.2">
                        <div class="inputCell">
                            <p:selectOneMenu id="fileRecognizer"
                                             value="#{AdministerUsesBean.currentUse.fileRecognizer}"
                                             required="true">
                                <f:attribute name="fileRecognizer"
                                             value="#{AdministerUsesBean.currentUse.fileRecognizer}" />
                                <f:selectItems value="#{FileRecognizer.ALL_VALUES}" var="item"
                                               itemValue="#{item.value}" itemLabel="#{item.label}" />
                            </p:selectOneMenu>
                        </div>
                        <div class="inputCell">
                            <p:selectOneMenu id="sortComparator"
                                             value="#{AdministerUsesBean.currentUse.sortComparator}"
                                             required="true">
                                <f:attribute name="sortComparator"
                                             value="#{AdministerUsesBean.currentUse.sortComparator}" />
                                <f:selectItems value="#{SortComparator.ALL_VALUES}" var="item"
                                               itemValue="#{item.value}" itemLabel="#{item.label}" />
                            </p:selectOneMenu>
                        </div>
                    </div>

                    <div class="row" data-row-id="6.1">
                        <div class="labelCell">
                            <p:outputLabel for="fileRenamer"
                                           value="#{msg['uses.admin.dialog.file.renamer']}" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="textMessage"
                                           value="#{msg['uses.admin.dialog.secure.text.message']}" />
                        </div>
                    </div>
                    <div class="row" data-row-id="6.2">
                        <div class="inputCell">
                            <p:selectOneMenu id="fileRenamer"
                                             value="#{AdministerUsesBean.currentUse.fileRenamer}"
                                             required="true">
                                <f:attribute name="fileRenamer"
                                             value="#{AdministerUsesBean.currentUse.fileRenamer}" />
                                <f:selectItems value="#{FileRenamer.ALL_VALUES}" var="item"
                                               itemValue="#{item.value}" itemLabel="#{item.label}" />
                            </p:selectOneMenu>

                        </div>
                        <div class="inputCell">
                            <p:selectOneMenu id="textMessage"
                                             value="#{AdministerUsesBean.currentUse.textMessage}"
                                             required="true">
                                <f:attribute name="textMessage"
                                             value="#{AdministerUsesBean.currentUse.textMessage}" />
                                <f:selectItems value="#{BooleanYesNo.ALL_VALUES}" var="item"
                                               itemValue="#{item.value}" itemLabel="#{item.label}" />
                            </p:selectOneMenu>
                        </div>
                    </div>

                    <div class="row" data-row-id="7.1">
                        <div class="labelCell">
                            <p:outputLabel for="fileSizeLimit"
                                           value="#{msg['uses.admin.dialog.mailbox.size.limit']}" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="timeLimitDays"
                                           value="#{msg['uses.admin.dialog.file.lifespan']}" />
                        </div>
                    </div>
                    <div class="row" data-row-id="7.2">
                        <div class="inputCell">
                            <p:inputText id="fileSizeLimit" type="number"
                                         value="#{AdministerUsesBean.currentUse.fileSizeLimit}"
                                         required="true" maxlength="4" />
                        </div>
                        <div class="inputCell">
                            <p:inputText id="timeLimitDays" type="number"
                                         value="#{AdministerUsesBean.currentUse.timeLimitDays}"
                                         required="true" maxlength="4">
                            </p:inputText>
                        </div>
                    </div>

                    <div class="row" data-row-id="8.1">
                        <div class="labelCell">
                            <p:outputLabel for="recipient" id="recipientLabel"
                                           styleClass="#{AdministerUsesBean.multiMode ? 'readonly' : ''}"
                                           value="#{msg['uses.admin.dialog.recipient.mailbox.name']}" />
                        </div>
                        <div class="labelCell">
                            <p:outputLabel for="multi"
                                           value="#{msg['uses.admin.dialog.is.multi']}" />
                        </div>
                    </div>
                    <div class="row" data-row-id="8.2">
                        <div class="inputCell">
                            <p:inputText id="recipient" widgetVar="recipientWidget"
                                         value="#{AdministerUsesBean.multiMode ? AdministerUsesBean.multiLabel : AdministerUsesBean.currentUse.rulesbasedaccountDto.accountId}"
                                         required="#{!AdministerUsesBean.multiMode}"
                                         disabled="#{AdministerUsesBean.multiMode}"
                                         validatorMessage="#{msg['uses.admin.message.create.invalid.recipient']}"
                                         maxlength="20">
                                <f:validateRegex pattern="#{SFDSConstants.ALPHANUMERIC_PATTERN}" />
                            </p:inputText>
                        </div>
                        <div class="inputCell">
                            <p:selectBooleanCheckbox id="multi"
                                                     value="#{AdministerUsesBean.multiMode}" itemLabel="Yes">
                                <p:ajax event="valueChange"
                                        update="searchFields, searchFieldsLabel, recipient, recipientLabel, recipientMailboxParameters"
                                        immediate="true">
                                </p:ajax>
                            </p:selectBooleanCheckbox>
                        </div>
                    </div>

                    <div class="row" data-row-id="9.1">
                        <div class="labelCell">
                            <p:outputLabel for="searchFields" id="searchFieldsLabel"
                                           styleClass="#{AdministerUsesBean.multiMode ? '': 'readonly'}"
                                           value="#{msg['uses.admin.dialog.search.parameters']}" />
                        </div>
                    </div>
                    <div class="row" data-row-id="9.2">
                        <div class="inputCell">
                            <p:selectOneMenu id="searchFields" widgetVar="searchFieldsWidget"
                                             value="#{AdministerUsesBean.currentUse.searchFields}"
                                             required="#{AdministerUsesBean.multiMode}"
                                             disabled="#{!AdministerUsesBean.multiMode}">
                                <f:attribute name="searchFields"
                                             value="#{AdministerUsesBean.currentUse.searchFields}" />
                                <f:selectItem itemLabel="Select" noSelectionOption="true" />
                                <f:selectItems value="#{SearchField.ALL_VALUES}" var="item"
                                               itemValue="#{item.value}" itemLabel="#{item.label}" />
                            </p:selectOneMenu>
                        </div>
                    </div>
                </div>

                <p:fieldset style="margin-bottom:2em"
                            id="recipientMailboxParameters">
                    <div class="table">
                        <div class="row">
                            <div class="labelCell">
                                <p:outputLabel
                                    styleClass="#{AdministerUsesBean.multiMode ? 'readonly' : ''}"
                                    value="#{msg['uses.admin.dialog.recipient.mailbox.parameters']}" />
                                <br /> <br />
                            </div>
                        </div>

                        <div class="row" data-row-id="10.1">
                            <div class="labelCell">
                                <p:outputLabel for="businessArea"
                                               styleClass="#{AdministerUsesBean.multiMode ? 'readonly' : ''}"
                                               value="#{msg['uses.admin.dialog.moh.business.area.title']}" />
                            </div>
                            <div class="labelCell">
                                <p:outputLabel for="overwrite"
                                               styleClass="#{AdministerUsesBean.multiMode ? 'readonly' : ''}"
                                               value="#{msg['uses.admin.dialog.file.overwrite']}" />
                            </div>
                        </div>
                        <div class="row" data-row-id="10.2">
                            <div class="inputCell">
                                <p:inputText id="businessArea" widgetVar="businessAreaWidget"
                                             value="#{AdministerUsesBean.currentUse.rulesbasedaccountDto.businessArea}"
                                             required="#{!AdministerUsesBean.multiMode}"
                                             disabled="#{AdministerUsesBean.multiMode}" maxlength="30"
                                             validatorMessage="#{msg['uses.admin.message.create.invalid.businessArea']}">
                                    <f:validateRegex
                                        pattern="#{SFDSConstants.ALPHANUMERIC_PATTERN_WITH_SPACE}" />
                                </p:inputText>
                            </div>
                            <div class="inputCell">
                                <p:selectOneMenu id="overwrite" widgetVar="overwriteWidget"
                                                 value="AdministerUsesBean.currentUse.rulesbasedaccoun Dto.overwrite"
                                                 required="true" disabled="#{AdministerUsesBean.multiMode}">
                                    <f:selectItems value="#{BooleanTrueFalse.ALL_VALUES}"
                                                   var="item" itemValue="#{item.value}" itemLabel="#{item.label}" />
                                </p:selectOneMenu>
                            </div>
                        </div>

                        <div class="row" data-row-id="11.1">
                            <div class="labelCell">
                                <p:outputLabel for="sendingUseId"
                                               styleClass="#{AdministerUsesBean.multiMode ? 'readonly' : ''}"
                                               value="#{msg['uses.admin.dialog.sending.use']}" />
                            </div>
                            <div class="labelCell">
                                <p:outputLabel for="rulesbasedaccountNotificationType"
                                               styleClass="#{AdministerUsesBean.multiMode ? 'readonly' : ''}"
                                               value="#{msg['uses.admin.dialog.eulesbased.timing.of.notifictn']}" />
                            </div>
                        </div>
                        <div class="row" data-row-id="11.2">
                            <div class="inputCell">
                                <p:inputText id="sendingUseId"
                                             value="#{AdministerUsesBean.currentUse.rulesbasedaccountDto.sendingUseId}"
                                             required="#{!AdministerUsesBean.multiMode}"
                                             disabled="#{AdministerUsesBean.multiMode}" maxlength="20"
                                             validatorMessage="#{msg['uses.admin.message.create.invalid.sendingUseId']}">
                                    <f:validateRegex
                                        pattern="#{SFDSConstants.ALPHANUMERIC_PATTERN}" />
                                </p:inputText>
                            </div>
                            <div class="inputCell">
                                <p:selectOneMenu id="rulesbasedaccountNotificationType"
                                                 widgetVar="rulesbasedaccountNotificationTypeWidget"
                                                 value="#{AdministerUsesBean.currentUse.rulesbasedaccountDto.notificationType}"
                                                 required="true" disabled="#{AdministerUsesBean.multiMode}">
                                    <f:selectItems value="#{NotificationType.ALL_VALUES}"
                                                   var="item" itemValue="#{item.value}" itemLabel="#{item.label}" />
                                </p:selectOneMenu>
                            </div>
                        </div>

                        <div class="row" data-row-id="12.1">
                            <div class="labelCell">
                                <p:outputLabel for="rulesbasedaccountConfirmationType"
                                               styleClass="#{AdministerUsesBean.multiMode ? 'readonly' : ''}"
                                               value="#{msg['uses.admin.dialog.rulesbased.timing.of.confirmtn']}" />
                            </div>
                            <div class="labelCell">
                                <p:outputLabel for="rulesbasedaccountAcknowledgementType"
                                               styleClass="#{AdministerUsesBean.multiMode ? 'readonly' : ''}"
                                               value="#{msg['uses.admin.dialog.rulesbased.timing.of.ack']}" />
                            </div>
                        </div>
                        <div class="row" data-row-id="12.2">
                            <div class="inputCell">
                                <p:selectOneMenu id="rulesbasedaccountConfirmationType"
                                                 widgetVar="rulesbasedaccountConfirmationTypeWidget"
                                                 value="#{AdministerUsesBean.currentUse.rulesbasedaccountDto.confirmationType}"
                                                 required="true" disabled="#{AdministerUsesBean.multiMode}">
                                    <f:selectItems value="#{NotificationType.ALL_VALUES}"
                                                   var="item" itemValue="#{item.value}" itemLabel="#{item.label}" />
                                </p:selectOneMenu>
                            </div>
                            <div class="inputCell">
                                <p:selectOneMenu id="rulesbasedaccountAcknowledgementType"
                                                 widgetVar="rulesbasedaccountAcknowledgementTypeWidget"
                                                 value="#{AdministerUsesBean.currentUse.rulesbasedaccountDto.acknowledgementType}"
                                                 required="true" disabled="#{AdministerUsesBean.multiMode}">
                                    <f:selectItems value="#{NotificationType.ALL_VALUES}"
                                                   var="item" itemValue="#{item.value}" itemLabel="#{item.label}" />
                                </p:selectOneMenu>
                            </div>
                        </div>
                    </div>

                </p:fieldset>
            </p:outputPanel>

            <p:commandButton id="useCreationProceed"
                             styleClass="ie-fix"
                             value="#{msg['usesContent.button.create']}"
                             rendered="#{!AdministerUsesBean.currentUse.persisted}"
                             widgetVar="useCreationProceedButton"
                             action="#{AdministerUsesBean.createUse()}"
                             process="useCreateForm"
                             update="usesForm useMessages"
                             onclick="onclickFn()"
                             onstart="onstartFn()"
                             onerror="onerrorFn(xhr, status, exception)"
                             oncomplete="oncompleteFn(xhr, status, args)">
            </p:commandButton>

            <p:commandButton id="useUpdateProceed"
                             value="#{msg['usesContent.button.update']}"
                             rendered="#{AdministerUsesBean.currentUse.persisted}"
                             widgetVar="useUpdateProceedButton"
                             action="#{AdministerUsesBean.updateUse()}"
                             update="usesForm useMessages"
                             process="useCreateForm"
                             onclick="onclickFn()"
                             onstart="onstartFn()"
                             styleClass="ie-fix"
                             oncomplete="oncompleteFn(xhr, status, args)">
            </p:commandButton>

            <p:commandButton id="useDeletionProceed"
                             value="#{msg['usesContent.button.delete']}"
                             rendered="#{AdministerUsesBean.currentUse.persisted}"
                             widgetVar="useDeleteProceedButton"
                             action="#{AdministerUsesBean.deleteUse()}"
                             styleClass="danger ie-fix"
                             update="usesForm useMessages"
                             process="useCreateForm"
                             onclick="onclickFn()"
                             onstart="onstartFn()"
                             oncomplete="oncompleteFn(xhr, status, args)">
                <p:confirm header="Confirmation"
                           message="#{msg['uses.admin.message.delete.confirmation']}"
                           icon="pi pi-info-circle" />
            </p:commandButton>

            <p:commandButton id="useCreationCancel"
                             value="#{msg['usesContent.button.cancel']}" styleClass="secondary ie-fix"
                             widgetVar="useCreationCancelButton" immediate="true" process="@form"
                             resetValues="true" oncomplete="PF('useCreateDialogWidget').hide();">
            </p:commandButton>

            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade"
                             responsive="true" width="350">
                <p:commandButton value="No" type="button"
                                 styleClass="ui-confirmdialog-no secondary" />
                <p:commandButton value="Yes" type="button"
                                 styleClass="ui-confirmdialog-yes" />
            </p:confirmDialog>
        </p:dialog>
    </h:form>

    <ui:include src="/statusSpinner.xhtml" />

    <script>
        function clearMessages() {
            $('a.ui-messages-close').click();
        }

        function showProgress(state) {
            if (state) {
                PF('statusDialog').show();
            } else {
                PF('statusDialog').hide();
            }
        }

        function onclickFn() {
            clearMessages();
        }

        function onstartFn() {
            gf = PF('globalFilterVar').jq.val();
            showProgress(true);
            PF('useCreateDialogWidget').hide();
        }

        function onerrorFn() {
            console.log("onerror", xhr, status, exception);
        }

        function oncompleteFn(xhr, status, args) {
            console.log("Filter is " + gf);
            showProgress(false);
            if (args.validationFailed) {
                console.log("Validation failed; filter is " + gf);
                PF('globalFilterVar').jq.val(gf);
                PF('useCreateDialogWidget').show();
            } else
            {
                console.log("Validation succeeded");
                PF('usesTableWidget').clearFilters();
                PF('globalFilterVar').jq.val(gf);
                PF('usesTableWidget').filter();
            }
        }
    </script>
</ui:composition>