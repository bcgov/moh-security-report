/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.rtrans.ha.service;

import ca.bc.gov.moh.rtrans.entity.Message;
import java.util.Map;
import org.apache.camel.Exchange;
import org.apache.camel.Processor;
import org.slf4j.LoggerFactory;

/**
 * Sets the {@link #SSL_ID} exchange property on the route. The exchange property
 * identifies which SSL certificates to use when calling HCIM endpoints.
 * <p>
 * The property is set based on a map defined in "haEnvironmentSpecific.xml"
 * which maps HCIM Organization IDs to SSL context parameters.
 *
 * @author David Sharpe (david.a.sharpe@cgi.com)
 */
public class LookupSslParamsForOrg implements Processor {
    
    private final Map<String,String> certificateMapping;
    
    public static final String SSL_ID = "sslId";
    
    private static final org.slf4j.Logger logger = LoggerFactory.getLogger(LookupSslParamsForOrg.class);

    public LookupSslParamsForOrg(Map<String, String> certificateMapping) {
        this.certificateMapping = certificateMapping;
    }
    
    public void process(Exchange exchange) throws Exception {
        Message message = exchange.getIn().getBody(Message.class);
        String orgId = message.getSender().getOrganization();
        String certId = certificateMapping.get(orgId);
        if (certId == null) {
            logger.error("No certificate mapping found for '{}'.", orgId);
        }
        exchange.setProperty(SSL_ID, certId);
    }
    
}
