/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

package ca.bc.gov.moh.rtrans.entity.transaction.converter;

import ca.bc.gov.moh.rtrans.util.converter.HAValueMapperConstants;
import ca.bc.gov.moh.rtrans.util.converter.HaValueMapperConfiguration;
import java.util.Properties;
import org.apache.camel.component.file.FileComponent;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

/**
 *
 * @author conrad.gustafson
 */
@Component
public class HealthAuthorityValueMapper extends FileComponent {
    
    private static HealthAuthorityValueMapper instance = null;
    
    public static HealthAuthorityValueMapper getInstance() {
        if (instance==null){
            instance = new HealthAuthorityValueMapper();
            HaValueMapperConfiguration config = new HaValueMapperConfiguration();
            config.setHaValueMapConfigProperties(new Properties());
            instance.setHaValueMapperConfiguration(config);
        }
        return instance;
    }

    public HealthAuthorityValueMapper() {
        instance = this;
    }
    
    private HaValueMapperConfiguration haValueMapperConfiguration;

    @Autowired
    public void setHaValueMapperConfiguration(HaValueMapperConfiguration haValueMapperConfiguration) {
        this.haValueMapperConfiguration = haValueMapperConfiguration;
    }
    
    public String mapRequestSenderApplication(String sendingApplication, String sendingFacility) {
        if (StringUtils.isEmpty(sendingFacility)) {
            return sendingFacility;
        }
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(HAValueMapperConstants.REQUEST
                .concat(HAValueMapperConstants.SOURCE)
                .concat(sendingFacility))) {
            return haValueMapperConfiguration.getLookupValue(HAValueMapperConstants.REQUEST
                    .concat(HAValueMapperConstants.SOURCE)
                    .concat(sendingFacility));
        } else {
            //Only using the sendingFacility if we can map it, otherwise use the sending application in this field
            //TO DO verify this behavior is correct
            //TSS 2017/07/25
            return sendingApplication;
        }
    }

    public String mapRequestSenderFacility(String v2Input) {
        if (StringUtils.isEmpty(v2Input)) {
            return v2Input;
        }
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(HAValueMapperConstants.REQUEST
                .concat(HAValueMapperConstants.ORG)
                .concat(v2Input))) {
            return haValueMapperConfiguration.getLookupValue(HAValueMapperConstants.REQUEST
                    .concat(HAValueMapperConstants.ORG)
                    .concat(v2Input));
        } else {
            return v2Input;
        }
    }
    
    public String mapRequestReceiverApplication(String v2Input) {
        if (StringUtils.isEmpty(v2Input)) {
            return v2Input;
        }
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(HAValueMapperConstants.REQUEST.concat(v2Input))) {
            return haValueMapperConfiguration.getLookupValue(HAValueMapperConstants.REQUEST.concat(v2Input));
        } else {
            return v2Input;
        }
    }
    public String mapRequestReceiverFacility(String v2Input) {
        if (StringUtils.isEmpty(v2Input)) {
            return v2Input;
        }
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(HAValueMapperConstants.REQUEST.concat(v2Input))) {
            return haValueMapperConfiguration.getLookupValue(HAValueMapperConstants.REQUEST.concat(v2Input));
        } else {
            return v2Input;
        }
    }

    //map response from HCIM to Cerner
    public String mapMSH11Segment(String envInput) {
        if (StringUtils.isEmpty(envInput)) {
            return envInput;
        }
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(envInput)) {
            return haValueMapperConfiguration.getLookupValue(envInput);
        } else {
            return envInput;
        }
    }

    public String mapMsa3_TextMessageRP207(String input) {
        if (StringUtils.isEmpty(input)) {
            return input;
        }
        
        String inputV3ErrorCode = "BCHCIM_RP_2_0007_V3_INPUT";
        String inputV2ErrorText = "BCHCIM_RP_2_0007_V2_TEXT";
        if (input.startsWith(haValueMapperConfiguration.getLookupValue(inputV3ErrorCode))) {
            return haValueMapperConfiguration.getLookupValue(inputV2ErrorText);
        } else {
            return input;
        }
    }
    
    public String mapMsa3_TextMessageRP021(String input) {
        if (StringUtils.isEmpty(input)) {
            return input;
        }
        
        String inputV3ErrorCode = "BCHCIM_RP_0_0021_V3_INPUT";
        String inputV2ErrorText = "BCHCIM_RP_0_0021_V2_TEXT";
        if (input.equals(haValueMapperConfiguration.getLookupValue(inputV3ErrorCode))) {
            return haValueMapperConfiguration.getLookupValue(inputV2ErrorText);
        } else {
            return input;
        }
    }
    
    public String mapMsa3_TextMessageRP222(String input) {
        if (StringUtils.isEmpty(input)) {
            return input;
        }
        
        String inputV3ErrorCode = "BCHCIM_RP_2_0022_V3_INPUT";
        String inputV2ErrorText = "BCHCIM_RP_2_0022_V2_TEXT";
        if (input.equals(haValueMapperConfiguration.getLookupValue(inputV3ErrorCode))) {
            return haValueMapperConfiguration.getLookupValue(inputV2ErrorText);
        } else {
            return input;
        }
    }
    
    public String mapPid4_getCx4_AssigningAuthorityMessage(String input) {
        if (StringUtils.isEmpty(input)) {
            return input;
        }
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(HAValueMapperConstants.RESPONSE.concat(input))) {
            return haValueMapperConfiguration.getLookupValue(HAValueMapperConstants.RESPONSE.concat(input));
        } else {
            return input;
        }
    }
    
    public String mapPid4_getCx5_IdentifierTypeCode(String input) {
        if (StringUtils.isEmpty(input)) {
            return input;
        }
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(HAValueMapperConstants.RESPONSE.concat(input))) {
            return haValueMapperConfiguration.getLookupValue(HAValueMapperConstants.RESPONSE.concat(input));
        } else {
            return input;
        }
    }
    
    public String mapPid3_getCx4_AssigningAuthorityMessage(String input) {
        if (StringUtils.isEmpty(input)) {
            return input;
        }
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(HAValueMapperConstants.REVISE_PERSON_DISTRIBUTION_REQUEST_MRN.concat(input))) {
            return haValueMapperConfiguration.getLookupValue(HAValueMapperConstants.REVISE_PERSON_DISTRIBUTION_REQUEST_MRN.concat(input));
        } else {
            return input;
        }
    }
    
    /**
     * Common lookup method for mapping specific PID4 segment elements
     * (Assigning Authority) from v2 request messages.
     * 
     * @param input String - PID4 segment value
     * @return String
     */
    public String mapPid4_getCx4_AssigningAuthorityRequest(String input) {
        if (StringUtils.isEmpty(input)) {
            return input;
        }
        // replace whitespaces with '_'
        String inputReq = StringUtils.replace(input, " ", "_");
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(HAValueMapperConstants.REQUEST.concat(inputReq))) {
            return haValueMapperConfiguration.getLookupValue(HAValueMapperConstants.REQUEST.concat(inputReq));
        } else {
            return input;            
        }
    }
    
    /**
     * Common lookup method for mapping specific PID4 segment elements
     * (Identifier Type Code) from v2 request messages.
     * 
     * @param input String - PID4 segment value
     * @return String
     */
    public String mapPid4_getCx5_IdentifierTypeCodeRequest(String input) {
        if (StringUtils.isEmpty(input)) {
            return input;
        }
        // replace whitespaces with '_'
        String inputReq = StringUtils.replace(input, " ", "_");
        
        if (haValueMapperConfiguration.getHaValueMapConfigProperties().containsKey(HAValueMapperConstants.REQUEST.concat(inputReq))) {
            return haValueMapperConfiguration.getLookupValue(HAValueMapperConstants.REQUEST.concat(inputReq));
        } else {
            return input;
        }
    }
}
