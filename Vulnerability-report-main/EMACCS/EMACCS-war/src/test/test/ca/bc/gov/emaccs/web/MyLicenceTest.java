/*******************************************************************************
 * Copyright Â© 2015, Province of British Columbia.                             *
 *                                                                             *
 * All rights reserved.                                                        *
 *                                                                             *
 * File:                        MyLicenceTest.java                             *
 * Date of Last Commit: $Date:: 2015-06-22 17:18:37 -0700 (Mon, 22 Jun 2015) $ *
 * Revision Number:      $Rev:: 2540                                         $ *
 * Last Commit by:    $Author:: cmatsond                                     $ *
 *                                                                             *
 *******************************************************************************/

/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package test.ca.bc.gov.emaccs.web;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import static org.junit.Assert.*;
import org.junit.Before;
import org.junit.Test;
import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;

/**
 *
 * @author joshua.lewis
 */
public class MyLicenceTest extends BaseTestCase {

    @Before
    public void goToMyLicence() {
        findElement(By.linkText("EMACCS Home")).click();
        findElement(By.linkText("View My Licence")).click();
    }


    @Test
    public void testPresence() {
        // Page header
        assertTrue(isTextPresent("My Licence"));

        // Entry box contents
        By entryDiv = By.id("form1:entry");

        assertTrue(isTextPresent(entryDiv, "Expiry"));
        assertTrue(isTextPresent(entryDiv, "Suspension Date"));

        // Necessary Tables and Columns
        By qualificationsTable = By.xpath("//div[2]/div/div");
        By endorsementsTable = By.xpath("//div[2]/div/div[2]");
        By restrictionsTable = By.xpath("//div[2]/div/div[3]");

        // Patient Contacts table and columns
        assertTrue(isTextPresent(qualificationsTable, "Qualification"));
        assertTrue(isTextPresent(qualificationsTable, "Description"));
        assertTrue(isTextPresent(qualificationsTable, "Effective Date"));
        assertTrue(isTextPresent(qualificationsTable, "Expiry Date"));

        // Approved Activities table and columns
        assertTrue(isTextPresent(endorsementsTable, "Endorsements"));
        assertTrue(isTextPresent(endorsementsTable, "Description"));
        assertTrue(isTextPresent(endorsementsTable, "Certification Date"));
        assertTrue(isTextPresent(endorsementsTable, "Edit"));

        List<WebElement> editCol = driver.findElements(By.xpath("//div[2]/table/tbody/tr/td[3]"));
        List<WebElement> relinquishBtns = driver.findElements(By.xpath("//div[2]/table/tbody/tr/td[3]/input[@type='submit'][@value='Relinquish']"));

        // There should be an relinquish button for every row
        assertTrue(editCol.size() == relinquishBtns.size());

        // Activities Pending Approval table and columns
        assertTrue(isTextPresent(restrictionsTable, "Restrictions"));
        assertTrue(isTextPresent(restrictionsTable, "Description"));
        assertTrue(isTextPresent(restrictionsTable, "Restricted Date"));


        assertTrue(isElementPresent(By.xpath("//input[@type='submit'][@value='Relinquish Licence']")));

    }

    @Test
    public void testPopups() {

        // click a Relinquish button
        findElement(By.xpath("//div[2]/table/tbody/tr/td[3]/input[@type='submit'][@value='Relinquish']")).click();
        waitasec();
        // assert that the popup appears, and that it has a message
        assertTrue(findElement(By.id("form1:relinquishEndorsementPopup_content")).isDisplayed());
        assertTrue(findElement(By.id("form1:relinquishEndorsementPopup_content"))
                .getText().matches(regexIt("Are you sure you want to relinquish this IV endorsement")));

        // click cancel, and assert that the popup disappears
        findElement(By.xpath("//div[@id='form1:relinquishEndorsementPopup_content']/div/button")).click();
        waitasec();
        assertFalse(findElement(By.id("form1:relinquishEndorsementPopup_content")).isDisplayed());


        // click Relinquish Licence button
        findElement(By.id("form1:relinquishPopupButton")).click();
        waitasec();
        // assert that the popup appears, and that it has a message
        assertTrue(findElement(By.id("form1:relinquishLicencePopup_content")).isDisplayed());
        assertTrue(findElement(By.id("form1:relinquishLicencePopup_content"))
                .getText().matches(regexIt("Are you sure you want to relinquish your licence")));

        // click cancel, and assert that the popup disapears
        findElement(By.xpath("//div[@id='form1:relinquishLicencePopup_content']/div/button")).click();
        waitasec();
        assertFalse(findElement(By.id("form1:relinquishLicencePopup_content")).isDisplayed());

    }

    @Test
    public void testRelinquished() {

        // Check that the endorsement disappears from the list
        String relinquishedIV = findElement(By.xpath("//div[2]/table/tbody/tr/td[1]")).getText();
        String relinquishedDate = findElement(By.xpath("//div[2]/table/tbody/tr/td[2]")).getText();
        findElement(By.xpath("//div[2]/table/tbody/tr/td[3]/input[@type='submit'][@value='Relinquish']")).click();
        waitasec();
        findElement(By.xpath("//div[@id='form1:relinquishEndorsementPopup_content']/div/input[@value='Relinquish']")).click();

        assertEquals("Endorsement Relinquished", findElement(By.cssSelector("span.rf-msgs-sum")).getText());
        assertFalse(findElement(By.xpath("//div[2]/table/tbody"))
                .getText().matches(regexIt(relinquishedIV)));
        assertFalse(findElement(By.xpath("//div[2]/table/tbody"))
                .getText().matches(regexIt(relinquishedDate)));

        // Check that the suspension date is updated
        findElement(By.id("form1:relinquishPopupButton")).click();
        waitasec();
        findElement(By.xpath("//div[@id='form1:relinquishLicencePopup_content']/div/input[@value='Relinquish']")).click();

        waitasec();
        SimpleDateFormat fmt = new SimpleDateFormat("yyyy/MM/dd");
        assertEquals("Suspension Date: " + fmt.format(new Date()),
                findElement(By.id("form1:entry_body"))
                .findElement(By.xpath("//table/tbody/tr/td[2]")).getText());

    }

}
