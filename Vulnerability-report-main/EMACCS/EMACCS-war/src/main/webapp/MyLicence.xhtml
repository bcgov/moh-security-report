<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/gov30Template.xhtml">

    <ui:define name="title">My Licence</ui:define>
    <ui:define name="body">

        <h1 >My Licence</h1>

        <h:form id="form1">
            <ui:include src="/WEB-INF/fragments/returnedMail.xhtml" />

            <ui:fragment rendered="#{User.isInactive}">
                <ui:include src="/WEB-INF/fragments/noAccess.xhtml" />
            </ui:fragment>

            <ui:fragment rendered="#{not User.isInactive}">
                <h:panelGroup id="licenceNumber" class="ui-g-12" style="padding-left: 25px">
<!--                    <p:panelGrid columns="2" styleClass="borderless ui-grid-blank" layout="grid" -->
<!--                                 columnClasses="ui-grid-col-1 label-col, ui-grid-col-4" >-->

                        #{msg['EmergencyMedicalAssistant.licno.desc']}:
                        <p:inputText value="#{MyLicence.licenceNumber}" size="10" maxlength="6" label="LicenceNumber" 
                                     id="LicenceNumber" valueChangeListener="#{MyLicence.changeLicenceNumber}"
                                     style="margin-left:20px; margin-right: 20px">
<!--                            <p:ajax event="change" update="form1 global-messages" process="@this" />-->
                        </p:inputText>
                    <p:commandButton action="#{MyLicence.search}"  styleClass="submit-button interactiveButton"
                                     value="#{msg['button.search']}"
                                     update="form1 global-messages" partialSubmit="true" process="LicenceNumber"/>

<!--                    </p:panelGrid>-->
                </h:panelGroup>


                <h:panelGroup rendered="#{!MyLicence.licenceNumber.isEmpty() and MyLicence.validLicenceNumber}">

                    <h:panelGroup styleClass="error-message" rendered="#{User.isInactive}">
                        <i class="pi pi-ban"/>
                        <h:outputText value="#{msg['User.inactive']}"  />
                    </h:panelGroup>

                    <p:panelGrid columns="2" styleClass="borderless ui-grid-blank licence-info" layout="grid" 
                                 columnClasses="ui-grid-col-2 label-col pct-width-12, ui-grid-col-4" style="margin-bottom: 20px" >
                        Expiry:
                        <h:outputText value="#{MyLicence.getAsBasicDateString(MyLicence.licenceInfo.licexpdt)}"/>

                        Suspension Date:
                        <h:outputText value="#{MyLicence.getAsBasicDateString(MyLicence.suspDate)}" rendered="#{MyLicence.suspDate!=null}"/>
                    </p:panelGrid>

                    <p:dataTable value="#{MyLicence.qualifications}" var="quals" rows="10" style="margin-bottom: 20px" >
                        <f:facet name="header"><h:outputText value="Qualification"/></f:facet>

                        <p:column sortBy="#{quals.qcode.qdesc}" headerText="Description">
                            #{quals.qcode.qdesc}
                        </p:column>

                        <p:column sortBy="#{quals.effectdt}" headerText="Effective Date">
                            <f:facet name="header">Effective Date</f:facet>
                            <h:outputText value="#{MyLicence.getAsBasicDateString(quals.effectdt)}">
                            </h:outputText>
                        </p:column>

                        <p:column sortBy="#{quals.enddate}" headerText="Expiry Date" styleClass="last-col">
                            <h:outputText value="#{MyLicence.getAsBasicDateString(quals.licexpdt)}"/>
                        </p:column>
                    </p:dataTable>

                    <p:dataTable value="#{MyLicence.endorsements}" var="endors" rows="10" style="margin-bottom: 20px">
                        <f:facet name="header">Endorsements</f:facet>

                        <p:column sortBy="#{endors.ecode.edesc}" headerText="Description">
                            #{endors.ecode.edesc}
                        </p:column>

                        <p:column sortBy="#{endors.ecertdate}" headerText="Certification Date" 
                                  styleClass="#{(endors.ecode.ecode.equals('E23') or endors.ecode.ecode.equals('E24'))
                                                and !User.isInactive ? 'last-col' : ''} ">
                            <h:outputText value="#{MyLicence.getAsBasicDateString(endors.ecertdate)}"/>
                        </p:column>

                        <p:column id="relinquishIv" style="text-align: center;" headerText="Edit">
                            <p:commandButton id="selectButton"
                                             value="Relinquish"
                                             oncomplete="PF('relinquishEndorsementPopup').show();"
                                             update="form1:relinquishEndorsementPopup" process="@this"
                                             rendered="#{(endors.ecode.ecode.equals('E23') or endors.ecode.ecode.equals('E24'))
                                                         and !User.isInactive}">
                                <f:setPropertyActionListener id="selectParam" target="#{MyLicence.endorsement}" value="#{endors}" />
                            </p:commandButton>
                        </p:column>
                    </p:dataTable>

                    <p:dataTable value="#{MyLicence.restrictions}" var="restrs" rows="10" style="margin-bottom: 20px">
                        <f:facet name="header">Restrictions</f:facet>

                        <p:column sortBy="#{restrs.rcode.rdesc}" headerText="Description">
                            #{restrs.rcode.rdesc}
                        </p:column>

                        <p:column sortBy="#{restrs.restdate}" headerText="Restricted Date">
                            <h:outputText value="#{MyLicence.getAsBasicDateString(restrs.restdate)}"/>
                        </p:column>        
                    </p:dataTable>

                    <h:panelGroup id="relinquishPopupPanel" rendered="#{MyLicence.validLicenceNumber and MyLicence.suspDate == null}">
                        <p:commandButton id="relinquishPopupButton" 
                                         value="Relinquish Licence" oncomplete="PF('relinquishLicencePopup').show();" 
                                         process="@this" update="relinquishLicencePopup"  />
                    </h:panelGroup>


                    <p:dialog id="relinquishEndorsementPopup" widgetVar="relinquishEndorsementPopup" modal="true" header="Confirmation">

                        <h:outputText class="label right" value="#{MyLicence.endorsement.ecode.edesc}" />
                        <br />
                        Are you sure you want to relinquish this IV endorsement?
                        <br /><br />
                        <div class="center">
                            <p:commandButton id="relinquishEndorsementButton"
                                             action="#{MyLicence.relinquishEndorsement}"
                                             value="Relinquish"
                                             onclick="PF('relinquishEndorsementPopup').hide();"
                                             update="form1" styleClass="submit-button"/>
                            <h:commandLink onclick="PF('relinquishEndorsementPopup').hide(); return false;">Cancel</h:commandLink>
                        </div>
                    </p:dialog>

                    <p:dialog id="relinquishLicencePopup" widgetVar="relinquishLicencePopup" modal="true" header="Confirmation">

                        Licence #: <h:outputText class="label right" value="#{MyLicence.licenceInfo.licno}" />
                        <br />
                        Are you sure you want to relinquish your licence?
                        <br /><br />

                        <div class="center">
                            <p:commandButton id="relinquishLicenceButton"
                                             action="#{MyLicence.relinquishLicence}"
                                             value="Relinquish" styleClass="submit-button"
                                             onclick="PF('relinquishLicencePopup').hide();"
                                             update="form1"/>
                            <h:commandLink onclick="PF('relinquishLicencePopup').hide();return false;">Cancel</h:commandLink>
                        </div>
                    </p:dialog>

                </h:panelGroup>
            </ui:fragment>

        </h:form>
        <script type="text/javascript">

            // Function for submitting licence number form when enter key is pressed
            function detectEnter(event) {
                if (event.keyCode == 13) {
                    document.getElementById("form1:LicenceNumber").blur();
                    return false;
                }
            }

        </script>
    </ui:define>
</ui:composition>