<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/gov30Template.xhtml">

    <ui:define name="title">My Continuing Competence Status</ui:define>
    <ui:define name="body">

        <h1 >My Continuing Competence Status</h1>

        <h:form id="form1" enctype="multipart/form-data">

            <ui:include src="/WEB-INF/fragments/returnedMail.xhtml" />

            <ui:fragment rendered="#{User.isInactive}">
                <ui:include src="/WEB-INF/fragments/noAccess.xhtml" />
            </ui:fragment>

            <ui:fragment rendered="#{not User.isInactive}">
                <h:panelGroup id="licenceNumber"  style="padding-left: 25px; margin-bottom: 20px">
<!--                    <p:panelGrid columns="2" styleClass="borderless ui-grid-blank" layout="grid"-->
<!--                                 columnClasses="ui-grid-col-1 label-col, ui-grid-col-4" >-->

                        #{msg['EmergencyMedicalAssistant.licno.desc']}:
                        <p:inputText value="#{MyContinuingCompetence.licenceNumber}" size="10" maxlength="6" label="LicenceNumber" 
                                     id="LicenceNumber" valueChangeListener="#{MyContinuingCompetence.changeLicenceNumber}"
                                     style="margin-left:20px; margin-right: 20px">
<!--                            <p:ajax event="change" update="form1 global-messages" process="@this" />-->
                        </p:inputText>
                    <p:commandButton action="#{MyContinuingCompetence.search}"
                                     styleClass="submit-button interactiveButton"
                                     value="#{msg['button.search']}"
                                     update="form1 global-messages"  partialSubmit="true" process="LicenceNumber"/>
<!--                    </p:panelGrid>-->
                </h:panelGroup>

                <h:panelGroup styleClass="error-message" rendered="#{User.isInactive}">
                    <i class="pi pi-ban"/>
                    <h:outputText value="#{msg['User.inactive']}"  />
                </h:panelGroup>

                <h:panelGroup rendered="#{!MyContinuingCompetence.licenceNumber.isEmpty() and MyContinuingCompetence.validLicenceNumber}">           
                    <p:panelGrid columns="4" styleClass="borderless ui-grid-blank licence-info" layout="grid" 
                                 columnClasses="ui-grid-col-2 label-col pct-width-12, ui-grid-col-2, ui-grid-col-3 label-col, ui-grid-col-2" >

                        Reporting Year:
                        <h:selectOneMenu id="reportingYear"
                                         value="#{MyContinuingCompetence.reportingYearId}"
                                         valueChangeListener="#{MyContinuingCompetence.selectReportingYear}">
                            <f:selectItems value="#{Droplists.reportingYears}" />
                            <p:ajax process="@this" update="form1" event="change"  />
                        </h:selectOneMenu>

                        Patient Contacts:
                        <h:outputText value="#{MyContinuingCompetence.patientContactCount}" />

                        CC Status:
                        <h:outputText value="#{MyContinuingCompetence.licenceMaintenance.ccode.cdesc}" />

                        Continuing Education Credits:
                        <h:outputText value="#{MyContinuingCompetence.contEducationCreditCount}" />

                    </p:panelGrid>

                    <h2>Patient Contact and Continuing Education List</h2>
                    <p:dataTable id="patientTable" value="#{MyContinuingCompetence.patientContacts}" var="row" rows="10" 
                                 style="margin-bottom: 20px" paginator="true" paginatorPosition="top" paginatorAlwaysVisible="false"
                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}">
                        <f:facet name="header">Patient Contacts</f:facet>

                        <p:column sortBy="#{row.callDate}" headerText="#{msg['PatientContact.callDate.desc']}">
                            <h:outputText value="#{MyContinuingCompetence.getAsDateTimeString(row.callDate)}"/>
                        </p:column>

                        <p:column sortBy="#{row.contactTypeId.contactTypeName}" headerText="#{msg['PatientContact.contactTypeId.desc']}">
                            #{row.contactTypeId.contactTypeName}
                        </p:column>

                        <p:column sortBy="#{row.contactSubtypeId.contactSubtypeName}" headerText="#{msg['PatientContact.contactSubtypeId.desc']}">
                            #{row.contactSubtypeId.contactSubtypeName}
                        </p:column>

                        <p:column sortBy="#{row.skill1Id.skillName}" headerText="#{msg['PatientContact.skill1Id.desc']}">
                            #{row.skill1Id.skillName}
                        </p:column>

                        <p:column sortBy="#{row.skill2Id.skillName}" headerText="#{msg['PatientContact.skill2Id.desc']}">
                            #{row.skill2Id.skillName}
                        </p:column>   
                    </p:dataTable>


                    <p:dataTable id="approvedTable" value="#{MyContinuingCompetence.approvedActivities}" var="row" rows="10"
                                 style="margin-bottom: 20px" paginator="true" paginatorPosition="top" paginatorAlwaysVisible="false"
                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}">
                        <f:facet name="header">Approved Activities</f:facet>

                        <p:column sortBy="#{row.activityName}" headerText="Activity Name">
                            #{row.activityName}
                        </p:column>

                        <p:column sortBy="#{row.nocpListAsString}" headerText="NOCP">
                            #{row.nocpListAsString}
                        </p:column>

                        <p:column sortBy="#{row.startDate}" headerText="Start Date">
                            <h:outputText value="#{MyContinuingCompetence.getAsBasicDateString(row.startDate)}"/>
                        </p:column>

                        <p:column sortBy="#{row.endDate}" headerText="End Date">
                            <h:outputText value="#{MyContinuingCompetence.getAsBasicDateString(row.endDate)}"/>
                        </p:column>

                        <p:column sortBy="#{row.credits}" headerText="Credits">
                            #{row.credits}
                        </p:column>

                        <p:column sortBy="#{row.adjudicatedCredits}" headerText="Adjudicated Credits">
                            #{row.adjudicatedCredits}
                        </p:column>
                    </p:dataTable>

                    <p:dataTable id="pendingTable" value="#{MyContinuingCompetence.pendingActivities}" var="row" rows="10"
                                 style="margin-bottom: 20px" paginator="true" paginatorPosition="top" paginatorAlwaysVisible="false"
                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}">
                        <f:facet name="header">Activities Pending Approval</f:facet>

                        <p:column sortBy="#{row.activityName}" headerText="Activity Name">
                            #{row.activityName}
                        </p:column>

                        <p:column sortBy="#{row.statusId.activityStatus}" headerText="Status">
                            #{row.statusId.activityStatus}
                        </p:column>
                    </p:dataTable>

                    <p:dataTable id="rejectedTable" value="#{MyContinuingCompetence.rejectedActivities}" var="row" rows="10"
                                 style="margin-bottom: 20px" paginator="true" paginatorPosition="top" paginatorAlwaysVisible="false"
                                 paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}">                
                        <f:facet name="header">Activities Rejected</f:facet>

                        <p:column sortBy="#{row.activityName}" headerText="Activity Name">
                            #{row.activityName}
                        </p:column>

                        <p:column headerText="Comments">
                            #{row.comments}
                        </p:column>
                    </p:dataTable>


                    <h:panelGroup id="EMAReport">
                        <p:panel header="Adjudication Report for #{MyContinuingCompetence.reportingYearString}">

                            <h:outputText value="If you are in shortfall for the previous year during the adjudication period, 
                                          you can request adjudication by selecting that year above." 
                                          rendered="#{MyContinuingCompetence.reportingYearId ne EmaccsVariables.previousReportingYearId and !User.isInactive}"
                                          style="display: block;" />
                            <br />
                            <h:outputText rendered="#{MyContinuingCompetence.adjudicationRequest.id==null}" 
                                          value="#{msg['MyContinuingCompetence.NoAdjudicationRequest']}"/>

                            <h:panelGroup rendered="#{MyContinuingCompetence.adjudicationRequest.id!=null}">
                                <table cellpadding="2" cellspacing="0" class="layout">
                                    <tr>
                                        <td class="right">Additional Patient Contacts?
                                        </td><td>
                                            <h:outputText value="#{MyContinuingCompetence.adjudicationRequest.patientContactsYn}" />
                                        </td>
                                        <td rowspan="3">
                                            Notes:<br />
                                            <h:outputText value="#{MyContinuingCompetence.adjudicationRequest.additionalNotes}" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="right">Additional Activity Credits?
                                        </td><td>
                                            <h:outputText value="#{MyContinuingCompetence.adjudicationRequest.activityCreditsYn}" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="right">Submission Complete?
                                        </td><td>
                                            <h:outputText value="#{MyContinuingCompetence.adjudicationRequest.submissionCompleteYn}" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="3">
                                            <h:outputLink
                                                rendered="#{MyContinuingCompetence.adjudicationRequest.attachment!=null}"
                                                value="#{facesContext.externalContext.requestContextPath}/attachment?ent=adjudication&amp;id=#{MyContinuingCompetence.adjudicationRequest.id}">
                                                <h:graphicImage value="/images/attach.png"/>
                                                <h:outputText value=" #{MyContinuingCompetence.adjudicationRequest.filename}"/>
                                            </h:outputLink>
                                            <h:outputText
                                                rendered="#{MyContinuingCompetence.adjudicationRequest.filename!=null}"
                                                value=" (#{MyContinuingCompetence.adjudicationRequest.mimetype})"/>
                                        </td>
                                    </tr>
                                </table>
                            </h:panelGroup>
                            <br />
                            <br />
                            <p:panel id="adjudicationReportForm"
                                     rendered="#{!User.isInactive
                                                 &amp;&amp; EmaccsVariables.isAdjudicationPeriod(MyContinuingCompetence.reportingYearId)
                                                 &amp;&amp; (User.isPendingAdj(MyContinuingCompetence.reportingYearId) || User.previousYearShortFall)
                                                 &amp;&amp; MyContinuingCompetence.reportingYearId == EmaccsVariables.previousReportingYearId
                            }">
                                <table cellpadding="2" cellspacing="0" class="layout">
                                    <tr>
                                        <td rowspan="2">
                                            Notes:<br />
                                            <p:inputTextarea value="#{MyContinuingCompetence.adjudicationRequest.additionalNotes}" cols="60" rows="10" id="area" />
                                        </td>
                                        <td class="right">Additional Patient Contacts?</td>
                                        <td>
                                            <h:selectOneMenu value="#{MyContinuingCompetence.adjudicationRequest.patientContactsYn}" id="drop1">
                                                <f:selectItem itemValue="N" itemLabel="No" />
                                                <f:selectItem itemValue="Y" itemLabel="Yes" />
                                            </h:selectOneMenu>
                                        </td>
                                        <td class="right">Additional Activity Credits?</td>
                                        <td>
                                            <h:selectOneMenu value="#{MyContinuingCompetence.adjudicationRequest.activityCreditsYn}" id="drop2">
                                                <f:selectItem itemValue="N" itemLabel="No" />
                                                <f:selectItem itemValue="Y" itemLabel="Yes" />
                                            </h:selectOneMenu>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="center">
                                            <h:outputLink
                                                rendered="#{MyContinuingCompetence.adjudicationRequest.attachment!=null}"
                                                value="#{facesContext.externalContext.requestContextPath}/attachment?ent=adjudication&amp;id=#{MyContinuingCompetence.adjudicationRequest.id}">
                                                <h:graphicImage value="/images/attach.png"/>
                                                <h:outputText value=" #{MyContinuingCompetence.adjudicationRequest.filename}"/>
                                            </h:outputLink>
                                            <h:outputText
                                                rendered="#{MyContinuingCompetence.adjudicationRequest.filename!=null}"
                                                value=" (#{MyContinuingCompetence.adjudicationRequest.mimetype})"/>
                                            <br/>
                                            <p:fileUpload  listener="#{MyContinuingCompetence.uploadFile}" update="@form"
                                                           fileLimit="1" mode="advanced" uploadLabel="Upload File" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="center" colspan="5">
                                            <p:commandButton id="requestAdjBtn"
                                                             value="Request Adjudication"
                                                             rendered="#{MyContinuingCompetence.adjudicationRequest.id==null}"
                                                             update="form1"
                                                             oncomplete="PF('submitAdjudication')}.show();"/>
                                            <h:outputText value=" " />
                                            <p:commandButton id="UpdateAdjBtn"
                                                             value="Update Request"
                                                             rendered="#{MyContinuingCompetence.adjudicationRequest.id!=null}"
                                                             update="form1"
                                                             oncomplete="PF('updateAdjudication')}.show();"/>
                                            <h:outputText value=" " />
                                            <p:commandButton action="#{MyContinuingCompetence.clear}"
                                                             value="#{msg['button.cancel']}"
                                                             update="form1"
                                                             process="@this" />
                                        </td>
                                    </tr>
                                </table>
                            </p:panel>
                        </p:panel>




                        <h:outputText value="Upon receipt of your shortfall letter you may request an exam through this screen until September 1st." rendered="#{!User.isPendingAdj(MyContinuingCompetence.reportingYearId)  &amp;&amp; User.previousYearShortFall}" style="display: block;" />
                        <h:panelGroup id="requestExam" styleClass="center">
                            <h:commandButton onclick="window.location = 'https://www.health.gov.bc.ca/exforms/ema/request-for-evaluation.html';" value="Request Exam" styleClass="center" rendered="#{EmaccsVariables.isExamPeriod(MyContinuingCompetence.reportingYearId) &amp;&amp; (User.previousYearShortFall || User.isPendingAdj(MyContinuingCompetence.reportingYearId))}" type="button" />
                        </h:panelGroup>
                    </h:panelGroup>

                    <p:panel id="AdminReport">
                        <f:facet name="header">Adjudication Report for <h:outputText value="#{MyContinuingCompetence.reportingYearString}" /></f:facet>

                        <h:outputText rendered="#{MyContinuingCompetence.adjudicationRequest.id==null}" value="#{msg['MyContinuingCompetence.NoAdjudicationRequest']}"/>
                        <h:panelGroup rendered="#{MyContinuingCompetence.adjudicationRequest.id!=null}">
                            <table cellpadding="2" cellspacing="0" class="layout">
                                <tr>
                                    <td >Additional Patient Contacts?</td>
                                    <td style="padding-left: 10px">
                                        <h:outputText value="#{MyContinuingCompetence.adjudicationRequest.patientContactsYn}" />
                                    </td>
                                </tr>
                                <tr>
                                    <td >Additional Activity Credits?</td>
                                    <td style="padding-left: 10px">
                                        <h:outputText value="#{MyContinuingCompetence.adjudicationRequest.activityCreditsYn}" />
                                    </td>
                                </tr>
                                <tr>
                                    <td >Submission Complete?</td>
                                    <td style="padding-left: 10px">
                                        <h:outputText value="#{MyContinuingCompetence.adjudicationRequest.submissionCompleteYn}" />
                                    </td>
                                </tr>
                                <tr>
                                    <td>Notes: <h:outputText value="#{MyContinuingCompetence.adjudicationRequest.additionalNotes}" /></td>
                                </tr>
                                <tr>
                                    <td colspan="3">
                                        <h:outputLink
                                            rendered="#{MyContinuingCompetence.adjudicationRequest.attachment!=null}"
                                            value="#{facesContext.externalContext.requestContextPath}/attachment?ent=adjudication&amp;id=#{MyContinuingCompetence.adjudicationRequest.id}">
                                            <h:graphicImage value="/images/attach.png"/>
                                            <h:outputText value=" #{MyContinuingCompetence.adjudicationRequest.filename}"/>
                                        </h:outputLink>
                                        <h:outputText
                                            rendered="#{MyContinuingCompetence.adjudicationRequest.filename!=null}"
                                            value=" (#{MyContinuingCompetence.adjudicationRequest.mimetype})"/>
                                    </td>
                                </tr>
                            </table>
                        </h:panelGroup>
                    </p:panel>

                </h:panelGroup>

                <p:dialog id="submitAdjudication" modal="true" widgetVar="submitAdjudication">
                    <f:facet name="header">Submission Complete?</f:facet>
                    Are you sure you want to request adjudication?<br />
                    Upon selecting yes, you will be able to update your activities and patient contacts until the adjudication period ends<br /><br />
                    <div class="center">

                        <p:commandButton id="adjRequestYes"
                                         action="#{MyContinuingCompetence.requestYes}"
                                         value="Yes"
                                         onclick="PF('submitAdjudication')}.hide();"
                                         update="form1 global-messages"
                                         type="button"
                                         />
                        <h:outputText value=" " />
                        <p:commandButton id="adjRequestNo"
                                         action="#{MyContinuingCompetence.requestNo}"
                                         value="No"
                                         onclick="PF('submitAdjudication')}.hide();"
                                         update="form1 global-messages"
                                         />
                        <h:outputText value=" " />
                        <p:commandButton process="@this" onclick="PF('submitAdjudication')}.hide();" value="Cancel"/>
                    </div>
                </p:dialog>
                <p:dialog id="updateAdjudication" modal="true" widgetVar="updateAdjudication">
                    <f:facet name="header">Submission Complete?</f:facet>
                    Are you sure you want to re-request adjudication?<br />
                    Upon selecting yes, you will be able to update your activities and patient contacts until the adjudication period ends<br /><br />
                    <div class="center">
                        <p:commandButton id="adjUpdateYes"
                                         action="#{MyContinuingCompetence.updateYes}"
                                         value="Yes"
                                         onclick="PF('updateAdjudication')}.hide();"
                                         update="form1 global-messages"
                                         />
                        <h:outputText value=" " />
                        <p:commandButton id="adjUpdateNo"
                                         action="#{MyContinuingCompetence.updateNo}"
                                         value="No"
                                         onclick="PF('updateAdjudication')}.hide();"
                                         update="form1 global-messages"
                                         />
                        <h:outputText value=" " />
                        <p:commandButton process="@this" onclick="PF('updateAdjudication')}.hide();" value="Cancel"/>
                    </div>
                </p:dialog>
            </ui:fragment>

        </h:form>
        <script type="text/javascript">

            // Function for submitting licence number form when enter key is pressed
            function detectEnter(event) {
            if (event.keyCode == 13) {
            document.getElementById("form1:LicenceNumber").blur();
            return false;
            }
            }

        </script>
    </ui:define></ui:composition>
