/*
 * *********************************************************************************************************************
 *  Copyright (c) 2017, Ministry of Health, BC.                                                 *
 *                                                                                                                     *
 *  All rights reserved.                                                                                               *
 *    This information contained herein may not be used in whole                                                       *
 *    or in part without the express written consent of the                                                            *
 *    Government of British Columbia, Canada.                                                                          *
 *                                                                                                                     *
 *  Revision Control Information                                                                                       *
 *  File:                $Id::                                                                                       $ *
 *  Date of Last Commit: $Date::                                                                                     $ *
 *  Revision Number:     $Rev::                                                                                      $ *
 *  Last Commit by:      $Author::                                                                                   $ *
 *                                                                                                                     *
 * *********************************************************************************************************************
 */
package ca.bc.gov.hlth.hem.validator;

import ca.bc.gov.hlth.hem.facade.HemProductFacadeLocal;
import javax.ejb.EJB;
import javax.enterprise.context.RequestScoped;
import javax.faces.application.FacesMessage;
import javax.faces.component.UIComponent;
import javax.faces.context.FacesContext;
import javax.faces.validator.Validator;
import javax.faces.validator.ValidatorException;
import javax.inject.Named;

/**
 * Custom validator to ensure one date is after another. Must provide the
 * reference to the beforeDate via an f:attribute May provide custom error
 * messsage via an errorMessage f:attribute
 *
 * @author CGI Information Management Consultants Inc.
 */
@Named
@RequestScoped
public class ProductValidator implements Validator {

    /* Facade for persistence */
    @EJB
    private transient HemProductFacadeLocal hemProductFacade;

    /**
     * Runs validation check to ensure this component's name value is not
     * already existing in the database.
     *
     * @param context FacesContext
     * @param component UIComponent
     * @param value Object
     * @throws ValidatorException
     */
    @Override
    public void validate(FacesContext context, UIComponent component, Object value) throws ValidatorException {
        if (value == null) {
            return; //Can't proceed
        }

        String newName = value.toString();
        Integer currentId = (Integer) component.getAttributes().get("currentId");
        if (currentId == null) {
            currentId = 0;
        }

        // if exists in the database, throw exception
        if (hemProductFacade.isProductExists(newName, currentId)) {
            String errorMessage = (String) component.getAttributes().get("errorMessage");
            if (errorMessage == null || "".equals(errorMessage)) {
                errorMessage = "Product name '" + newName + "' already exists";
            }
            throw new ValidatorException(new FacesMessage(FacesMessage.SEVERITY_ERROR, errorMessage, errorMessage));
        }
    }
}
