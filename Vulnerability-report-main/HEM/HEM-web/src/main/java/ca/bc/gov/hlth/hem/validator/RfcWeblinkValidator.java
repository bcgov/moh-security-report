/*
 * *********************************************************************************************************************
 *  Copyright (c) 2017, Ministry of Health, BC.                                                 *
 *                                                                                                                     *
 *  All rights reserved.                                                                                               *
 *    This information contained herein may not be used in whole                                                       *
 *    or in part without the express written consent of the                                                            *
 *    Government of British Columbia, Canada.                                                                          *
 *                                                                                                                     *
 *  Revision Control Information                                                                                       *
 *  File:                $Id::                                                                                       $ *
 *  Date of Last Commit: $Date::                                                                                     $ *
 *  Revision Number:     $Rev::                                                                                      $ *
 *  Last Commit by:      $Author::                                                                                   $ *
 *                                                                                                                     *
 * *********************************************************************************************************************
 */
package ca.bc.gov.hlth.hem.validator;

import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.enterprise.context.RequestScoped;
import javax.faces.application.FacesMessage;
import javax.faces.component.UIComponent;
import javax.faces.context.FacesContext;
import javax.faces.validator.Validator;
import javax.faces.validator.ValidatorException;
import javax.inject.Named;

/**
 * Custom validator to ensure the web link format is good.
 *
 * @author CGI Information Management Consultants Inc.
 */
@Named
@RequestScoped
public class RfcWeblinkValidator implements Validator {

    private static final String RFC_REGEX = "#(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))#iS";
    private static final String CLASSNAME = RfcWeblinkValidator.class.getSimpleName();
    private static final Logger LOGGER = Logger.getLogger(CLASSNAME);

    private final Pattern pattern;
    private Matcher matcher;

    public RfcWeblinkValidator() {
        pattern = Pattern.compile(RFC_REGEX);
    }

    /**
     * Runs validation check to ensure this component's name value is not
     * already existing in the database.
     *
     * @param context FacesContext
     * @param component UIComponent
     * @param value Object
     * @throws ValidatorException
     */
    @Override
    public void validate(FacesContext context, UIComponent component, Object value) throws ValidatorException {

        String link = value.toString();
        matcher = pattern.matcher(link.trim());
        if (!"".equals(link.trim()) && !matcher.matches()) {
            FacesMessage msg = new FacesMessage("Invalid web link format:" + link, "Invalid web link format.");
            msg.setSeverity(FacesMessage.SEVERITY_ERROR);
            LOGGER.log(Level.SEVERE, "Invalid web link format for : {0}", link);
            throw new ValidatorException(msg);
        }
    }
}
