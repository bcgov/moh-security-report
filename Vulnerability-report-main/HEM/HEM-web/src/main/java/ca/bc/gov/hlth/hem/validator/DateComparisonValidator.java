/*
 * *********************************************************************************************************************
 *  Copyright (c) 2017, Ministry of Health, BC.                                                 *
 *                                                                                                                     *
 *  All rights reserved.                                                                                               *
 *    This information contained herein may not be used in whole                                                       *
 *    or in part without the express written consent of the                                                            *
 *    Government of British Columbia, Canada.                                                                          *
 *                                                                                                                     *
 *  Revision Control Information                                                                                       *
 *  File:                $Id::                                                                                       $ *
 *  Date of Last Commit: $Date::                                                                                     $ *
 *  Revision Number:     $Rev::                                                                                      $ *
 *  Last Commit by:      $Author::                                                                                   $ *
 *                                                                                                                     *
 * *********************************************************************************************************************
 */
package ca.bc.gov.hlth.hem.validator;

import java.text.SimpleDateFormat;
import java.util.Date;
import javax.enterprise.context.RequestScoped;
import javax.faces.application.FacesMessage;
import javax.faces.component.UIComponent;
import javax.faces.component.UIInput;
import javax.faces.context.FacesContext;
import javax.faces.validator.Validator;
import javax.faces.validator.ValidatorException;
import javax.inject.Named;

/**
 * Custom validator to ensure one date is after another. Must provide the
 * reference to the beforeDate via an f:attribute May provide custom error
 * messsage via an errorMessage f:attribute
 *
 * @author CGI Information Management Consultants Inc.
 */
@Named
@RequestScoped
public class DateComparisonValidator implements Validator {

    /**
     * Date formatter for building error messages
     */
    private static final SimpleDateFormat SIMPLEDATEFORMAT = new SimpleDateFormat("MM/dd/yy HH:mm");

    /**
     * Runs validation check to ensure this component's date value is after the
     * referenced component's date. Assumes mandatory and pattern checks are
     * done by other validators, so these will short-circuit the validation.
     *
     * @param context FacesContext
     * @param component UIComponent
     * @param value Object
     * @throws ValidatorException
     */
    @Override
    public void validate(FacesContext context, UIComponent component, Object value) throws ValidatorException {
        if (value == null) {
            return; //Can't proceed
        }

        UIInput beforeDateControl = (UIInput) component.getAttributes().get("beforeDate");
        if (!beforeDateControl.isValid()) {
            return;  //Can't proceed
        }

        Date beforeDate = (Date) beforeDateControl.getValue();
        if (beforeDate == null) {
            return; //Can't proceed
        }

        Date afterDate = (Date) value;

        if (afterDate.before(beforeDate)) {
            String errorMessage = (String) component.getAttributes().get("errorMessage");
            if (errorMessage == null || "".equals(errorMessage)) {
                errorMessage = SIMPLEDATEFORMAT.format(afterDate) + " must be after " + SIMPLEDATEFORMAT.format(beforeDate);
            }
            throw new ValidatorException(new FacesMessage(FacesMessage.SEVERITY_ERROR, errorMessage, errorMessage));
        }
    }
}
