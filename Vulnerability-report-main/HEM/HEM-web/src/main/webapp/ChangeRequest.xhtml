<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
*********************************************************************************************************************
 Copyright (c) 2017, Ministry of Health, BC.                                                 *
                                                                                                                    *
 All rights reserved.                                                                                               *
   This information contained herein may not be used in whole                                                       *
   or in part without the express written consent of the                                                            *
   Government of British Columbia, Canada.                                                                          *
                                                                                                                    *
 Revision Control Information                                                                                       *
 File:                $Id::                                                                                       $ *
 Date of Last Commit: $Date::                                                                                     $ *
 Revision Number:     $Rev::                                                                                      $ *
 Last Commit by:      $Author::                                                                                   $ *
                                                                                                                    *
*********************************************************************************************************************
-->
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:p="http://primefaces.org/ui">

    <div class="ui-fluid">
        <link rel="stylesheet" href="resources/css/hemstyle.css"></link>



        <h:form id="entityForm">         
            <p:panelGrid id="entityParent" columns="2" layout="grid">
                <p:panelGrid  class="box_margin_right" id="entityPanel" columns="2" layout="grid"
                              columnClasses="form-column-label,form-column-data">
                    <f:facet name="header">
                        <p:row>
                            <p:column colspan="2">Task details</p:column>
                        </p:row>
                    </f:facet>  

                    <p:outputLabel for="status" value="Status:" />
                    <p:selectOneMenu id="status" 
                                     value="#{ChangeRequest.selectedHemChangeRequest.status}"
                                     required="true"
                                     appendTo="@(#schedulerDialog)">
                        <f:selectItems value="#{ChangeRequest.statusList}" />
                    </p:selectOneMenu>

                    <p:outputLabel for="requestorName" value="#{bundle.ChangeRequestRequestorLabel}"/>
                    <p:selectOneMenu id="requestorName" 
                                     value="#{ChangeRequest.selectedHemChangeRequest.hemRequestor}"
                                     required="true"
                                     requiredMessage="#{bundle.ChangeRequestRequestorRequiredMessage}"
                                     rendered="#{Login.userHasAdminRole}"
                                     converter="EntityConverter"
                                     appendTo="@(#schedulerDialog)"
                                     >
                        <f:selectItem itemLabel="Select a Requester" itemValue="" />
                        <f:selectItems
                            var="item"
                            value="#{ChangeRequest.hemRequestorList}"
                            itemLabel="#{item.requestorName}" />
                        <f:ajax render="dialogForm:entityForm:submit requestorName" execute="dialogForm:entityForm:submit requestorName" event="change"/>
                        <f:ajax render="allEmailRecipients" event="change" />
                    </p:selectOneMenu>

                    <h:outputText value="#{ChangeRequest.selectedHemChangeRequest.hemRequestor.requestorName}"
                                  rendered="#{not Login.userHasAdminRole}"/>

                    <p:outputLabel for="product" value="#{bundle.ChangeRequestProductLabel}"/>
                    <p:selectCheckboxMenu id="product" 
                                          value="#{ChangeRequest.selectedHemChangeRequest.hemProduct}" 
                                          required="true"
                                          requiredMessage="#{bundle.ChangeRequestProductRequiredMessage}"
                                          multiple="true"
                                          filter="true"
                                          filterMatchMode="contains"
                                          label="Select Product"
                                          title="#{bundle.ChangeRequestProductTooltip}"
                                          appendTo="@(#schedulerDialog)">

                        <f:selectItems
                            var="item"
                            value="#{ChangeRequest.hemProductList}"
                            itemLabel="#{item.productName}" />
                        <p:ajax update="allEmailRecipients" global="false" />
                        <f:ajax render="dialogForm:entityForm:submit  product" execute="dialogForm:entityForm:submit product" event="change"/>



                    </p:selectCheckboxMenu>

                    <p:outputLabel for="includingDistList" value="Include product distribution list(s)"/>
                    <p:selectBooleanCheckbox id="includingDistList"
                                             value="#{ChangeRequest.selectedHemChangeRequest.includingDistList}"
                                             immediate="true"
                                             >
                        <p:ajax update="allEmailRecipients" global="false" />
                    </p:selectBooleanCheckbox>

                    <p:outputLabel for="environment" value="#{bundle.ChangeRequestEnvironmentLabel}"/>
                    <p:selectOneMenu id="environment" 
                                     value="#{ChangeRequest.selectedHemChangeRequest.hemEnvironment}" 
                                     required="true"
                                     requiredMessage="#{bundle.ChangeRequestEnvironmentRequiredMessage}"
                                     rendered="#{Login.userHasAdminRole}"                                 
                                     converter="EntityConverter"
                                     appendTo="@(#schedulerDialog)">
                        <f:selectItem itemLabel="Select an Environment" itemValue="" />
                        <f:selectItems
                            var="item"
                            value="#{ChangeRequest.hemEnvironmentList}"
                            itemLabel="#{item.environmentName}" />
                         <f:ajax render="dialogForm:entityForm:submit  environment" execute="dialogForm:entityForm:submit environment" event="change"/>
                        <p:ajax listener="#{ChangeRequest.onEnvironmentChange}"  update="server_combo"/>
                    </p:selectOneMenu>

                    <h:outputText value="#{ChangeRequest.selectedHemChangeRequest.hemEnvironment.environmentName}"
                                  rendered="#{not Login.userHasAdminRole}"/>

                    <p:outputLabel for="server" value="#{bundle.ChangeRequestServerLabel}"/>
                    <p:outputPanel id="server_combo" class="server_combo">
                        <p:selectCheckboxMenu id="server" 
                                              value="#{ChangeRequest.selectedHemChangeRequest.hemServer}" 
                                              required="true" 
                                              multiple="true"
                                              label="Select Server"
                                              filter="true"
                                              filterMatchMode="contains"
                                              requiredMessage="#{bundle.ChangeRequestServerRequiredMessage}"
                                              title="#{bundle.ChangeRequestServerTooltip}"
                                              converter="EntityConverter"
                                              appendTo="@(#schedulerDialog)">
                            <f:selectItems
                                var="item"
                                value="#{ChangeRequest.hemServerList}"
                                itemLabel="#{item.serverName}" />  
                            <f:ajax render="dialogForm:entityForm:submit server" execute="dialogForm:entityForm:submit server" event="change"/>
                        </p:selectCheckboxMenu>
                    </p:outputPanel>

                    <p:outputLabel for="category" value="#{bundle.ChangeRequestCategoryLabel}"/>
                    <p:selectOneMenu id="category" 
                                     value="#{ChangeRequest.selectedHemChangeRequest.hemCategory}" 
                                     required="true"
                                     rendered="#{Login.userHasAdminRole}"
                                     requiredMessage="#{bundle.ChangeRequestCategoryRequiredMessage}"
                                     appendTo="@(#schedulerDialog)"
                                     converter="EntityConverter">
                        <f:selectItem itemLabel="Select a Category" itemValue="" />
                        <f:selectItems
                            var="item"
                            value="#{ChangeRequest.hemChangeCategoryList}"
                            itemLabel="#{item.categoryName}" />
                        <f:ajax render="dialogForm:entityForm:submit category" execute="dialogForm:entityForm:submit category" event="change"/>
                   </p:selectOneMenu>
                    <h:outputText value="#{ChangeRequest.selectedHemChangeRequest.hemCategory.categoryName}"
                                  rendered="#{not Login.userHasAdminRole}"/>

                    <p:outputLabel for="onDemand" value="#{bundle.ChangeRequestOnDemandLabel}"/>
                    <p:selectBooleanCheckbox id="onDemand" value="#{ChangeRequest.selectedHemChangeRequest.onDemand}" 
                                             title="#{bundle.ChangeRequestOnDemandTooltip}"
                                             disabled="#{not Login.userHasAdminRole}"/>



                    <p:outputLabel for="startDate" value="#{bundle.ChangeRequestStartDateLabel}"/>
                    <p:datePicker id="startDate" binding="#{beforeDate}" 
                                  value="#{ChangeRequest.selectedHemChangeRequest.startDate}" 
                                  required="true" 
                                  requiredMessage="#{bundle.ChangeRequestStartDateRequiredMessage}"
                                  pattern="MM/dd/yyyy HH:mm"  
                                  showTime="true"
                                  stepMinute="15"
                                  appendTo="@(#schedulerDialog)"
                                  rendered="#{Login.userHasAdminRole}"
                                  title="#{bundle.ChangeRequestStartDateTooltip}">
                        <f:ajax event="dateSelect" 
                                listener="#{ChangeRequest.onStartDateChange}" 
                                render="endDate"/>

                    </p:datePicker>
                    <h:outputText value="#{ChangeRequest.selectedHemChangeRequest.startDate}"
                                  rendered="#{not Login.userHasAdminRole}">
                        <f:convertDateTime pattern="MM/dd/yyyy HH:mm" />
                    </h:outputText>

                    <p:outputLabel for="timeRequired" value="#{bundle.ChangeRequestEstimatedChangeDurationLabel}"/>
                    <p:spinner id="timeRequired"
                               value="#{ChangeRequest.selectedHemChangeRequest.timeRequired}" 
                               min="0" max="168" stepFactor="0.25"
                               required="true"
                               requiredMessage="#{bundle.ChangeRequestTimeRequiredMessage}"
                               rendered="#{Login.userHasAdminRole}">
                        <f:ajax event="valueChange" render="endDate" listener="#{ChangeRequest.onTimeRequiredValueChange()}"/>

                    </p:spinner>
                    <h:outputText value="#{ChangeRequest.selectedHemChangeRequest.timeRequired}"
                                  rendered="#{not Login.userHasAdminRole}"/>

                    <p:outputLabel for="endDate" value="#{bundle.ChangeRequestEndDateLabel}"/>
                    <p:datePicker id="endDate"
                                  widgetVar="endDate"
                                  value="#{ChangeRequest.selectedHemChangeRequest.endDate}" 
                                  required="true" 
                                  requiredMessage="#{bundle.ChangeRequestEndDateRequiredMessage}"
                                  pattern="MM/dd/yyyy HH:mm" 
                                  stepMinute="15"
                                  appendTo="@(#schedulerDialog)"
                                  showTime="true"
                                  rendered="#{Login.userHasAdminRole}"
                                  title="#{bundle.ChangeRequestEndDateTooltip}">
                        <f:attribute name="beforeDate" value="#{beforeDate}"/>
                        <f:attribute name="errorMessage" value="The end date is before the start date."/>
                        <f:validator binding="#{dateComparisonValidator}"/>
                        <f:ajax event="dateSelect" render="timeRequired"
                                listener="#{ChangeRequest.onEndDateChange}" 
                                />

                    </p:datePicker>
                    <h:outputText value="#{ChangeRequest.selectedHemChangeRequest.endDate}"
                                  rendered="#{not Login.userHasAdminRole}">
                        <f:convertDateTime pattern="MM/dd/yyyy HH:mm" />
                    </h:outputText>

                    <p:outputLabel for="rfcName" value="#{bundle.ChangeRequestRfcNameLabel}"/>
                    <p:inputText id="rfcName" 
                                 value="#{ChangeRequest.selectedHemChangeRequest.rfcName}" 
                                 required="true" 
                                 requiredMessage="#{bundle.ChangeRequestRfcNameRequiredMessage}"
                                 rendered="#{Login.userHasAdminRole}"
                                 title="#{bundle.ChangeRequestRfcNameTooltip}">
                        <f:ajax render="dialogForm:entityForm:submit  rfcName" execute="dialogForm:entityForm:submit rfcName" event="change"/>
                    </p:inputText>
                    <h:outputText value="#{ChangeRequest.selectedHemChangeRequest.rfcName}"
                                  rendered="#{not Login.userHasAdminRole}"/>

                    <p:outputLabel for="rfcLink" value="#{bundle.ChangeRequestRfcLinkLabel}"/>
                    <p:inputText id="rfcLink" 
                                 value="#{ChangeRequest.selectedHemChangeRequest.rfcLink}" 
                                 required="true" 
                                 requiredMessage="#{bundle.ChangeRequestRfcLinkRequiredMessage}"
                                 rendered="#{Login.userHasAdminRole}"
                                 title="#{bundle.ChangeRequestRfcLinkTooltip}">
                       <f:ajax render="dialogForm:entityForm:submit  rfcLink" execute="dialogForm:entityForm:submit rfcLink" event="change"/>
                    </p:inputText>
                    <h:outputText value="#{ChangeRequest.selectedHemChangeRequest.rfcLink}"
                                  rendered="#{not Login.userHasAdminRole}"/>

                    <p:outputLabel for="changeImplementers" value="#{bundle.ChangeRequestChangeImplementersLabel}"/>
                    <p:selectCheckboxMenu id="changeImplementers" 
                                          widgetVar="changeImpl"
                                          value="#{ChangeRequest.selectedHemChangeRequest.changeImplementers}" 
                                          required="true"
                                          requiredMessage="#{bundle.ChangeRequestChangeImplementersRequiredMessage}"
                                          multiple="true"
                                          filter="true"
                                          filterMatchMode="contains"
                                          label="Select Change Implementer(s)"
                                          title="#{bundle.ChangeRequestChangeImplementersTooltip}"
                                          converter="EntityConverter"
                                          appendTo="@(#schedulerDialog)">
                        <f:selectItems
                            var="item"
                            value="#{ChangeRequest.hemChangeImplementerList}"
                            itemLabel="#{item.userName}"/>
                        <f:ajax render="allEmailRecipients" execute="allEmailRecipients" event="change"/>
                        <f:ajax render="dialogForm:entityForm:submit changeImplementers" execute="dialogForm:entityForm:submit changeImplementers" event="change"/>
                    </p:selectCheckboxMenu>

                    <h:outputText value="#{ChangeRequest.selectedHemChangeRequest.changeImplementers}"
                                  rendered="#{not Login.userHasAdminRole}"/>

                    <p:outputLabel for="comment" value="#{bundle.ChangeRequestCommentLabel}"/>
                    <p:inputTextarea id="comment" rows="5" cols="60" 
                                     value="#{ChangeRequest.selectedHemChangeRequest.optComment}"
                                     disabled="#{not Login.userHasAdminRole}"
                                     title="#{bundle.ChangeRequestCommentTooltip}"/>
             
                </p:panelGrid>

                <!-- Second column / Email notification-->
                <p:outputPanel class="box_margin_left" id="entityPanel2">

                    <ui:param value="#{ChangeRequest.selectedHemChangeRequest}" name="sharedTaskBean" />
                    <ui:include src="/WEB-INF/fragments/emailNotification.xhtml" />

                </p:outputPanel>

            </p:panelGrid>

            <div>
                <div class="ui-fluid">
                    <p:panelGrid columns="5" layout="grid">                      
                        <p:commandButton id="submit" 
                                         type="submit"  
                                         value="#{bundle.SaveLabel}" 
                                         action="#{ChangeRequest.save}" 
                                         rendered="#{Login.userHasAdminRole}"
                                         update="entityForm:entityParent, growl"
                                         ajax="true"
                                         disabled="#{ChangeRequest.selectedHemChangeRequest.status ==2 
                                                     ||ChangeRequest.selectedHemChangeRequest.status ==3                                           
                                                     ||!ChangeRequest.allRequiredFieldsFilled()
                                                     }">
                            <f:ajax event="click" listener="#{ChangeRequest.save()}" onevent="PF('mainFormScheduler').update"/>
                        </p:commandButton>


                        <p:commandButton id="reset" 
                                         value="#{bundle.ResetLabel}" 
                                         rendered="#{Login.userHasAdminRole}"
                                         title="#{bundle.ResetTooltip}"
                                         update="entityForm:entityParent" 
                                         immediate="true"
                                         ajax="true"
                                         disabled="#{ChangeRequest.selectedHemChangeRequest.hemEmailNotification.notificationLevel != 0}" >
                            <p:resetInput target="entityForm:entityParent"/>
                        </p:commandButton>

                        <p:commandButton id="deleteBtn" 
                                         value="Delete"
                                         action="#{ChangeRequest.delete}"
                                         immediate="true"
                                         ajax="true"
                                         rendered="#{Login.userHasOneOfAdminRoles and ChangeRequest.selectedHemChangeRequest.status == 0}"
                                         update="entityForm:entityParent,growl"
                                         renderDisabledClick="true"
                                         validateClient="true"
                                         disabled="#{!ChangeRequest.editMode || ChangeRequest.selectedHemChangeRequest.hemEmailNotification.notificationLevel >0}" >
                            <f:ajax event="click" listener="#{ChangeRequest.delete()}" execute="entityForm:entityParent, growl" render="entityForm:entityParent, growl" 
                                    onevent="PF('mainFormScheduler').update();"/>
                        </p:commandButton>


                        <p:commandButton id="previewBtn" 
                                         value="Preview"
                                         action="#{ChangeRequest.preview}"
                                         oncomplete="openWindowToPreviewEmailNotification();"
                                         validateClient="true"
                                         ajax="true"
                                         update="entityForm:entityParent"
                                         disabled="#{!ChangeRequest.editMode || ChangeRequest.selectedHemChangeRequest.hemEmailNotification.notificationLevel >1}"/>

                        <p:commandButton id="sendBtn" 
                                         value="Send"
                                         action="#{ChangeRequest.send}"
                                         immediate="true"
                                         ajax="true"
                                         rendered="#{Login.userHasOneOfAdminRoles and ChangeRequest.editMode and 
                                                     !ChangeRequest.selectedHemChangeRequest.hemEmailNotification.flagEmailAssigning
                                                     and ChangeRequest.selectedHemChangeRequest.status==1
                                                     and   ChangeRequest.selectedHemChangeRequest.hemEmailNotification.notificationLevel==0
                                                     and  ChangeRequest.userTeamMatch}"
                                         update="growl"
                                         renderDisabledClick="true"
                                         validateClient="true">

                            <f:ajax event="click" listener="#{ChangeRequest.send()}" execute="growl" render="growl" 
                                    onevent="PF('growl').update();"/>


                            <c:if test="#{ChangeRequest.environmentProd}">
                                <p:confirm 
                                    header="Confirmation" 
                                    message="Have you receive the CAB approval to generate the email and proceeed?" 
                                    icon="fa fa-exclamation-triangle"/>
                            </c:if>
                        </p:commandButton>

                        <p:commandButton id="cancelBtn" 
                                         value="Cancel"
                                         action="#{ChangeRequest.send}"
                                         immediate="true"
                                         ajax="true"
                                         rendered="#{Login.userHasOneOfAdminRoles and ChangeRequest.selectedHemChangeRequest.status == 4}"
                                         update="entityForm:entityParent,growl"
                                         renderDisabledClick="true"
                                         validateClient="true"
                                         >
                            <f:ajax event="click" listener="#{ChangeRequest.send()}" execute="entityForm:entityParent, growl" render="entityForm:entityParent, growl" 
                                    onevent="PF('mainFormScheduler').update();"/>
                        </p:commandButton>

                        <p:commandButton id="PostponedBtn" 
                                         value="Postpone"
                                         action="#{ChangeRequest.send}"
                                         immediate="true"
                                         ajax="true"
                                         rendered="#{Login.userHasOneOfAdminRoles and ChangeRequest.selectedHemChangeRequest.status == 5}"
                                         update="entityForm:entityParent,growl"
                                         renderDisabledClick="true"
                                         validateClient="true"
                                         >
                            <f:ajax event="click" listener="#{ChangeRequest.send()}" execute="entityForm:entityParent, growl" render="entityForm:entityParent, growl" 
                                    onevent="PF('mainFormScheduler').update();"/>
                        </p:commandButton>




                        <c:if test="#{ChangeRequest.environmentProd}">
                            <p:confirmDialog global="true" 
                                             showEffect="fade" 
                                             hideEffect="fade">
                                <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="fa fa-check" />
                                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="fa fa-times" />
                            </p:confirmDialog>
                        </c:if>
                    </p:panelGrid>   
                </div>
                <p:inputText class="PreviewContent"  id="PreviewContent" value="#{ChangeRequest.previewContent}" style="display:none;"/>
            </div>
        </h:form>
    </div>        
</ui:composition>
