/*
 * *********************************************************************************************************************
 *  Copyright (c) 2018, Ministry of Health, BC.                                                                        *
 *                                                                                                                     *
 *  All rights reserved.                                                                                               *
 *    This information contained herein may not be used in whole                                                       *
 *    or in part without the express written consent of the                                                            *
 *    Government of British Columbia, Canada.                                                                          *
 *                                                                                                                     *
 *  Revision Control Information                                                                                       *
 *  File:                $Id::                                                                                       $ *
 *  Date of Last Commit: $Date::                                                                                     $ *
 *  Revision Number:     $Rev::                                                                                      $ *
 *  Last Commit by:      $Author::                                                                                   $ *
 *                                                                                                                     *
 * *********************************************************************************************************************
 */
package ca.bc.gov.hlth.hem.facade;

import ca.bc.gov.hlth.hem.entity.HemProduct;
import java.sql.Timestamp;
import java.time.Instant;

import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import java.util.List;

/**
 *
 * @author CGI Information Management Consultants Inc.
 */
@Stateless
public class HemProductFacade extends AbstractFacade<HemProduct> implements HemProductFacadeLocal {

    @PersistenceContext(unitName = "HEM-pu")
    private EntityManager em;

    @Override
    protected EntityManager getEntityManager() {
        return em;
    }

    public HemProductFacade() {
        super(HemProduct.class);
    }

    @Override
    public void create(HemProduct h, String username) {
        h.setCreatedBy(username);
        h.setCreatedDate(Timestamp.from(Instant.now()));

        h.setLastModifiedBy(username);
        h.setLastModifiedDate(Timestamp.from(Instant.now()));

        em.persist(h);
    }

    @Override
    public void edit(HemProduct h, String username) {
        h.setLastModifiedBy(username);
        h.setLastModifiedDate(Timestamp.from(Instant.now()));

        em.merge(h);
    }

    @Override
    public void remove(HemProduct h, String username) {
        h.setArchived(true);
        h.setArchivedBy(username);
        h.setArchivedDate(Timestamp.from(Instant.now()));

       // em.merge(h);
        edit(h);
    }

    /**
     * Find a product by his object representation
     *
     * @param id Object product
     * @return return a product by his object representation
     */
    @Override
    @SuppressWarnings("unchecked")
    public HemProduct find(Object id) {
        return em.find(ca.bc.gov.hlth.hem.entity.HemProduct.class, id);
    }

    @Override
    public List<HemProduct> findAll() {
        Query query = em.createNamedQuery("HemProduct.findAll");
        query.setParameter("archived", false);

        return query.getResultList();
    }

    /**
     * Get a list of products by their names
     *
     * @param param String product name
     * @return return a list of products by their names
     */
    @Override
    @SuppressWarnings("unchecked")
    public List<HemProduct> findByProductName(String param) {
        Query query = em.createNamedQuery("HemProduct.findByProductName");
        query.setParameter("productName", param);
        return query.getResultList();
    }

    @Override
    public boolean isProductExists(String productName, int productId) {
        boolean result = false;
        Query query = em.createNamedQuery("HemProduct.findExistingProduct");
        query.setParameter("productName", productName);
        query.setParameter("productId", productId);
        if (query.getResultList().size() > 0) {
            result = true;
        }
        return result;
    }

    @Override
    public boolean isProductInUse(HemProduct hemProduct) {
        return !hemProduct.getHemChangeRequestList().isEmpty();
    }

}
