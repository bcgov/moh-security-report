/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.esb.service.batch;

import ca.bc.gov.moh.hsa.esb.service.batch.dto.BatchRequestDTO;
import ca.bc.gov.moh.hsa.esb.service.batch.dto.BatchResponseDTO;
import ca.bc.gov.moh.hsa.esb.service.batch.dto.IndividualBatchRequestDTO;
import java.io.StringReader;
import javax.xml.namespace.NamespaceContext;
import javax.xml.xpath.*;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;
import org.apache.camel.Exchange;
import org.apache.camel.Processor;
import org.springframework.stereotype.Component;
import org.xml.sax.InputSource;

/**
 * Prepares a message for re-sending the get eligibility message when the original PHN was merged.
 * @author greg.perkins
 */
@Component
public class SurvivorGetEligibilityRequestConverter implements Processor {

    final static XPath xPath = XPathFactory.newInstance().newXPath();
    final static NamespaceContext nsc = new BatchNamespaceContext();

    static {
        xPath.setNamespaceContext(nsc);
    }

    /**
     * Prepares the Get Eligibility Message for re-sending
     * @param exchange
     * @throws Exception 
     */
    @Override
    public void process(Exchange exchange) throws Exception {
        BatchResponseDTO body = exchange.getIn().getBody(BatchResponseDTO.class);
        exchange.setProperty("ORIGINAL_RESPONSE", exchange.getIn().getBody());
        BatchRequestDTO orig = exchange.getProperty("ORIGINAL_REQUEST", BatchRequestDTO.class);
        IndividualBatchRequestDTO originalDTO = null;
        for (IndividualBatchRequestDTO dto : orig.getIndividualMessages()) {
            if (dto.getIsGetEligibility()) {
                originalDTO = dto;
            }
        }
        if (originalDTO != null) {
            originalDTO.setMessageBody(updatePhn(originalDTO.getMessageBody(), body.getGetDemographicsResponse()));
            exchange.getIn().setBody(originalDTO);
        }
    }

    /**
     * Updates the original message with the merged PHN
     * @param messageBody String - Body of the original Get Eligibility Request message
     * @param getDemoResponse String - Body of the Get Demographics response message
     * @return String - Revised Get Eligibility Request message
     * @throws XPathExpressionException 
     */
    private String updatePhn(String messageBody, String getDemoResponse) throws XPathExpressionException {
            String newPhn = (String)xPath.evaluate("//v3:identifiedPerson/v3:id/@extension", new InputSource(new StringReader(getDemoResponse)), XPathConstants.STRING);
            String oldPhn = (String)xPath.evaluate("//v3:queryByParameter/v3:parameterList/v3:coveredPartyAsPatient.Id/v3:value/@extension", new InputSource(new StringReader(messageBody)), XPathConstants.STRING);
            return messageBody.replaceAll(oldPhn,newPhn);
    }

}
