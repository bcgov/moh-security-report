/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.hsa.util.audit;

import ca.bc.gov.moh.hsa.util.SimpleSerializer;
import static ca.bc.gov.moh.hsa.util.audit.AuditProcessor.TRANSACTION_HEADER_KEY;
import static ca.bc.gov.moh.hsa.util.audit.TransactionIDAssigner.TRANSACTION_ID_HEADER_KEY;
import ca.bc.gov.moh.hsa.util.audit.entity.Transaction;
import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.UUID;
import org.apache.camel.Exchange;
import org.apache.camel.Processor;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Component;

/**
 * This method is used to create the initial audit transaction for applications
 * that use a wiretap to call the audit component
 * @author trevor.schiavone
 */
@Component
public class AuditProcessorInit implements Processor {
    
    String transactionType;
    
    public AuditProcessorInit() {
        
    }
    public AuditProcessorInit(String transactionType) {
        this.transactionType = transactionType;
    }
    
    @Override
    public void process(Exchange exchange) throws Exception {
            
        Transaction transaction;   
        String hostName;
        String transactionID = UUID.randomUUID().toString();            
        exchange.getIn().setHeader(TRANSACTION_ID_HEADER_KEY, transactionID);
        transaction = new Transaction(transactionID);

        try {
            hostName = InetAddress.getLocalHost().getHostName();
        } catch (UnknownHostException ex){
            hostName = "unknown";
        } 
        transaction.setServer(hostName);

        if (transactionType != null) {
            transaction.setType(transactionType);

            String messageTypeHeader = (String) exchange.getIn().getHeader(FileDropComponent.TRANSACTION_MESSAGE_TYPE_HEADER_KEY);
            if (StringUtils.isEmpty(messageTypeHeader)) {
                exchange.getIn().setHeader(FileDropComponent.TRANSACTION_MESSAGE_TYPE_HEADER_KEY, transactionType);
            }
        }

        String newSerializedTransaction = SimpleSerializer.toString(transaction);
        exchange.getIn().setHeader(TRANSACTION_HEADER_KEY, newSerializedTransaction);
    }
}
