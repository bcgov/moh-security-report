/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

package ca.bc.gov.moh.hsa.util.audit;

import java.util.Properties;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

/**
 *
 * @author conrad.gustafson
 */
@Component
public class FileDropConfiguration {

//    @Resource(name = "fileDropConfigurationProperties")
    private Properties fileDropConfigurationProperties;
    private final String TRANSACTION_TYPE_ALL = "ALL";
    private final String MESSAGE_CONTEXT_ALL = "ALL";
    
    boolean isMessageToBeSaved(String transactionType, String messageContext) {
        
        Boolean isMessageToBeSaved = Boolean.FALSE;
        
        try {
            Context ctx = new InitialContext();
            fileDropConfigurationProperties = (Properties) ctx.lookup("java:app/fileDropConfig");
        
        if (StringUtils.isEmpty(transactionType)) {
            transactionType = TRANSACTION_TYPE_ALL;
        }
        
        if (StringUtils.isEmpty(messageContext)) {
            messageContext = MESSAGE_CONTEXT_ALL;
        }
        
        String propertyKey = transactionType + "." + messageContext;
        String propertyValue = (String) fileDropConfigurationProperties.get(propertyKey);
        
        if (!StringUtils.isEmpty(propertyValue)) {
            isMessageToBeSaved = Boolean.valueOf(propertyValue);
            return isMessageToBeSaved;
        }
        
        // Check the general case for the transaction type
        propertyKey = transactionType + "." + MESSAGE_CONTEXT_ALL;
        propertyValue = (String) fileDropConfigurationProperties.get(propertyKey);
        if (!StringUtils.isEmpty(propertyValue)) {
            isMessageToBeSaved = Boolean.valueOf(propertyValue);
            return isMessageToBeSaved;
        }
                
        // Check the general case for the message context
        propertyKey = TRANSACTION_TYPE_ALL + "." + messageContext;
        propertyValue = (String) fileDropConfigurationProperties.get(propertyKey);
        if (!StringUtils.isEmpty(propertyValue)) {
            isMessageToBeSaved = Boolean.valueOf(propertyValue);
            return isMessageToBeSaved;
        }
        
        // Check the catch-all case
        propertyKey = TRANSACTION_TYPE_ALL + "." + MESSAGE_CONTEXT_ALL;
        propertyValue = (String) fileDropConfigurationProperties.get(propertyKey);
        if (!StringUtils.isEmpty(propertyValue)) {
            isMessageToBeSaved = Boolean.valueOf(propertyValue);
            return isMessageToBeSaved;
        }
        } catch (NamingException e) {
            Logger.getLogger(FileDropConfiguration.class.getName()).log(Level.SEVERE.SEVERE, "Error retrieving FileDrop Configuration", e);
        }
        return isMessageToBeSaved.booleanValue();
    }
    
}
