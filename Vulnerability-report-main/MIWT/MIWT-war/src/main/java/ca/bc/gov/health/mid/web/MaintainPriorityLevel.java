package ca.bc.gov.health.mid.web;

import ca.bc.gov.health.jsf.BaseBean;
import ca.bc.gov.health.mid.ejb.entity.PriorityLevel;
import ca.bc.gov.health.mid.ejb.session.PriorityLevelFacadeLocal;
import jakarta.annotation.PostConstruct;
import jakarta.ejb.EJB;
import jakarta.faces.application.FacesMessage;
import jakarta.faces.context.FacesContext;
import jakarta.faces.view.ViewScoped;
import jakarta.inject.Named;
import java.util.List;
import org.primefaces.PrimeFaces;

@Named("MaintainPriorityLevel")
@ViewScoped
/**
 * Backing bean for PriorityLevel code table maintenance
 * @author JSF Code Generator
 */
public class MaintainPriorityLevel extends BaseBean implements java.io.Serializable {

    /* Facade for persistence */
    @EJB
    private PriorityLevelFacadeLocal priorityLevelFacade;

    /* List of all values in the code table */
    private List<PriorityLevel> allPriorityLevels;

    /* The instance we're currently editing */
    private PriorityLevel priorityLevel;

    /* PK of the selected instance */
    private Object selectedKey;

    /**
     * Default Constructor
     */
    public MaintainPriorityLevel() {
    }

    /**
     * Initializes this bean after injection
     */
    @PostConstruct
    public void init() {
        allPriorityLevels = priorityLevelFacade.findAll();
        priorityLevel = new PriorityLevel();
    }

    /**
     * Adds a new record
     */
    public String add() {
        nullify();
        if (validForm(1)) {
            return null;
        }
        priorityLevelFacade.create(priorityLevel);
        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_INFO, "Add Successful", "Add Successful"));
        init();
        ((Droplists) findBeanDL("Droplists")).init();
        return clear();
    }

    /**
     * Updates an existing record
     */
    public String update() {
        nullify();
        if (validForm(2)) {
            return null;
        }
        priorityLevelFacade.edit(priorityLevel);
        FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_INFO, "Update Successful", "Update Successful"));
        init();
        ((Droplists) findBeanDL("Droplists")).init();
        return clear();
    }

    /**
     * Deletes a record
     */
    public String delete() {
        nullify();
        priorityLevelFacade.remove(priorityLevel);
        init();
        addInfoMessage("Record deleted.");
        return clear();
    }

    /**
     * Clears the form
     */
    public String clear() {
        selectedKey = null;
        priorityLevel = new PriorityLevel();
        return null;
    }

    /**
     * Selects a record for editing
     */
    public String select() {
        priorityLevel = priorityLevelFacade.find(selectedKey);
        PrimeFaces.current().scrollTo("navbar");
        return null;
    }

    /**
     * Nullifys any parent records where proper PKs aren't set
     */
    private void nullify() {
    }

    /* Getters and Setters */
    public List<PriorityLevel> getAllPriorityLevels() {
        return allPriorityLevels;
    }

    public void setAllPriorityLevels(List<PriorityLevel> allPriorityLevels) {
        this.allPriorityLevels = allPriorityLevels;
    }

    public PriorityLevel getPriorityLevel() {
        return priorityLevel;
    }

    public void setPriorityLevel(PriorityLevel priorityLevel) {
        this.priorityLevel = priorityLevel;
    }

    public Object getSelectedKey() {
        return selectedKey;
    }

    public void setSelectedKey(Object selectedKey) {
        this.selectedKey = selectedKey;
    }

    /**
     * Validate the form elements
     *
     * @param action - 1 Add 2 Update
     */
    private boolean validForm(int action) {

        boolean isError = false;
        if (priorityLevel.getExpiryDt() != null && priorityLevel.getExpiryDt().compareTo(priorityLevel.getEffectiveDt()) < 0) {
            addErrorMessage("Expiry Date must be greater than Effective Date");
            isError = true;
        }

        if (!isError && allPriorityLevels != null) {
            for (int i = 0; i < allPriorityLevels.size(); i++) {
                if (allPriorityLevels.get(i).getModalityCd().equals(priorityLevel.getModalityCd())
                        && allPriorityLevels.get(i).getPriorityLevelCd().equalsIgnoreCase(priorityLevel.getPriorityLevelCd())) {
                    if (action == 1 || !allPriorityLevels.get(i).getPriorityLevelId().equals(priorityLevel.getPriorityLevelId())) {
                        if (!((priorityLevel.getExpiryDt() != null && priorityLevel.getExpiryDt().before(allPriorityLevels.get(i).getEffectiveDt()))
                                || (allPriorityLevels.get(i).getExpiryDt() != null && priorityLevel.getEffectiveDt().after(allPriorityLevels.get(i).getExpiryDt())))) {
                            addErrorMessage("A combination Modality Code and Priority Level Code must be unique");
                            isError = true;
                            break;
                        }
                    }

                }
            }
        }

        return isError;
    }
}