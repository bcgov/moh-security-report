/*
 * *********************************************************************************************************************
 *  Copyright (c) 2020, Ministry of Health, BC.                                                                        *
 *                                                                                                                     *
 *  All rights reserved.                                                                                               *
 *    This information contained herein may not be used in whole                                                       *
 *    or in part without the express written consent of the                                                            *
 *    Government of British Columbia, Canada.                                                                          *
 *                                                                                                                     *
 *  Revision Control Information                                                                                       *
 *  File:                $Id:: CallbackServlet.java 2939 2024-10-28 20:31:11Z ahoplock                               $ *
 *  Date of Last Commit: $Date:: 2024-10-28 13:31:11 -0700 (Mon, 28 Oct 2024)                                        $ *
 *  Revision Number:     $Rev:: 2939                                                                                 $ *
 *  Last Commit by:      $Author:: ahoplock                                                                          $ *
 *                                                                                                                     *
 * *********************************************************************************************************************
 */
package ca.bc.gov.health.security;

import ca.bc.gov.health.login.UserPrincipal;
import ca.bc.gov.health.mid.web.User;
import ca.bc.gov.health.mid.ejb.session.HealthAuthorityFacadeLocal;
import fish.payara.security.openid.api.OpenIdContext;
import jakarta.ejb.EJB;
import jakarta.inject.Inject;
import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * Callback servlet for Keycloak integration
 *
 * @author CGI Information Management Consultants Inc.
 */
@WebServlet("/callback")
public class CallbackServlet extends HttpServlet {

    @Inject
    private OpenIdContext context;
    
    @Inject
    private User user;
  
    @EJB
    private transient HealthAuthorityFacadeLocal healthAuthorityFacade;

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        // The legacy ASSMAuth requires an instance of ca.bc.gov.health.login.UserPrincipal alongside MIWT's User class
        UserPrincipal up = new UserPrincipal();
        
        if (user == null) {
            user = new User();
        }

        if (request.getUserPrincipal() != null) {
            up.setName(request.getUserPrincipal().getName());
            user.setUserName(request.getUserPrincipal().getName());
        }

        if (context.getCallerGroups() != null && !context.getCallerGroups().isEmpty()) {
            up.setRoles(context.getCallerGroups());
            user.setRoles(context.getCallerGroups());
            
            // MIWT should only ever have a single role assigned through Keycloak
            for (String role : user.getRoles()) {
                if (role.contains("HA")) {
                    user.setHealthAuthority(healthAuthorityFacade.findByHealthAuthorityCd(user.getHaCode(role)));
                    break;
                }
            }
        }

        if (context.getAccessToken() != null) {
            user.setEmail(context.getAccessToken().getJwtClaims().getStringClaim("email").orElse(""));
        }

        /* Set UserPrincipal for ASSMAuth */
        request.getSession().setAttribute("ca.bc.gov.health.login.USER_KEY", up);

        response.sendRedirect(request.getContextPath() + "/Index.xhtml");
    }
}
