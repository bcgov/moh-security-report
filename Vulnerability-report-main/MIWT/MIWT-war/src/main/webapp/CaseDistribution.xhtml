<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/gov30.xhtml"
>
    <ui:define name="title">Case Distribution Reports</ui:define>
    <ui:define name="body">
        <p:messages id="messages">
            <p:autoUpdate/>
        </p:messages>

        <h:form id="form1">

            <h1>Case Distribution</h1>

            <div class="instruction">
                <h2>Instructions</h2>
                Select the fields you wish to include in your report, and select either View Chart or View Details to view the results in either graphical or tabular formats.
            </div>

            <div class="columns">
                <div class="large column">
                    <label>
                        Snapshot
                        <span class="required">*</span>
                    </label>
                    <p:selectOneMenu value="#{CaseDistribution.snapshotId}">
                        <f:selectItems value="#{Droplists.snapshots}"/>
                    </p:selectOneMenu>
                </div>
                <div class="small column">
                    <label>
                        From
                        <span class="required">*</span>
                    </label>
                    <p:calendar value="#{CaseDistribution.startDate}" navigator="true" pattern="dd-MMM-yyyy"
                                yearRange="c-10:c"/>
                </div>
                <div class="small column">
                    <label>
                        To
                        <span class="required">*</span>
                    </label>
                    <p:calendar value="#{CaseDistribution.endDate}" navigator="true" pattern="dd-MMM-yyyy"
                                yearRange="c-10:c"/>
                </div>
            </div>

            <table class="ui-datatable rf-dt stable">
                <thead>
                <tr class="rf-dt-shdr">
                    <th style="width: 120px; padding:10px;" class="ui-state-default">Primary Grouping</th>
                    <th style="width: 140px; padding:10px;" class="ui-state-default">Secondary Grouping</th>
                    <th style="width: 150px; padding:10px;" class="ui-state-default">Field</th>
                    <th style="width: auto; padding:10px;" class="ui-state-default">Filter</th>
                </tr>
                </thead>
                <tbody class="ui-datatable-data">
                <ui:repeat value="#{CaseDistribution.criteria.filters}" var="row">
                    <tr class="ui-widget-content ui-datatable-odd">
                        <td>
                            <p:outputPanel rendered="#{row.primaryGrouping}">
                                <input name="primary" type="radio" checked="checked"
                                       onclick="clearHiddens('primary');this.parentNode.nextSibling.value=this.checked"/>
                            </p:outputPanel>
                            <p:outputPanel rendered="#{!row.primaryGrouping}">
                                <input name="primary" type="radio"
                                       onclick="clearHiddens('primary');this.parentNode.nextSibling.value=this.checked"/>
                            </p:outputPanel>
                            <h:inputHidden id="primary" value="#{row.primaryGrouping}"/>
                        </td>
                        <td>
                            <p:outputPanel rendered="#{row.secondaryGrouping}">
                                <input name="secondary" type="radio" checked="checked"
                                       onclick="clearHiddens('secondary');this.parentNode.nextSibling.value=this.checked"/>
                            </p:outputPanel>
                            <p:outputPanel rendered="#{!row.secondaryGrouping}">
                                <input name="secondary" type="radio"
                                       onclick="clearHiddens('secondary');this.parentNode.nextSibling.value=this.checked"/>
                            </p:outputPanel>
                            <h:inputHidden id="secondary" value="#{row.secondaryGrouping}"/>
                        </td>
                        <td>#{row.label}</td>
                        <td>
                            <h:selectManyListbox value="#{row.selectedOptions}"
                                                 size="#{row.options.size()>5?5:row.options.size()}"
                                                 style="width: 100%">
                                <f:selectItems value="#{row.options}"/>
                            </h:selectManyListbox>
                        </td>
                    </tr>
                </ui:repeat>
                </tbody>
            </table>

            <div>
                <div class="buttons">
                    <p:commandButton value="Clear" action="#{CaseDistribution.clear}" update="@form messages"/>
                    <p:commandButton value="View Chart" action="#{CaseDistribution.displayChart}" icon="pi pi-chart-bar"
                                     disabled="#{Snapshots.snapshots.isEmpty()}" update="@form messages resultAsChart"/>
                    <p:commandButton value="View Details" action="#{CaseDistribution.displayTable}" icon="pi pi-table"
                                     disabled="#{Snapshots.snapshots.isEmpty()}" update="@form messages resultsTable"/>
                </div>
                <div class="clear"></div>
            </div>

            <h:panelGroup class="results" layout="block" id="resultAsTable" rendered="#{CaseDistribution.showTable}">
                <h2>#{CaseDistribution.criteria.groupingDisplayTxt}</h2>

                <h:panelGroup layout="block" style="text-align:right">
                    <p:commandButton value="Export as CSV" ajax="false" icon="pi pi-download">
                        <p:dataExporter type="csv" target="resultsTable"
                                        fileName="#{CaseDistribution.criteria.groupingSlugTxt}"/>
                    </p:commandButton>
                </h:panelGroup>

                <p:dataTable id="resultsTable" var="row" value="#{CaseDistribution.dataAsList}">
                    <p:columns value="#{CaseDistribution.columns}" var="column" columnIndexVar="index">
                        <f:facet name="header">
                            <h:outputText value="#{column.header}"/>
                        </f:facet>
                        <h:outputText value="#{row[column.property]}"/>
                    </p:columns>
                </p:dataTable>
                <div class="criteria">
                    <h3>Criteria</h3>
                    <h:panelGroup layout="block"
                                  rendered="#{not empty CaseDistribution.criteria.criteriaDisplayTxtForPrimaryGroup or not empty CaseDistribution.criteria.criteriaDisplayTxtForSecondaryGroup}">
                        <h:outputText value="#{CaseDistribution.criteria.criteriaDisplayTxtForPrimaryGroup}"/>
                        <h:outputText value=", "
                                      rendered="#{not empty CaseDistribution.criteria.criteriaDisplayTxtForPrimaryGroup and not empty CaseDistribution.criteria.criteriaDisplayTxtForSecondaryGroup}"/>
                        <h:outputText value="#{CaseDistribution.criteria.criteriaDisplayTxtForSecondaryGroup}"/>
                    </h:panelGroup>
                    <h:outputText value="No criterion selected."
                                  rendered="#{empty CaseDistribution.criteria.criteriaDisplayTxtForPrimaryGroup and empty CaseDistribution.criteria.criteriaDisplayTxtForSecondaryGroup}"/>
                </div>
            </h:panelGroup>

            <h:panelGroup class="results" layout="block" id="resultAsChart" rendered="#{CaseDistribution.showChart}">
                <h2>
                    <h:outputText value="#{CaseDistribution.criteria.groupingDisplayTxt}"/>
                </h2>
                <div class="chart">
                    <h:graphicImage id="chart" value="/chart/#{CaseDistribution.imageId}"/>
                </div>
                <div class="criteria">
                    <h3>Criteria</h3>
                    <h:panelGroup layout="block"
                                  rendered="#{not empty CaseDistribution.criteria.criteriaDisplayTxtForPrimaryGroup or not empty CaseDistribution.criteria.criteriaDisplayTxtForSecondaryGroup}">
                        <h:outputText value="#{CaseDistribution.criteria.criteriaDisplayTxtForPrimaryGroup}"/>
                        <h:outputText value=", "
                                      rendered="#{not empty CaseDistribution.criteria.criteriaDisplayTxtForPrimaryGroup and not empty CaseDistribution.criteria.criteriaDisplayTxtForSecondaryGroup}"/>
                        <h:outputText value="#{CaseDistribution.criteria.criteriaDisplayTxtForSecondaryGroup}"/>
                    </h:panelGroup>
                    <h:outputText value="No criterion selected."
                                  rendered="#{empty CaseDistribution.criteria.criteriaDisplayTxtForPrimaryGroup and empty CaseDistribution.criteria.criteriaDisplayTxtForSecondaryGroup}"/>
                </div>
            </h:panelGroup>
        </h:form>

        <script type="text/javascript">
            function clearHiddens(suffix){
                var hiddens = $('input[type=hidden]');
                var index = 0;
                for (index=0; index!=hiddens.length; index++){
                    var obj = hiddens[index];
                    if (obj.name.indexOf(suffix)!=-1){
                        obj.value = 'false';
                    }
                }
            }

        </script>
    </ui:define>
</ui:composition>