<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/gov30.xhtml">
    <ui:define name="title">Maintain Snapshots</ui:define>
    <ui:define name="body">

        <h:form id="form1">
            <h1>Maintain Snapshots</h1>

            <p:messages id="messages">
                <p:autoUpdate/>
            </p:messages>

            <div class="instruction">
                <h2>Instructions</h2>
                The table below lists all the reporting snapshots that have been created. 
                Clicking the Create New Snapshot button will create a new snapshot using all available data from April 1st, 2015 onwards.
            </div>

            <h2>All Snapshots</h2>
            <p:dataTable id="snapshotTable" value="#{Snapshots.snapshots}" rows="10" var="row"
                         paginator="true"
                         paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink}"
                         paginatorPosition="top" paginatorAlwaysVisible="false" rowsPerPageTemplate="5,10,15">
                <p:column sortBy="#{row.snapshotId}">
                    <f:facet name="header">Snapshot #</f:facet>
                    <h:outputText value="#{row.snapshotId}"/>
                </p:column>
                <p:column sortBy="#{row.createdOnDtm}">
                    <f:facet name="header">Created On</f:facet>
                    <h:outputText value="#{row.createdOnDtm}">
                        <f:convertDateTime pattern="dd-MMM-yyyy" timeZone="America/Vancouver"/>
                    </h:outputText>
                </p:column>
                <p:column sortBy="#{row.reportingPeriodStartDt}">
                    <f:facet name="header">Reporting Period Start Date</f:facet>
                    <h:outputText value="#{row.reportingPeriodStartDt}">
                        <f:convertDateTime pattern="dd-MMM-yyyy" timeZone="America/Vancouver"/>
                    </h:outputText>
                </p:column>
                <p:column sortBy="#{row.reportingPeriodEndDt}">
                    <f:facet name="header">Reporting Period End Date</f:facet>
                    <h:outputText value="#{row.reportingPeriodEndDt}">
                        <f:convertDateTime pattern="dd-MMM-yyyy" timeZone="America/Vancouver"/>
                    </h:outputText>
                </p:column>
                <p:column>
                    <f:facet name="header">Log File</f:facet>
                    <p:commandButton value="View" process="@this" update=":snapshotLogDlg"
                                     oncomplete="PF('snapshotLogViewer').show();" global="false">
                        <f:setPropertyActionListener value="#{row}" target="#{Snapshots.snapshot}"/>
                    </p:commandButton>
                </p:column>
            </p:dataTable>

            <h2>Data Approvals</h2>
            <p:dataTable value="#{Snapshots.approvals}" rows="10" var="row">
                <p:column sortBy="#{row.healthAuthorityId.healthAuthorityCd}">
                    <f:facet name="header">Health Authority</f:facet>
                    <h:outputText value="#{row.healthAuthorityId.healthAuthorityCd}"/>
                </p:column>
                <p:column sortBy="#{row.approvalDtm}">
                    <f:facet name="header">Last Approval Date</f:facet>
                    <h:outputText value="#{row.approvalDtm}">
                        <f:convertDateTime pattern="dd-MMM-yyyy" timeZone="America/Vancouver"/>
                    </h:outputText>
                </p:column>
            </p:dataTable>

            <div style="text-align: right">
                <p:commandButton action="#{Snapshots.createSnapshot}" async="true"
                                 onclick="PF('pbAjax').start();PF('progressDialog').show();"
                                 value="Create New Snapshot"/>
            </div>

            <p:dialog closable="false" resizable="false" draggable="false" id="modalDialog" visible="#{SnapshotProgress.inProgress}"
                      widgetVar="progressDialog" modal="true" class="progress" header="Snapshot creation">
                <h:panelGroup id="status" layout="block">
                    <h2>
                        <h:outputText value="#{SnapshotProgress.state}"/>
                    </h2>
                    <ui:fragment rendered="#{not empty SnapshotProgress.averageTime}">
                        <b>Average time: </b>
                        <h:outputText value="#{SnapshotProgress.averageTime}"/>
                    </ui:fragment>

                    <b>Running time: </b>
                    <h:outputText value="#{SnapshotProgress.runningTime}"/>
                </h:panelGroup>
                <p:poll update="status" interval="10"/>
                <p:progressBar ajax="true" interval="60" value="#{SnapshotProgress.progress}" labelTemplate="{value}%"
                               widgetVar="pbAjax" 
                               id="progressBar" style="width:600px;" styleClass="animated" global="false">
                    <p:ajax event="complete" oncomplete="PF('pbAjax').cancel();PF('progressDialog').hide();"
                            listener="#{Snapshots.onSnapshotComplete}" update="snapshotTable @form"/>
                </p:progressBar>
            </p:dialog>
        </h:form>

        <p:dialog id="snapshotLogDlg" header="Snapshot log" widgetVar="snapshotLogViewer" modal="true"
                  resizable="false" draggable="false" position="center">
            <p:dataTable id="snapshotLogViewerTable" value="#{Snapshots.snapshot.snapshotLogList}" var="row" rows="10"
                         paginator="true"
                         paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink}"
                         paginatorPosition="top" paginatorAlwaysVisible="false" rowsPerPageTemplate="5,10,15">
                <p:column sortBy="#{row.healthAuthorityId.healthAuthorityCd}">
                    <f:facet name="header">Health Authority</f:facet>
                    <h:outputText value="#{row.healthAuthorityId.healthAuthorityCd}"/>
                </p:column>
                <p:column sortBy="#{row.rowsProcessed}">
                    <f:facet name="header">Rows Submitted</f:facet>
                    <h:outputText value="#{row.rowsProcessed}"/>
                </p:column>
                <p:column sortBy="#{row.rowsProcessed - rowsRejected}">
                    <f:facet name="header">Rows Accepted</f:facet>
                    <h:outputText value="#{row.rowsProcessed - row.rowsRejected}"/>
                </p:column>
                <p:column sortBy="#{row.rowsRejected}">
                    <f:facet name="header">Rows Rejected</f:facet>
                    <h:outputText value="#{row.rowsRejected}"/>
                </p:column>
                <p:column sortBy="#{row.rowsWithWarnings}">
                    <f:facet name="header">Rows with Warnings</f:facet>
                    <h:outputText value="#{row.rowsWithWarnings}"/>
                </p:column>
            </p:dataTable>

            <div style="text-align: right">
                <p:commandButton value="Close" onclick="PF('snapshotLogViewer').hide();"/>
            </div>
        </p:dialog>
    </ui:define>
</ui:composition>

