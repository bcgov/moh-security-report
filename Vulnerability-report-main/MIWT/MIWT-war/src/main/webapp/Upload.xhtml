<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/gov30.xhtml">
    <ui:define name="title">Upload and Approve Health Authority data</ui:define>
    <ui:define name="body">
        <h1>Upload and Approve Health Authority data</h1>

        <p:messages id="messages">
            <p:autoUpdate/>
        </p:messages>

        <div class="instruction">
            <h2>Instructions</h2>
            Please select a file to upload. Only CSV files (comma separated files) are allowed.
        </div>

        <h:form id="form1" enctype="multipart/form-data">
            <p:panel id="approvalDate">
                <f:facet name="header">
                    <h:outputText value="Last Approval Date"/>
                </f:facet>
                <h:outputText value="#{DataUploadBean.healthAuthority.healthAuthorityNm}"/>
                data submissions last approved on
                <b>
                    <h:outputText value="#{DataUploadBean.lastApprovalDate}">
                        <f:convertDateTime pattern="dd-MMM-yyyy hh:mm a" timeZone="America/Vancouver"/>
                    </h:outputText>
                </b>
            </p:panel>

            <p:panel id="entry" class="formgroup">
                <h2>Upload Data File</h2>
                <h:panelGroup layout="block" class="ui-messages"
                              rendered="#{FileUploadBean.dataUploadBean.uploadComplete}">
                    <div class="ui-messages-info">
                        <span class="ui-messages-info-icon"></span>
                        <ul>
                            <li>
                                <span class="ui-messages-info-summary">
                                File uploaded:
                                 <h:outputText value="#{FileUploadBean.uploadedFileName}"/>
                                </span>
                            </li>
                        </ul>
                    </div>
                </h:panelGroup>
                <h:selectBooleanCheckbox id="headerLineChkBox"
                                         disabled="#{FileUploadBean.dataUploadBean.uploadInProgress}"
                                         value="#{FileUploadBean.dataUploadBean.firstLineHeader}">
                    <p:ajax event="change" process="@this" update="@none" global="false"/>
                </h:selectBooleanCheckbox>
                Skip First Line - (Headers/Summary)
                <p:fileUpload id="fileUploader" widgetVar="upload" listener="#{FileUploadBean.upload}"
                              onstart="PF('pbAjax').cancel();PF('progressDialog').show();PF('pbAjax').start();"
                              mode="advanced" dragDropSupport="true" fileLimit="1" label="Select file to upload..."
                              allowTypes="/(\.|\/)(csv)$/" invalidFileMessage="Only CSV files are accepted"
                              update="entry,validationErrContainer, previewPanel, uploadState, errContainer, dbErrContainer, dbErrorsPanel, fileStats"
                              sizeLimit="209715200" >
                </p:fileUpload>
            </p:panel>
            <p:remoteCommand name="resetUploadFlag" action="#{FileUploadBean.clear()}" global="false"/>

            <p:outputPanel id="errContainer">
                <p:panel id="validationErrContainer"
                         rendered="#{not FileUploadBean.dataUploadBean.uploadInProgress and not FileUploadBean.dataUploadBean.validationErrors.isEmpty()}">
                    <h2>
                        <h:outputText value="Validation Messages"/>
                    </h2>
                    <div class="buttons">
                        <p:commandButton id="excelExport" value="Export as CSV" icon="pi pi-download" ajax="false">
                            <p:dataExporter type="csv" target="errWarnings" fileName="upload-validation"/>
                        </p:commandButton>
                    </div>
                    <p:dataTable id="errWarnings" value="#{FileUploadBean.dataUploadBean.validationErrors}"
                                 var="row" rows="10" widgetVar="errorTable"
                                 paginator="true"
                                 paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink}"
                                 paginatorPosition="top" paginatorAlwaysVisible="false"
                                 styleClass="hide-column-names hide-borders">
                        <p:column styleClass="error">
                            <f:facet name="header">Message</f:facet>
                            <h:outputText value="#{row}"/>
                        </p:column>
                    </p:dataTable>
                </p:panel>
            </p:outputPanel>

            <p:outputPanel id="dbErrorsPanel">
                <p:panel id="dbErrContainer"
                         rendered="#{not FileUploadBean.dataUploadBean.uploadInProgress and not FileUploadBean.dataUploadBean.dbErrors.isEmpty()}">
                    <h2>
                        <h:outputText value="Database Insertion Error Messages"/>
                    </h2>
                    <div class="buttons">
                        <p:commandButton id="dbExcelExport" value="Export as CSV" icon="pi pi-download" ajax="false">
                            <p:dataExporter type="csv" target="dbErrors" fileName="upload-db-errors"/>
                        </p:commandButton>
                    </div>
                    <p:dataTable id="dbErrors" value="#{FileUploadBean.dataUploadBean.dbErrors}" var="row"
                                 rows="10" widgetVar="dbErrorTable"
                                 paginator="true"
                                 paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink}"
                                 paginatorPosition="top" paginatorAlwaysVisible="false"
                                 styleClass="hide-column-names hide-borders" style="width: auto">
                        <p:column styleClass="error">
                            <f:facet name="header">Message</f:facet>
                            <h:outputText value="#{row}"/>
                        </p:column>
                    </p:dataTable>
                </p:panel>
            </p:outputPanel>

            <p:outputPanel id="fileStats" layout="block">
                <p:panel id="previewPanel" rendered="#{DataUploadBean.uploadComplete}">
                    <h2>
                        Data submission summary
                    </h2>
                    <h3>
                        <h:outputText value="#{User.healthAuthority.healthAuthorityNm}"/>
                    </h3>
                    <p:dataTable id="statsTable" value="#{FileUploadBean.dataUploadBean.stats}" var="var">
                        <p:column style="width: 70%">
                            <f:facet name="header">Summary Results</f:facet>
                            <h:outputText value="#{var[0]}" escape="#{FileUploadBean.dataUploadBean.doingExport}"/>
                        </p:column>
                        <p:column>
                            <f:facet name="header">Row Counts</f:facet>
                            <h:outputText value="#{var[1]}"/>
                        </p:column>
                    </p:dataTable>

                    <div>
                        <div class="left">
                            <p:commandButton id="excelStatsExport" value="Export as CSV" icon="pi pi-download"
                                             ajax="false">
                                <p:dataExporter type="csv" target="statsTable" fileName="upload-stats"/>
                            </p:commandButton>
                        </div>
                        <div class="right">
                            <p:commandButton id="modalDialogButton" value="Approve Submission"
                                             onclick="PF('dlgApprove').show();" icon="pi pi-check"
                                             type="button"/>
                        </div>
                        <div class="clear"></div>
                    </div>
                </p:panel>
            </p:outputPanel>

            <h:selectBooleanCheckbox id="uploadState" value="#{FileUploadBean.dataUploadBean.uploadInProgress}"
                                     style="display: none" readonly="true"/>

            <p:dialog closable="false" resizable="false" id="modalDialog" header="Processing Records..."
                      widgetVar="progressDialog" modal="true" width="600" height="33">
                <p:progressBar  ajax="true" labelTemplate="{value}%" widgetVar="pbAjax"
                               value="#{DataUploadBean.progress}" id="progressBar"
                               style="height:30px;font-size:1.5em;vertical-align:middle;" styleClass="animated">
                    <p:ajax event="complete"
                            oncomplete="PF('progressDialog').hide();if(PF('errorTable')!=null){PF('errorTable').getPaginator().setPage(0);}if(PF('dbErrorTable')!=null){PF('dbErrorTable').getPaginator().setPage(0);}"
                            update="validationErrContainer, previewPanel, uploadState, errContainer, dbErrContainer, dbErrorsPanel, fileStats"/>
                </p:progressBar>
            </p:dialog>

            <div style="text-align: right; margin-top: 20px;">
                <p:commandButton id="refresh" style="display:none;" process="@this" update="@form messages"
                                 ajax="false"/>
                <p:commandButton value="Screen Reset" action="#{FileUploadBean.clear}" process="@this"
                                 update="@form messages" ajax="false"/>
            </div>

            <p:dialog id="modalDialogApprove" header="Approval Confirmation" widgetVar="dlgApprove" modal="true"
                      width="550">
                <p>
                    Selecting the “Yes” button approves only the current uploaded csv file.
                    <br/>
                    Selecting the “No” button deletes all uploaded records from the current uploaded csv file.
                </p>
                <p>
                    For Questions: Contact the Ministry of Health <b>Service Desk</b><br/>
                    250-952-1234<br/>
                    <a href="mailto:HLTH.ServiceDesk@gov.bc.ca">HLTH.ServiceDesk@gov.bc.ca</a>
                </p>
                <p><b>Do you wish to Approve?</b></p>
                <div>
                    <div class="left">
                        <p:commandButton style="float: left; margin-left: 120px;" value="Yes"
                                         action="#{FileUploadBean.dataUploadBean.approveData}" ajax="false"
                                         process="@this"
                                         update="approvalDate"/>
                    </div>
                    <div class="right">
                        <p:commandButton style="float: right; margin-right: 120px;" value="No"
                                         action="#{FileUploadBean.dataUploadBean.cleanupTemp}" process="@this"
                                         update="@form messages" ajax="false" id="closeModalWindowButton"
                                         onclick="PF('dlgApprove').hide();"/>
                    </div>
                    <div class="clear"></div>
                </div>
            </p:dialog>
        </h:form>
    </ui:define>

</ui:composition>
