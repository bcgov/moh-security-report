<%@ Language=VBScript %>

<%' Option Explicit %>

<!-- #include file = "global_dims.inc" -->

<%
'	dim path, section_name
	
	path			= ""
	section_name	= "email_friend"
	
	dim issubmit, emailfrom, emailto1, message, referralurl
	dim emailfrommsg, emailto1msg, errormsg, errormsg1, namefrom, namefrommsg
	dim namefriend, namefriendmsg
	
	namefrom	= trim(request.form("namefrom"))
	emailfrom	= trim(request.form("emailfrom"))
	emailto1	= trim(request.form("emailto1"))
	message		= trim(request.form("message"))
	referralurl	= trim(request.form("referralurl"))
	namefriend	= trim(request.form("namefriend"))
	if referralurl = "" then
'		tinstr = instr(request.querystring, "http://")
'		if (tinstr = 0) then
'			tinstr = instr(request.querystring, "https://")
'		end if
'		referralurl = mid(request.querystring, tinstr)
		referralurl = request.querystring("url")

	end if
	
	if request.querystring("action") <> "" then
		issubmit = true
		
		if trim(request.form("namefrom")) = "" then
			namefrommsg	= "Please enter your name."
			issubmit	= false
		end if
		
		if trim(request.form("namefriend")) = "" then
			namefriendmsg	= "Please enter your friend's name."
			issubmit		= false
		end if
		
		if not isEmail(request.form("emailfrom")) then
		    emailfrommsg	= "Please enter a valid e-mail address."
			issubmit		= false
		end if
		
		if not isEmail(request.form("emailto1")) then
		    emailto1msg	= "Please enter a valid e-mail address."
			issubmit		= false
		end if
		
		if issubmit = true then
			
			strMessage = "Your friend " & namefrom & " thought you would be interested in this article from <a href=""http://www.HealthLinkBC.ca"">HealthLink BC</a> (http://www.HealthLinkBC.ca)<br><br>"
			
			if message <> "" then
				strMessage = strMessage & "*** Here is your personal message from " & namefrom & " ***<br><br>" & message & "<br><br>"
			end if
			
			strMessage = strMessage & "To read this article, click here: <a href="& referralurl & "> " & referralurl & " </a>."
			
			' create the e-mail
    	set o_msg = createobject("cdo.message")
   	    set o_conf = createobject("cdo.configuration")
    	With o_conf.Fields
        .Item("http://schemas.microsoft.com/cdo/configuration/sendusing") = 2
        .Item("http://schemas.microsoft.com/cdo/configuration/smtpserver") = "smtp.gov.bc.ca"
        .Update
    	End With
    	With o_msg
        set .Configuration = o_conf
        .AutoGenerateTextBody = true
        .Fields("urn:schemas:httpmail:importance").Value = 1
        .Fields.Update()
        .To = trim(request.form("emailto1"))
        .From = trim(request.form("emailfrom"))
        .Subject = "An article from HealthLink BC"
        .HTMLBody = strMessage
        '.AddAttachment "C:\files\a.doc"
        .Send
    	End With
    	set o_msg = nothing
    	set o_conf = nothing
			int_action_id	= 1
			str_capture_url	= referralurl
		else
			errormsg = "<font color=""#ff0000"">Please enter all required fields.</font>"
			errormsg1 = "<font color=""#ff0000"">*</font>"
		end if
	end if
%>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Send to A Friend</title>
<link href="../style/govbc.css" rel="stylesheet" type="text/css" />
<script>
	// Get the passed in URL from the query string
	var qs = (function(a) {
		if (a == '') return {};
		var b = {};
		for (var i = 0; i < a.length; ++i){
			var p=a[i].split('=');
			if (p.length != 2) continue;
			b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, ' '));
		}
		return b;
	})(window.location.search.substr(1).split('&'));			
	var url = qs['url'];
</script>
</head>
<body>
	<div id="tellfriend">
		<h3>Email this link to a friend:</h3>
		<%
			if request.querystring("action") <> "" and issubmit = true then
				response.write "<p>Your message has been sent.</p>"
			else
		%>
		<p>Send the latest feature articles and other health resources to your friends. Enter the information below and click on the "Submit" button.</p>
		<p>Fields marked with an asterix (<span class="required">*</span>) are mandatory.</p>
		<%
			end if
		%>	
				<% if request.querystring("action") <> "" and issubmit = true then %>
		<form action="email-friend.asp" method="post" name="email_form">
			<input type="hidden" name="namefrom"  value="<%= namefrom %>">
			<input type="hidden" name="emailfrom"  value="<%= emailfrom %>">
			<input type="hidden" name="message" value="<%= message %>">
			<input type="hidden" name="referralurl" value="<%= referralurl %>">
			<input type="submit" id="submit-success" value="Email link to another friend">			
		</form>
		<% else %>
		<p><%=errormsg%></p>
		<form id="tellafriend_form" name="email_form" method="post" action="email-friend.asp?action=submit">
		<label for="name">Your Name:<span class="required">*</span></label>
		<input type="text" id="name" name="namefrom" value="<%= namefrom %>" />
		<label for="from">Your Email:<span class="required">*</span></label>
		<input type="text" id="from" name="emailfrom" value="<%= emailfrom %>" />
		<label for="to">Friend's Name:<span class="required">*</span></label>
		<input type="text" id="to_name" name="namefriend"  value="<%= namefriend %>" />
		<label for="to">Friend's Email:<span class="required">*</span></label>
		<input type="text" id="to" name="emailto1" value="<%= emailto1 %>" />
		<label for="message">Personal Message:</label>
		<textarea id="message" name="message" rows="4" cols="40"><%= message %></textarea>
		<input type="hidden" name="referralurl"  value="<%= referralurl %>" />
		<input type="submit" name="submit" class="submit" value="Submit"/>
		<div class="clear zero"></div>
		</form>
		<% end if %>
	</div>
<!--#include file="footer_scripts.inc" -->
</body>
</html>