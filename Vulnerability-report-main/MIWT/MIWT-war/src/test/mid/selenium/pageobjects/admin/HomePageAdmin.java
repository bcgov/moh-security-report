package mid.selenium.pageobjects.admin;

import mid.selenium.pageobjects.fragment.LeftMenuAdmin;
import org.openqa.selenium.By;
import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.remote.RemoteWebDriver;
import org.openqa.selenium.support.PageFactory;
import org.openqa.selenium.support.ui.LoadableComponent;
import selenium.pageobject.LoginPage;
import selenium.util.ActionBot;
import selenium.util.Constants;

/**
 *
 * @author CGI Information Management Consultants Inc.
 */
public class HomePageAdmin extends LoadableComponent<HomePageAdmin> {

    public static final String XPATH_FOR_LOGOUT_LINK = "//a[text()='Logout']";
    public static final String XPATH_FOR_HOME_PAGE_FORM = "//form[contains(@action, 'index.xhtml')]";
    private final WebDriver driver;
    private String[] handles;
    private final ActionBot actionBot;
    private final String browser;
    private final LoadableComponent<?> parent;
    private final LeftMenuAdmin leftMenu;
    private boolean isSuite;

    public HomePageAdmin(LoadableComponent<?> parent, LeftMenuAdmin leftMenu, WebDriver driver, String browser) {

        this.driver = driver;
        this.browser = browser;
        this.parent = parent;
        this.leftMenu = leftMenu;
        actionBot = new ActionBot(driver);


        PageFactory.initElements(driver, this);

    }

    public boolean isIsSuite() {
        return isSuite;
    }

    public void setIsSuite(boolean isSuite) {
        this.isSuite = isSuite;
    }
    
    

    @Override
    protected void load() {

        if (!((LoginPage) parent).isLoggedIn()) {
            parent.get();

            //open a new tab/window
            actionBot.click(By.xpath("//a[@href='/HNWebController?ExternalAction=WssoTransfer&receivingApplication=mix']"));

            handles = driver.getWindowHandles().toArray(new String[0]);
            driver.switchTo().window(handles[handles.length - 1]);

            if (browser.equals(((RemoteWebDriver) driver).getCapabilities().getBrowserName())) {
                driver.navigate().to("javascript:document.getElementById('overridelink').click()");
            }

            actionBot.waitForLoadingUsingXpath(XPATH_FOR_HOME_PAGE_FORM, Constants.MEDIUM_TIMEOUT);
            leftMenu.setHandle(handles[handles.length - 1]);
        }
        
        leftMenu.showHomePage();
        actionBot.waitForLoadingUsingXpath(XPATH_FOR_HOME_PAGE_FORM, Constants.MEDIUM_TIMEOUT);
    }

    @Override
    protected void isLoaded() throws Error {

        try {
            driver.findElement(By.xpath(XPATH_FOR_HOME_PAGE_FORM));
            assert true;
        } catch (NoSuchElementException e) {
            load();

        }
    }

    public void signOut() {
        driver.findElement(By.xpath(XPATH_FOR_LOGOUT_LINK));
        ((LoginPage) parent).signOut();
    }

    public void assertPageLoaded() {
        leftMenu.assertPageLoaded();
    }
}
