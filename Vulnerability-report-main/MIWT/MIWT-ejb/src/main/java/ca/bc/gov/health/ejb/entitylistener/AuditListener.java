package ca.bc.gov.health.ejb.entitylistener;

import ca.bc.gov.health.login.RoleHelper;
import jakarta.faces.context.FacesContext;
import jakarta.persistence.PrePersist;
import jakarta.persistence.PreUpdate;
import java.util.Date;
import org.apache.commons.beanutils.PropertyUtils;

/**
 *
 * @author CGI Information Management Consultants Inc.
 */
public class AuditListener {

    public AuditListener() {
    }

    @PrePersist
    public void prePersist(Object entity) {
        try {
            PropertyUtils.setProperty(entity, "createdOnDtm", new Date());
            PropertyUtils.setProperty(entity, "createdByNm", findUserName());
            PropertyUtils.setProperty(entity, "statelessTransactionNbr", 1l);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @PreUpdate
    public void preUpdate(Object entity) {
        try {
            PropertyUtils.setProperty(entity, "lastModifiedOnDtm", new Date());
            PropertyUtils.setProperty(entity, "lastModifiedByNm", findUserName());
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    /**
     * Pulls the current user's name
     *
     * @return String
     */
    private String findUserName() {

        if (FacesContext.getCurrentInstance() == null) { // if no facesContext, this must be an ejb scheduler call
            return "System";
        }
        return RoleHelper.getUserName(FacesContext.getCurrentInstance());
    }
}
