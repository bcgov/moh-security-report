package ca.bc.gov.health.mid.ejb.session;

import ca.bc.gov.health.mid.ejb.entity.DataApproval;
import ca.bc.gov.health.mid.ejb.entity.HealthAuthority;
import jakarta.ejb.Stateless;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.persistence.Query;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

/**
 *
 * @author CGI Information Management Consultants Inc.
 */
@Stateless
public class DataApprovalFacade extends AbstractFacade<DataApproval> implements DataApprovalFacadeLocal {
    @PersistenceContext(unitName = "MIDPU")
    private EntityManager em;

    protected EntityManager getEntityManager() {
        return em;
    }

    public DataApprovalFacade() {
        super(DataApproval.class);
    }
    
    @Override
    public List<DataApproval> currentApprovals(){
        
        Query q = em.createQuery("SELECT MD.healthAuthorityId, MAX(MD.approvalDtm) FROM DataApproval MD GROUP BY MD.healthAuthorityId", DataApproval.class);
        List result = q.getResultList();
        
        List<DataApproval> converted = new ArrayList<>(result.size());
        
        Object[] temp;
        DataApproval item;
        for (int i = 0; i < result.size(); i++) {
           temp =  (Object[]) result.get(i);
           
           item = new DataApproval();
           item.setHealthAuthorityId((HealthAuthority) temp[0]);
           item.setApprovalDtm((Date) temp[1]);
           
           converted.add(item);
           
        }
        
        return converted;
    }
}
