package ca.bc.gov.health.beans.claim.importer;

import ca.bc.gov.health.beans.BaseBean;
import ca.bc.gov.health.importfile.HopsitalClaimCreator;
import ca.bc.gov.health.importfile.HospitalClaimValidator;
import jakarta.enterprise.context.RequestScoped;
import jakarta.inject.Inject;
import jakarta.inject.Named;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.Serializable;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;
import org.primefaces.event.FileUploadEvent;
import org.primefaces.model.file.UploadedFile;

@Named("ImportClaim")
@RequestScoped
public class ImportClaim extends BaseBean implements Serializable {

  @Inject HospitalClaimValidator hospClaimImport;
  @Inject HopsitalClaimCreator hospClaimCreator;

  public void handleFileUpload(FileUploadEvent event) throws Exception {
    UploadedFile file = event.getFile();
    List<String> lines = readFile(file);
    hospClaimImport.validateImportFile(file.getFileName(), lines);
    List errors = hospClaimImport.getErrors().getErrors();
    if (errors.isEmpty()) {
      addInfoMessage(file.getFileName() + " was uploaded.");
      hospClaimCreator.createClaims(file.getFileName(), lines);
    } else {
      addErrorMessage(
          MessageFormat.format(
              "The import file ''{0}'' was received but claims were not loaded as the file contains errors.",
              file.getFileName()));
      addErrorMessage(
          errors.stream().map(t -> t.toString()).collect(Collectors.joining("<br/>")).toString());
    }
  }

  private List<String> readFile(UploadedFile f) throws IOException {
    try (BufferedReader reader = new BufferedReader(new InputStreamReader(f.getInputStream()))) {
      List<String> lines = new ArrayList<>();
      String line;
      while ((line = reader.readLine()) != null) {
        lines.add(line);
      }
      return lines;
    }
  }
}
