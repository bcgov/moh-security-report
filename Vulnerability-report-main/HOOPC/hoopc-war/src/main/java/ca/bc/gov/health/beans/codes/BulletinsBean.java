/*
 * To change this license header, choose License Headers in Project Properties. To change this
 * template file, choose Tools | Templates and open the template in the editor.
 */
package ca.bc.gov.health.beans.codes;

import ca.bc.gov.health.beans.BaseBean;
import ca.bc.gov.health.constants.GlobalConstants;
import ca.bc.gov.health.database.ejb.ApplicationBulletinsFacadeLocal;
import ca.bc.gov.health.database.entity.ApplicationBulletins;
import ca.bc.gov.health.exception.HoopcException;
import jakarta.annotation.PostConstruct;
import jakarta.ejb.EJB;
import jakarta.faces.application.FacesMessage;
import jakarta.faces.context.FacesContext;
import jakarta.faces.view.ViewScoped;
import jakarta.inject.Named;
import java.io.Serializable;
import java.time.LocalDate;
import java.util.List;
import org.primefaces.PrimeFaces;

/**
 * The Class BulletinsBean.
 *
 * @author Trevor.Schiavone
 */
@ViewScoped
@Named("BulletinsBean")
public class BulletinsBean extends BaseBean implements Serializable {

  private static final long serialVersionUID = 1409627608855947183L;

  @EJB private ApplicationBulletinsFacadeLocal applicationBulletinsFacade;

  private List<ApplicationBulletins> allBulletins;
  private ApplicationBulletins bulletin = new ApplicationBulletins();

  /** Inits the. */
  @PostConstruct
  public void init() {
    loadAllBulletinsList();
  }

  /** Load all bulletins list. */
  public void loadAllBulletinsList() {
    try {
      allBulletins = applicationBulletinsFacade.findAll();
    } catch (HoopcException e) {
      addMessage(e, false);
    }
  }

  /** Clear bulletin. */
  public void clearBulletin() {
    bulletin = new ApplicationBulletins();
  }

  /** Save bulletin. */
  public void saveBulletin() {

    try {

      if (bulletin.getId() == null) {
              //BCMOHAD-9605-17Mar22: Applying validation on effective date not to allow the past date for bulletin
              if (bulletin.getStartDate().isBefore(LocalDate.now())) {
                  String errorMsg = "Effective date cannot be in the past.";
                  FacesContext.getCurrentInstance().validationFailed();
                  addMessage(FacesMessage.SEVERITY_ERROR, errorMsg, false);
                  return;
              }
        applicationBulletinsFacade.create(bulletin);
        addMessage(FacesMessage.SEVERITY_INFO, GlobalConstants.BULLETIN_CREATE_MESSAGE, false);
      } else {
        applicationBulletinsFacade.edit(bulletin);
        addMessage(FacesMessage.SEVERITY_INFO, GlobalConstants.BULLETIN_EDIT_MESSAGE, false);
      }

      loadAllBulletinsList();
      PrimeFaces.current().ajax().update("bulletinForm");

    } catch (HoopcException e) {
      addMessage(e, false);
    }
  }

  /** Removes the bulletin. */
  public void removeBulletin() {
    try {
      applicationBulletinsFacade.remove(bulletin);
      loadAllBulletinsList();

      addMessage(FacesMessage.SEVERITY_INFO, GlobalConstants.BULLETIN_DELETE_MESSAGE, false);
      PrimeFaces.current().ajax().update("bulletinForm");
    } catch (HoopcException e) {
      addMessage(e, false);
    }
  }

  /* Getters and Setters */
  public List<ApplicationBulletins> getAllBulletins() {
    return allBulletins;
  }

  public ApplicationBulletins getBulletin() {
    return bulletin;
  }

  public void setBulletin(ApplicationBulletins bulletin) {
    this.bulletin = bulletin;
  }
}
