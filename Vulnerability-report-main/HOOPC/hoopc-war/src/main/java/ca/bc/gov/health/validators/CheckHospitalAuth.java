package ca.bc.gov.health.validators;

import ca.bc.gov.health.beans.ApplicationBean;
import ca.bc.gov.health.service.HoopcSessionBean;
import jakarta.faces.application.FacesMessage;
import jakarta.faces.component.UIComponent;
import jakarta.faces.context.FacesContext;
import jakarta.faces.validator.FacesValidator;
import jakarta.faces.validator.Validator;
import jakarta.faces.validator.ValidatorException;
import jakarta.inject.Inject;
import java.text.MessageFormat;
import java.util.ResourceBundle;
import org.apache.commons.lang3.StringUtils;

/** The Class CheckHospitalAuth. */
@FacesValidator(value = "checkHospitalAuth", managed = true)
public class CheckHospitalAuth implements Validator<String> {

  @Inject private ApplicationBean appBean;

  @Inject private HoopcSessionBean session;

  private static ResourceBundle bundle = ResourceBundle.getBundle("messages");

  /*
   * (non-Javadoc)
   *
   * @see jakarta.faces.validator.Validator#validate(jakarta.faces.context.FacesContext,
   * jakarta.faces.component.UIComponent, java.lang.Object)
   */
  @Override
  public void validate(FacesContext context, UIComponent component, String value)
      throws ValidatorException {
    String province = "BC";
    String hospitalNameAndNumber = ((String) value);

    // TODO: Invalid hospitals should pass
    if (!StringUtils.isEmpty(hospitalNameAndNumber)) {
      String hospitalNumber = hospitalNameAndNumber.split("-")[0];

      if (!appBean.isUserAuthorized(province, hospitalNumber)) {
        String errorMsg =
            MessageFormat.format(
                bundle.getString("claim.validation.checkHospitalAuth"),
                session.getCurrentUser().getApplicationUserid(),
                hospitalNumber);
        throw new ValidatorException(new FacesMessage(FacesMessage.SEVERITY_ERROR, errorMsg, ""));
      }
    }
  }
}
