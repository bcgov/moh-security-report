/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.health.service;

import ca.bc.gov.health.database.entity.HighcostProcedureCodes;
import ca.bc.gov.health.database.entity.HighcostProcedureRate;
import ca.bc.gov.health.service.viewmodel.ClaimViewModel;
import ca.bc.gov.health.service.viewmodel.HighcostViewModel;
import jakarta.ejb.Stateless;
import jakarta.inject.Inject;
import jakarta.inject.Named;
import org.apache.commons.lang3.StringUtils;

/** @author trevor.schiavone */
@Stateless
@Named("ClaimPreProcessor")
public class ClaimPreProcessor {

  @Inject private HoopcAppService appService;

  public void updateHighCostRate(ClaimViewModel claimView) {

    for (HighcostViewModel highCostProcedureView : claimView.getHighCostProcedures()) {

      // If there's a code and a date but no rate then we lookup the rate
      if (StringUtils.isNotBlank(highCostProcedureView.getCodeValue())
          && highCostProcedureView.getProcedureDate() != null
          && highCostProcedureView.getProcedureCost() == null) {

        HighcostProcedureCodes highCostProcedureCode =
            appService.getHighcostCode(Short.valueOf(highCostProcedureView.getCodeValue()));
        selectCorrectHighCostRate(highCostProcedureCode, highCostProcedureView);
      }
    }
  }

  private void selectCorrectHighCostRate(
      HighcostProcedureCodes highCostProcedureCode, HighcostViewModel highCostProcedureView) {
    // Find the correct rate based on the procedure date
    for (HighcostProcedureRate highCostRate :
        highCostProcedureCode.getHighcostProcedureRateList()) {

      // Effective Date is before or equal
      // AND
      // End Date is null, or after, or equal
      if ((highCostRate.getEffectiveDate().isBefore(highCostProcedureView.getProcedureDate())
              || highCostRate.getEffectiveDate().isEqual(highCostProcedureView.getProcedureDate()))
          && (highCostRate.getEndDate() == null
              || highCostRate.getEndDate().isAfter(highCostProcedureView.getProcedureDate())
              || highCostRate.getEndDate().isEqual(highCostProcedureView.getProcedureDate()))) {

        highCostProcedureView.setProcedureCost(highCostRate.getBasicBlockRateAmount());
        break;
      }
    }
  }
}
