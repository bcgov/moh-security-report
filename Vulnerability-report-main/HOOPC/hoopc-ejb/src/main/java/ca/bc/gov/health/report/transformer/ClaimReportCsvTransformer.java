package ca.bc.gov.health.report.transformer;

import java.math.BigDecimal;
import java.sql.Timestamp;
import java.util.List;
import java.util.Map;

/** The Class ClaimReportCsvTransformer. */
public class ClaimReportCsvTransformer extends BaseReportTransformer {

  /**
   * Transform.
   *
   * @param record the record
   * @param fields the fields
   * @return the string
   */
  public static String transform(Map<String, Object> record, List<String> fields) {
    StringBuilder row = new StringBuilder();
    for (String key : fields) {
      String value = setPropertyValue(record, key);
      if (row.length() > 0) {
        row.append("," + value);
      } else {
        row.append(value);
      }
    }
    return row.toString();
  }

  private static String setPropertyValue(Map<String, Object> record, String key) {
    String value = "";
    if (record.containsKey(key)) {
      if (record.get(key) instanceof String) {
        value = readString(record, key);
      } else if (record.get(key) instanceof Timestamp) {
        value = readTimestamp(record, key, "dd-MMM-YY");
        value = value != null ? value.toUpperCase() : value;
      } else if (record.get(key) instanceof BigDecimal) {
        value = readBigDecimalAsString(record, key, 2);
      }
      value = value != null ? value : "";
    } else if (key.equals("INITCAP_REPORT_TYPE")) { // DETL_RES_OUT_PATIENT
      value = readString(record, "REPORT_TYPE");
    } else if (key.equals("CF_SEX_DEC_REAS")) { // DETL_RES_IN_PATIENT
      value = readString(record, "SEX") + " / " + readString(record, "DECEASED");
    }
    return value;
  }
}
