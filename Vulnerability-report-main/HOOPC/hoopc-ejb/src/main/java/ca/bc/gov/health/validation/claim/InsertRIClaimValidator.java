package ca.bc.gov.health.validation.claim;

import ca.bc.gov.health.service.viewmodel.ClaimViewModel;
import ca.bc.gov.health.validation.rule.ComplexRule;
import ca.bc.gov.health.validation.rule.InDateRangeRule;
import ca.bc.gov.health.validation.rule.InSetRule;
import ca.bc.gov.health.validation.rule.LookupRule;
import ca.bc.gov.health.validation.rule.MandatoryRule;
import ca.bc.gov.health.validation.rule.NotInSetRule;
import ca.bc.gov.health.validation.rule.ValidationRule;
import jakarta.annotation.PostConstruct;
import jakarta.inject.Named;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/** Validation rules for Create resident inpatient claims. */
@Named("InsertRIClaimValidator")
public class InsertRIClaimValidator extends CommonClaimValidator {
  private static final String SUBMISSION_DATE = "Submission Date";
  private static final String TREATING_PROVINCE = "Treating Province";
  private static Logger log = LoggerFactory.getLogger(InsertRIClaimValidator.class);

  /** Post construct. */
  @PostConstruct
  private void postConstruct() {
    log.info("InsertRIClaimValidator");
  }

  /* (non-Javadoc)
   * @see ca.bc.gov.health.validation.ValidatorBase#getRules(java.lang.Object)
   */
  @Override
  public List<ValidationRule<ClaimViewModel>> getRules(ClaimViewModel claimView) {

    List<ValidationRule<ClaimViewModel>> rules = new ArrayList<>();
    rules.addAll(insertRIClaimRules());
    rules.addAll(insertRIPatientRules());
    rules.addAll(editAdmissionRules());
    rules.addAll(editDiagnosticRules());
    rules.addAll(editProcedureInfoRules());
    rules.addAll(editHighCostProcedureRules());
    return rules;
  }

  /**
   * Create validation rules for INSERTRESINPATCLAIMINFO.
   *
   * @return the list
   */
  protected List<ValidationRule<ClaimViewModel>> insertRIClaimRules() {
    List<ValidationRule<ClaimViewModel>> rules = new ArrayList<>();

    // Treating Province PV_TREATING_PROVINCE
    rules.add(
        new MandatoryRule<ClaimViewModel, String>(
            TREATING_PROVINCE, ClaimViewModel::getTreatingProvince));
    rules.add(
        new LookupRule<ClaimViewModel, String>(
            TREATING_PROVINCE,
            ClaimViewModel::getTreatingProvince,
            (v) -> appService.getProvince(v) != null));
    rules.add(
        new NotInSetRule<ClaimViewModel, String>(
            TREATING_PROVINCE, ClaimViewModel::getTreatingProvince, "BC"));

    // Hospital Number PV_HOSPITAL_NUMBER
    rules.add(
        new MandatoryRule<ClaimViewModel, String>(
            "Hospital Number & Name", ClaimViewModel::getHospitalNumber));

    // Hospital Name PV_HOSPITAL_NAME
    rules.add(
        new ComplexRule<ClaimViewModel>("Hospital Name", c -> complexRules.checkValidHospital(c)));
    // CHECKHOSPITALACTIVERANGE
    rules.add(
        new ComplexRule<ClaimViewModel>(
            "Check Hospital Active", c -> complexRules.checkHospitalActiveRange(c)));
    // CHECKPERDIEMRATE
    rules.add(
        new ComplexRule<ClaimViewModel>(
            "Check Perdiem Rate", c -> complexRules.checkPerDiemRate(c)));

    // Total Amount Claimed PN_TOTAL_AMOUNT_CLAIMED
    rules.add(
        new MandatoryRule<ClaimViewModel, BigDecimal>(
            "Total Amount Claimed", ClaimViewModel::getTotalAmountClaimed));
    // Diagnostic Code
    // NOTE: Conflicting rules see CLAIMHASDIAGNOSTICCODE and See also PN_TOTAL_AMOUNT_CLAIMED in
    // excel. This seem to be the intended rule.
    // Moved to editDiagnosticRules
    // rules.add(new MandatoryRule<ClaimViewModel, String>("Diagnostic Code #1",
    // c -> c.getMainDiagnosisCode()));
    // CHECKINPATIENTTOTALAMT
    rules.add(
        new ComplexRule<ClaimViewModel>(
            "Check Total Amout", c -> complexRules.checkInPatientTotalAmout(c)));

    // Claim Source PV_CLAIM_SOURCE
    rules.add(
        new MandatoryRule<ClaimViewModel, String>("Claim Source", ClaimViewModel::getClaimSource));
    rules.add(
        new InSetRule<ClaimViewModel, String>(
            "Claim Source", ClaimViewModel::getClaimSource, "MANUAL", "IMPORT"));

    // Coding Scheme SV_CODING_SCHEME
    // NOTE: Those 2 rules replaces the documented rule for coding scheme to reflect what was coded
    // in HoopcV1 (not as documented).
    // Will give an error if coding scheme is not 'ICD10'
    rules.add(
        new MandatoryRule<ClaimViewModel, String>(
            "Coding Scheme", ClaimViewModel::getIcdCodingScheme));
    rules.add(
        new InSetRule<ClaimViewModel, String>(
            "Coding Scheme", ClaimViewModel::getIcdCodingScheme, "ICD10"));

    // Accident Code PV_ACCIDENT_CODE
    rules.add(
        new LookupRule<ClaimViewModel, String>(
            "Accident Code",
            ClaimViewModel::getAccidentCodeOnly,
            (v) -> appService.getDiagnosticCode(v) != null));

    // Accident indicator PV_ACCIDENT_INDICATOR
    rules.add(
        new ComplexRule<ClaimViewModel>(
            "Accident Indicator", c -> complexRules.checkIncidentCodeIndicator(c)));

    // Submission Date SD_SUBMISSION_DATE
    rules.add(
        new InDateRangeRule<ClaimViewModel, LocalDate>(
            "Discharge Date",
            c -> c.getAdmission().getDischargeDate(),
            null,
            ClaimViewModel::getSubmissionDate,
            null,
            SUBMISSION_DATE));
    rules.add(
        new ComplexRule<ClaimViewModel>(SUBMISSION_DATE, c -> complexRules.checkYearOldClaim(c)));

    return rules;
  }

  /**
   * Create validation rules for INSERTRESINPATPATIENTINFO.
   *
   * @return the list
   */
  protected List<ValidationRule<ClaimViewModel>> insertRIPatientRules() {

    // Assumes claimView.getPatient() not null
    List<ValidationRule<ClaimViewModel>> rules = new ArrayList<>();

    // Insurance Card Number PV_INSURANCE_NUMBER
    rules.add(
        new MandatoryRule<ClaimViewModel, String>(
            "Insurance Number", c -> c.getPatient().getInsuranceCardNumber()));
    // CHECKINPATDUPLICATE
    rules.add(
        new ComplexRule<ClaimViewModel>(
            "Check Patient Duplicate", c -> complexRules.checkInPatientDuplicate(c)));
    // CHECKINPATCONFLICT
    rules.add(
        new ComplexRule<ClaimViewModel>(
            "Check Patient Conflict", c -> complexRules.checkInPatientConflict(c)));

    // Last Name PV_LAST_NAME
    rules.add(
        new MandatoryRule<ClaimViewModel, String>("Last Name", c -> c.getPatient().getLastName()));

    // First Name PV_FIRST_NAME
    rules.add(
        new MandatoryRule<ClaimViewModel, String>(
            "First Name", c -> c.getPatient().getFirstName()));

    // Address PV_ADDRESS1
    rules.add(
        new MandatoryRule<ClaimViewModel, String>(
            "Address Line 1", c -> c.getPatient().getAddress1()));

    // City PV_CITY
    rules.add(new MandatoryRule<ClaimViewModel, String>("City", c -> c.getPatient().getCity()));

    // Province PV_PROVINCE
    rules.add(
        new MandatoryRule<ClaimViewModel, String>("Province", c -> c.getPatient().getProvince()));
    rules.add(
        new InSetRule<ClaimViewModel, String>("Province", c -> c.getPatient().getProvince(), "BC"));

    // Postal Code PV_POSTAL_CODE
    rules.add(
        new MandatoryRule<ClaimViewModel, String>(
            "Postal Code", c -> c.getPatient().getPostalCode()));
    // CHECKPOSTALCODEFORMAT
    rules.add(
        new ComplexRule<ClaimViewModel>(
            "checkPostalCodeFormat", c -> complexRules.checkPostalCodeFormat(c)));
    // CHECKPOSTALCODEPREFIX
    rules.add(
        new ComplexRule<ClaimViewModel>(
            "checkPostalCodePrefix", c -> complexRules.checkPostalCodePrefix(c)));

    // Birth Date PD_BIRTH_DATE
    rules.add(
        new MandatoryRule<ClaimViewModel, LocalDate>(
            "Birth Date", c -> c.getPatient().getBirthDate()));
    // Birth date must be <= admissionDate
    rules.add(
        new InDateRangeRule<ClaimViewModel, LocalDate>(
            "Birth Date",
            c -> c.getPatient().getBirthDate(),
            null,
            c -> c.getAdmission().getAdmissionDate(),
            null,
            "Admission Date"));

    // Sex PV_SEX_CODE
    rules.add(new MandatoryRule<ClaimViewModel, String>("Sex", c -> c.getPatient().getSexCode()));

    // Deceased flag PV_DECEASED_FLAG
    rules.add(
        new MandatoryRule<ClaimViewModel, String>(
            "Deceased Flag", c -> c.getPatient().getDeceasedFlag()));

    return rules;
  }
}
