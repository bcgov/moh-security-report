package ca.bc.gov.health.validation.claim;

import ca.bc.gov.health.constants.ClaimDetailCodePurpose;
import ca.bc.gov.health.constants.ClaimDetailCodeType;
import ca.bc.gov.health.database.entity.ClaimDetailCodes;
import ca.bc.gov.health.service.HoopcAppService;
import ca.bc.gov.health.service.viewmodel.AdmissionsViewModel;
import ca.bc.gov.health.service.viewmodel.ClaimViewModel;
import ca.bc.gov.health.service.viewmodel.PatientsViewModel;
import ca.bc.gov.health.validation.ValidationError;
import ca.bc.gov.health.validation.rule.ValidationRuleType;
import java.util.ArrayList;
import java.util.List;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertNull;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.MockitoAnnotations;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/** Test Validation rules for EDITDIAGNOSTICINFO in InsertRIClaimValidator.editDiagnosticRules() */
public class EditDiagnosticValidatorTest {

  // TODO: Setup debug logger
  private static Logger log = LoggerFactory.getLogger(EditDiagnosticValidatorTest.class);

  @InjectMocks private InsertRIClaimValidator validator;

  @InjectMocks private ClaimValidatorComplexRules complexRules;

  @Mock private HoopcAppService appService;

  @Mock private ClaimValidatorHelper helper;

  @BeforeEach
  public void initMocks() {
    MockitoAnnotations.initMocks(this);
    validator.setComplexRules(complexRules);
  }

  private ClaimViewModel emptyClaim() {
    ClaimViewModel claim = new ClaimViewModel();
    claim.setPatient(new PatientsViewModel());
    claim.setAdmission(new AdmissionsViewModel());
    claim.setDiagnosisCodes(new String[] {"", "", ""});
    return claim;
  }

  // ===========================================================================================
  // Edit Diagnostic Info rules # 1
  // ===========================================================================================
  @Test
  public void diagnosticCode1_Mandatory() {
    ClaimViewModel claim = emptyClaim();

    // Negative test
    claim.getDiagnosisCodes()[0] = null;
    List<ValidationError> errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect one mandatory error
    ValidationError error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #1"))
            .filter(e -> e.getRule().getType().equals(ValidationRuleType.MANDATORY_VALUE))
            .findFirst()
            .orElse(null);
    assertNotNull(error);
    log.info(error.getMessage());

    // Positive test
    claim.getDiagnosisCodes()[0] = "A000";
    Mockito.when(appService.getClaimDetailCodes("A000", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ArrayList<ClaimDetailCodes>() {
              {
                add(new ClaimDetailCodes());
              }
            });

    errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect no error
    error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #1"))
            .findFirst()
            .orElse(null);
    assertNull(error);
  }

  @Test
  public void diagnosticCode1_Lookup() {
    ClaimViewModel claim = emptyClaim();

    // Negative test
    claim.getDiagnosisCodes()[0] = "XXX";
    Mockito.when(appService.getClaimDetailCodes("XXX", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(new ArrayList<>());
    List<ValidationError> errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect one lookup error
    ValidationError error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #1"))
            .filter(e -> e.getRule().getType().equals(ValidationRuleType.LOOKUP_VALUE))
            .findFirst()
            .orElse(null);
    assertNotNull(error);
    log.info(error.getMessage());

    // Positive test
    claim.getDiagnosisCodes()[0] = "A000";
    Mockito.when(appService.getClaimDetailCodes("A000", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ArrayList<ClaimDetailCodes>() {
              {
                add(new ClaimDetailCodes());
              }
            });

    errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect no error
    error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #1"))
            .findFirst()
            .orElse(null);
    assertNull(error);
  }

  @Test
  public void diagnosticCode1_CheckCodingScheme() {
    ClaimViewModel claim = emptyClaim();

    // Negative test
    claim.setIcdCodingScheme("ICD10");
    claim.getDiagnosisCodes()[0] = "A000";
    Mockito.when(appService.getClaimDetailCodeAnyScheme("A000", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ClaimDetailCodes() {
              {
                setCodeValue("A000");
                setCodeType(ClaimDetailCodeType.ICD09.toString());
              }
            });
    List<ValidationError> errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect one complex error
    ValidationError error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Check Coding Scheme"))
            .filter(e -> e.getRule().getType().equals(ValidationRuleType.COMPLEX))
            .findFirst()
            .orElse(null);
    assertNotNull(error);
    log.info(error.getMessage());

    // Positive test
    claim.setIcdCodingScheme("ICD10");
    claim.getDiagnosisCodes()[0] = "A001";
    Mockito.when(appService.getClaimDetailCodeAnyScheme("A001", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ClaimDetailCodes() {
              {
                setCodeValue("A001");
                setCodeType(ClaimDetailCodeType.ICD10.toString());
              }
            });

    errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect no error
    error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Check Coding Scheme"))
            .findFirst()
            .orElse(null);
    assertNull(error);
  }

  // ===========================================================================================
  // Edit Diagnostic Info rules # 2
  // ===========================================================================================
  @Test
  public void diagnosticCode2_Optionnal() {
    ClaimViewModel claim = emptyClaim();

    // Negative test
    claim.getDiagnosisCodes()[1] = null;
    List<ValidationError> errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect no mandatory error
    ValidationError error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #2"))
            .filter(e -> e.getRule().getType().equals(ValidationRuleType.MANDATORY_VALUE))
            .findFirst()
            .orElse(null);
    assertNull(error);
  }

  @Test
  public void diagnosticCode2_Lookup() {
    ClaimViewModel claim = emptyClaim();

    // Negative test
    claim.getDiagnosisCodes()[1] = "XXX";
    Mockito.when(appService.getClaimDetailCodes("XXX", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(new ArrayList<>());
    List<ValidationError> errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect one lookup error
    ValidationError error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #2"))
            .filter(e -> e.getRule().getType().equals(ValidationRuleType.LOOKUP_VALUE))
            .findFirst()
            .orElse(null);
    assertNotNull(error);
    log.info(error.getMessage());

    // Positive test
    claim.getDiagnosisCodes()[1] = "A000";
    Mockito.when(appService.getClaimDetailCodes("A000", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ArrayList<ClaimDetailCodes>() {
              {
                add(new ClaimDetailCodes());
              }
            });

    errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect no error
    error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #2"))
            .findFirst()
            .orElse(null);
    assertNull(error);
  }

  @Test
  public void diagnosticCode2_CheckCodingScheme() {
    ClaimViewModel claim = emptyClaim();

    // Negative test
    claim.setIcdCodingScheme("ICD10");
    claim.getDiagnosisCodes()[1] = "A000";
    Mockito.when(appService.getClaimDetailCodeAnyScheme("A000", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ClaimDetailCodes() {
              {
                setCodeValue("A000");
                setCodeType(ClaimDetailCodeType.ICD09.toString());
              }
            });
    List<ValidationError> errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect one complex error
    ValidationError error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Check Coding Scheme"))
            .filter(e -> e.getRule().getType().equals(ValidationRuleType.COMPLEX))
            .findFirst()
            .orElse(null);
    assertNotNull(error);
    log.info(error.getMessage());

    // Positive test
    claim.setIcdCodingScheme("ICD10");
    claim.getDiagnosisCodes()[1] = "A001";
    Mockito.when(appService.getClaimDetailCodeAnyScheme("A001", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ClaimDetailCodes() {
              {
                setCodeValue("A001");
                setCodeType(ClaimDetailCodeType.ICD10.toString());
              }
            });

    errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect no error
    error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Check Coding Scheme"))
            .findFirst()
            .orElse(null);
    assertNull(error);
  }

  // ===========================================================================================
  // Edit Diagnostic Info rules # 3
  // ===========================================================================================
  @Test
  public void diagnosticCode3_Optionnal() {
    ClaimViewModel claim = emptyClaim();

    // Negative test
    claim.getDiagnosisCodes()[2] = null;
    List<ValidationError> errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect no mandatory error
    ValidationError error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #3"))
            .filter(e -> e.getRule().getType().equals(ValidationRuleType.MANDATORY_VALUE))
            .findFirst()
            .orElse(null);
    assertNull(error);
  }

  @Test
  public void diagnosticCode3_Lookup() {
    ClaimViewModel claim = emptyClaim();

    // Negative test
    claim.getDiagnosisCodes()[2] = "XXX";
    Mockito.when(appService.getClaimDetailCodes("XXX", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(new ArrayList<>());
    List<ValidationError> errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect one lookup error
    ValidationError error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #3"))
            .filter(e -> e.getRule().getType().equals(ValidationRuleType.LOOKUP_VALUE))
            .findFirst()
            .orElse(null);
    assertNotNull(error);
    log.info(error.getMessage());

    // Positive test
    claim.getDiagnosisCodes()[2] = "A000";
    Mockito.when(appService.getClaimDetailCodes("A000", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ArrayList<ClaimDetailCodes>() {
              {
                add(new ClaimDetailCodes());
              }
            });

    errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect no error
    error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Diagnostic Code #3"))
            .findFirst()
            .orElse(null);
    assertNull(error);
  }

  @Test
  public void diagnosticCode3_CheckCodingScheme() {
    ClaimViewModel claim = emptyClaim();

    // Negative test
    claim.setIcdCodingScheme("ICD10");
    claim.getDiagnosisCodes()[2] = "A000";
    Mockito.when(appService.getClaimDetailCodeAnyScheme("A000", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ClaimDetailCodes() {
              {
                setCodeValue("A000");
                setCodeType(ClaimDetailCodeType.ICD09.toString());
              }
            });
    List<ValidationError> errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect one complex error
    ValidationError error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Check Coding Scheme"))
            .filter(e -> e.getRule().getType().equals(ValidationRuleType.COMPLEX))
            .findFirst()
            .orElse(null);
    assertNotNull(error);
    log.info(error.getMessage());

    // Positive test
    claim.setIcdCodingScheme("ICD10");
    claim.getDiagnosisCodes()[2] = "A001";
    Mockito.when(appService.getClaimDetailCodeAnyScheme("A001", ClaimDetailCodePurpose.DIAGNOSTIC))
        .thenReturn(
            new ClaimDetailCodes() {
              {
                setCodeValue("A001");
                setCodeType(ClaimDetailCodeType.ICD10.toString());
              }
            });

    errors = validator.validate(claim);
    assertNotNull(errors);

    // Expect no error
    error =
        errors.stream()
            .filter(e -> e.getRule().getRuleIdentifier().equals("Check Coding Scheme"))
            .findFirst()
            .orElse(null);
    assertNull(error);
  }
}
