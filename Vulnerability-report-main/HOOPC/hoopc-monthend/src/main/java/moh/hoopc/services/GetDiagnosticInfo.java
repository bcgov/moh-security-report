package moh.hoopc.services;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.util.Properties;
import moh.hoopc.services.input.GetDiagnosticInfoIn;
import moh.hoopc.services.output.GetDiagnosticInfoCur;
import moh.hoopc.services.output.GetDiagnosticInfoOut;
import moh.hoopc.services.util.IErrorText;
import moh.hoopc.services.util.ServiceFailedException;
import moh.hoopc.services.util.ValidationException;
import oracle.jdbc.OracleTypes;

/**
 * @author Eric Bregeon
 * @version 1.0
 * @copyright Licensed Materials - Property of IBM - Copyright IBM Canada Ltd. 2003. All Rights
 *     Reserved
 * @security IBM Confidential
 * @date 20 November 2004
 * @revision Last Revision Name Comments
 * @revision ==========================================================================
 * @revision 20 November 2004 Eric Bregeon Created.
 * @see
 */
public class GetDiagnosticInfo extends DBService implements IErrorText {

  private String HOOPC2_DETAIL_CODES_getDiagnosticInfo =
      "{ call HOOPC2_DETAIL_CODES.getDiagnosticInfo(?, ?, ?, ?, ?, ?, ?, ?) }";

  public GetDiagnosticInfo(GetDiagnosticInfoIn getDiagnosticInfoIn, Properties properties) {
    super(getDiagnosticInfoIn, new GetDiagnosticInfoOut(), properties);
  }

  public GetDiagnosticInfo(GetDiagnosticInfoIn getDiagnosticInfoIn) {
    super(getDiagnosticInfoIn, new GetDiagnosticInfoOut(), null);
  }

  /**
   * validateInput ensures the service has not been passed invalid input. In the case that invalid
   * input has been passed a ValidationException is thrown which is dealt with by the handler
   */
  protected void validateInput() throws ValidationException {
    super.validateInput();
  }

  /**
   * Populates the output object with the returned search results
   *
   * @param cstmt CallableStatement used to run the SQL stored procedure created in
   *     createOracleStatement
   */
  protected void setOutputBean(CallableStatement cstmt)
      throws SQLException, ServiceFailedException {
    // retrieves the output object that is returned to the handler

    GetDiagnosticInfoOut output = (GetDiagnosticInfoOut) getOutputBean();

    int resultCode = cstmt.getInt(7);
    ResultSet rs = null;

    // if no oracle error was encoutered,
    if (resultCode == ORACLE_OK) {

      try {
        rs = (ResultSet) cstmt.getObject(6);
        GetDiagnosticInfoCur getDiagnosticInfoCur = null;
        while (rs.next()) {

          getDiagnosticInfoCur = new GetDiagnosticInfoCur();
          // Creating new output row with the result
          getDiagnosticInfoCur.setCode(rs.getString(1));
          getDiagnosticInfoCur.setCodeType(rs.getString(2));
          getDiagnosticInfoCur.setDescription(rs.getString(3));
          getDiagnosticInfoCur.setSequenceNum(rs.getInt(4));
          getDiagnosticInfoCur.setLockSeqNum(rs.getInt(5));

          // Add the new row to the results arraylist.
          output.addDiagnosticInfoCur(getDiagnosticInfoCur);
        }
        rs.close();
        rs = null;
      } finally {
        if (rs != null) {
          rs.close();
          rs = null;
        }
      }

    } else {
      throw new ServiceFailedException(Integer.toString(resultCode), cstmt.getString(8));
    }
  }

  /**
   * Creates and prepares the callable statement that will be executed by the OracleService object
   * that this class inherits from
   *
   * @param cstmt CallableStatement used to run the SQL stored procedure
   * @return cstmt CallableStatement is created here and returned
   */
  protected CallableStatement createStatement(CallableStatement cstmt) throws SQLException {
    GetDiagnosticInfoIn inputBean = (GetDiagnosticInfoIn) getInputBean();

    Connection con = inputBean.getConnection();

    cstmt = con.prepareCall(HOOPC2_DETAIL_CODES_getDiagnosticInfo);

    // set the input params
    cstmt.setInt(1, inputBean.getSearchID());
    cstmt.setInt(2, inputBean.getRecordNumber());
    cstmt.setString(3, inputBean.getCodingScheme());
    cstmt.setString(4, inputBean.getUserID());
    cstmt.setString(5, inputBean.getSessionID());

    // register the output paramters
    cstmt.registerOutParameter(6, OracleTypes.CURSOR);
    cstmt.registerOutParameter(7, Types.NUMERIC);
    cstmt.registerOutParameter(8, Types.VARCHAR);

    return cstmt;
  }
}
