package moh.hpc.month.end.test;

import moh.hpc.month.end.constants.*;

public class PortTest {
  public static final int MONTH_END_MAIN_PROCESS = 1;
  public static final int MONTH_END_OP_THREAD = 2;
  public static final int MONTH_END_RES_THREAD = 8;
  public static final int MONTH_END_NONRES_THREAD = 10;

  public static boolean isSocketOpen(String lockPort) {
    boolean retVal = false;
    java.net.ServerSocket myLock = null;
    try {
      myLock = new java.net.ServerSocket(Integer.parseInt(lockPort));
      myLock.close();
      myLock = null;
      retVal = true;
    } catch (java.io.IOException e) {
    } catch (NumberFormatException e) {
      e.printStackTrace();
    }
    return retVal;
  }

  private static int checkSocket(int statusCode, String port, String msg, boolean quiet) {
    int retVal = 0;
    if (!isSocketOpen(port)) {
      retVal = statusCode;
      if (!quiet) System.out.println(msg + "Up");
    } else if (!quiet) System.out.println(msg + "Down");
    return retVal;
  }

  public static void main(String[] args) {
    int retVal = -1;
    if (args.length >= 1) {
      java.util.Properties prp = new java.util.Properties();
      try {
        boolean quiet = false;
        if (args.length >= 2) if (args[1].equalsIgnoreCase("-q")) quiet = true;
        prp.load(new java.io.FileInputStream(args[0]));

        retVal =
            checkSocket(
                MONTH_END_MAIN_PROCESS,
                prp.getProperty(PropertyFileKeys.PRP_LOCK_PORT),
                "Month End Main Thread: ",
                quiet);
        retVal +=
            checkSocket(
                MONTH_END_OP_THREAD,
                prp.getProperty(PropertyFileKeys.PRP_OPS_LOCK_PORT),
                "Ops Thread: ",
                quiet);
        retVal +=
            checkSocket(
                MONTH_END_RES_THREAD,
                prp.getProperty(PropertyFileKeys.PRP_RES_HANDLER_LOCK_PORT),
                "Month End Resident Handler Thread: ",
                quiet);
        retVal +=
            checkSocket(
                MONTH_END_NONRES_THREAD,
                prp.getProperty(PropertyFileKeys.PRP_NONRES_HANDLER_LOCK_PORT),
                "Month End No-Resident Handler Thread: ",
                quiet);
      } catch (java.io.IOException e) {
        e.printStackTrace();
      }
    } else {
      System.out.println("Usage: PortTest properties.file [-q]");
    }
    System.exit(retVal);
  }
}
