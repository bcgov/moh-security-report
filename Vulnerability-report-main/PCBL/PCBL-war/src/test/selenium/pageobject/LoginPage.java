/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package selenium.pageobject;

import org.openqa.selenium.By;
import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.remote.RemoteWebDriver;
import org.openqa.selenium.support.PageFactory;
import org.openqa.selenium.support.ui.LoadableComponent;
import selenium.util.ActionBot;
import selenium.util.Constants;
import selenium.util.SeleniumConfigLoader;

/**
 *
 * @author adebiyi.kuseju
 */
public class LoginPage extends LoadableComponent<LoginPage> {
    
     public static final String USERNAME_FIELD_NAME = "username";

    private final WebDriver driver;
    private WebElement username;
    private WebElement password;
    private String[] handles;
    private final String userId;
    private final String pw;
    private final ActionBot actionBot;
    private final String browser;
    
    
    private WebElement exitServiceLink;

    public LoginPage(WebDriver driver, String browser, String userName, String password) {

        this.driver = driver;
        this.userId = userName;
        this.pw = password;
        this.browser = browser;
        actionBot = new ActionBot(driver);

        PageFactory.initElements(driver, this);

    }

    private void login(String userName, String pw) {

        actionBot.type(username, userName);
        actionBot.type(password, pw);
        this.password.submit();

        handles = driver.getWindowHandles().toArray(new String[0]);

    }

    @Override
    protected void load() {

        driver.get(SeleniumConfigLoader.getProperty("login_url", "https://hnwd1.moh.hnet.bc.ca/"));

        if (browser.equals(((RemoteWebDriver) driver).getCapabilities().getBrowserName())) {
            driver.navigate().to("javascript:document.getElementById('overridelink').click()");
        }

        actionBot.waitForLoadingUsingName(USERNAME_FIELD_NAME, Constants.MEDIUM_TIMEOUT);
        login(userId, pw);
    }

    @Override
    protected void isLoaded() throws Error {

        try {
            driver.findElement(By.name(USERNAME_FIELD_NAME));
            assert true;
        } catch (NoSuchElementException e) {
            load();
        }
    }

    public void signOut() {

        driver.switchTo().window(handles[0]);
        
        try {
            driver.findElement(By.xpath("//a[@href='/HNWebController?ExternalAction=WsignOff']")).click();
        } catch (Exception e) {
            
        }
        
    }
}
