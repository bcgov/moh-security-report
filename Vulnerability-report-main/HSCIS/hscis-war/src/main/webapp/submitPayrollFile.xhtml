<ui:composition template="/WEB-INF/templates/gov30Template.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:f="http://xmlns.jcp.org/jsf/core">
  <ui:define name="title">
    Submit Payroll File
  </ui:define>
  <ui:define name="content">
    <h:outputStylesheet name="css/fileupload.css" />
    <h:outputStylesheet name="css/submitpayrollfile.css" />
    <ui:include src="/WEB-INF/fragments/navTabs/payrollTabs.xhtml" />
    <!-- NOTE: enctype required for fileUpload see: 
    https://stackoverflow.com/questions/8875818/how-to-use-primefaces-pfileupload-listener-method-is-never-invoked-or-uploaded -->
    <h:form id="submitPayrollFileForm" enctype="multipart/form-data">
      <p:remoteCommand name="onload" autoRun="true"
                       action="#{SubmitPayrollFileView.refreshReportList}" update="messages reportsPanel" />
      <p:messages id="messages" closable="true">
        <p:autoUpdate />
      </p:messages>
      <div class="ui-g-3 no-margin-left no-padding-left">
        <p:outputLabel class="ui-g-label" for="@next" value="Account" />
        <div class="ui-g-field">
          <p:selectOneMenu id="selectAccount" value="#{SubmitPayrollFileView.selectedAccount}"
                           required="true" style="width: 100%;">
            <p:ajax event="valueChange" listener="#{SubmitPayrollFileView.refreshReportList}"
                    update="messages reportTable" />
            <f:selectItems value="#{SubmitPayrollFileView.accounts}" />
          </p:selectOneMenu>
        </div>
        <div class="clearfix" />
        <p:outputLabel class="ui-g-label" for="@next" value="Year" />
        <div class="ui-g-field">
          <p:selectOneMenu id="selectYear" value="#{SubmitPayrollFileView.selectedYear}"
                           required="true">
            <f:selectItems value="#{SubmitPayrollFileView.years}" />
          </p:selectOneMenu>
        </div>
        <div class="clearfix" />
        <p:outputLabel class="ui-g-label" for="@next" value="Quarter" />
        <div class="ui-g-field">
          <p:selectOneMenu id="selectQuarter" value="#{SubmitPayrollFileView.selectedQuarter}"
                           required="true">
            <f:selectItems value="#{SubmitPayrollFileView.quarters}" />
          </p:selectOneMenu>
        </div>
      </div>
      <div class="ui-g">
        <div class="ui-g-12 no-margin-left no-padding-left no-margin-right no-padding-right">
          <!-- 
          The upload works in 2 phases (ajax calls).
          The first phase is handled by fileUpload. 
          It completes after the file is uploaded to the webserver. 
          The file should appear as 'In Progress' in the submissionTable. 
          -->
          <h:panelGroup id="fileUploadGroup">
            <p:fileUpload listener="#{SubmitPayrollFileView.handleFileUpload}" multiple="false"
                          fileLimit="1" mode="advanced" dragDropSupport="true" auto="true"
                          update="messages submissionTable fileUploadGroup" label="Add File"
                          oncomplete="completeUpload()" allowTypes="/(\.|\/)(txt|TXT)$/"
                          sizeLimit="#{ApplicationBean.sfdsProperties.getProperty('maxFileSize')}"
                          rendered="#{SubmitPayrollFileView.isUploadEnabled()}"
                          id="fileUpload" />
          </h:panelGroup>
          <!-- 
          The upload works in 2 phases (ajax calls). 
          The second phase is handled by completeUpload . It launches the SFDS upload. 
          It completes after the file is uploaded to SFDS. 
          The file should appear as 'Accepted' or 'Error' in the submissionTable. 
          -->
          <p:remoteCommand name="completeUpload"
                           update="messages submissionTable" action="#{SubmitPayrollFileView.submitFile()}" />
          <p:dataTable id="submissionTable" value="#{SubmitPayrollFileView.submissions}"
                       sortBy="#{file.submissionTime}"
                       var="file" rowKey="#{file.filename}">
            <p:column headerText="NAME">
              <h:outputText value="#{file.filename}" />
            </p:column>
            <p:column headerText="SIZE">
              <h:outputText value="#{file.filesize}">
                <f:converter converterId="byteCountConverter" />
              </h:outputText>
            </p:column>
            <p:column headerText="STATUS">
              <h:graphicImage width="12" height="12"
                              value="/resources/template-images/animated-spinner.gif"
                              rendered="#{file.status eq 'IN_PROGRESS'}" styleClass="submission-status-icon" />
              <h:graphicImage width="12" height="12"
                              value="/resources/template-images/error-large.png"
                              rendered="#{file.status eq 'ERROR'}" styleClass="submission-status-icon" />
              <h:graphicImage width="12" height="12"
                              value="/resources/template-images/success-large.png"
                              rendered="#{file.status eq 'ACCEPTED'}" styleClass="submission-status-icon" />
              <h:outputText value="#{file.status.label}" styleClass="submission-status" />
            </p:column>
            <p:column headerText="SUBMITTED" sortBy="#{file.submissionTime}" sortOrder="desc">
              <h:outputText value="#{file.submissionTime}">
                <f:convertDateTime type="localDateTime"
                                   pattern="yyyy-MM-dd HH:mm" />
              </h:outputText>
            </p:column>
          </p:dataTable>
        </div>
      </div>
      <pe:timer id="refreshTimer" interval="#{SubmitPayrollFileView.refreshInterval}"
                visible="false" autoStart="true" update="messages reportsPanel"
                listener="#{SubmitPayrollFileView.refreshReportList}" singleRun="false"
                widgetVar="refreshTimer" />
      <div class="reports-panel">
        <p:panel id="reportsPanel">
          <div class="padding-left-6-5 padding-right-6-5">
            <p:dataTable id="reportTable" value="#{SubmitPayrollFileView.reports}" var="report"
                         sortBy="#{report.modifiedTime}"
                         selection="#{SubmitPayrollFileView.selectedReports}" rowKey="#{report.filename}">
              <f:facet name="header">
                PAYROLL EXTRACT REPORTS
              </f:facet>
              <p:ajax event="toggleSelect"
                      update="submitPayrollFileForm:download submitPayrollFileForm:delete"
                      process="@this" />
              <p:ajax event="rowSelect"
                      update="submitPayrollFileForm:download submitPayrollFileForm:delete"
                      process="@this" />
              <p:ajax event="rowSelectCheckbox"
                      update="submitPayrollFileForm:download submitPayrollFileForm:delete"
                      process="@this" />
              <p:ajax event="rowUnselectCheckbox"
                      update="submitPayrollFileForm:download submitPayrollFileForm:delete"
                      process="@this" />
              <!-- TODO hardcoded width until css is fixed. Should be aligned same as row checkboxes in css -->
              <p:column selectionMode="multiple" />
              <p:column headerText="CREATED" sortBy="#{report.modifiedTime}" sortOrder="desc">
                <h:outputText value="#{report.modifiedTime}">
                  <f:convertDateTime type="localDateTime"
                                     pattern="yyyy-MM-dd HH:mm" />
                </h:outputText>
              </p:column>
              <p:column headerText="NAME" sortBy="#{report.filename}">
                <h:outputText value="#{report.filename}" />
              </p:column>
              <ui:remove>
                <p:column headerText="CORPORATION"
                          sortBy="#{report.corporationName}">
                  <h:outputText value="" />
                </p:column>
                <p:column headerText="VALID" sortBy="#{report.valid}">
                  <h:outputText value="" />
                </p:column>
              </ui:remove>
              <p:column headerText="SIZE" sortBy="#{report.filesize}">
                <h:outputText value="#{report.filesize}">
                  <f:converter converterId="byteCountConverter" />
                </h:outputText>
              </p:column>
            </p:dataTable>
            <div class="margin-bottom-10">
              <p:commandButton id="download" value="Download"
                               disabled="#{!SubmitPayrollFileView.downloadEnabled}" ajax="false"
                               title="Download all selected Payroll Extract Reports">
                <p:fileDownload value="#{SubmitPayrollFileView.download()}" />
              </p:commandButton>
              <p:commandButton id="delete" value="Delete"
                               disabled="#{!SubmitPayrollFileView.deleteEnabled}" styleClass="danger"
                               title="Delete the selected Payroll Extract Reports"
                               onclick="PF('cdReport').show()"
                               immediate="true">
              </p:commandButton>
            </div>
          </div>  
        </p:panel>
      </div>
    </h:form>
    <h:form id="delConfirmForm">
      <p:confirmDialog id="deleteConfirm" global="false" widgetVar="cdReport" header="Delete Payroll Extract Reports" appendTo="@(body)" width="650px">
        <f:facet name="message">
          <p:outputPanel>
            <h:outputText id="confirmtext" value="Delete the selected Payroll Extract Reports?" escape="false" /> 
          </p:outputPanel>
        </f:facet>
        <p:commandButton value="Delete" 
                         action="#{SubmitPayrollFileView.delete}" onclick="PF('cdReport').hide();"
                         update="submitPayrollFileForm:reportsPanel submitPayrollFileForm:messages"
                         styleClass="danger" />
        <p:commandButton value="Cancel" type="button"
                         onclick="PF('cdReport').hide();"
                         styleClass="ui-confirmdialog-no" />
      </p:confirmDialog>
    </h:form>
  </ui:define>
</ui:composition>