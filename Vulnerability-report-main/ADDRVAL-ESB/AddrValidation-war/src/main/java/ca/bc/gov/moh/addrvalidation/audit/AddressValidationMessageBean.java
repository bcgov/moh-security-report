/*
 * *********************************************************************************************************************
 *  Copyright (c) 2017, Ministry of Health, BC.                                                 *
 *                                                                                                                     *
 *  All rights reserved.                                                                                               *
 *    This information contained herein may not be used in whole                                                       *
 *    or in part without the express written consent of the                                                            *
 *    Government of British Columbia, Canada.                                                                          *
 *                                                                                                                     *
 *  Revision Control Information                                                                                       *
 *  File:                $Id::                                                                                       $ *
 *  Date of Last Commit: $Date::                                                                                     $ *
 *  Revision Number:     $Rev::                                                                                      $ *
 *  Last Commit by:      $Author::                                                                                   $ *
 *                                                                                                                     *
 * *********************************************************************************************************************
 */
package ca.bc.gov.moh.addrvalidation.audit;

import ca.bc.gov.moh.esb.util.audit.AuditProcessor;
import ca.bc.gov.moh.esb.util.audit.entity.Transaction;
import ca.bc.gov.moh.esb.util.audit.entity.TransactionEvent;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.ejb.ActivationConfigProperty;
import javax.ejb.MessageDriven;
import javax.jms.JMSException;
import javax.jms.Message;
import javax.jms.MessageListener;
import javax.jms.ObjectMessage;

/**
 * This class reads a Transaction object from the JMS queue and persists it into
 * the audit tables
 *
 * @author joshua.burton
 */
@MessageDriven(activationConfig = {
    @ActivationConfigProperty(propertyName = "destinationLookup", propertyValue = "jms/addrValQueue"),
    @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue")
})
public class AddressValidationMessageBean implements MessageListener {

    private final AuditProcessor ap = new AuditProcessor();
    
    public AddressValidationMessageBean() {
    }

    @Override
    public void onMessage(Message message) {
        try {
            ObjectMessage objectMsg = (ObjectMessage) message;
            
            if (objectMsg.getObject() instanceof Transaction) {
                ap.insert((Transaction) objectMsg.getObject());
            } else if (objectMsg.getObject() instanceof TransactionEvent) {
                ap.insert((TransactionEvent) objectMsg.getObject());
            }
            
        } catch (JMSException ex) {
            Logger.getLogger(AddressValidationMessageBean.class.getName()).log(Level.SEVERE, null, ex);

        }
    }
}
