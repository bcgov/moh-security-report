/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.bc.gov.moh.addrvalidation.converter;

import ca.bc.gov.moh.addrvalidation.AddressValidationWebServiceTest;
import ca.bc.gov.moh.addrvalidation.entity.wsdl.AddressCode;
import org.junit.Assert;
import org.junit.Test;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Unmarshaller;
import javax.xml.soap.MessageFactory;
import javax.xml.soap.SOAPException;
import javax.xml.soap.SOAPMessage;
import ca.bc.gov.moh.addrvalidation.entity.wsdl.Process;

/**
 *
 * @author killian.faussart
 */
public class SoapEntityToAddressDoctorXMLConverterTest {

    private Process convertXMLFile(String fileName) {
        Process process = null;
        try {

            File file = new File(getClass().getClassLoader().getResource(fileName).getFile());
            JAXBContext jaxbContext = JAXBContext.newInstance(ca.bc.gov.moh.addrvalidation.entity.wsdl.Process.class);

            SOAPMessage message = MessageFactory.newInstance().createMessage(null, new FileInputStream(file));

            Unmarshaller jaxbUnmarshaller = jaxbContext.createUnmarshaller();
            process = (Process) jaxbUnmarshaller.unmarshal(message.getSOAPBody().extractContentAsDocument());

        } catch (JAXBException | SOAPException | IOException ex) {
            Logger.getLogger(AddressValidationWebServiceTest.class.getName()).log(Level.SEVERE, null, ex);
        }

        return process;

    }

    private AddressCode createAddressCode() {
        AddressCode addressCode = new AddressCode();
        addressCode.setCodeType("A");
        addressCode.setValue("B");
        return addressCode;
    }
    
    @Test
    public void testAddressConverter() {

        //GIVEN
        Process process = convertXMLFile("TEST_ONE_FC_D_Full_Details.xml");
        process.getAddresses().getAddress().get(0).setAddressCode(createAddressCode());
        process.getAddresses().getAddress().get(0).setAddressComplete("Complete");
        process.getAddresses().getAddress().get(0).setRecordId("RecordId");
        
        SoapEntityToAddressDoctorXMLConverter converter = new SoapEntityToAddressDoctorXMLConverter();

        //WHEN
        String result = converter.convert(process.getAddresses().getAddress().get(0));

        //THEN
        Assert.assertEquals("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n" +
                "<InputData>\n" +
                "    <AddressElements>\n" + 
                "        <Key Item=\"1\" Type=\"RECORD_ID\">RecordId</Key>\n" +
                "        <Country Item=\"1\" Type=\"NAME\">Canada</Country>\n" +
                "        <Country Item=\"0\" Type=\"NAME\">?</Country>\n" +
                "        <Country Item=\"0\" Type=\"ABBREVIATION\">?</Country>\n" +
                "        <Country Item=\"0\" Type=\"ISO2\"/>\n" +
                "        <Country Item=\"0\" Type=\"ISO3\"/>\n" +
                "        <Country Item=\"0\" Type=\"ISO_NUMBER\"/>\n" +
                "        <Locality Item=\"1\" Type=\"COMPLETE\">Victoria</Locality>\n" +
                "        <Locality Item=\"0\" Type=\"COMPLETE\"/>\n" +
                "        <Locality Item=\"0\" Type=\"NAME\"/>\n" +
                "        <Locality Item=\"0\" Type=\"PREFERRED_NAME\"/>\n" +
                "        <Locality Item=\"0\" Type=\"SORTING_CODE\"/>\n" +
                "        <Locality Item=\"0\" Type=\"ADD_INFO\">?</Locality>\n" +
                "        <PostalCode Item=\"1\" Type=\"FORMATTED\"></PostalCode>\n" +
                "        <PostalCode Item=\"0\" Type=\"FORMATTED\">?</PostalCode>\n" +
                "        <PostalCode Item=\"0\" Type=\"UNFORMATTED\">?</PostalCode>\n" +
                "        <PostalCode Item=\"0\" Type=\"BASE\">?</PostalCode>\n" +
                "        <PostalCode Item=\"0\" Type=\"ADD_ON\">?</PostalCode>\n" +
                "        <Province Item=\"1\" Type=\"COUNTRY_STANDARD\"></Province>\n" +
                "        <Province Item=\"0\" Type=\"COUNTRY_STANDARD\">?</Province>\n" +
                "        <Province Item=\"0\" Type=\"ABBREVIATION\">?</Province>\n" +
                "        <Province Item=\"0\" Type=\"EXTENDED\">?</Province>\n" +
                "        <Province Item=\"0\" Type=\"ISO\">?</Province>\n" +
                "        <Street Item=\"1\" Type=\"COMPLETE\">1405 Douglas Street</Street>\n" +
                "        <Street Item=\"0\" Type=\"COMPLETE\">?</Street>\n" +
                "        <Street Item=\"0\" Type=\"COMPLETE_WITH_NUMBER\">?</Street>\n" +
                "        <Street Item=\"0\" Type=\"NAME\">?</Street>\n" +
                "        <Street Item=\"0\" Type=\"PRE_DESCRIPTOR\">?</Street>\n" +
                "        <Street Item=\"0\" Type=\"POST_DESCRIPTOR\">?</Street>\n" +
                "        <Street Item=\"0\" Type=\"PRE_DIRECTIONAL\">?</Street>\n" +
                "        <Street Item=\"0\" Type=\"POST_DIRECTIONAL\">?</Street>\n" +
                "        <Street Item=\"0\" Type=\"ADD_INFO\">?</Street>\n" +
                "        <Number Item=\"1\" Type=\"COMPLETE\"></Number>\n" +
                "        <Number Item=\"0\" Type=\"COMPLETE\">?</Number>\n" +
                "        <Number Item=\"0\" Type=\"NUMBER\">?</Number>\n" +
                "        <Number Item=\"0\" Type=\"DESCRIPTOR\">?</Number>\n" +
                "        <Number Item=\"0\" Type=\"ADD_INFO\">?</Number>\n" +
                "        <Building Item=\"1\" Type=\"COMPLETE\"></Building>\n" +
                "        <Building Item=\"0\" Type=\"COMPLETE\">?</Building>\n" +
                "        <Building Item=\"0\" Type=\"COMPLETE_WITH_SUBBUILDING\">?</Building>\n" +
                "        <Building Item=\"0\" Type=\"NAME\">?</Building>\n" +
                "        <Building Item=\"0\" Type=\"NUMBER\">?</Building>\n" +
                "        <Building Item=\"0\" Type=\"DESCRIPTOR\">?</Building>\n" +
                "        <SubBuilding Item=\"1\" Type=\"COMPLETE\"></SubBuilding>\n" +
                "        <SubBuilding Item=\"0\" Type=\"COMPLETE\">?</SubBuilding>\n" +
                "        <SubBuilding Item=\"0\" Type=\"NAME\">?</SubBuilding>\n" +
                "        <SubBuilding Item=\"0\" Type=\"NUMBER\">?</SubBuilding>\n" +
                "        <SubBuilding Item=\"0\" Type=\"DESCRIPTOR\">?</SubBuilding>\n" +
                "        <DeliveryService Item=\"1\" Type=\"COMPLETE\"></DeliveryService>\n" +
                "        <DeliveryService Item=\"0\" Type=\"COMPLETE\">?</DeliveryService>\n" +
                "        <DeliveryService Item=\"0\" Type=\"DESCRIPTOR\">?</DeliveryService>\n" +
                "        <DeliveryService Item=\"0\" Type=\"NUMBER\">?</DeliveryService>\n" +
                "        <DeliveryService Item=\"0\" Type=\"ADD_INFO\">?</DeliveryService>\n" +
                "        <Organization Item=\"1\" Type=\"COMPLETE\"></Organization>\n" +
                "        <Organization Item=\"0\" Type=\"COMPLETE\">?</Organization>\n" +
                "        <Organization Item=\"0\" Type=\"NAME\">?</Organization>\n" +
                "        <Organization Item=\"0\" Type=\"DESCRIPTOR\">?</Organization>\n" +
                "        <Organization Item=\"0\" Type=\"DEPARTMENT\">?</Organization>\n" +
                "        <Contact Item=\"1\" Type=\"COMPLETE\"></Contact>\n" +
                "        <Contact Item=\"0\" Type=\"COMPLETE\">?</Contact>\n" +
                "        <Contact Item=\"0\" Type=\"FIRST_NAME\">?</Contact>\n" +
                "        <Contact Item=\"0\" Type=\"MIDDLE_NAME\">?</Contact>\n" +
                "        <Contact Item=\"0\" Type=\"LAST_NAME\">?</Contact>\n" +
                "        <Contact Item=\"0\" Type=\"NAME\">?</Contact>\n" +
                "        <Contact Item=\"0\" Type=\"TITLE\">?</Contact>\n" +
                "        <Contact Item=\"0\" Type=\"FUNCTION\">?</Contact>\n" +
                "        <Contact Item=\"0\" Type=\"SALUTATION\">?</Contact>\n" +
                "        <Contact Item=\"0\" Type=\"GENDER\">?</Contact>\n" +
                "        <Residue Item=\"1\" Type=\"SUPERFLUOUS\"></Residue>\n" +
                "        <Residue Item=\"0\" Type=\"NECESSARY\">?</Residue>\n" +
                "        <Residue Item=\"0\" Type=\"SUPERFLUOUS\">?</Residue>\n" +
                "        <Residue Item=\"0\" Type=\"UNRECOGNIZED\">?</Residue>\n" +
                "    </AddressElements>\n" +
                "    <AddressLines>\n" +
                "        <RecipientLine Line=\"1\"></RecipientLine>\n" +
                "        <DeliveryAddressLine Line=\"1\"></DeliveryAddressLine>\n" +
                "        <CountrySpecificLocalityLine Line=\"1\"></CountrySpecificLocalityLine>\n" +
                "        <FormattedAddressLine Line=\"1\"></FormattedAddressLine>\n" +
                "    </AddressLines>\n" +
                "    <AddressComplete>Complete</AddressComplete>\n" +
                "    <AddressCode Type=\"A\">B</AddressCode>\n" +
                "</InputData>\n", result);
    }

    @Test
    public void testParameterConverter() {

        //GIVEN
        Process process = convertXMLFile("TEST_ONE_FC_NOD.xml");
        SoapEntityToAddressDoctorXMLConverter converter = new SoapEntityToAddressDoctorXMLConverter();

        //WHEN
        String result = converter.convertParameters(process.getParameters());

        //THEN
        Assert.assertEquals("<?xml version=\"1.0\" encoding=\"UTF-16\"?>\n"
                + "<Parameters WriteXMLEncoding=\"UTF-16\" WriteXMLBOM=\"NEVER\">\n"
                + "  <Process Mode=\"FASTCOMPLETION\" EnrichmentGeoCoding=\"ON\" EnrichmentCASS=\"ON\" EnrichmentSERP=\"ON\" EnrichmentCAMEO=\"ON\" EnrichmentSupplementaryUS=\"ON\" />\n"
                + "  <Input Encoding=\"UTF-16\" FormatType=\"ALL\" FormatWithCountry=\"ON\" />\n"
                + "  <Result Encoding=\"UTF-16\" CountryType=\"NAME_EN\" GlobalPreferredDescriptor=\"SHORT\" />\n"
                + "</Parameters>", result);
    }
    
    @Test
    public void testParameterConverterInvalidProcessMode() {

        //GIVEN
        Process process = convertXMLFile("TEST_ONE_BATCH_NOD.xml");
        SoapEntityToAddressDoctorXMLConverter converter = new SoapEntityToAddressDoctorXMLConverter();

        //WHEN
        process.getParameters().setProcessMode("InvalidProcessMode");
        String result = converter.convertParameters(process.getParameters());

        //THEN
        Assert.assertEquals("<?xml version=\"1.0\" encoding=\"UTF-16\"?>\n"
                + "<Parameters WriteXMLEncoding=\"UTF-16\" WriteXMLBOM=\"NEVER\">\n"
                + "  <Process Mode=\"BATCH\" EnrichmentGeoCoding=\"ON\" EnrichmentCASS=\"ON\" EnrichmentSERP=\"ON\" EnrichmentCAMEO=\"ON\" EnrichmentSupplementaryUS=\"ON\" />\n"
                + "  <Input Encoding=\"UTF-16\" FormatType=\"ALL\" FormatWithCountry=\"ON\" />\n"
                + "  <Result Encoding=\"UTF-16\" CountryType=\"NAME_EN\" GlobalPreferredDescriptor=\"SHORT\" />\n"
                + "</Parameters>", result);
    }

}
